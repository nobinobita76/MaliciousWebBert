<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html;charset=utf-8;"><meta http-equiv="X-UA-Compatible" content="IE=edge"></head><body style=""><object id="CryptCtrl" border="0" classid="CLSID:3C474273-7F8B-4690-8C34-855C4528658D" style="visibility:hidden;"></object><title>增值税发票选择确认平台</title><link href="css/common.6fb1824a.css" rel="stylesheet" type="text/css"><link href="css/style.1bd61d4b.css" rel="stylesheet" type="text/css"><link rel="stylesheet" type="text/css" href="css/jquery.alerts.9e55c5da.css"><link rel="stylesheet" type="text/css" href="css/jquery.dataTables.6b081e8c.css"><link rel="stylesheet" type="text/css" href="css/bootstrap-datepicker.min.5dd03c9d.css"><script type="text/javascript" language="javascript" src="js/jquery-1.10.2.min.js"></script><script type="text/javascript" src="js/jquery.alerts.js"></script><script type="text/javascript" language="javascript" src="js/jquery.dataTables.js"></script><script type="text/javascript" src="js/laydate.dev.js"></script><script type="text/javascript" src="js/mxtjtable.ce66b81e.js"></script><script type="text/javascript" src="js/common.4cdba89a.js"></script><script type="text/javascript" src="js/crypt.js"></script><script type="text/javascript" language="javascript" src="js/bootstrap-datepicker.js"></script><script type="text/javascript" language="javascript" src="js/bootstrap-datepicker.zh-CN.min.js"></script><script type="text/javascript" src="js/cookies.334ab6ee.js"></script><div id="header"><div class="logo"><img src="images/logo.3c817f58.png"><span class="city_name"></span></div><div class="user_on"><span><a href="qyxxwh.78738167.html" id="nsrmc"></a></span>&nbsp;&nbsp;|&nbsp;&nbsp; <a href="#" onclick="quit();">退出</a></div><div class="nav"><ul><li><a href="main.002ca525.html">首页</a></li><li><a href="fphx.25a771ed.html">发票勾选</a></li><li><a href="upload.236276c8.html">批量勾选</a></li><li><a href="sbqr.ac947dc4.html">确认勾选</a></li><li><a href="fpcx.043fa7a1.html">发票查询</a></li><li class="currentnav"><a href="dktj.8472863b.html">抵扣统计</a></li><li><a href="qyxxwh.78738167.html">档案信息维护</a></li></ul></div></div><div id="main"><div class="position pad10 pad50_l">当前位置：<a href="main.002ca525.html">首页</a> - <span class="color_2">抵扣统计</span> <a href="javascript:void(0);" title="帮助" class="help" onclick="helpInfo_rename('help-dktj.170e1bfa.html');">帮助</a></div><div class="T-title clearfix"><span class="pad15_r" id="yf_flag">税款所属期：</span> <span style="width:130px;"><input type="text" id="rzyf" class="form-control" style="width:150px;display: inline !important;"></span> <span class="floatR_btn font_1"><a class="button button-green theme-btn" href="javascript:;" id="tj_button"><span>统计查询</span></a> <a href="#" class="button button-white" id="un_tj_button" style="display:none;"><span>统计查询</span></a> <a href="javascript:void(0);" class="button button-green theme-btn" id="printdata"><span id="print" style="display: none; ">打印</span></a></span></div><center id="init" style="height:250px"></center><center id="load" style="display:none;"><img src="images/loadding.1459ba38.gif"><p class="font_2" style="margin-top:-120px;">正在处理，请稍候...</p></center><div id="tj_panle" style="display:none;"><div id="dcarea"><div class="T-title"><center>申报抵扣发票统计表&nbsp;——&nbsp;<span id="table_text" class="font_4"></span><span id="tjsj" class="font_4"></span></center></div><table width="100%" class="height40"><tbody><tr><td><span class="height40 color_2" id="nsrmc1">纳税人名称：</span></td><td><span class="height40 color_2" id="nsrsbh1">纳税人识别号：</span></td><td><span class="height40 color_2" id="rzyf1">认证月份：</span></td><td align="right"><span class="height40 color_2 mar_l_30">单位：（份、元）</span></td></tr></tbody></table><div style="overflow-x:auto;width:100%;"><table width="100%" class="height40 resultTable" border="1"><tbody><tr><th width="20%" rowspan="2"><div class="out"><b>认证方式</b> <em style="color:#000000;">发票类型</em></div></th><th width="20%" colspan="3">勾选认证</th><th width="20%" colspan="3">扫描认证</th><th width="20%" colspan="3">合计</th></tr><tr><th>份数</th><th>金额</th><th>税额</th><th>份数</th><th>金额</th><th>税额</th><th>份数</th><th>金额</th><th>税额</th></tr><tr id="row_0"></tr><tr id="row_1"></tr><tr id="row_2"></tr><tr id="row_3"></tr></tbody></table></div></div><div id="dcarea1" style="width:210mm;display: none;"><div class="T-title"><center>申报抵扣发票统计表&nbsp;——&nbsp;<span id="table_text2" class="font_4"></span><span id="tjsj1" class="font_4"></span></center></div><table width="100%" class="height40" style="width:160mm; font-size:6pt;color:#000;"><tbody><tr><td style="width:25mm;"><span class="height40" id="nsrmc11">纳税人名称：</span></td><td style="width:25mm;"><span class="height40" id="nsrsbh11">纳税人识别号：</span></td></tr><tr><td style="width:25mm;"><span class="height40" id="rzyf11">认证月份：</span></td><td style="width:25mm;"><span class="height40 mar_l_30">单位：（份、元）</span></td></tr></tbody></table><table width="100%" class="height40" border="1" style="width:160mm;font-size:6pt;" id="printTable"><tbody><tr><th rowspan="2" style="width:25mm;"><div style="width:25mm;"><b style="left:-4mm!important;">发票类型</b> <em style="color:#000000;left:-12mm!important;">认证方式</em></div></th><th style="width:60mm;" colspan="3">勾选认证</th><th style="width:30mm;" colspan="3">扫描认证</th><th style="width:60mm;" colspan="3">合计</th></tr><tr><th style="width:20mm;">份数</th><th style="width:20mm;">金额</th><th style="width:20mm;">税额</th><th style="width:10mm;">份数</th><th style="width:10mm;">金额</th><th style="width:10mm;">税额</th><th style="width:20mm;">份数</th><th style="width:20mm;">金额</th><th style="width:20mm;">税额</th></tr><tr id="row1_0"></tr><tr id="row1_1"></tr><tr id="row1_2"></tr><tr id="row1_3"></tr></tbody></table><div style="display: none;"><form id="dcform"><input id="dcnr" name="html" type="text"> <input id="filename" name="options" type="text"></form></div><div class="color_3" style="border-top:1px dotted; padding-top:15px; line-height:20px!important;margin-top:20px;font-size:14px;" id="tipInfo">注：<br>1、本统计表包括指定税款所属期内所有勾选认证和扫描认证的发票。<br><span>2、新增勾选认证和扫描认证数据会触发报表更新。</span><br><span>3、当天勾选认证数据会准实时在本统计表中体现，当天扫描认证数据会第二天在本统计表中体现，请您关注统计表上方的“报表更新时间”。</span><br><span>4、若勾选认证栏显示的发票数量少于确认勾选模块中查询到的当期累计确认发票数量，可能是由于同一张发票既勾选认证、又扫描认证了，系统去重导致。</span></div></div><br><div class="color_3" style="border-top:1px dotted #666; padding-top:15px; line-height:20px!important;margin-top:20px;font-size:14px;" id="tipInfo_yc">上述抵扣统计表中包含认证完成后变为异常的发票（不能抵扣用），清单如下：</div><div id="ycfpqd"><div class="T-title"><center>异常发票清单&nbsp;——&nbsp;<span id="table_text1" class="font_4"></span></center></div><div id="ycfp"></div></div><div class="color_3" style="border-top:1px dotted #666; padding-top:15px; line-height:20px!important;margin-top:20px;font-size:14px;" id="tipInfo">注：<br>1、本统计表包括指定税款所属期内所有勾选认证和扫描认证的发票。<br><span>2、新增勾选认证和扫描认证数据会触发报表更新。</span><br><span>3、当天勾选认证数据会准实时在本统计表中体现，当天扫描认证数据会第二天在本统计表中体现，请您关注统计表上方的“报表更新时间”。</span><br><span>4、若勾选认证栏显示的发票数量少于确认勾选模块中查询到的当期累计确认发票数量，可能是由于同一张发票既勾选认证、又扫描认证了，系统去重导致。</span></div><br><div class="login_word" id="show_mx" style="display:none;"><a href="javascript:void(0);" onclick="mxShow();" class="color_5 font_3 downfile">查看明细</a></div></div><center id="loadMx" style="display:none;"><img src="images/loadding.1459ba38.gif"><p class="font_2" style="margin-top:-120px;">正在处理，请稍候...</p></center><div id="tip_info" style="display:none;"><hr class="detail_hr"><div class="height40"><span class="pad15_r">发票代码：<input type="text" id="fpdm" class="input_1"></span> <span class="pad15_r">发票号码：<input type="text" id="fphm" class="input_1"></span> <span class="pad15_r">开票日期： <label><input type="text" id="mx_sjq" class="form-control" style="width:110px;display: inline !important;"> - <input type="text" id="mx_sjz" class="form-control" style="width:110px;display: inline !important;"></label></span> <span class="pad15_r">销方税号：<input type="text" id="xfsbh" class="input_1" style="width:200px;"></span><br><span class="pad15_r">认证方式： <label class="pad30_r"><input name="fply" type="radio" value="0" checked=""> 全部</label> <label class="pad30_r"><input name="fply" type="radio" value="1"> 勾选认证</label> <label class="pad30_r"><input name="fply" type="radio" value="2"> 扫描认证</label></span></div><div class="T-title clearfix"><span class="floatL">查询结果</span> <span class="floatR_btn font_1"><a href="#" class="button button-blue" id="search" onclick="searchInfo();"><span>查询</span></a> <a href="#" class="button button-white" id="unsearch" style="display:none;"><span>查询</span></a></span></div><center id="load" style="display:none;"><img src="images/loadding.1459ba38.gif"><p class="font_2" style="margin-top:-120px;">正在处理，请稍候...</p></center><div class="T-title"><center>发票清单</center></div><table width="100%" class="height40" id="tab_title"><tbody><tr><td><span class="height40 color_2" id="nsrmc2">纳税人名称：</span></td><td><span class="height40 color_2" id="nsrsbh2">纳税人识别号：</span></td><td><span class="height40 color_2" id="rzyf2">认证月份：</span></td><td align="right" colspan="3"><span class="height40 color_2 mar_l_30">单位：（份、元）</span></td></tr></tbody></table><div class="container" id="tab1"><section><table id="example" class="display nowrap" cellspacing="0" width="100%"><thead><tr><th>序号</th><th>发票代码</th><th>发票号码</th><th>开票日期</th><th>销方名称</th><th>金额</th><th>税额</th><th>认证方式</th><th>确认/认证日期</th><th>发票类型</th><th>发票状态</th></tr></thead></table></section></div></div><div id="file_panle" style="display:none;"><div class="T-title clearfix"><span class="floatL">抵扣明细文件下载</span></div><a href="#" onclick="downLoadSj();" class="color_5 font_3 downfile"><span class="underline" id="fileName">aaaaaasa.xsl</span></a></div></div><div id="footer"><div>监制单位：国家税务总局电子税务管理中心&nbsp;&nbsp;&nbsp;&nbsp;研发单位：长城计算机软件与系统有限公司<br>请使用IE8及以上浏览器&nbsp;&nbsp;&nbsp;&nbsp;建议分辨率1280*768及以上 &nbsp;&nbsp;&nbsp;&nbsp;版本号：<span id="version"></span><br></div></div><script type="text/javascript">
var ymbb = "3.0.09";
var token=getCookie("token");
setCookie("token",token,seconds);
var filePath;
var yfsj;
var DQSSQ="";
$('#print').hide();
$(document).ready(function(){ 

  if(token==""||token==undefined){
    jAlert("<div id='popup_message'>会话失效，请重新登录！</div>","提示",function(r){
      if(r){
        window.location.href=getDomainName();
      }
    });
  }else{ 
    $('#version').text(VERSION);
    $('.city_name').text(getCityName());
    var nsrmc=getCookie("nsrmc");
    $('#nsrmc').text(nsrmc);
    setCookie("nsrmc",nsrmc,seconds); 
    $('#rzyf').datepicker({
        format: "yyyymm",
        startView: 1,
        minViewMode: 1,
        autoclose: true,
        language: "zh-CN"
    });

    $('#mx_sjq').datepicker({
      format: "yyyy-mm-dd",
      autoclose: true,
      language: "zh-CN"
    });
    
    $('#mx_sjz').datepicker({
      format: "yyyy-mm-dd",
      autoclose: true,
      language: "zh-CN"
    });
       

    var dqrq=getCookie("dqrq");
    setCookie("dqrq",dqrq,seconds);
  
    var cert=getCert();
    if(!velidateNsrsbh(cert)){
      return;
    }
  
    var skyf=GetQueryString("skyf");
  
    if(skyf==null||skyf==""||skyf=="null"){ 
      var param={"cert":cert,"token":token,"ymbb":ymbb};
  
      var cookssq=getCookie("skssq");

      if(cookssq==""){    
        $.ajax({
        type:"get",
        url:IP+"/SbsqWW/hqssq.do",
        dataType: "jsonp",
        data:param,
        timeout:TIMEOUT,
        jsonp: "callback",
        success: function(jsonData) {

          var key1=jsonData.key1;
          var key2=jsonData.key2;
          if(key1=="01"){                  
            token=jsonData.key2;
            clearCookie("token");
            setCookie("token",token,seconds);
            cookssq=jsonData.key3;
            var infoArr=cookssq.split(';'); 
            DQSSQ=infoArr[0];
            $('#rzyf').val(DQSSQ);
            setCookie("skssq",cookssq,seconds);
            setCookie("gxrqfw",jsonData.key4,seconds);

          }else if(key1=='09'){
            jAlert("<div id='popup_message'>会话已超时，请重新登陆！</div>","提示",function(r) {
              if(r){
                  window.location.href = getDomainName();
              }
            });
          }else if(key1=="00"){
            jAlert_error("<div id='popup_message'>系统异常！</div>","提示");
          }
        },error:function(data){
          if(data.responseText==""||data.responseText==undefined){
            jAlert_error("<div id='popup_message'>网络异常，请重试！</div>","提示");
          }else{
            jAlert_error("<div id='popup_message'>系统异常，请重试！统一受理系统报文为:"+data.responseText+"</div>","提示");
          }        
        }                            
        });
      }else{
        setCookie("skssq",cookssq,seconds);
        var infoArr=cookssq.split(';'); 
        DQSSQ=infoArr[0];
        $('#rzyf').val(DQSSQ);
      }  
    }else{
      $('#rzyf').val(skyf);
    }
  }
  
});

$('#tj_button').click(function(){
  var rzyf=$('#rzyf').val();

  if(rzyf==''){
    jAlert("<div id='popup_message'>请选择税款所属期！</div>","提示");
    return;
  }
  //add by ljx
  if(rzyf<201608){
    $('#tjsj').hide();
    $('#tjsj1').hide();
	  $('#ycfpqd').hide();
  }else{
    $('#tjsj').show();
    $('#tjsj1').show();
	  $('#ycfpqd').show();
  }
  
  
  $('#init').hide();
  $('#tj_panle').hide();
  $('#loadMx').hide();
  $('#show_mx').hide();
  $('#tip_info').hide();  
  $('#file_panle').hide();  
  $('#load').show();     

  var dqrq=getCookie("dqrq");
  setCookie("dqrq",dqrq,seconds);
  
  var cert=getCert();
  if(!velidateNsrsbh(cert)){
    return;
  }

  yfsj=rzyf;
  $('#un_tj_button').show();
  $('#tj_button').hide();

  $.ajax({
    type: "get", 
    url: IP+"/SbsqWW/dktj.do",
    data:{"cert":cert,"token":token,"tjyf":rzyf,"oper":"tj","ymbb":ymbb},
    dataType: "jsonp",
    timeout:LONGTIMEOUT,
    jsonp: "callback",
    success: function(jsonData) { 
      var key1=jsonData.key1;
	    if(key1=="50"){
	      jAlert_error("<div id='popup_message'>抵扣统计查询失败！</div>","提示");
      }else if(key1=="00"){
        jAlert_error("<div id='popup_message'>系统异常！</div>","提示");
      }else if(key1=="20"){
	  
        $('#print').show();
		 
        if(rzyf==DQSSQ){
          $('#table_text').text('当期');
		      $('#table_text1').text('当期');
		      //打印
		      $('#table_text2').text('当期');
        }else{
          $('#table_text').text('往期');
		      $('#table_text1').text('往期');
		      $('#table_text2').text('往期');
        }

        var child=$('#row_0 td').size();
        if(child>0){
          for(var i=0;i<5;i++){                         
            $("#row_"+i).empty();
            $("#row1_"+i).empty();
          }
        }  

        var tjxx=jsonData.key2;
        var arr=tjxx.split(";");
        for(var i=0;i<arr.length;i++){
          var result=arr[i].split("=");
          for(var j=0;j<result.length;j++){
            if(j==0){
              if(result[j]=="01"){
                $('#row_'+i).append("<td>增值税专用发票</td>");
				        $('#row1_'+i).append("<td>增值税专用发票</td>");
              }else if(result[j]=="02"){
                $('#row_'+i).append("<td>货物运输业增值税专用发票</td>");
				        $('#row1_'+i).append("<td>货物运输业增值税专用发票</td>");
              }else if(result[j]=="03"){
                $('#row_'+i).append("<td>机动车销售统一发票</td>");
				        $('#row1_'+i).append("<td>机动车销售统一发票</td>");
              }else{
                $('#row_'+i).append("<td>总计</td>");
				        $('#row1_'+i).append("<td>总计</td>");
              }
            }else if((j-1)%3==0){
              $('#row_'+i).append("<td>"+result[j]+"</td>");
			        $('#row1_'+i).append("<td>"+result[j]+"</td>");
            }else{
              $('#row_'+i).append("<td>"+getFormatYuan(result[j])+"</td>");
			        $('#row1_'+i).append("<td>"+getFormatYuan(result[j])+"</td>");
            }                           
          }          
        }


        $('#printTable td').css({color:"#000",border:"1px solid",padding:"0 10px","text-align":"center"});
        $('#printTable th').css({color:"#000",border:"1px solid"});
		//add by ljx20160714  ycfpqd
		    $('#ycfp').empty();
		    var tableValue='<table width="100%" class="height40 resultTable" border="1"><tr><th>序号</th><th>发票代码</th><th>发票号码</th><th>开票日期</th><th>销方名称</th><th>发票状态</th></tr>';
		    var ycxx=jsonData.key5;
    		if(ycxx.length>0){
    		 var arrYc=ycxx.split(";");
            for(var m=0;m<arrYc.length-1;m++){
              var resultYc=arrYc[m].split("=");
    		   tableValue=tableValue + '<tr>' + '<td>' + (m+1) + '</td>';
              for(var n=0;n<resultYc.length;n++){
                  tableValue=tableValue +'<td>' + resultYc[n] + '</td>';		                 
              }      
              tableValue=tableValue +'</tr>';   		  
            }
    		 tableValue=tableValue +'</table>';   		  
    		//alert(tableValue);
    		$('#ycfp').append(tableValue);
    		}else{
    		 //$('#ycfp').append("无异常发票信息");
    		 $('#tipInfo_yc').hide();
    		 $('#ycfpqd').hide();
    		}
		
		//$('#printdata').attr("class","button button-green");
		//$('#printdata').attr("onclick","printData();");
		
        /*统计数据信息*/
        token=jsonData.key3;
        clearCookie("token");
        setCookie("token",token,seconds);

        nsrmc=getCookie("nsrmc");
        setCookie("nsrmc",nsrmc,seconds);

        $('#nsrmc1').text("纳税人名称："+nsrmc);
        $('#nsrsbh1').text("纳税人识别号："+cert);
        $('#rzyf1').text("认证月份："+getDqSsq($('#rzyf').val()));
		//var myDate = getCookie("dqrq");
		var myDate=jsonData.key4;
		
		$('#tjsj').text("（报表更新时间："+myDate+")");
        $('#init').hide();
        $('#load').hide();
        $('#show_mx').show();
        $('#tj_panle').show();
		
		//打印
		 $('#nsrmc11').text("纳税人名称："+nsrmc);
        $('#nsrsbh11').text("纳税人识别号："+cert);
        $('#rzyf11').text("认证月份："+getDqSsq($('#rzyf').val()));
		$('#tjsj1').text("（报表更新时间："+myDate+")");
		
      }else if (key1=="21") {
        jAlert("<div id='popup_message'>正在统计，请稍候重试！</div>","提示");
        $('#load').hide();
        $('#init').show();
      }else if (key1=="22") {
        jAlert("<div id='popup_message'>所选月份无抵扣发票！</div>","提示");
        $('#load').hide();
        $('#init').show();
      }else if (key1=="03") {
        jAlert_error("<div id='popup_message'>系统异常！</div>","提示");
        $('#load').hide();
        $('#init').show();
      }else if(key1=='09'){
        jAlert("<div id='popup_message'>会话已超时，请重新登陆！</div>","提示",function(r) {
            if(r){
                window.location.href = getDomainName();
            }
          });
      }else if(key1=="98"){
        jAlert_mail("<div id='popup_message'><br/>网络调用异常！<br/></div>","提示",PROVINCE+"(纳税人识别号："+cert+")抵扣统计失败","网络调用异常！");
        $('#load').hide();
        $('#init').show();
      }else if(key1=="99"){
        jAlert_mail("<div id='popup_message'><br/>网络调用超时！<br/></div>","提示",PROVINCE+"(纳税人识别号："+cert+")抵扣统计失败","网络调用超时！");
        $('#load').hide();
        $('#init').show();
      }else{
       jAlert_error("<div id='popup_message'>系统异常，错误代码为:"+key1+"</div>","提示");
       $('#load').hide();
       $('#init').show();
      }
      $('#un_tj_button').hide();
      $('#tj_button').show();
    },error:function(data){

       if(data["statusText"]=="timeout"){
          jAlert_error("<div id='popup_message'>加载数据超时，请稍后重试！</div>","提示");
        }else{
          if(data.responseText==""||data.responseText==undefined){
            jAlert_mail("<div id='popup_message'><br/>网络异常！<br/></div>","提示",PROVINCE+"(纳税人识别号："+cert+")抵扣统计失败","网络异常！");
          }else{
            jAlert_mail("<div id='popup_message'>网络异常:"+data.responseText+"</div>","提示",PROVINCE+"(纳税人识别号："+cert+")抵扣统计失败","网络异常:"+getTyslInfo(data.responseText));
          }
        }
      
      $('#un_tj_button').hide();
      $('#tj_button').show();
      $('#load').hide();
      $('#init').show();
    }
  });
});
function GetQueryString(name)
{
  var reg = new RegExp("(^|&)"+ name +"=([^&]*)(&|$)");
  var r = window.location.search.substr(1).match(reg);
  if(r!=null)return  unescape(r[2]); return null;
}

//明细查询 update by ljx 20160722
function searchInfo(){
  var fpdm=$('#fpdm').val();
  var fphm=$('#fphm').val();
  var xfsbh=$('#xfsbh').val();
  var kprq_q=$('#mx_sjq').val();

  var kprq_z=$('#mx_sjz').val();

  var fply=getFply();
   var cert=getCert();
  if(!velidateNsrsbh(cert)){
    return;
  }
  $('#file_panle').hide();
  $('#tip_info').hide();
  $('#loadMx').show();
    $('#example').dataTable({
		"destroy": true,
		"processing": true,
		"serverSide": true,
		"sAjaxSource": IP+"/SbsqWW/dktj.do",
	    "oLanguage": {
		   "sLengthMenu": "每页显示 _MENU_ 条记录",
		   "sInfo": "显示 _START_ 到 _END_ 条，共 _TOTAL_ 条记录",
		   "oPaginate": {
			   "sPrevious": "上一页",
			   "sNext": "下一页"
		   },
		   "sInfoEmpty":"显示 0 到 0 共 0 条记录",
		   "sInfoFiltered":" ",
		   "sZeroRecords": "未找到符合条件的记录",
		   "sProcessing" : "正在获取数据，请稍后..."
	   },
	   "searching":false,
	   "scrollX":true,
	   "bSort": false,
	   "aLengthMenu": [50,80,100],
	   "iDisplayLength":50,
	   "columnDefs":[
	   		{
	   			className: "tdleft",
	   			targets:[4]
	   		},
	   		{
	   			className: "tdcenter",
	   			targets:[0,1,2,3,7,8,9,10]
	   		},
	   		{
	   			className: "tdright",
	   			targets:[5,6]
	   		}
	   ],
	   "fnServerData": function(sSource, aoData, fnCallback){
	   		$.ajax({
                url : sSource,
                data : {"cert":cert,"token":token,"tjyf":yfsj,"oper":"cx","fpdm":fpdm,"fphm":fphm,"xfsbh":xfsbh,"kprq_q":kprq_q,"kprq_z":kprq_z,"fply":fply,"aoData":JSON.stringify(aoData),"ymbb":ymbb},
                type : 'post',
                dataType : 'jsonp',
                timeout:LONGTIMEOUT,
                // async : false,
                success : function(jsonData) {
                	var key1 = jsonData.key1;
		        	var key2 = jsonData.key2;
		        	var key4 = jsonData.key4;
					if(key1=="00"){
		          		jAlert_error("<div id='popup_message'>查询失败，请稍后再试！</div>","提示");
                  relaodMxData();
		        	}else if(key1=="01"){
					     $('#loadMx').hide();                        
                         $('#tip_info').show();
                         $('#file_panle').show();
	          			//displayCssShow();
	          			fnCallback(key2);
	          			nsrmc=getCookie("nsrmc");
                        setCookie("nsrmc",nsrmc,seconds);
                        $('#nsrmc2').text("纳税人名称："+nsrmc);
                        $('#nsrsbh2').text("纳税人识别号："+cert);
                        $('#rzyf2').text("认证月份："+getDqSsq(yfsj));
                          var dqrq=getCookie("dqrq");
                           setCookie("dqrq",dqrq,seconds);
                            token=jsonData.key3;
                            clearCookie("token");
                            setCookie("token",token,seconds); 
	          			if(key4==0){
	          				jAlert("<div id='popup_message'>没有符合条件的记录！</div>","提示");
	          			}
						
		        	}else if(key1=='09'){
		          	  jAlert("<div id='popup_message'>会话已超时，请重新登陆！</div>","提示",function(r) {
			            if(r){
                            window.location.href = getDomainName();
			            }
			          });
			        }else if(key1=="20"){
			          jAlert_error("<div id='popup_message'>网络异常，提交失败，请重试！</div>","提示");
                relaodMxData();
			        }else if(key1=="98"){
			          jAlert_error("<div id='popup_message'>外网调用内网异常，请重试！","提示");
                relaodMxData();
			        }else if(key1=="99"){
			          jAlert_error("<div id='popup_message'>外网调用内网超时，请重试！","提示");  
                relaodMxData();
			        }else if(key1=="101"){
			          jAlert_error("<div id='popup_message'>外网内存数据库连接失败！","提示"); 
                relaodMxData(); 
			        }else{
			          jAlert_error("<div id='popup_message'>系统异常！</div>","提示");
                relaodMxData();
			        }
                },
                error:function(data) {
                  if(data["statusText"]=="timeout"){
                    jAlert_error("<div id='popup_message'>加载数据超时，请稍后重试！</div>","提示");
                  }else{
                  	if(data.responseText==""||data.responseText==undefined){
        				        jAlert_error("<div id='popup_message'>网络异常，请重试！</div>","提示");
        				    }else{
        				        jAlert_error("<div id='popup_message'>系统异常，请重试！</div>","提示");
        				    }
                  }
                  
                  relaodMxData();
                }


            });
	   }
	});
  /*var result=[];
  for(var i=0;i<dataset.length;i++){
    if(fpdm!=""&&dataset[i][1]!=fpdm){
      continue;
    }
     if(fphm!=""&&dataset[i][2]!=fphm){
      continue;
    }
    if(xfsbh!=""&&dataset[i][4]!=xfsbh){
      continue;
    }
    if(dataset[i][3]<kprq_q||dataset[i][3]>kprq_z){
      continue;
    }
    if(fply!="全部"&&fply!=dataset[i][7]){
      continue;
    }
    result.push(dataset[i]);
  }
  loadMxData(result);*/
}

function relaodMxData(){
  $('#loadMx').hide();    
  $('#tip_info').show();
  $('#file_panle').show();
  clearMxData();
}

function clearMxData(){
  var dTable = $('#example').dataTable({
      "data":[],
      "destroy": true,
      "processing": false,
      "serverSide": false,
      "oLanguage": {
          "sLengthMenu": "每页显示 _MENU_ 条记录",
          "sInfo": "显示 _START_ 到 _END_ 条，共 _TOTAL_ 条记录",
          "oPaginate": {
              "sPrevious": "上一页",
              "sNext": "下一页"
          },
          "sInfoEmpty":"显示 0 到 0 共 0 条记录",
          "sInfoFiltered":" ",
          "sZeroRecords": "未找到符合条件的记录",
          "sProcessing" : ""
      },
      "searching":false,
      "scrollX":true,
      "bSort": false,
      "aLengthMenu": [50,80,100],
      "iDisplayLength":50,
       "columnDefs":[
        {
          className: "tdleft",
          targets:[4]
        },
        {
          className: "tdcenter",
          targets:[0,1,2,3,7,8,9,10]
        },
        {
          className: "tdright",
          targets:[5,6]
        }
     ]
  });  
}

function getFply(){
  var fplyValue="";
  $('input[type=radio][name=fply]').each(function(){
      if($(this).is(":checked")==true){
          fplyValue=$(this).val();
      }           
  });

  // if(fplyValue=="0"){
  //   fplyValue="全部";
  // }
  // else if(fplyValue=="1"){
  //   fplyValue="底账系统";
  // }
  // else if(fplyValue=="2"){
  //   fplyValue="认证系统";
  // }
  return fplyValue;
}

function changeWindow(){
}

//明细查询 update by ljx
function mxShow(){
  cz();
  $('#file_panle').hide();
  $('#tip_info').hide();
  $('#loadMx').show();

  var cert=getCert();
  if(!velidateNsrsbh(cert)){
    return;
  }

   var fply=getFply();
   
  $('#example').dataTable({
		"destroy": true,
		"processing": true,
		"serverSide": true,
		"sAjaxSource": IP+"/SbsqWW/dktj.do",
	    "oLanguage": {
		   "sLengthMenu": "每页显示 _MENU_ 条记录",
		   "sInfo": "显示 _START_ 到 _END_ 条，共 _TOTAL_ 条记录",
		   "oPaginate": {
			   "sPrevious": "上一页",
			   "sNext": "下一页"
		   },
		   "sInfoEmpty":"显示 0 到 0 共 0 条记录",
		   "sInfoFiltered":" ",
		   "sZeroRecords": "未找到符合条件的记录",
		   "sProcessing" : "正在获取数据，请稍后..."
	   },
	   "searching":false,
	   "scrollX":true,
	   "bSort": false,
	   "aLengthMenu": [50,80,100],
	   "iDisplayLength":50,
	   "columnDefs":[
	   		{
	   			className: "tdleft",
	   			targets:[4]
	   		},
	   		{
	   			className: "tdcenter",
	   			targets:[0,1,2,3,7,8,9,10]
	   		},
	   		{
	   			className: "tdright",
	   			targets:[5,6]
	   		}
	   ],
	   "fnServerData": function(sSource, aoData, fnCallback){
	   		$.ajax({
                url : sSource,
                data : {"cert":cert,"token":token,"tjyf":yfsj,"fply":fply,"oper":"cx","aoData":JSON.stringify(aoData),"ymbb":ymbb},
                type : 'post',
                dataType : 'jsonp',
                timeout:LONGTIMEOUT,
                // async : false,
                success : function(jsonData) {
                	var key1 = jsonData.key1;
		        	var key2 = jsonData.key2;
		        	var key4 = jsonData.key4;
		        	if(key1=="00"){
		          		jAlert_error("<div id='popup_message'>查询失败，请稍后再试！</div>","提示");
                  $('#loadMx').hide(); 
		        	}else if(key1=="01"){
					     $('#loadMx').hide();                        
                         $('#tip_info').show();
                         $('#file_panle').show();
						 filePath=jsonData.key6;
                         var index=filePath.lastIndexOf('/');
                         var file_name=filePath.substring(index+1);
                         $('#fileName').text(file_name);
	          			//displayCssShow();
	          			fnCallback(key2);
	          			nsrmc=getCookie("nsrmc");
                        setCookie("nsrmc",nsrmc,seconds);
                        $('#nsrmc2').text("纳税人名称："+nsrmc);
                        $('#nsrsbh2').text("纳税人识别号："+cert);
                        $('#rzyf2').text("认证月份："+getDqSsq(yfsj));
                          var dqrq=getCookie("dqrq");
                           setCookie("dqrq",dqrq,seconds);
                            var year=yfsj.substring(0,4);
                            var mon=parseInt(yfsj.substring(4),10);
                             $('#mx_sjq').val(year+"-"+yfsj.substring(4)+"-"+"01");
                             $('#mx_sjz').val(year+"-"+yfsj.substring(4)+"-"+getDayNum(year,mon));
        
        token=jsonData.key3;
        clearCookie("token");
        setCookie("token",token,seconds); 
	          			if(key4==0){
	          				jAlert("<div id='popup_message'>没有符合条件的记录！</div>","提示");
	          			}
						
		        	}else if(key1=='09'){
		          	  jAlert("<div id='popup_message'>会话已超时，请重新登陆！</div>","提示",function(r) {
			            if(r){
                            window.location.href = getDomainName();
			            }
			          });
			        }else if(key1=="20"){
			          jAlert_error("<div id='popup_message'>网络异常，提交失败，请重试！</div>","提示");
                $('#loadMx').hide(); 
			        }else if(key1=="98"){
			          jAlert_error("<div id='popup_message'>外网调用内网异常，请重试！","提示");
                $('#loadMx').hide(); 
			        }else if(key1=="99"){
			          jAlert_error("<div id='popup_message'>外网调用内网超时，请重试！","提示");  
                $('#loadMx').hide(); 
			        }else if(key1=="101"){
			          jAlert_error("<div id='popup_message'>外网内存数据库连接失败！","提示"); 
                $('#loadMx').hide(); 
			        }else{
			          jAlert_error("<div id='popup_message'>系统异常！</div>","提示");
                $('#loadMx').hide(); 
			        }
                },
                error:function(data) {
                  if(data["statusText"]=="timeout"){
                    jAlert_error("<div id='popup_message'>加载数据超时，请稍后重试！</div>","提示");
                  }else{
                  	if(data.responseText==""||data.responseText==undefined){
        				      jAlert_error("<div id='popup_message'>网络异常，请重试！</div>","提示");
        				    }else{
        				      jAlert_error("<div id='popup_message'>系统异常，请重试！</div>","提示");
        				    }
                  }
                  $('#loadMx').hide(); 
                }
            });
	   }
	});
  
 } 
  
  
  /*$.ajax({
    type: "get", 
    url: IP+"/SbsqWW/dktj.do",
    data:{"cert":cert,"token":token,"tjyf":yfsj,"oper":"cx"},
    dataType: "jsonp",
    timeout:TIMEOUT,
    jsonp: "callback",
    success: function(jsonData) { 
      var key1=jsonData.key1;
      if(key1=="00"){
          jAlert("<div id='popup_message'>系统异常！</div>","提示");
      }else if(key1=="20"){

        $('#loadMx').hide();                        
        $('#tip_info').show();
        $('#file_panle').show();
        filePath=jsonData.key6;
        var index=filePath.lastIndexOf('/');
        var file_name=filePath.substring(index+1);
        $('#fileName').text(file_name);
        var num=jsonData.key4;
        var maxNum=jsonData.key5;
        if(num>maxNum){
          jAlert("<div id='popup_message'>发票明细数量为："+num+"条，只显示前"+maxNum+"条数据，如需查看所有抵扣明细数据，请下载申报抵扣发票明细文件！</div>","提示");
        }        
        
        var cxjg=jsonData.key2;
        var arr=cxjg.split(";");
        dataset=[];
        for(var i=0;i<arr.length-1;i++){
          var result=arr[i].split("=");
          var index=parseInt(i,10)+1;
          dataset.push(createMxDateSet(index,result));
        }
        loadMxData(dataset);
        nsrmc=getCookie("nsrmc");
        setCookie("nsrmc",nsrmc,seconds);
        $('#nsrmc2').text("纳税人名称："+nsrmc);
        $('#nsrsbh2').text("纳税人识别号："+cert);
        $('#rzyf2').text("认证月份："+getDqSsq(yfsj));
        var dqrq=getCookie("dqrq");
        setCookie("dqrq",dqrq,seconds);
        if(dqrq==""){
             $('#mx_sjq').val(getRzcxDate(getDqrq()));
             $('#mx_sjz').val(getNowDate(2));
        }else{
            var year=parseInt(dqrq.substring(0,4),10);
            var month=parseInt(dqrq.substring(5,7),10);
            if(month==1){
              year-=1;
              month=12;
            }else{
              month-=1;
            }
            if(month<10){
              month="0"+month;
            }
            $('#mx_sjq').val(getRzcxDate(dqrq));
            $('#mx_sjz').val(getXtsj(dqrq,2));
        }
        
        token=jsonData.key3;
        clearCookie("token");
        setCookie("token",token,seconds);                     
      }else if (key1=="03") {
        jAlert_mail("<div id='popup_message'>系统异常！</div>","提示",PROVINCE+"(纳税人识别号："+cert+")抵扣统计明细查询失败","系统异常！");
      }else if(key1=='09'){
        jAlert("<div id='popup_message'>会话已超时，请重新登陆！</div>","提示",function(r) {
            if(r){
             window.location.href="index.html";
            }
          });
      }else if(key1=="98"){
          jAlert_mail("<div id='popup_message'>网络调用异常！</div>","提示",PROVINCE+"(纳税人识别号："+cert+")抵扣统计明细查询失败","网络调用异常！");
      }else if(key1=="99"){
        jAlert_mail("<div id='popup_message'>网络调用超时！</div>","提示",PROVINCE+"(纳税人识别号："+cert+")抵扣统计明细查询失败","网络调用超时！");
      }else{
       jAlert("<div id='popup_message'>系统异常，错误代码为:"+key1+"</div>","提示");
      }   
    },error:function(data){
      if(data.responseText==""||data.responseText==undefined){
        jAlert_mail("<div id='popup_message'>网络异常！</div>","提示",PROVINCE+"(纳税人识别号："+cert+")抵扣统计明细查询失败","网络异常！");
      }else{
        jAlert_mail("<div id='popup_message'>网络异常:"+data.responseText+"</div>","提示",PROVINCE+"(纳税人识别号："+cert+")抵扣统计明细查询失败","网络异常:"+getTyslInfo(data.responseText));
      }
    }
  });
}*/

function downLoadSj(){
  var cert=getCert();
  if(!velidateNsrsbh(cert)){
    return;
  }

  $.ajax({
    type: "get", 
    url: IP+"/SbsqWW/downloadTjsj.do",
    data:{"cert":cert,"type":"HELLO","token":token,"ymbb":ymbb},
    dataType: "jsonp",
    callback:"json",
    success: function(jsonData) { 

      var key1=jsonData.key1;
      if(key1=="01"){
        var key2=jsonData.key2;
        token=jsonData.key3;
        clearCookie("token");
        setCookie("token",token,seconds);
        location.href=IP+"/SbsqWW/downloadTjsj.do?randomKey="+key2+"&token="+token+"&filepath="+filePath+"&ymbb="+ymbb;
      }else if(key1=="03"){
        jAlert_mail("<div id='popup_message'><br/>系统异常！<br/></div>","提示",PROVINCE+"(纳税人识别号："+cert+")抵扣统计下载失败","系统异常！");
      }else if(key1=='09'){
        jAlert("<div id='popup_message'>会话已超时，请重新登陆！</div>","提示",function(r) {
            if(r){
                window.location.href = getDomainName();
            }
          });
      }else if(key1=="98"){
          jAlert_mail("<div id='popup_message'><br/>网络调用异常！<br/></div>","提示",PROVINCE+"(纳税人识别号："+cert+")抵扣统计下载失败","网络调用异常！");
      }else if(key1=="99"){
        jAlert_mail("<div id='popup_message'><br/>网络调用超时！<br/></div>","提示",PROVINCE+"(纳税人识别号："+cert+")抵扣统计下载失败","网络调用超时！");
      }else{
        jAlert("<div id='popup_message'>系统异常，错误代码为:"+key1+"</div>","提示");
      }
    },error:function(data){
      if(data.responseText==""||data.responseText==undefined){
        jAlert_mail("<div id='popup_message'><br/>网络异常！<br/></div>","提示",PROVINCE+"(纳税人识别号："+cert+")抵扣统计下载失败","网络异常！");
      }else{
        jAlert_mail("<div id='popup_message'>网络异常:"+data.responseText+"</div>","提示",PROVINCE+"(纳税人识别号："+cert+")抵扣统计下载失败","网络异常:"+getTyslInfo(data.responseText));
      } 
    }
  }); 
}


function cz(){
   document.getElementById("fpdm").value="";
   document.getElementById("fphm").value="";
   document.getElementById("xfsbh").value="";
   $("input[name='fply']").get(0).checked=true;
   var rzyf=$('#rzyf').val();
   var year=rzyf.substring(0,4);
   var mon=parseInt(rzyf.substring(4),10);
   $('#mx_sjq').val(year+"-"+rzyf.substring(4)+"-"+"01");
   $('#mx_sjz').val(year+"-"+rzyf.substring(4)+"-"+getDayNum(year,mon));
}

$('#printdata').click(function(){
	var fileName = "123";
	$('#dcform').attr("action",pdf);
	$('#dcform').attr("method","post");
	$('#dcnr').val(encodeURIComponent($('#dcarea1').html().replace(/>\s*</gi, '><')));
	$('#filename').val(JSON.stringify({filename1: fileName}));
	$('#dcform').submit();
})
</script><div id="popup_overlay" style="position: absolute; z-index: 99998; top: 0px; left: 0px; width: 100%; height: 815px; background-color: rgb(0, 0, 0); opacity: 0.4; background-position: initial initial; background-repeat: initial initial; "></div><div id="popup_container" style="position: fixed; z-index: 99999; padding: 0px; margin: 0px; min-width: 300px; max-width: 300px; top: 0px; left: 0px; "><h1 id="popup_title">提示</h1><div id="popup_content" class="alert"><div id="popup_message">会话失效，请重新登录！</div><div id="popup_panel"><input type="button" value="&nbsp;确定&nbsp;" id="popup_ok" class="bluebtn"></div></div></div></body></html>