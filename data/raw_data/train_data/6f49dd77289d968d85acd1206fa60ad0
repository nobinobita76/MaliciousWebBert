<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
 <head id="Head">
  <title>
	 2010年9月17日 随笔档案 - 庄周梦蝶 - BlogJava
</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta id="metaKeywords" name="keywords" content="killme2008  编程 技术 java erlang clojure ruby 程序 程序员 代码" />
  <link type="text/css" rel="stylesheet" href="/css/common.css" />
  <link id="MainCss" type="text/css" rel="stylesheet" href="http://www.blogjava.net/Skins/KJC/style.css" />
  <link id="RSSLink" title="RSS" type="application/rss+xml" rel="alternate" href="http://www.blogjava.net/killme2008/rss.aspx" />
 </head> 
 <body> 
  <form name="Form1" method="post" action="17.html" id="Form1"> 
   <input type="hidden" name="__VIEWSTATE" id="
__VIEWSTATE" value="" />  
   <table class="Framework" cellspacing="0" cellpadding="0" width="100%"> 
    <tbody>
     <tr> 
      <td colspan="3"> 
       <div id="top"> 
        <table cellpadding="10" cellspacing="0"> 
         <tbody>
          <tr> 
           <td nowrap=""> <h1><a id="Header1_HeaderTitle" class="headermaintitle" href="http://www.blogjava.net/killme2008/">庄周梦蝶</a></h1> 生活、程序、未来 </td> 
          </tr> 
         </tbody>
        </table> 
       </div> 
       <div id="sub"> 
        <div id="sub-right"></div> &nbsp; &nbsp;:: 
        <a id="Header1_MyLinks1_MyHomeLink" href="http://www.blogjava.net/killme2008/">首页</a>&nbsp;:: &nbsp;:: &nbsp;:: 
        <a id="Header1_MyLinks1_Syndication" href="http://www.blogjava.net/killme2008/rss">聚合</a> 
        <a id="Header1_MyLinks1_XMLLink" class="XMLLink" href="http://www.blogjava.net/killme2008/rss"><img src="http://www.blogjava.net/images/xml.gif" border="0" /></a>&nbsp;:: 
        <a id="Header1_MyLinks1_Admin" href="http://www.blogjava.net/killme2008/admin/EditPosts.aspx">管理</a> 
       </div> </td> 
     </tr> 
     <tr> 
      <td class="LeftCell"> 
       <div id="leftmenu"> 
       </div> </td> 
      <td class="MainCell"> 
       <div id="main"> 
        <p class="date"> <span> <a id="ArchiveDay1_SingleDay_ImageLink" title="Day Archive" href="http://www.blogjava.net/killme2008/archive/2010/09/17.html" style="display:inline-block;">2010年9月17日</a> </span> </p> 
        <div class="post" style="filter:progid:DXImageTransform.Microsoft.Shadow(color='Blue', Direction=135, Strength=32)"> 
         <div class="posthead"> 
          <h2 style="padding-top:4px; padding-bottom:4px;"><a id="ArchiveDay1_SingleDay_DayList_ctl00_TitleUrl" href="http://www.blogjava.net/killme2008/archive/2012/12/10/392701.html">博客搬迁</a></h2> 
         </div> 
         <div class="postbody">
          <br />很久没有更新博客，没想到更新是搬迁公告。这个博客累计的访问量突破百万，是我建立的时候完全没有想过的事情。博客对我来说更多是记录、记忆的地方，我时常因为想不起某个东西，来翻自己的博客，查找旧知，发现新知。阅读很多人的博客，也是我跟踪、学习新知的主要方式。虽然微博兴起，不过博客作为更系统性的记录的地方，不会过时。
          <br />
          <br />非常感谢blogjava提供这么优秀的平台。只是我今年给自己的一个目标是建立自己的博客，因此现在要搬迁，加上其实现在也写的少，其实搬迁不搬迁，意义也不大了。算是一个通告，有兴趣的可以订阅我的新博客，没兴趣的请自行略过，谢谢大家。
          <br />
          <br />新博客地址：
          <a href="http://blog.fnil.net/">http://blog.fnil.net/</a>
          <br />RSS地址：
          <a href="http://blog.fnil.net/index.php/feed">http://blog.fnil.net/index.php/feed</a>
          <br />
          <br />新博客的第一篇记忆是《
          <a href="http://blog.fnil.net/index.php/archives/14">Leiningen教程中文版</a>》，从现在开始，这个博客将不再发布任何新的文章，已有的也不会删除，部分可能会导到我的知识库上去。
          <br />
          <br />最后，祝福blogjava越办越好。
          <br />
         </div> 
         <p class="postfoot"> posted @ <a href="http://www.blogjava.net/killme2008/archive/2012/12/10/392701.html" title="permalink">2012-12-10 01:24</a> dennis 阅读(11166) | <a href="http://www.blogjava.net/killme2008/archive/2012/12/10/392701.html#FeedBack" title="comments, pingbacks, trackbacks">评论 (6)</a> |&nbsp;<a href="http://www.blogjava.net/killme2008/admin/EditPosts.aspx?postid=392701">编辑</a>&nbsp;<a href="http://www.blogjava.net/killme2008/AddToFavorite.aspx?id=392701">收藏</a> </p> 
        </div> 
        <div class="post" style="filter:progid:DXImageTransform.Microsoft.Shadow(color='Blue', Direction=135, Strength=32)"> 
         <div class="posthead"> 
          <h2 style="padding-top:4px; padding-bottom:4px;"><a id="ArchiveDay1_SingleDay_DayList_ctl01_TitleUrl" href="http://www.blogjava.net/killme2008/archive/2012/11/25/391936.html">Another URL Shortener using NodeJS</a></h2> 
         </div> 
         <div class="postbody">
          It's my weekend project――node-shorten: URL Shortener just like t.cn,goo.gl etc.
          <br /> 
          <br /> Is is written in&nbsp;
          <a href="http://nodejs.org/">NodeJS</a>,using 
          <a href="http://expressjs.com/">express.js</a> for MVC framework,and using MySQL for storage and Redis for caching.
          <br /> 
          <br /> A demo online: 
          <a href="http://fnil.me/">http://fnil.me/</a>
          <br /> 
          <br /> The project is at 
          <a href="https://github.com/killme2008/node-shorten">https://github.com/killme2008/node-shorten</a>
          <br /> 
          <br /> Feel free to modify and use it.Have fun.
         </div> 
         <p class="postfoot"> posted @ <a href="http://www.blogjava.net/killme2008/archive/2012/11/25/391936.html" title="permalink">2012-11-25 20:31</a> dennis|&nbsp;<a href="http://www.blogjava.net/killme2008/admin/EditPosts.aspx?postid=391936">编辑</a>&nbsp;<a href="http://www.blogjava.net/killme2008/AddToFavorite.aspx?id=391936">收藏</a> </p> 
        </div> 
        <div class="post" style="filter:progid:DXImageTransform.Microsoft.Shadow(color='Blue', Direction=135, Strength=32)"> 
         <div class="posthead"> 
          <h2 style="padding-top:4px; padding-bottom:4px;"><a id="ArchiveDay1_SingleDay_DayList_ctl02_TitleUrl" href="http://www.blogjava.net/killme2008/archive/2012/09/25/388498.html">Clojure中文专业技术社区</a></h2> 
         </div> 
         <div class="postbody">
          很久没写博客，一是工作忙，二是没有太多的事情可说。
          <br />
          <br />最近在公司大佬的支持下，建立了一个Clojure语言中文方面的博客和问答网站，欢迎任何对Clojure这门基于JVM之上的函数式语言感兴趣的童鞋贡献原创文章或者资料，申请帐号请看
          <a href="http://blog.clojure.cn/?page_id=8">这里</a>。
          <br />
          <br />博客地址： &nbsp;
          <a href="http://blog.clojure.cn/">http://blog.clojure.cn/</a>
          <br />问答网站： &nbsp;
          <a href="http://ask.clojure.cn/" title="http://ask.clojure.cn/">http://ask.clojure.cn/</a>
          <br />
          <br />欢迎转发和注册使用，谢谢。
          <br />
          <br />邮件列表仍然使用google group：
          <a href="https://groups.google.com/group/cn-clojure/">https://groups.google.com/group/cn-clojure/</a>
         </div> 
         <p class="postfoot"> posted @ <a href="http://www.blogjava.net/killme2008/archive/2012/09/25/388498.html" title="permalink">2012-09-25 12:51</a> dennis 阅读(11160) | <a href="http://www.blogjava.net/killme2008/archive/2012/09/25/388498.html#FeedBack" title="comments, pingbacks, trackbacks">评论 (4)</a> |&nbsp;<a href="http://www.blogjava.net/killme2008/admin/EditPosts.aspx?postid=388498">编辑</a>&nbsp;<a href="http://www.blogjava.net/killme2008/AddToFavorite.aspx?id=388498">收藏</a> </p> 
        </div> 
        <div class="post" style="filter:progid:DXImageTransform.Microsoft.Shadow(color='Blue', Direction=135, Strength=32)"> 
         <div class="posthead"> 
          <h2 style="padding-top:4px; padding-bottom:4px;"><a id="ArchiveDay1_SingleDay_DayList_ctl03_TitleUrl" href="http://www.blogjava.net/killme2008/archive/2012/07/18/383354.html">Ring.velocity:render velocity templates for ring in clojure</a></h2> 
         </div> 
         <div class="postbody">
          <h1></h1>
          <span style="color: #333333; font-family: Helvetica, arial, freesans, clean, sans-serif; line-height: 22px; ">Home:&nbsp;</span>
          <a href="https://github.com/killme2008/ring.velocity" style="font-family: Helvetica, arial, freesans, clean, sans-serif; line-height: 22px; ">https://github.com/killme2008/ring.velocity<br /></a>
          <br />
          <p style="margin: 0px 0px 15px; padding: 0px; border: 0px; color: #333333; font-family: Helvetica, arial, freesans, clean, sans-serif; line-height: 22px; ">A Clojure library designed to render velocity template for ring in clojure.<br /></p>
          <h2><a name="usage" href="https://github.com/killme2008/ring.velocity#usage" style="margin: 0px 0px 0px -30px; padding: 0px 0px 0px 30px; border: 0px; color: rgb(65, 131, 196); text-decoration: none; display: block; cursor: pointer; position: absolute; top: 0px; left: 0px; bottom: 0px; "></a>Usage</h2>
          <p style="margin: 0px 0px 15px; padding: 0px; border: 0px; color: #333333; font-family: Helvetica, arial, freesans, clean, sans-serif; line-height: 22px; ">Adds dependency in leiningen project.clj:</p>
          <pre style="margin-top: 15px; margin-bottom: 15px; padding: 6px 10px; border: 1px solid #cccccc; font-size: 13px; font-family: Consolas, 'Liberation Mono', Courier, monospace; background-color: #f8f8f8; line-height: 19px; overflow: auto; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; color: #333333; "><code style="margin: 0px; padding: 0px; border: none; font-size: 12px; font-family: Consolas, 'Liberation Mono', Courier, monospace; background-color: transparent; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; ">  [ring.velocity &quot;0.1.0-SNAPSHOT&quot;] </code></pre>
          <p style="margin: 15px 0px; padding: 0px; border: 0px; color: #333333; font-family: Helvetica, arial, freesans, clean, sans-serif; line-height: 22px; ">Create a directory named&nbsp;<code style="margin: 0px 2px; padding: 0px 5px; border: 1px solid #eaeaea; font-size: 12px; font-family: Consolas, 'Liberation Mono', Courier, monospace; white-space: nowrap; background-color: #f8f8f8; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; ">templates</code>&nbsp;in your project directory to keep all velocity templates.</p>
          <p style="margin: 15px 0px; padding: 0px; border: 0px; color: #333333; font-family: Helvetica, arial, freesans, clean, sans-serif; line-height: 22px; ">Create a template&nbsp;<code style="margin: 0px 2px; padding: 0px 5px; border: 1px solid #eaeaea; font-size: 12px; font-family: Consolas, 'Liberation Mono', Courier, monospace; white-space: nowrap; background-color: #f8f8f8; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; ">templates/test.vm</code>:</p>
          <pre style="margin-top: 15px; margin-bottom: 15px; padding: 6px 10px; border: 1px solid #cccccc; font-size: 13px; font-family: Consolas, 'Liberation Mono', Courier, monospace; background-color: #f8f8f8; line-height: 19px; overflow: auto; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; color: #333333; "><code style="margin: 0px; padding: 0px; border: none; font-size: 12px; font-family: Consolas, 'Liberation Mono', Courier, monospace; background-color: transparent; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; ">  hello,$name,your age is $age. </code></pre>
          <p style="margin: 15px 0px; padding: 0px; border: 0px; color: #333333; font-family: Helvetica, arial, freesans, clean, sans-serif; line-height: 22px; ">Use ring.velocity in your namespace:</p>
          <pre style="margin-top: 15px; margin-bottom: 15px; padding: 6px 10px; border: 1px solid #cccccc; font-size: 13px; font-family: Consolas, 'Liberation Mono', Courier, monospace; background-color: #f8f8f8; line-height: 19px; overflow: auto; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; color: #333333; "><code style="margin: 0px; padding: 0px; border: none; font-size: 12px; font-family: Consolas, 'Liberation Mono', Courier, monospace; background-color: transparent; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; ">  (use '[ring.velocity.core :only [render]]) </code></pre>
          <p style="margin: 15px 0px; padding: 0px; border: 0px; color: #333333; font-family: Helvetica, arial, freesans, clean, sans-serif; line-height: 22px; ">Use&nbsp;<code style="margin: 0px 2px; padding: 0px 5px; border: 1px solid #eaeaea; font-size: 12px; font-family: Consolas, 'Liberation Mono', Courier, monospace; white-space: nowrap; background-color: #f8f8f8; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; ">render</code>&nbsp;function to render template with vars:</p>
          <pre style="margin-top: 15px; margin-bottom: 15px; padding: 6px 10px; border: 1px solid #cccccc; font-size: 13px; font-family: Consolas, 'Liberation Mono', Courier, monospace; background-color: #f8f8f8; line-height: 19px; overflow: auto; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; color: #333333; "><code style="margin: 0px; padding: 0px; border: none; font-size: 12px; font-family: Consolas, 'Liberation Mono', Courier, monospace; background-color: transparent; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; ">  (render &quot;test.vm&quot; :name &quot;dennis&quot; :age 29) </code></pre>
          <p style="margin: 15px 0px; padding: 0px; border: 0px; color: #333333; font-family: Helvetica, arial, freesans, clean, sans-serif; line-height: 22px; ">The&nbsp;<code style="margin: 0px 2px; padding: 0px 5px; border: 1px solid #eaeaea; font-size: 12px; font-family: Consolas, 'Liberation Mono', Courier, monospace; white-space: nowrap; background-color: #f8f8f8; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; ">test.vm</code>&nbsp;will be interpreted equals to:</p>
          <pre style="margin-top: 15px; margin-bottom: 15px; padding: 6px 10px; border: 1px solid #cccccc; font-size: 13px; font-family: Consolas, 'Liberation Mono', Courier, monospace; background-color: #f8f8f8; line-height: 19px; overflow: auto; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; color: #333333; "><code style="margin: 0px; padding: 0px; border: none; font-size: 12px; font-family: Consolas, 'Liberation Mono', Courier, monospace; background-color: transparent; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; ">  hello,dennis,your age is 29. </code></pre>
          <p style="margin: 15px 0px; padding: 0px; border: 0px; color: #333333; font-family: Helvetica, arial, freesans, clean, sans-serif; line-height: 22px; ">Use ring.velocity in <a href="https://github.com/weavejester/compojure/">compojure</a>:</p>
          <pre style="margin-top: 15px; margin-bottom: 15px; padding: 6px 10px; border: 1px solid #cccccc; font-size: 13px; font-family: Consolas, 'Liberation Mono', Courier, monospace; background-color: #f8f8f8; line-height: 19px; overflow: auto; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; color: #333333; "><code style="margin: 0px; padding: 0px; border: none; font-size: 12px; font-family: Consolas, 'Liberation Mono', Courier, monospace; background-color: transparent; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; ">  (defroutes app-routes      <br />    (GET &quot;/&quot; [] (render &quot;test.vm&quot; :name &quot;dennis&quot; :age 29))   <br />    (route/not-found &quot;Not Found&quot;)) </code></pre>
          <p style="margin: 15px 0px; padding: 0px; border: 0px; color: #333333; font-family: Helvetica, arial, freesans, clean, sans-serif; line-height: 22px; ">Use ring.velocity in <a href="https://github.com/ring-clojure/ring">ring</a>:</p>
          <pre style="margin-top: 15px; margin-bottom: 15px; padding: 6px 10px; border: 1px solid #cccccc; font-size: 13px; font-family: Consolas, 'Liberation Mono', Courier, monospace; background-color: #f8f8f8; line-height: 19px; overflow: auto; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; color: #333333; "><code style="margin: 0px; padding: 0px; border: none; font-size: 12px; font-family: Consolas, 'Liberation Mono', Courier, monospace; background-color: transparent; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; ">  (use '[ring.util.response])   <br />  (response (render &quot;test.vm&quot; :name &quot;dennis&quot; :age 29)) </code></pre>
          <p style="margin: 15px 0px; padding: 0px; border: 0px; color: #333333; font-family: Helvetica, arial, freesans, clean, sans-serif; line-height: 22px; ">Custom velocity properties,just put a file named&nbsp;<code style="margin: 0px 2px; padding: 0px 5px; border: 1px solid #eaeaea; font-size: 12px; font-family: Consolas, 'Liberation Mono', Courier, monospace; white-space: nowrap; background-color: #f8f8f8; border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; ">ring-velocity.properties</code>&nbsp;to your classpath or resource paths.The default velocity properties is in&nbsp;<a href="https://github.com/killme2008/ring.velocity/blob/master/src/default/velocity.properties" style="margin: 0px; padding: 0px; border: 0px; color: #4183c4; text-decoration: none; ">src/default/velocity.properties</a>.</p>
          <h2><a name="license" href="https://github.com/killme2008/ring.velocity#license" style="margin: 0px 0px 0px -30px; padding: 0px 0px 0px 30px; border: 0px; color: rgb(65, 131, 196); text-decoration: none; display: block; cursor: pointer; position: absolute; top: 0px; left: 0px; bottom: 0px; "></a>License</h2>
          <p style="margin: 0px 0px 15px; padding: 0px; border: 0px; color: #333333; font-family: Helvetica, arial, freesans, clean, sans-serif; line-height: 22px; ">Copyright &copy; 2012 dennis zhuang[killme2008@gmail.com]</p>
          <p style="margin-top: 15px; margin-right: 0px; margin-bottom: 0px !important; margin-left: 0px; padding: 0px; border: 0px; color: #333333; font-family: Helvetica, arial, freesans, clean, sans-serif; line-height: 22px; ">Distributed under the Eclipse Public License, the same as Clojure.<br /><br />Home:&nbsp;<a href="https://github.com/killme2008/ring.velocity">https://github.com/killme2008/ring.velocity</a></p>
         </div> 
         <p class="postfoot"> posted @ <a href="http://www.blogjava.net/killme2008/archive/2012/07/18/383354.html" title="permalink">2012-07-18 00:07</a> dennis 阅读(9058) | <a href="http://www.blogjava.net/killme2008/archive/2012/07/18/383354.html#FeedBack" title="comments, pingbacks, trackbacks">评论 (0)</a> |&nbsp;<a href="http://www.blogjava.net/killme2008/admin/EditPosts.aspx?postid=383354">编辑</a>&nbsp;<a href="http://www.blogjava.net/killme2008/AddToFavorite.aspx?id=383354">收藏</a> </p> 
        </div> 
        <div class="post" style="filter:progid:DXImageTransform.Microsoft.Shadow(color='Blue', Direction=135, Strength=32)"> 
         <div class="posthead"> 
          <h2 style="padding-top:4px; padding-bottom:4px;"><a id="ArchiveDay1_SingleDay_DayList_ctl04_TitleUrl" href="http://www.blogjava.net/killme2008/archive/2012/07/10/382738.html">Clojure笔记：用好type hint</a></h2> 
         </div> 
         <div class="postbody">
          <br /> &nbsp; &nbsp; Clojure的一大优点就是跟Java语言的完美配合，Clojure和Java之间可以相互调用，Clojure可以天然地使用Java平台上的丰富资源。在Clojure里调用一个类的方法很简单，利用dot操作符：
          <br /> 
          <br /> 
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br />
<br />
Code highlighting produced by Actipro CodeHighlighter (freeware)<br />
http://www.CodeHighlighter.com/<br />
<br />
-->user=&gt;&nbsp;(.substring&nbsp;&quot;hello&quot;&nbsp;3)
           <br /> &quot;lo&quot;
           <br /> user=&gt;&nbsp;(.substring&nbsp;&quot;hello&quot;&nbsp;0&nbsp;3)
           <br /> &quot;hel&quot;
          </div> 
          <br /> &nbsp; &nbsp; 上面的例子是在clojure里调用String的substring方法做字符串截取。Clojure虽然是一门弱类型的语言，但是它的Lisp Reader还是能识别大多数常见的类型，比如这里hello是一个字符串就可以识别出来,3是一个整数也可以，通过这些类型信息可以找到最匹配的substring方法，在生成字节码的时候避免使用反射，而是直接调用substring方法（INVOKEVIRTUAL指令）。
          <br /> 
          <br /> &nbsp; &nbsp; 但是当你在函数里调用类方法的时候，情况就变了，例如，定义substr函数：
          <br /> 
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br />
<br />
Code highlighting produced by Actipro CodeHighlighter (freeware)<br />
http://www.CodeHighlighter.com/<br />
<br />
-->(defn&nbsp;substr&nbsp;[s&nbsp;begin&nbsp;end]&nbsp;(.substring&nbsp;s&nbsp;begin&nbsp;end))
          </div> 
          <br /> &nbsp; &nbsp; 我们打开*warn-on-reflection*选项，当有反射的时候告警：
          <br /> 
          <br /> 
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br />
<br />
Code highlighting produced by Actipro CodeHighlighter (freeware)<br />
http://www.CodeHighlighter.com/<br />
<br />
-->user=&gt;&nbsp;(set!&nbsp;*warn-on-reflection*&nbsp;
           <span style="color: #0000FF; ">true</span>)
           <br /> 
           <span style="color: #0000FF; ">true</span>
           <br /> user=&gt;&nbsp;(defn&nbsp;substr&nbsp;[s&nbsp;begin&nbsp;end]&nbsp;(.substring&nbsp;s&nbsp;begin&nbsp;end))
           <br /> 
           <strong>Reflection&nbsp;warning,&nbsp;NO_SOURCE_PATH:22&nbsp;-&nbsp;call&nbsp;to&nbsp;substring&nbsp;can't&nbsp;be&nbsp;resolved.</strong>
           <br /> #'user/substr
          </div> &nbsp; &nbsp; 
          <br /> &nbsp; &nbsp; 问题出现了，由于函数substr里没有任何关于参数s的类型信息，为了调用s的substring方法，必须使用反射来调用，clojure编译器也警告我们调用substring没办法解析，只能通过反射调用。众所周知，反射调用是个相对昂贵的操作（对比于普通的方法调用有）。这一切都是因为clojure本身是弱类型的语言，对参数或者返回值你不需要声明类型而直接使用,Clojure会自动处理类型的转换和调用。ps.在
          <a href="https://github.com/technomancy/leiningen">leiningen</a>里启用反射警告很简单，在project.clj里设置：
          <br />
          <br /> 
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->;;&nbsp;Emit&nbsp;warnings&nbsp;on&nbsp;all&nbsp;reflection&nbsp;calls.
           <br />&nbsp;&nbsp;:warn-on-reflection&nbsp;
           <span style="color: #0000FF; ">true</span>
          </div> &nbsp; &nbsp; 
          <br />过多的反射调用会影响效率，有没有办法避免这种情况呢？有的，Clojure提供了type hint机制，允许我们帮助编译器来生成更高效的字节码。所谓type hint就是给参数或者返回值添加一个提示：hi,clojure编译器，这是xxx类型，我想调用它的yyy方法，请生成最高效的调用代码，谢谢合作：
          <br /> 
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br />
<br />
Code highlighting produced by Actipro CodeHighlighter (freeware)<br />
http://www.CodeHighlighter.com/<br />
<br />
-->user=&gt;&nbsp;(defn&nbsp;substr&nbsp;[
           <strong>^String</strong>&nbsp;s&nbsp;begin&nbsp;end]&nbsp;(.substring&nbsp;s&nbsp;begin&nbsp;end))
           <br /> #'user/substr
          </div> &nbsp; &nbsp; &nbsp;
          <br /> &nbsp; &nbsp; 这次没有警告，^String就是参数s的type hint，提示clojure编译器说s的类型是字符串，那么clojure编译器会从java.lang.String类里查找
          <strong>名称为substring并且接收两个参数的方法</strong>，并利用invokevirtual指令直接调用此方法，避免了反射调用。除了target对象（这里的s)可以添加type hint，方法参数和返回值也可以添加type hint：
          <br /> 
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br />
<br />
Code highlighting produced by Actipro CodeHighlighter (freeware)<br />
http://www.CodeHighlighter.com/<br />
<br />
-->user=&gt;&nbsp;(defn&nbsp;
           <strong>^{:tag&nbsp;String}</strong>&nbsp;substr&nbsp;[
           <strong>^String</strong>&nbsp;s&nbsp;
           <strong>^Integer</strong>&nbsp;begin
           <strong>&nbsp;^Integer</strong>&nbsp;end]&nbsp;(.substring&nbsp;s&nbsp;begin&nbsp;end))
           <br /> #'user/substr
          </div> &nbsp; &nbsp;&nbsp;
          <br /> &nbsp; &nbsp; 返回值添加type hint是利用tag元数据，提示substr的返回类型是String，其他函数在使用substr的时候可以利用这个类型信息来避免反射；而参数的type hint跟target object的type hint一样以^开头加上类型，例如这里begin和end都提示说是Integer类型。
          <br /> 
          <br /> &nbsp; &nbsp; 
          <strong>问题1，什么时候应该为参数添加type hint呢？我的观点是，在任何为target object添加type hint的地方，都应该相应地为参数添加type hint，除非你事先不知道参数的类型。</strong>为什么呢？因为clojure查找类方法的顺序是这样：
          <br /> 
          <br /> 1.从String类里查找出所有参数个数为2并且名称为substring方法
          <br /> 2.遍历第一步里查找出来的Method，如果你有设置参数的type hint,则 
          <div style="display: inline-block; "></div> 查找最匹配参数类型的Method；否则，如果第一步查找出来的Method就一个，直接使用这个Method，相反就认为没有找到对应的Method。
          <br /> 3.如果第二步没有找到Method，使用反射调用；否则根据该Method元信息生成调用字节码。
          <br /> 
          <br /> &nbsp; &nbsp;因此，如果substring方法的两个参数版本刚好就一个，方法参数有没有type hint都没有关系（有了错误的type hint反而促使反射的发生），我们都会找到这个唯一的方法；但是如果目标方法的有多个重载方法并且参数相同，而只是参数类型不同（Java里是允许方法的参数类型重载的，Clojure只允许函数的参数个数重载），那么如果没有方法参数的type hint，Clojure编译器仍然无法找到合适的调用方法，而只能通过反射。
          <br /> &nbsp; &nbsp;
          <br /> &nbsp; &nbsp;看一个例子,定义get-bytes方法调用String.getBytes：
          <br /> 
          <br /> 
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br />
<br />
Code highlighting produced by Actipro CodeHighlighter (freeware)<br />
http://www.CodeHighlighter.com/<br />
<br />
-->user=&gt;&nbsp;(defn&nbsp;get-bytes&nbsp;[s&nbsp;charset]&nbsp;(.getBytes&nbsp;s&nbsp;charset))
           <br /> 
           <strong>Reflection&nbsp;warning,&nbsp;NO_SOURCE_PATH:26&nbsp;-&nbsp;call&nbsp;to&nbsp;getBytes&nbsp;can't&nbsp;be&nbsp;resolved</strong>.
           <br /> #'user/get-bytes
           <br /> user=&gt;&nbsp;(defn&nbsp;get-bytes&nbsp;[
           <strong>^String</strong>&nbsp;s&nbsp;charset]&nbsp;(.getBytes&nbsp;s&nbsp;charset))
           <br /> 
           <strong>Reflection&nbsp;warning,&nbsp;NO_SOURCE_PATH:27&nbsp;-&nbsp;call&nbsp;to&nbsp;getBytes&nbsp;can't&nbsp;be&nbsp;resolved.</strong>
           <br /> #'user/get-bytes
          </div> 
          <br /> &nbsp; &nbsp; 第一次定义，s和charset都没有设置type hint，有反射警告；第二次，s设置了type hint，但是还是有反射警告。原因就在于String.getBytes有两个重载方法，参数个数都是一个，但是接收不同的参数类型，一个是String的charset名称，一个Charset对象。如果我们明确地知道这里charset是字符串，那么还可以为charset添加type hint:
          <br /> 
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br />
<br />
Code highlighting produced by Actipro CodeHighlighter (freeware)<br />
http://www.CodeHighlighter.com/<br />
<br />
-->user=&gt;&nbsp;(defn&nbsp;get-bytes&nbsp;[
           <strong>^String</strong>&nbsp;s&nbsp;
           <strong>^String</strong>&nbsp;charset]&nbsp;(.getBytes&nbsp;s&nbsp;charset))
           <br /> #'user/get-bytes
          </div> &nbsp; &nbsp;
          <br /> &nbsp; &nbsp; 这次才真正的没有警告了。总结：在设置type hint的时候，不要只考虑被调用的target object，也要考虑调用的方法参数。
          <br /> 
          <br /> &nbsp; &nbsp; 问题2：什么时候应该添加tag元数据呢？理论上，在任何你明确知道返回类型的地方都应该添加tag，但是这不是教条，如果一个偶尔被调用的方法是无需这样做的。这一点只对写库的童鞋要特别注意。
          <br /> 
          <br /> &nbsp; &nbsp; Type hint的原理在上文已经大概描述了下，具体到clojure源码级别，请参考clojure.lang.Compiler.InstanceMethodExpr类的构造函数和emit方法。最后，附送是否使用type hint生成substr函数的字节码之间的差异对比：
          <br /> 
          <table border="1" cellspacing="2" cellpadding="2" width="500"> 
           <tbody> 
            <tr> 
             <td>未使用type hint</td> 
             <td>使用type hint</td> 
            </tr> 
            <tr> 
             <td> <p>&nbsp; // access flags 1</p> <p>&nbsp; public invoke(Ljava/lang/Object;Ljava/lang/Object;Ljava/lang/Object;)Ljava/lang/Object;</p> <p>&nbsp;&nbsp; L0</p> <p>&nbsp; &nbsp; LINENUMBER 14 L0</p> <p>&nbsp;&nbsp; L1</p> <p>&nbsp; &nbsp; LINENUMBER 14 L1</p> <p>&nbsp; &nbsp; ALOAD 1</p> <p>&nbsp; &nbsp; ACONST_NULL</p> <p>&nbsp; &nbsp; ASTORE 1</p> <p>&nbsp; &nbsp; LDC &quot;substring&quot;</p> <p>&nbsp; &nbsp; ICONST_2</p> <p>&nbsp; &nbsp; ANEWARRAY java/lang/Object</p> <p>&nbsp; &nbsp; DUP</p> <p>&nbsp; &nbsp; ICONST_0</p> <p>&nbsp; &nbsp; ALOAD 2</p> <p>&nbsp; &nbsp; ACONST_NULL</p> <p>&nbsp; &nbsp; ASTORE 2</p> <p>&nbsp; &nbsp; AASTORE</p> <p>&nbsp; &nbsp; DUP</p> <p>&nbsp; &nbsp; ICONST_1</p> <p>&nbsp; &nbsp; ALOAD 3</p> <p>&nbsp; &nbsp; ACONST_NULL</p> <p>&nbsp; &nbsp; ASTORE 3</p> <p>&nbsp; &nbsp; AASTORE</p> <p>&nbsp; &nbsp; <strong>INVOKESTATIC clojure/lang/Reflector.invokeInstanceMethod (Ljava/lang/Object;Ljava/lang/String;[Ljava/lang/Object;)Ljava/lang/Object;</strong></p> <p>&nbsp;&nbsp; L2</p> <p>&nbsp; &nbsp; LOCALVARIABLE this Ljava/lang/Object; L0 L2 0</p> <p>&nbsp; &nbsp; LOCALVARIABLE s Ljava/lang/Object; L0 L2 1</p> <p>&nbsp; &nbsp; LOCALVARIABLE begin Ljava/lang/Object; L0 L2 2</p> <p>&nbsp; &nbsp; LOCALVARIABLE end Ljava/lang/Object; L0 L2 3</p> <p>&nbsp; &nbsp; ARETURN</p> <p>&nbsp; &nbsp; MAXSTACK = 0</p> <p>&nbsp; &nbsp; MAXLOCALS = 0</p> </td> 
             <td> <p>public invoke(Ljava/lang/Object;Ljava/lang/Object;Ljava/lang/Object;)Ljava/lang/Object;</p> <p>&nbsp;&nbsp; L0</p> <p>&nbsp; &nbsp; LINENUMBER 15 L0</p> <p>&nbsp;&nbsp; L1</p> <p>&nbsp; &nbsp; LINENUMBER 15 L1</p> <p>&nbsp; &nbsp; ALOAD 1</p> <p>&nbsp; &nbsp; ACONST_NULL</p> <p>&nbsp; &nbsp; ASTORE 1</p> <p>&nbsp; &nbsp; CHECKCAST java/lang/String</p> <p>&nbsp; &nbsp; ALOAD 2</p> <p>&nbsp; &nbsp; ACONST_NULL</p> <p>&nbsp; &nbsp; ASTORE 2</p> <p>&nbsp; &nbsp; CHECKCAST java/lang/Number</p> <p>&nbsp; &nbsp; INVOKESTATIC clojure/lang/RT.intCast (Ljava/lang/Object;)I</p> <p>&nbsp; &nbsp; ALOAD 3</p> <p>&nbsp; &nbsp; ACONST_NULL</p> <p>&nbsp; &nbsp; ASTORE 3</p> <p>&nbsp; &nbsp; CHECKCAST java/lang/Number</p> <p>&nbsp; &nbsp; INVOKESTATIC clojure/lang/RT.intCast (Ljava/lang/Object;)I</p> <p>&nbsp; &nbsp; <strong>INVOKEVIRTUAL java/lang/String.substring (II)Ljava/lang/String;</strong></p> <p>&nbsp;&nbsp; L2</p> <p>&nbsp; &nbsp; LOCALVARIABLE this Ljava/lang/Object; L0 L2 0</p> <p>&nbsp; &nbsp; LOCALVARIABLE s Ljava/lang/Object; L0 L2 1</p> <p>&nbsp; &nbsp; LOCALVARIABLE begin Ljava/lang/Object; L0 L2 2</p> <p>&nbsp; &nbsp; LOCALVARIABLE end Ljava/lang/Object; L0 L2 3</p> <p>&nbsp; &nbsp; ARETURN</p> <p>&nbsp; &nbsp; MAXSTACK = 0</p> <p>&nbsp; &nbsp; MAXLOCALS = 0</p> </td> 
            </tr> 
           </tbody> 
          </table> 
          <br /> &nbsp; &nbsp;&nbsp;
          <br /> &nbsp; &nbsp; 对比很明显，没有使用type hint，调用clojure.lang.Reflector的invokeInstanceMethod方法，使用反射调用（具体见clojure.lang.Reflector.java)，而使用了type hint之后，则直接使用invokevirtual指令（其他方法可能是invokestatic或者invokeinterface等指令）调用该方法，避免了反射。
          <br /> &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;
          <br /> 
          <br /> &nbsp; &nbsp; 参考：
          <br /> 
          <ul> 
           <li><a href="http://clojure.org/java_interop#Java%20Interop-Type%20Hints">Type hint官方指南</a></li> 
           <li><a href="http://docs.oracle.com/javase/specs/jvms/se7/html/jvms-4.html#jvms-4.10.1.4.5.invokevirtual">invokevirtual指令</a></li> 
           <li><a href="https://github.com/clojure/clojure">Clojure源码</a></li> 
          </ul>
         </div> 
         <p class="postfoot"> posted @ <a href="http://www.blogjava.net/killme2008/archive/2012/07/10/382738.html" title="permalink">2012-07-10 20:37</a> dennis 阅读(10999) | <a href="http://www.blogjava.net/killme2008/archive/2012/07/10/382738.html#FeedBack" title="comments, pingbacks, trackbacks">评论 (1)</a> |&nbsp;<a href="http://www.blogjava.net/killme2008/admin/EditPosts.aspx?postid=382738">编辑</a>&nbsp;<a href="http://www.blogjava.net/killme2008/AddToFavorite.aspx?id=382738">收藏</a> </p> 
        </div> 
        <div class="post" style="filter:progid:DXImageTransform.Microsoft.Shadow(color='Blue', Direction=135, Strength=32)"> 
         <div class="posthead"> 
          <h2 style="padding-top:4px; padding-bottom:4px;"><a id="ArchiveDay1_SingleDay_DayList_ctl05_TitleUrl" href="http://www.blogjava.net/killme2008/archive/2012/06/15/380822.html">Clojure世界：利用HouseMD诊断clojure</a></h2> 
         </div> 
         <div class="postbody">
          <br /> &nbsp; &nbsp; 
          <a href="https://github.com/zhongl/HouseMD">HouseMD</a>是淘宝的聚石写的一个非常优秀的Java进程运行时诊断和调试工具，如果你接触过btrace，那么HouseMD也许你应该尝试下，它比btrace更易用，不需要写脚本，类似strace的方式attach到jvm进程做跟踪调试。
          <br /> 
          <br /> &nbsp; &nbsp; 基本的安装和使用请看这篇文档《
          <a href="https://github.com/zhongl/HouseMD/wiki/UserGuideCN">UserGuide</a>》，恕不重复。以下内容都假设你正确安装了housemd。
          <br /> 
          <br /> &nbsp; &nbsp; 本文主要介绍下怎么用housemd诊断跟踪clojure进程。Clojure的java实现也是跑在JVM里，当然也可以用housemd。
          <br />
          <br /> &nbsp; &nbsp; 我们以一个简单的例子开始，假设我们有如下clojure代码：
          <br /> 
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br />
<br />
Code highlighting produced by Actipro CodeHighlighter (freeware)<br />
http://www.CodeHighlighter.com/<br />
<br />
-->(loop&nbsp;[x&nbsp;1]
           <br /> &nbsp;&nbsp;(Thread/sleep&nbsp;1000)
           <br /> &nbsp;&nbsp;(prn&nbsp;x)
           <br /> &nbsp;&nbsp;(recur (inc x)))
          </div> 
          <br /> &nbsp; &nbsp; 这段很简单，只是间隔一秒不断地打印递增的数字x。我们准备用housemd跟踪这个程序的运行，首先运行这个程序，你可以用lein，也可以直接java命令运行：
          <br /> 
          <div style="font-size: 13px; border: 1px solid #cccccc; padding: 4px 5px 4px 4px; width: 98%; word-break: break-all; background-color: #eeeeee; ">
           <!--<br />
<br />
Code highlighting produced by Actipro CodeHighlighter (freeware)<br />
http://www.CodeHighlighter.com/<br />
-->java&nbsp;-cp&nbsp;clojure.jar&nbsp;clojure.main&nbsp;test.clj
          </div> 
          <br /> &nbsp; &nbsp; 运行时不断地在控制台打印数字，通过jps或者ps查询到该进程的id，假设为pid，使用housemd连接到该进程：
          <br /> 
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br />
<br />
Code highlighting produced by Actipro CodeHighlighter (freeware)<br />
http://www.CodeHighlighter.com/<br />
-->housemd&nbsp;&lt;pid&gt;
          </div> &nbsp; &nbsp; 顺利进入housemd的交互控制台，通过help命令可以查询支持的命令：
          <br /> 
          <br /> 
          <div style="font-size: 13px; border: 1px solid #cccccc; padding: 4px 5px 4px 4px; width: 98%; word-break: break-all; background-color: #eeeeee; ">
           <!--<br />
<br />
Code highlighting produced by Actipro CodeHighlighter (freeware)<br />
http://www.CodeHighlighter.com/<br />
<br />
-->housemd&gt;&nbsp;help
           <br /> 
           <br /> quit&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;terminate&nbsp;the&nbsp;process.
           <br /> help&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;display&nbsp;
           <span style="color: #0000FF; ">this</span>&nbsp;infomation.
           <br /> trace&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;display&nbsp;or&nbsp;output&nbsp;infomation&nbsp;of&nbsp;method&nbsp;invocaton.
           <br /> loaded&nbsp;&nbsp;&nbsp;&nbsp;display&nbsp;loaded&nbsp;classes&nbsp;information.
          </div> 
          <br /> &nbsp; &nbsp; 要用housemd调试clojure，你需要对clojure的实现有一点点了解，有兴趣可以看过去的一篇blog《
          <a href="http://www.blogjava.net/killme2008/archive/2010/07/11/325775.html">clojure hacking guide</a>》，简单来说，clojure的编译器会将clojure代码编译成java类并运行。对于JVM来说，clojure生成的类，跟java编译器生成类没有什么不同。
          <br /> &nbsp; &nbsp; 具体到上面的clojure代码，会生成一个名为
          <strong>user$eval1</strong>的类，user是默认的namespace，而eval1是clojure编译器自动生成的一个标示类名，通过
          <strong>loaded</strong>命令查询类的加载情况：
          <br /> 
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br />
<br />
Code highlighting produced by Actipro CodeHighlighter (freeware)<br />
http://www.CodeHighlighter.com/<br />
<br />
-->housemd&gt;&nbsp;loaded&nbsp;user$eval1&nbsp;-h
           <br /> user$eval1&nbsp;-&gt;&nbsp;
           <span style="color: #0000FF; ">null</span>
           <br /> &nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;clojure.lang.DynamicClassLoader@1d25d06e
           <br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;clojure.lang.DynamicClassLoader@1d96f4b5
           <br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;sun.misc.Launcher$AppClassLoader@a6eb38a
           <br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;sun.misc.Launcher$ExtClassLoader@69cd2e5f
          </div> 
          <br /> &nbsp; &nbsp; 通过-h选项打印了加载user$eval1的类加载器的层次关系，因为user$eval1是动态生成的（clojure启动过程中），因此它不在任何一个class或者jar文件中。除了查询user namespace的类之外，你还可以查询clojure.core,clojure.lang,clojure.java等任何被加载进来的类，例如查询clojure.core.prn的类,在clojure里这是一个函数，在jvm看来这只是一个类：
          <br />
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->housemd&gt;&nbsp;loaded&nbsp;-h&nbsp;core$prn
           <br />clojure.core$prn&nbsp;-&gt;&nbsp;/Volumes/HDD/Users/apple/clojure/clojure.jar
           <br />&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;sun.misc.Launcher$AppClassLoader@a6eb38a
           <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;sun.misc.Launcher$ExtClassLoader@69cd2e5f
          </div>&nbsp; &nbsp;注意，不需要完整的namespace――clojure.core，直接core$prn即可。其他也是类似。
          <strong>小技巧：如果你实在不知道clojure编译器生成的类名，你可以利用jvm自带的jmap命令来查询。</strong>
          <br />
          <br />&nbsp; &nbsp;接下来，我们尝试用trace命令跟踪方法的运行，例如例子中的clojure代码用到了loop和recur两个sepcial form，我们跟踪下loop:
          <br />
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->housemd&gt;&nbsp;trace&nbsp;-t&nbsp;5&nbsp;core$loop
           <br />INFO&nbsp;:&nbsp;probe&nbsp;
           <span style="color: #0000FF; ">class</span>&nbsp;clojure.core$loop
           <br />core$loop.doInvoke(Object,&nbsp;Object,&nbsp;Object,&nbsp;Object)&nbsp;&nbsp;&nbsp;&nbsp;sun.misc.Launcher$AppClassLoader@a6eb38a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-ms&nbsp;&nbsp;&nbsp;&nbsp;
           <span style="color: #0000FF; ">null</span>
           <br />core$loop.getRequiredArity()&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sun.misc.Launcher$AppClassLoader@a6eb38a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-ms&nbsp;&nbsp;&nbsp;&nbsp;
           <span style="color: #0000FF; ">null</span>
           <br />
           <br />core$loop.doInvoke(Object,&nbsp;Object,&nbsp;Object,&nbsp;Object)&nbsp;&nbsp;&nbsp;&nbsp;sun.misc.Launcher$AppClassLoader@a6eb38a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-ms&nbsp;&nbsp;&nbsp;&nbsp;
           <span style="color: #0000FF; ">null</span>
           <br />core$loop.getRequiredArity()&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sun.misc.Launcher$AppClassLoader@a6eb38a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-ms&nbsp;&nbsp;&nbsp;&nbsp;
           <span style="color: #0000FF; ">null</span>
           <br />
           <br />core$loop.doInvoke(Object,&nbsp;Object,&nbsp;Object,&nbsp;Object)&nbsp;&nbsp;&nbsp;&nbsp;sun.misc.Launcher$AppClassLoader@a6eb38a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-ms&nbsp;&nbsp;&nbsp;&nbsp;
           <span style="color: #0000FF; ">null</span>
           <br />core$loop.getRequiredArity()&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sun.misc.Launcher$AppClassLoader@a6eb38a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-ms&nbsp;&nbsp;&nbsp;&nbsp;
           <span style="color: #0000FF; ">null</span>
           <br />
           <br />core$loop.doInvoke(Object,&nbsp;Object,&nbsp;Object,&nbsp;Object)&nbsp;&nbsp;&nbsp;&nbsp;sun.misc.Launcher$AppClassLoader@a6eb38a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-ms&nbsp;&nbsp;&nbsp;&nbsp;
           <span style="color: #0000FF; ">null</span>
           <br />core$loop.getRequiredArity()&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sun.misc.Launcher$AppClassLoader@a6eb38a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-ms&nbsp;&nbsp;&nbsp;&nbsp;
           <span style="color: #0000FF; ">null</span>
           <br />
           <br />core$loop.doInvoke(Object,&nbsp;Object,&nbsp;Object,&nbsp;Object)&nbsp;&nbsp;&nbsp;&nbsp;sun.misc.Launcher$AppClassLoader@a6eb38a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-ms&nbsp;&nbsp;&nbsp;&nbsp;
           <span style="color: #0000FF; ">null</span>
           <br />core$loop.getRequiredArity()&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sun.misc.Launcher$AppClassLoader@a6eb38a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-ms&nbsp;&nbsp;&nbsp;&nbsp;
           <span style="color: #0000FF; ">null</span>
           <br />
           <br />INFO&nbsp;:&nbsp;Ended&nbsp;by&nbsp;timeout
           <br />INFO&nbsp;:&nbsp;reset&nbsp;
           <span style="color: #0000FF; ">class</span>&nbsp;clojure.core$loop
          </div>
          <br />&nbsp; &nbsp; 在5秒内，clojure.core$loop类有两个方法各被调用了5次，doInvoke是实际的调用，而getRequiredArity用来查询loop所需要的参数个数。trace还可以跟踪到具体的方法，例如我们跟踪prn函数的调用情况：
          <br />
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->housemd&gt;&nbsp;trace&nbsp;-t&nbsp;5&nbsp;core$prn.
           <strong>doInvoke</strong>
           <br />INFO&nbsp;:&nbsp;probe&nbsp;
           <span style="color: #0000FF; ">class</span>&nbsp;clojure.core$prn
           <br />core$prn.doInvoke(Object)&nbsp;&nbsp;&nbsp;&nbsp;sun.misc.Launcher$AppClassLoader@a6eb38a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1ms&nbsp;&nbsp;&nbsp;&nbsp;clojure.core$prn@3e4ac866
           <br />
           <br />core$prn.doInvoke(Object)&nbsp;&nbsp;&nbsp;&nbsp;sun.misc.Launcher$AppClassLoader@a6eb38a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;1ms&nbsp;&nbsp;&nbsp;&nbsp;clojure.core$prn@3e4ac866
           <br />
           <br />core$prn.doInvoke(Object)&nbsp;&nbsp;&nbsp;&nbsp;sun.misc.Launcher$AppClassLoader@a6eb38a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;1ms&nbsp;&nbsp;&nbsp;&nbsp;clojure.core$prn@3e4ac866
           <br />
           <br />core$prn.doInvoke(Object)&nbsp;&nbsp;&nbsp;&nbsp;sun.misc.Launcher$AppClassLoader@a6eb38a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;1ms&nbsp;&nbsp;&nbsp;&nbsp;clojure.core$prn@3e4ac866
           <br />
           <br />core$prn.doInvoke(Object)&nbsp;&nbsp;&nbsp;&nbsp;sun.misc.Launcher$AppClassLoader@a6eb38a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;5&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;1ms&nbsp;&nbsp;&nbsp;&nbsp;clojure.core$prn@3e4ac866
           <br />
           <br />INFO&nbsp;:&nbsp;Ended&nbsp;by&nbsp;timeout
           <br />INFO&nbsp;:&nbsp;reset&nbsp;
           <span style="color: #0000FF; ">class</span>&nbsp;clojure.core$prn
          </div>&nbsp;&nbsp;
          <br />&nbsp; &nbsp;trace打印了方法的调用次数（5秒内）和每次调用的时间（毫秒级别），以及调用的target object
          <strong>。小技巧：没有可变参数的函数生成类最终调用的是invoke方法（参数个数可能重载），有可变参数的函数调用的是doInvoke方法。<br /><br /></strong>&nbsp; &nbsp;trace命令还支持打印调用堆栈到文件，例如：
          <br />
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->trace&nbsp;-t&nbsp;5&nbsp;-d&nbsp;-s&nbsp;&nbsp;core$prn.doInvoke
          </div>
          <br />&nbsp; &nbsp;利用-s和-d命令会将详细的调用信息输出到临时目录，临时目录的路径可以通过trace help命令查询到，在我的机器上是/tmp/trace/&lt;pid&gt;@host目录下。调用堆栈的输出类似：
          <br />
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->example$square.invoke(Long)&nbsp;call&nbsp;by&nbsp;thread&nbsp;[main]
           <br />&nbsp;&nbsp;&nbsp;&nbsp;example$eval9.invoke(test.clj:11)
           <br />&nbsp;&nbsp;&nbsp;&nbsp;clojure.lang.Compiler.eval(Compiler.java:6465)
           <br />&nbsp;&nbsp;&nbsp;&nbsp;clojure.lang.Compiler.load(Compiler.java:6902)
           <br />&nbsp;&nbsp;&nbsp;&nbsp;clojure.lang.Compiler.loadFile(Compiler.java:6863)
           <br />&nbsp;&nbsp;&nbsp;&nbsp;clojure.main$load_script.invoke(main.clj:282)
           <br />&nbsp;&nbsp;&nbsp;&nbsp;clojure.main$script_opt.invoke(main.clj:342)
           <br />&nbsp;&nbsp;&nbsp;&nbsp;clojure.main$main.doInvoke(main.clj:426)
           <br />&nbsp;&nbsp;&nbsp;&nbsp;clojure.lang.RestFn.invoke(RestFn.java:421)
           <br />&nbsp;&nbsp;&nbsp;&nbsp;clojure.lang.Var.invoke(Var.java:405)
           <br />&nbsp;&nbsp;&nbsp;&nbsp;clojure.lang.AFn.applyToHelper(AFn.java:163)
           <br />&nbsp;&nbsp;&nbsp;&nbsp;clojure.lang.Var.applyTo(Var.java:518)
           <br />&nbsp;&nbsp;&nbsp;&nbsp;clojure.main.main(main.java:37)
          </div>
          <br />&nbsp; &nbsp;上面这个简单的例子展示了使用housemd跟踪诊断clojure进程的方法。
          <br />
          <br />&nbsp; &nbsp;自定义ns和函数的调试与此类似，假设我们有下面的clojure代码：
          <br />
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->(ns&nbsp;example)
           <br />(defn&nbsp;square&nbsp;[x]
           <br />&nbsp;&nbsp;(*&nbsp;x&nbsp;x))
           <br />
           <br />(loop&nbsp;[x&nbsp;1]
           <br />&nbsp;&nbsp;(Thread/sleep&nbsp;1000)
           <br />&nbsp;&nbsp;(square&nbsp;x)
           <br />&nbsp;&nbsp;(recur&nbsp;(inc&nbsp;x)))
          </div>&nbsp;
          <br />&nbsp; &nbsp;ns为example，自定义函数square并定期循环调用。使用housemd诊断这段代码：
          <br />
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->loaded&nbsp;-h&nbsp;example$square&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#查询square的加载情况
           <br />trace&nbsp;-t&nbsp;10 -d -s example$square.invoke&nbsp;&nbsp;#跟踪10秒内square的调用情况
          </div>
         </div> 
         <p class="postfoot"> posted @ <a href="http://www.blogjava.net/killme2008/archive/2012/06/15/380822.html" title="permalink">2012-06-15 02:52</a> dennis 阅读(11290) | <a href="http://www.blogjava.net/killme2008/archive/2012/06/15/380822.html#FeedBack" title="comments, pingbacks, trackbacks">评论 (2)</a> |&nbsp;<a href="http://www.blogjava.net/killme2008/admin/EditPosts.aspx?postid=380822">编辑</a>&nbsp;<a href="http://www.blogjava.net/killme2008/AddToFavorite.aspx?id=380822">收藏</a> </p> 
        </div> 
        <div class="post" style="filter:progid:DXImageTransform.Microsoft.Shadow(color='Blue', Direction=135, Strength=32)"> 
         <div class="posthead"> 
          <h2 style="padding-top:4px; padding-bottom:4px;"><a id="ArchiveDay1_SingleDay_DayList_ctl06_TitleUrl" href="http://www.blogjava.net/killme2008/archive/2012/06/04/379895.html">分布式消息中间件Metaq发布1.4.3</a></h2> 
         </div> 
         <div class="postbody">
          <p style="margin: 0px; padding: 0px; font-family: Helvetica, Tahoma, Arial, sans-serif; line-height: 25px; text-align: left; background-color: #f7f7f7; ">我们在维护的淘宝开源消息中间件的<a href="http://metaq.taobao.org/" style="color: #006699; ">metaq</a>的<a href="https://github.com/killme2008/Metamorphosis" style="color: #006699; ">github分支</a>，今天发布了1.4.2版本，主要做了如下改进：<br /><br />1.支持发送和订阅分离，可以细粒度地控制Broker或者某个Topic是否接收消息和接受订阅。服务端添加新选项acceptPublish和acceptSubscribe。<br /><br />2.更友好地关闭Broker，梳理关闭流程并通过JMX调用方法关闭替代原来简单的kill。<br /><br />3.更新<a href="https://github.com/killme2008/Metamorphosis/tree/master/contrib/python/meta-python" style="color: #006699; ">python客户端</a>到0.2版本，可以通过pip安装: &nbsp;pip install metaq<br /><br />4.发布ruby语言客户端<a href="https://github.com/killme2008/Metamorphosis/tree/master/contrib/ruby/meta-ruby" style="color: #006699; ">meta-ruby</a>&nbsp;0.1版本。<br /><br />5.其他小改进：升级gecko到1.1.1版本，升级quartz到2.1.4版本，添加集成测试工程和内部重构等。<br /><br />6.新文档<a href="https://github.com/killme2008/Metamorphosis/wiki/%E4%BD%BF%E7%94%A8Log4j%E6%89%A9%E5%B1%95%E5%8F%91%E9%80%81%E6%B6%88%E6%81%AF">《使用log4j扩展发送消息》</a><br /><br />简介：<a href="https://github.com/killme2008/Metamorphosis/wiki/%E4%BB%8B%E7%BB%8D" style="color: #006699; ">https://github.com/killme2008/Metamorphosis/wiki/介绍</a><br />下载：<a href="https://github.com/killme2008/Metamorphosis/downloads" style="color: #006699; ">https://github.com/killme2008/Metamorphosis/downloads</a></p>
          <p style="margin: 0px; padding: 0px; font-family: Helvetica, Tahoma, Arial, sans-serif; line-height: 25px; text-align: left; background-color: #f7f7f7; ">文档：<a href="https://github.com/killme2008/Metamorphosis/wiki" style="color: #006699; ">https://github.com/killme2008/Metamorphosis/wiki</a></p>
         </div> 
         <p class="postfoot"> posted @ <a href="http://www.blogjava.net/killme2008/archive/2012/06/04/379895.html" title="permalink">2012-06-04 10:03</a> dennis 阅读(10770) | <a href="http://www.blogjava.net/killme2008/archive/2012/06/04/379895.html#FeedBack" title="comments, pingbacks, trackbacks">评论 (1)</a> |&nbsp;<a href="http://www.blogjava.net/killme2008/admin/EditPosts.aspx?postid=379895">编辑</a>&nbsp;<a href="http://www.blogjava.net/killme2008/AddToFavorite.aspx?id=379895">收藏</a> </p> 
        </div> 
        <div class="post" style="filter:progid:DXImageTransform.Microsoft.Shadow(color='Blue', Direction=135, Strength=32)"> 
         <div class="posthead"> 
          <h2 style="padding-top:4px; padding-bottom:4px;"><a id="ArchiveDay1_SingleDay_DayList_ctl07_TitleUrl" href="http://www.blogjava.net/killme2008/archive/2012/05/22/378885.html">如何熟悉一个开源项目？</a></h2> 
         </div> 
         <div class="postbody">
          <br />&nbsp; &nbsp; 你有个任务，需要用到某个开源项目;或者老大交代你一个事情，让你去了解某个东西。怎么下手呢？如何开始呢？我的习惯是这样：
          <br />
          <br />1.首先，查找和阅读该项目的博客和资料，通过google你能找到某个项目大体介绍的博客，快速阅读一下就能对项目的目的、功能、基本使用有个大概的了解。
          <br />
          <br />2.阅读项目的文档，重点关注类似
          <strong>Getting started、Example</strong>之类的文档，从中学习如何下载、安装、甚至基本使用该项目所需要的知识。
          <br />
          <br />3.如果该项目有提供现成的example工程，首先尝试按照开始文档的介绍运行example，如果运行顺利，那么恭喜你顺利开了个好头;如果遇到问题，首先尝试在项目的
          <strong>FAQ</strong>等文档里查找答案，再次，可以将问题（例如异常信息）当成关键词去搜索，查找相关的解决办法，你遇到了，别人一般也会遇到，热心的朋友会记录下解决的过程;最后，可以将问题提交到项目的邮件列表，请大家帮你看看。
          <strong>在没有成功运行example之前，不要尝试修改example。<br /><br /></strong>4.运行了第一个example之后，尝试根据你的理解和需要修改example，测试高级功能等。
          <br />
          <br />5.在了解基本使用后，需要开始深入的了解该项目。例如项目的配置管理、高级功能以及最佳实践。通常一个运作良好的项目会提供一份从浅到深的用户指南，你并不需要从头到尾阅读这份指南，根据时间和兴趣，特别是你自己任务的需要，重点阅读部分章节并做笔记（推荐evernote）。
          <br />
          <br />6.如果时间允许，尝试从源码构建该项目。通常开源项目都会提供一份构建指南，指导你如何搭建一个用于开发、调试和构建的环境。尝试构建一个版本。
          <br />
          <br />7.如果时间允许并且有兴趣，可以尝试阅读源码：
          <br />（1）阅读源码之前，查看该项目是否提供架构和设计文档，阅读这些文档可以了解该项目的大体设计和结构，读源码的时候不会无从下手。
          <br />（2）阅读源码之前，一定要能构建并运行该项目，有个直观感受。
          <br />（3）阅读源码的第一步是抓主干，尝试理清一次正常运行的代码调用路径，这可以通过debug来观察运行时的变量和行为。修改源码加入日志和打印可以帮助你更好的理解源码。
          <br />（4）适当画图来帮助你理解源码，在理清主干后，可以将整个流程画成一张流程图或者标准的UML图，帮助记忆和下一步的阅读。
          <br />（5）挑选感兴趣的“枝干”代码来阅读，比如你对网络通讯感兴趣，就阅读网络层的代码，深入到实现细节，如它用了什么库，采用了什么设计模式，为什么这样做等。如果可以，debug细节代码。
          <br />（6）阅读源码的时候，重视单元测试，尝试去运行单元测试，基本上一个好的单元测试会将该代码的功能和边界描述清楚。
          <br />（7）在熟悉源码后，发现有可以改进的地方，有精力、有意愿可以向该项目的开发者提出改进的意见或者issue，甚至帮他修复和实现，参与该项目的发展。
          <br />
          <br />8.通常在阅读文档和源码之后，你能对该项目有比较深入的了解了，但是该项目所在领域，你可能还想搜索相关的项目和资料，看看有没有其他的更好的项目或者解决方案。在广度和深度之间权衡。
          <br />
          <br />&nbsp; &nbsp; 以上是我个人的一些习惯，我自己也并没有完全按照这个来，但是按照这个顺序，基本上能让你比较高效地学习和使用某个开源项目。
         </div> 
         <p class="postfoot"> posted @ <a href="http://www.blogjava.net/killme2008/archive/2012/05/22/378885.html" title="permalink">2012-05-22 23:12</a> dennis 阅读(21587) | <a href="http://www.blogjava.net/killme2008/archive/2012/05/22/378885.html#FeedBack" title="comments, pingbacks, trackbacks">评论 (9)</a> |&nbsp;<a href="http://www.blogjava.net/killme2008/admin/EditPosts.aspx?postid=378885">编辑</a>&nbsp;<a href="http://www.blogjava.net/killme2008/AddToFavorite.aspx?id=378885">收藏</a> </p> 
        </div> 
        <div class="post" style="filter:progid:DXImageTransform.Microsoft.Shadow(color='Blue', Direction=135, Strength=32)"> 
         <div class="posthead"> 
          <h2 style="padding-top:4px; padding-bottom:4px;"><a id="ArchiveDay1_SingleDay_DayList_ctl08_TitleUrl" href="http://www.blogjava.net/killme2008/archive/2012/05/19/378535.html">Emacs + Clojure配置的几个Tip</a></h2> 
         </div> 
         <div class="postbody">
          <br /> &nbsp; &nbsp; 很久没更新博客了，在北京工作，忙碌并且充实。目前来说，Clojure最好的开发编辑器应该是Emacs + 
          <a href="http://common-lisp.net/project/slime/doc/html/">Slime</a>的组合，利用
          <a href="https://github.com/technomancy/swank-clojure">swank-clojure</a>这个项目，加上clojure-mode，可以完美地运行slime。编译、运行、跳转、文档和引用查看甚至
          <a href="http://georgejahad.com/clojure/swank-cdt.html">debug</a>都可以搞定。具体配置恕不重复，看swank-clojure的文档即可自己安装起来，或者这篇
          <a href="http://sunng.info/blog/2011/09/beginning-emacs-for-clojure/">中文博客</a>，
          <a href="http://www.cnblogs.com/darkluck99/archive/2012/02/20/2360216.html">windows上配置</a>。
          <br /> 
          <br /> &nbsp; &nbsp; 分享几个Tip，也期待大家分享你们的使用心得。
          <br /> 
          <br /> &nbsp; &nbsp; 首先是自动在打开clj后缀文件的时候启动执行clojure-jack-in与slime连接，可以在emacs配置里加上个callback：
          <br /> 
          <br />
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->(eval-after-load&nbsp;&quot;clojure-mode&quot;
           <br />&nbsp;&nbsp;'(progn
           <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(require&nbsp;'slime)
           <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(require&nbsp;'clojure-mode)
           <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(unless&nbsp;(slime-connected-p)
           <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(save-excursion&nbsp;(clojure-jack-in)))))
          </div> &nbsp; &nbsp; 这样在打开clj为后缀的文件的时候，将自动启动clojure-mode执行clojure-jack-in函数并且连接slime。
          <br />
          <br />&nbsp; &nbsp; 将clj后缀的文件自动关联到clojure-mode:
          <br /> 
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br />
<br />
Code highlighting produced by Actipro CodeHighlighter (freeware)<br />
http://www.CodeHighlighter.com/<br />
<br />
-->(setq&nbsp;auto-mode-alist&nbsp;(cons&nbsp;'(&quot;\\.clj$&quot;&nbsp;.&nbsp;clojure-mode)&nbsp;auto-mode-alist))
          </div> &nbsp; &nbsp; 通常来说如果你是利用
          <a href="http://marmalade-repo.org/">marmalade</a>安装的，会自动关联的。
          <br />
          <br />&nbsp; &nbsp; 另外，启动自动匹配括号、字符串引号等的paredit模式一定要启动：
          <br />
          <div style="font-size: 13px; border: 1px solid #cccccc; padding: 4px 5px 4px 4px; width: 98%; word-break: break-all; background-color: #eeeeee; ">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->(defun&nbsp;paredit-mode-enable&nbsp;()&nbsp;(paredit-mode&nbsp;1))
           <br />(add-hook&nbsp;'clojure-mode-hook&nbsp;'paredit-mode-enable)
           <br />(add-hook&nbsp;'clojure-test-mode-hook&nbsp;'paredit-mode-enable)
          </div>
          <br /> &nbsp; &nbsp;在使用clojure-mode或者clojure-test-mode的时候自动启用paredit模式，括号再也不是问题。括号匹配提示一般是开启的，如果没有，强制开启：
          <br />
          <br />
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->;;&nbsp;&nbsp;&nbsp;&nbsp;显示括号匹配
           <br />(show-paren-mode&nbsp;t)
           <br />(setq&nbsp;show-paren-style&nbsp;'parentheses)
          </div>
          <br />&nbsp; &nbsp; slime更多配置，启用IO重定向（多线程IO输出都定向到SLIME repl）以及设置通讯字符编码等：
          <br />
          <br />
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->(eval-after-load&nbsp;&quot;slime&quot;
           <br />&nbsp;&nbsp;'(progn
           <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(slime-setup&nbsp;'(slime-repl&nbsp;slime-fuzzy))
           <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;;(setq&nbsp;slime-truncate-lines&nbsp;t)
           <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(setq&nbsp;&nbsp;swank:*globally-redirect-io*&nbsp;&nbsp;t)
           <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;;&nbsp;(setq&nbsp;slime-complete-symbol-function&nbsp;'&nbsp;slime-fuzzy-complete-symbol)
           <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(setq&nbsp;slime-net-coding-system&nbsp;'utf-8-unix)))
          </div>
          <br />&nbsp; &nbsp; 细心的朋友可能注意到我注释了slime-fuzzy-complete的配置，这是一个支持更好的自动补全功能的SLIME插件（可以用缩写来自动补全），可惜在我机器上没有尝试配置成功，有兴趣你可以尝试下。
          <br />
          <br />&nbsp; &nbsp; 在REPL里支持语法高亮，一定要配置上：
          <br />
          <br />
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->(add-hook&nbsp;'slime-repl-mode-hook
           <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(defun&nbsp;clojure-mode-slime-font-lock&nbsp;()
           <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(require&nbsp;'clojure-mode)
           <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(let&nbsp;(font-lock-mode)
           <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(clojure-mode-font-lock-setup))))
          </div>
          <br />&nbsp; &nbsp; 单独在clojure-mode（在其他mode里这些快捷键不会起作用）里配置快捷键可以这样:
          <br />
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->(eval-after-load&nbsp;&quot;clojure-mode&quot;
           <br />&nbsp;&nbsp;'(progn
           <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(require&nbsp;'slime)
           <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(require&nbsp;'clojure-mode)
           <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(define-key&nbsp;clojure-mode-map&nbsp;(kbd&nbsp;&quot;M-/&quot;)&nbsp;&nbsp;(quote&nbsp;slime-complete-symbol))
           <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(define-key&nbsp;clojure-mode-map&nbsp;(kbd&nbsp;&quot;C-c&nbsp;s&quot;)&nbsp;&nbsp;(quote&nbsp;slime-selector)))
          </div>
          <br />&nbsp; &nbsp;例如我这里将M-/作为自动补全的快捷键，因为meta键在我的Mac机器上设置为command键，因此自动补全的操作习惯就跟Eclipse类似。而
          <strong>slime-selector</strong>是一个非常有用的函数，用来跳转到slime的一系列buffer，因此我绑定了C-c s快捷键。
          <br />
          <br />&nbsp; &nbsp; 额外一提，在Mac osx下，将command作为meta键:
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           ;;;&nbsp;I&nbsp;prefer&nbsp;cmd&nbsp;key&nbsp;
           <span style="color: #0000FF; ">for</span>&nbsp;meta
           <br />(setq&nbsp;mac-option-key-is-meta&nbsp;nil
           <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mac-command-key-is-meta&nbsp;t
           <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mac-command-modifier&nbsp;'meta
           <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mac-option-modifier&nbsp;'none)
          </div>
          <br />&nbsp; &nbsp; 最后，期待大家不吝分享你的心得。
          <br />&nbsp; &nbsp;&nbsp;
         </div> 
         <p class="postfoot"> posted @ <a href="http://www.blogjava.net/killme2008/archive/2012/05/19/378535.html" title="permalink">2012-05-19 00:57</a> dennis 阅读(14283) | <a href="http://www.blogjava.net/killme2008/archive/2012/05/19/378535.html#FeedBack" title="comments, pingbacks, trackbacks">评论 (11)</a> |&nbsp;<a href="http://www.blogjava.net/killme2008/admin/EditPosts.aspx?postid=378535">编辑</a>&nbsp;<a href="http://www.blogjava.net/killme2008/AddToFavorite.aspx?id=378535">收藏</a> </p> 
        </div> 
        <div class="post" style="filter:progid:DXImageTransform.Microsoft.Shadow(color='Blue', Direction=135, Strength=32)"> 
         <div class="posthead"> 
          <h2 style="padding-top:4px; padding-bottom:4px;"><a id="ArchiveDay1_SingleDay_DayList_ctl09_TitleUrl" href="http://www.blogjava.net/killme2008/archive/2012/05/12/378018.html">clj.monitor : monitoring applications in clojure based on SSH</a></h2> 
         </div> 
         <div class="postbody">
          <div>
           <br />&nbsp; &nbsp; My weekend project clj.monitor is beta release,it's a clojure DSL for monitoring system and applications based on SSH.
           <br /> 
           <br /> Home:
           <a href="https://github.com/killme2008/clj.monitor">https://github.com/killme2008/clj.monitor <br /></a>
           <br /> An example:
           <br /> 
           <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
            <!--<br />
<br />
Code highlighting produced by Actipro CodeHighlighter (freeware)<br />
http://www.CodeHighlighter.com/<br />
<br />
-->(ns&nbsp;clj.monitor.example
            <br /> &nbsp;&nbsp;(:use&nbsp;[clj.monitor.core]
            <br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[control.core]
            <br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[clj.monitor.tasks]))
            <br /> 
            <br /> ;;define&nbsp;a&nbsp;mysql&nbsp;cluster
            <br /> (defcluster&nbsp;mysql
            <br /> &nbsp;&nbsp;:clients&nbsp;[{:user&nbsp;&quot;deploy&quot;&nbsp;:host&nbsp;&quot;mysql.app.com&quot;}])
            <br /> 
            <br /> ;;define&nbsp;a&nbsp;monitor&nbsp;for&nbsp;mysql&nbsp;cluster
            <br /> (defmonitor&nbsp;mysql-monitor
            <br /> &nbsp;&nbsp;:tasks&nbsp;[(ping-mysql&nbsp;&quot;root&quot;&nbsp;&quot;password&quot;)
            <br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (system-load&nbsp;:5&nbsp;3)]
            <br /> &nbsp;&nbsp;:clusters&nbsp;[:mysql])
            <br /> 
            <br /> ;;start&nbsp;monitors
            <br /> (start-monitors
            <br /> &nbsp;:cron&nbsp;&quot;*&nbsp;0/5&nbsp;*&nbsp;*&nbsp;*&nbsp;?&quot;
            <br /> &nbsp;:alerts&nbsp;[(mail&nbsp;:from&nbsp;&quot;alert@app.com&quot;&nbsp;:to&nbsp;&quot;yourname@app.com&quot;)]
            <br /> &nbsp;:monitors&nbsp;[mysql-monitor])
           </div> 
           <br /> API document:
           <a href="http://fnil.net/clj.monitor">&nbsp;http://fnil.net/clj.monitor </a> 
           <br /> 
           <br />It is just a beta release,if you have any questions or find issues ,please let me know,thanks. 
          </div>
         </div> 
         <p class="postfoot"> posted @ <a href="http://www.blogjava.net/killme2008/archive/2012/05/12/378018.html" title="permalink">2012-05-12 22:38</a> dennis 阅读(8706) | <a href="http://www.blogjava.net/killme2008/archive/2012/05/12/378018.html#FeedBack" title="comments, pingbacks, trackbacks">评论 (5)</a> |&nbsp;<a href="http://www.blogjava.net/killme2008/admin/EditPosts.aspx?postid=378018">编辑</a>&nbsp;<a href="http://www.blogjava.net/killme2008/AddToFavorite.aspx?id=378018">收藏</a> </p> 
        </div> 
        <div class="post" style="filter:progid:DXImageTransform.Microsoft.Shadow(color='Blue', Direction=135, Strength=32)"> 
         <div class="posthead"> 
          <h2 style="padding-top:4px; padding-bottom:4px;"><a id="ArchiveDay1_SingleDay_DayList_ctl10_TitleUrl" href="http://www.blogjava.net/killme2008/archive/2012/05/09/377748.html">分布式消息中间件Metaq发布1.4.2</a></h2> 
         </div> 
         <div class="postbody">
          <br /> &nbsp; &nbsp; 
          <a href="https://github.com/killme2008/Metamorphosis/wiki/For_Developer">我们</a>在维护的淘宝开源消息中间件的
          <a href="https://github.com/killme2008/Metamorphosis">metaq</a>的github分支，今天发布了1.4.2版本，主要做了如下改进：
          <br /> 
          <br />&nbsp; &nbsp; 1.添加了大量的使用和原理文档，参见
          <a href="https://github.com/killme2008/Metamorphosis/wiki">Wiki</a>。
          <br />&nbsp; &nbsp; 2.合并tools和server-wrapper工程，提供统一的脚本来管理Broker，管理Broker的工作变得非常容易，全部工作都可以通过metaServer.sh的脚本来执行。同时提供了bat启动脚本，用于在windows上启动Broker做测试。
          <br />&nbsp; &nbsp; 3.新功能：
          <br />&nbsp; &nbsp;（1）新的客户端API用来获取topic的分区列表
          <br />&nbsp; &nbsp;（2）新的客户端API用来获取Broker的统计信息
          <br />&nbsp; &nbsp;（3）异步复制的Slave可以自动获取Master的配置变更，例如Master在配置文件中新增或者删除了topic并顺利reload热加载成功后，slave可自动复制或者移除变更的topic，无需重启。
          <br />&nbsp; &nbsp;（4）新的统计项目，可以通过'stats config'协议获取Broker的配置文件。
          <br />&nbsp; &nbsp; 4.添加meta-python项目，一个python的客户端，暂时仅支持发送消息功能。
          <br />&nbsp; &nbsp; 5.其他小改进，如统计信息的优化、构建工具的整合等。
          <br /> 
          <br />&nbsp; &nbsp; 更详细的发行日志请看
          <a href="https://github.com/killme2008/Metamorphosis/wiki/ReleaseNotes">RelaseNotes</a>。
          <br /> 
          <br />&nbsp; &nbsp; 下载地址： &nbsp;
          <a href="https://github.com/killme2008/Metamorphosis/downloads">https://github.com/killme2008/Metamorphosis/downloads<br /></a>&nbsp; &nbsp; 入门指南： &nbsp;《
          <a href="https://github.com/killme2008/Metamorphosis/wiki/%E5%A6%82%E4%BD%95%E5%BC%80%E5%A7%8B">如何开始</a>》
          <br />&nbsp; &nbsp; 更多文档请看
          <a href="https://github.com/killme2008/Metamorphosis/wiki">Wiki</a>。
         </div> 
         <p class="postfoot"> posted @ <a href="http://www.blogjava.net/killme2008/archive/2012/05/09/377748.html" title="permalink">2012-05-09 22:47</a> dennis 阅读(4319) | <a href="http://www.blogjava.net/killme2008/archive/2012/05/09/377748.html#FeedBack" title="comments, pingbacks, trackbacks">评论 (1)</a> |&nbsp;<a href="http://www.blogjava.net/killme2008/admin/EditPosts.aspx?postid=377748">编辑</a>&nbsp;<a href="http://www.blogjava.net/killme2008/AddToFavorite.aspx?id=377748">收藏</a> </p> 
        </div> 
        <div class="post" style="filter:progid:DXImageTransform.Microsoft.Shadow(color='Blue', Direction=135, Strength=32)"> 
         <div class="posthead"> 
          <h2 style="padding-top:4px; padding-bottom:4px;"><a id="ArchiveDay1_SingleDay_DayList_ctl11_TitleUrl" href="http://www.blogjava.net/killme2008/archive/2012/04/17/374936.html">Java程序员常用工具集</a></h2> 
         </div> 
         <div class="postbody">
          <br />&nbsp; &nbsp; 我发现很多人没办法高效地解决问题的关键原因是不熟悉工具，不熟悉工具也还罢了，甚至还不知道怎么去找工具，这个问题就大条了。我想列下我能想到的一个Java程序员会用到的常用工具。
          <br /> 
          <br /> 一、编码工具
          <br /> 
          <br /> 1.IDE：
          <a href="http://www.eclipse.org/">Eclipse</a>或者
          <a href="http://www.jetbrains.com/idea/">IDEA</a>，熟悉尽可能多的快捷键，《
          <a href="https://www.google.com/#hl=zh-CN&amp;site=&amp;source=hp&amp;q=Eclipse+%E5%B8%B8%E7%94%A8%E5%BF%AB%E6%8D%B7%E9%94%AE&amp;oq=Eclipse+%E5%B8%B8%E7%94%A8%E5%BF%AB%E6%8D%B7%E9%94%AE&amp;aq=f&amp;aqi=g-l1&amp;aql=&amp;gs_l=hp.3..0i13.449l7739l0l7948l53l49l9l4l4l9l278l4511l14j15j7l36l0.&amp;bav=on.2,or.r_gc.r_pw.r_cp.,cf.osb&amp;fp=eef1a08d3fa904e4&amp;biw=1594&amp;bih=858">Eclipse常见快捷键列表</a>》
          <br /> 2.插件：&nbsp;
          <br /> (1) 
          <a href="http://findbugs.sourceforge.net/">Findbugs</a>，在release之前进行一次静态代码检查是必须的
          <br /> (2) 
          <a href="http://www.atlassian.com/software/clover/overview">Clover</a>，关心你的单元测试覆盖率
          <br /> (3)&nbsp;
          <a href="http://checkstyle.sourceforge.net/">Checkstyle</a>&nbsp;代码风格检查
          <br /> 
          <br /> 3.构建和部署工具:
          <a href="http://ant.apache.org/">ant</a>或者
          <a href="http://maven.apache.org/">maven</a>，现在主流都是maven了吧，
          <a href="http://www.sonatype.org/nexus/">使用nexus搭建maven私服</a>，再加上持续集成
          <a href="http://jenkins-ci.org/">jenkins</a>。代码质量不用愁。
          <br /> 
          <br /> 4.版本管理工具： 
          <a href="http://subversion.tigris.org/">svn</a>或者
          <a href="http://git-scm.com/">git</a>
          <br /> 
          <br /> 5.
          <a href="http://www.linuxsky.org/doc/admin/200712/213.html">diff和patch</a>
          <br /> 
          <br /> 6.设置你的eclipse或者IDEA，如formatter,
          <a href="http://mestreota.blogspot.jp/2007/11/save-action-on-eclipse.html">save actions</a>以及code template等。代码风格，直接用google的也可以啊。《
          <a href="http://code.google.com/p/google-styleguide/">Google style guide</a>》
          <br /> 
          <br /> 7.掌握一个文本编辑器，Emacs或者VIM，熟悉常用快捷键。这在你需要在线编辑代码，或者编写其他语言代码时候特别有用。《
          <a href="http://linuxtoy.org/archives/why-emacs-vim-good.html">神器圣战</a>》
          <br /> 
          <br /> 二、JDK相关
          <br /> 
          <br /> 1.jstat : 观察GC情况，如：
          <br /> 
          <br /> 
          <div style="font-size: 13px; border-top-width: 1px; border-right-width: 1px; border-bottom-width: 1px; border-left-width: 1px; border-top-style: solid; border-right-style: solid; border-bottom-style: solid; border-left-style: solid; border-top-color: #cccccc; border-right-color: #cccccc; border-bottom-color: #cccccc; border-left-color: #cccccc; border-image: initial; padding-right: 5px; padding-bottom: 4px; padding-left: 4px; padding-top: 4px; width: 98%; word-break: break-all; background-color: #eeeeee; ">
           <!--<br />
<br />
Code highlighting produced by Actipro CodeHighlighter (freeware)<br />
http://www.CodeHighlighter.com/<br />
<br />
-->jstat&nbsp;-gcutil&nbsp;pid&nbsp;2000
          </div> 
          <br /> 2.jmap，查看heap情况，如查看存活对象列表：
          <br /> 
          <div style="font-size: 13px; border-top-width: 1px; border-right-width: 1px; border-bottom-width: 1px; border-left-width: 1px; border-top-style: solid; border-right-style: solid; border-bottom-style: solid; border-left-style: solid; border-top-color: #cccccc; border-right-color: #cccccc; border-bottom-color: #cccccc; border-left-color: #cccccc; border-image: initial; padding-right: 5px; padding-bottom: 4px; padding-left: 4px; padding-top: 4px; width: 98%; word-break: break-all; background-color: #eeeeee; ">
           <!--<br />
<br />
Code highlighting produced by Actipro CodeHighlighter (freeware)<br />
http://www.CodeHighlighter.com/<br />
<br />
-->jmap&nbsp;-histo:live&nbsp;pid&nbsp;|grep&nbsp;com.company&nbsp;|less&nbsp;
          </div> 
          <br /> 或者dump内存用来分析：
          <br /> 
          <br /> 
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br />
<br />
Code highlighting produced by Actipro CodeHighlighter (freeware)<br />
http://www.CodeHighlighter.com/<br />
<br />
-->jmap&nbsp;-dump:file=test.bin&nbsp;pid
          </div> 
          <br /> 3.分析dump的堆文件，可以用jhat:
          <br /> 
          <br /> 
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br />
<br />
Code highlighting produced by Actipro CodeHighlighter (freeware)<br />
http://www.CodeHighlighter.com/<br />
<br />
-->jhat&nbsp;test.bin
          </div> 
          <br /> &nbsp; 分析完成后可以用浏览器查看堆的情况。这个工具的分析结果还比较原始，你还可以用
          <a href="http://www.eclipse.org/mat/">Eclipse MAT</a>插件进行图形化分析，或者IBM的
          <a href="https://www.ibm.com/developerworks/community/groups/service/html/communityview?communityUuid=4544bafe-c7a2-455f-9d43-eb866ea60091">Heap Analyzer</a>.
          <br /> 
          <br /> 4.jvisualvm和jconsole： JVM自带的性能分析和监控工具，怎么用？
          <a href="http://docs.oracle.com/javase/6/docs/technotes/guides/visualvm/index.html">请自己看文档。</a>
          <br /> 
          <br /> 5.jstack：分析线程堆栈，如
          <br /> 
          <br /> 
          <div style="font-size: 13px; border-top-width: 1px; border-right-width: 1px; border-bottom-width: 1px; border-left-width: 1px; border-top-style: solid; border-right-style: solid; border-bottom-style: solid; border-left-style: solid; border-top-color: #cccccc; border-right-color: #cccccc; border-bottom-color: #cccccc; border-left-color: #cccccc; border-image: initial; padding-right: 5px; padding-bottom: 4px; padding-left: 4px; padding-top: 4px; width: 98%; word-break: break-all; background-color: #eeeeee; ">
           <!--<br />
<br />
Code highlighting produced by Actipro CodeHighlighter (freeware)<br />
http://www.CodeHighlighter.com/<br />
<br />
-->jstack&nbsp;pid&nbsp;&gt;&nbsp;thread_dump
          </div> 
          <br /> &nbsp; &nbsp; 查看CPU最高的线程在干什么的方法结合top和jstack：
          <a href="http://www.iteye.com/topic/1114219">http://www.iteye.com/topic/1114219</a>
          <br /> 
          <br /> 6.更多JVM工具，参见官方文档：
          <a href="http://docs.oracle.com/javase/6/docs/technotes/tools/">http://docs.oracle.com/javase/6/docs/technotes/tools/<br /> <br /> </a>7.学习使用btrace分析java运行时问题。《
          <a href="http://rdc.taobao.com/team/jm/archives/509">Btrace使用简介</a>》
          <br /> 
          <br /> 8.GC日志分析工具：
          <a href="http://www.tagtraum.com/gcviewer.html">GC viewer</a>、
          <a href="http://code.google.com/p/gc-console/">GC-console</a>或者
          <a href="http://stackoverflow.com/questions/1839599/analyze-gc-logs-for-sun-hotspots-jvm-6">自己挑吧。</a>
          <br /> 
          <br /> 9.性能分析工具，除了自带的jvisualvm外，还可以用商业的
          <a href="http://www.ej-technologies.com/products/jprofiler/overview.html">jprofiler</a>。
          <br /> 
          <br /> 
          <a href="http://kenwublog.com/docs/java6-jvm-options-chinese-edition.htm">10.JVM参数大全<br /> <br /> </a>11.《
          <a href="http://hllvm.group.iteye.com/group/topic/27945">JVM调优标准参数陷阱</a>》，iteye神贴。
          <br /> 
          <br /> 三、Linux工具
          <br /> 
          <br /> 1.
          <a href="http://www.commandlinefu.com/commands/browse/sort-by-votes">熟悉常用的shell命令，</a>
          <br /> 
          <div style="display: inline-block; ">
           <br /> 2.
           <a href="http://paulkeck.com/ssh/">设置ssh免登陆<br /> </a>
          </div> 
          <br /> 
          <br /> 3.使用
          <a href="http://htop.sourceforge.net/">htop</a>替换top。
          <br /> 
          <br /> 4.熟悉下
          <a href="http://www.ibm.com/developerworks/aix/library/au-unix-strace.html">strace,gdb</a>甚至
          <a href="http://sourceware.org/systemtap/" title="systemtap"></a>
          <a href="http://sourceware.org/systemtap/"></a>
          <a href="http://sourceware.org/systemtap/" title="systemtap">systemta</a>p来分析问题。
          <br /> 
          <br /> 
          <a href="http://techgurulive.com/2009/01/29/performance-tuning-tools-ps-top-sar-iostat-and-vmstat/">5.熟悉vmstat,iostat,sar等性能统计工具。</a>
          <br /> 
          <br /> 5.自动化部署脚本，
          <a href="http://docs.fabfile.org/en/1.4.1/index.html">py-fabric</a>或者自荐下我的
          <a href="https://github.com/killme2008/clojure-control">clojure-control</a>。
          <br /> 
          <br /> 四、其他
          <br /> 
          <br /> 1.掌握一门脚本语言，
          <a href="http://python.org">Python</a>或者
          <a href="http://www.ruby-lang.org">Ruby</a>，高效解决一些需要quick and dirty的任务：比如读写文件、导入导出数据库、网页爬虫等。注意不是python.com，咔咔。
          <br /> 
          <br /> 2.使用Linux或者Mac os系统作为你的开发环境。
          <br /> 
          <br /> 3.升级你的“硬件工具”，双屏大屏显示器、SSD、8G内存甚至更多。
          <br />
          <br />4.你懂的：
          <a href="https://code.google.com/p/goagent/">https://code.google.com/p/goagent/</a>
          <br /> 
          <br /> 五、如何查找工具？
          <br /> 
          <br /> 1.搜索引擎，google或者baidu，《
          <a href="http://www.williamlong.info/archives/728.html">搜索技巧</a>》
          <br /> 
          <br /> 2.万能的stack overflow：
          <a href="http://stackoverflow.com/">http://stackoverflow.com/<br /> </a> 
          <br /> 3.虚心问牛人。
          <br />
          <br />六、最重要的是6868
          <br />
          <br />一颗永不停止学习的心。
         </div> 
         <p class="postfoot"> posted @ <a href="http://www.blogjava.net/killme2008/archive/2012/04/17/374936.html" title="permalink">2012-04-17 17:05</a> dennis 阅读(17200) | <a href="http://www.blogjava.net/killme2008/archive/2012/04/17/374936.html#FeedBack" title="comments, pingbacks, trackbacks">评论 (17)</a> |&nbsp;<a href="http://www.blogjava.net/killme2008/admin/EditPosts.aspx?postid=374936">编辑</a>&nbsp;<a href="http://www.blogjava.net/killme2008/AddToFavorite.aspx?id=374936">收藏</a> </p> 
        </div> 
        <div class="post" style="filter:progid:DXImageTransform.Microsoft.Shadow(color='Blue', Direction=135, Strength=32)"> 
         <div class="posthead"> 
          <h2 style="padding-top:4px; padding-bottom:4px;"><a id="ArchiveDay1_SingleDay_DayList_ctl12_TitleUrl" href="http://www.blogjava.net/killme2008/archive/2012/04/13/374110.html">淘宝开源MQ――metaq的详细文档</a></h2> 
         </div> 
         <div class="postbody">
          <br /> 
          <span style="font-size: 10pt; ">&nbsp; &nbsp; 最近陆陆续续补充了不少</span>
          <a href="https://github.com/killme2008/Metamorphosis"><span style="font-size: 10pt; ">metaq</span></a>
          <span style="font-size: 10pt; ">的文档，部分是直接从官方文档里摘抄出来，放在了</span>
          <a href="https://github.com/killme2008/Metamorphosis/wiki"><span style="font-size: 10pt; ">github工程的wiki页</span></a>
          <span style="font-size: 10pt; ">，有兴趣了解甚至使用meta的可以仔细阅读下，一份目录：</span> 
          <div id="wiki-content" style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px; border-style: initial; border-color: initial; border-image: initial; font: inherit; color: #333333; font-family: Helvetica, arial, freesans, clean, sans-serif; background-color: #ffffff; "> 
           <div style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px; border-style: initial; border-color: initial; border-image: initial; font: inherit; "> 
            <div id="wiki-body" instapaper_body"="" style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px; border-style: initial; border-color: initial; border-image: initial; font: inherit; "> 
             <div style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px; border-style: initial; border-color: initial; border-image: initial; font: inherit; "> 
              <ul style="margin-top: 15px; margin-right: 0px; margin-bottom: 15px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 30px; border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px; border-style: initial; border-color: initial; border-image: initial; font: inherit; "> 
               <li style="margin-top: 15px; margin-right: 0px; margin-bottom: 15px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px; border-style: initial; border-color: initial; border-image: initial; font-size: 14px; font: inherit; "><a href="https://github.com/killme2008/Metamorphosis/wiki/%E4%BB%8B%E7%BB%8D" style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px; border-style: initial; border-color: initial; border-image: initial; font-size: 14px; font: inherit; color: #4183c4; text-decoration: none; "><span style="font-size: 10pt; ">介绍</span></a></li> 
               <li style="margin-top: 15px; margin-right: 0px; margin-bottom: 15px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px; border-style: initial; border-color: initial; border-image: initial; font-size: 14px; font: inherit; "><a href="https://github.com/killme2008/Metamorphosis/wiki/%E6%A6%82%E5%BF%B5%E5%92%8C%E6%9C%AF%E8%AF%AD" style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px; border-style: initial; border-color: initial; border-image: initial; font-size: 14px; font: inherit; color: #4183c4; text-decoration: none; "><span style="font-size: 10pt; ">基础概念和术语定义</span></a></li> 
               <li style="margin-top: 15px; margin-right: 0px; margin-bottom: 15px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px; border-style: initial; border-color: initial; border-image: initial; font-size: 14px; font: inherit; "><a href="https://github.com/killme2008/Metamorphosis/wiki/%E6%B6%88%E6%81%AF%E7%9A%84%E5%8F%AF%E9%9D%A0%E6%80%A7%E3%80%81%E9%A1%BA%E5%BA%8F%E5%92%8C%E9%87%8D%E5%A4%8D" style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px; border-style: initial; border-color: initial; border-image: initial; font-size: 14px; font: inherit; color: #4183c4; text-decoration: none; "><span style="font-size: 10pt; ">消息的可靠性、顺序和重复</span></a></li> 
               <li style="margin-top: 15px; margin-right: 0px; margin-bottom: 15px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px; border-style: initial; border-color: initial; border-image: initial; font-size: 14px; font: inherit; "><a href="https://github.com/killme2008/Metamorphosis/wiki/%E5%A6%82%E4%BD%95%E5%BC%80%E5%A7%8B" style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px; border-style: initial; border-color: initial; border-image: initial; font-size: 14px; font: inherit; color: #4183c4; text-decoration: none; "><span style="font-size: 10pt; ">如何开始</span></a></li> 
               <li style="margin-top: 15px; margin-right: 0px; margin-bottom: 15px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px; border-style: initial; border-color: initial; border-image: initial; font-size: 14px; font: inherit; "><a href="https://github.com/killme2008/Metamorphosis/wiki/%E7%AE%80%E5%8D%95%E4%BE%8B%E5%AD%90" style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px; border-style: initial; border-color: initial; border-image: initial; font-size: 14px; font: inherit; color: #4183c4; text-decoration: none; "><span style="font-size: 10pt; ">简单例子</span></a></li> 
               <li style="margin-top: 15px; margin-right: 0px; margin-bottom: 15px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px; border-style: initial; border-color: initial; border-image: initial; font-size: 14px; font: inherit; "><a href="https://github.com/killme2008/Metamorphosis/wiki/%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86" style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px; border-style: initial; border-color: initial; border-image: initial; font-size: 14px; font: inherit; color: #4183c4; text-decoration: none; "><span style="font-size: 10pt; ">服务端配置管理</span></a></li> 
               <li style="margin-top: 15px; margin-right: 0px; margin-bottom: 15px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px; border-style: initial; border-color: initial; border-image: initial; font-size: 14px; font: inherit; "><a href="https://github.com/killme2008/Metamorphosis/wiki/%E9%9B%86%E7%BE%A4%E5%92%8C%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1" style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px; border-style: initial; border-color: initial; border-image: initial; font-size: 14px; font: inherit; color: #4183c4; text-decoration: none; "><span style="font-size: 10pt; ">集群和负载均衡</span></a></li> 
               <li style="margin-top: 15px; margin-right: 0px; margin-bottom: 15px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px; border-style: initial; border-color: initial; border-image: initial; font-size: 14px; font: inherit; "><a href="https://github.com/killme2008/Metamorphosis/wiki/HA" style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px; border-style: initial; border-color: initial; border-image: initial; font-size: 14px; font: inherit; color: #4183c4; text-decoration: none; "><span style="font-size: 10pt; ">高可用配置(异步复制和同步复制)</span></a></li> 
               <li style="margin-top: 15px; margin-right: 0px; margin-bottom: 15px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px; border-style: initial; border-color: initial; border-image: initial; font-size: 14px; font: inherit; "><a href="https://github.com/killme2008/Metamorphosis/wiki/roadmap" style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px; border-style: initial; border-color: initial; border-image: initial; font-size: 14px; font: inherit; color: #4183c4; text-decoration: none; "><span style="font-size: 10pt; ">路线图</span></a></li> 
               <li style="margin-top: 15px; margin-right: 0px; margin-bottom: 15px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px; border-style: initial; border-color: initial; border-image: initial; font-size: 14px; font: inherit; "><a href="https://github.com/killme2008/Metamorphosis/wiki/Faq-chinese" style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px; border-style: initial; border-color: initial; border-image: initial; font-size: 14px; font: inherit; color: #4183c4; text-decoration: none; "><span style="font-size: 10pt; ">FAQ</span></a></li> 
               <li style="margin-top: 15px; margin-right: 0px; margin-bottom: 15px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px; border-style: initial; border-color: initial; border-image: initial; font-size: 14px; font: inherit; "><a href="https://github.com/killme2008/Metamorphosis/wiki/%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5" style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px; border-style: initial; border-color: initial; border-image: initial; font-size: 14px; font: inherit; color: #4183c4; text-decoration: none; "><span style="font-size: 10pt; ">最佳实践</span></a></li> 
               <li style="margin-top: 15px; margin-right: 0px; margin-bottom: 15px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px; border-style: initial; border-color: initial; border-image: initial; font-size: 14px; font: inherit; "><a href="http://code.taobao.org/p/metamorphosis/file/2154/%E8%AF%A6%E7%BB%86%E6%89%8B%E5%86%8C.docx" style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px; border-style: initial; border-color: initial; border-image: initial; font-size: 14px; font: inherit; color: #4183c4; text-decoration: none; "><span style="font-size: 10pt; ">官方手册(word文档)</span></a></li> 
              </ul> 
              <h1 style="line-height: 1.6; "><span style="font-size: 10pt; ">&nbsp; &nbsp; Developer</span></h1> 
              <ul style="margin-top: 15px; margin-right: 0px; margin-bottom: 15px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 30px; border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px; border-style: initial; border-color: initial; border-image: initial; font: inherit; "> 
               <li style="margin-top: 15px; margin-right: 0px; margin-bottom: 15px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px; border-style: initial; border-color: initial; border-image: initial; font-size: 14px; font: inherit; "><a href="https://github.com/killme2008/Metamorphosis/wiki/For_Developer" style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px; border-style: initial; border-color: initial; border-image: initial; font-size: 14px; font: inherit; color: #4183c4; text-decoration: none; "><span style="font-size: 10pt; ">参与贡献</span></a></li> 
               <li style="margin-top: 15px; margin-right: 0px; margin-bottom: 15px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px; border-style: initial; border-color: initial; border-image: initial; font-size: 14px; font: inherit; "><a href="https://github.com/killme2008/Metamorphosis/wiki/design" style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px; border-style: initial; border-color: initial; border-image: initial; font-size: 14px; font: inherit; color: #4183c4; text-decoration: none; "><span style="font-size: 10pt; ">设计</span></a></li> 
               <li style="margin-top: 15px; margin-right: 0px; margin-bottom: 15px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px; border-style: initial; border-color: initial; border-image: initial; font-size: 14px; font: inherit; "><a href="https://github.com/killme2008/Metamorphosis/wiki/%E5%8D%8F%E8%AE%AE" style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px; border-style: initial; border-color: initial; border-image: initial; font-size: 14px; font: inherit; color: #4183c4; text-decoration: none; "><span style="font-size: 10pt; ">通讯协议</span></a></li> 
               <li style="margin-top: 15px; margin-right: 0px; margin-bottom: 15px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px; border-style: initial; border-color: initial; border-image: initial; font-size: 14px; font: inherit; "><a href="https://github.com/killme2008/Metamorphosis/wiki/%E6%B6%88%E6%81%AF%E7%9A%84%E5%AD%98%E5%82%A8" style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px; border-style: initial; border-color: initial; border-image: initial; font-size: 14px; font: inherit; color: #4183c4; text-decoration: none; "><span style="font-size: 10pt; ">消息的存储</span></a></li> 
              </ul> 
              <h1 style="line-height: 1.6; "><span style="font-size: 10pt; ">关联项目</span></h1> 
              <ul style="margin-top: 15px; margin-right: 0px; margin-bottom: 0px !important; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 30px; border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px; border-style: initial; border-color: initial; border-image: initial; font: inherit; "> 
               <li style="margin-top: 15px; margin-right: 0px; margin-bottom: 15px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px; border-style: initial; border-color: initial; border-image: initial; font-size: 14px; font: inherit; "><a href="https://github.com/killme2008/metamorphosis-example" style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px; border-style: initial; border-color: initial; border-image: initial; font-size: 14px; font: inherit; color: #4183c4; text-decoration: none; "><span style="font-size: 10pt; ">metamorphosis-example</span></a><span style="font-size: 10pt; ">:示例项目</span></li> 
               <li style="margin-top: 15px; margin-right: 0px; margin-bottom: 15px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px; border-style: initial; border-color: initial; border-image: initial; font-size: 14px; font: inherit; "><a href="https://github.com/killme2008/storm-metamorphosis-spout" style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px; border-style: initial; border-color: initial; border-image: initial; font-size: 14px; font: inherit; color: #4183c4; text-decoration: none; "><span style="font-size: 10pt; ">storm-metamorphosis-spout</span></a><span style="font-size: 10pt; ">:使用metamorphosis作为twitter storm的spout源</span></li> 
               <li style="margin-top: 15px; margin-right: 0px; margin-bottom: 15px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px; border-style: initial; border-color: initial; border-image: initial; font-size: 14px; font: inherit; "><a href="https://github.com/killme2008/meta-python" style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px; border-style: initial; border-color: initial; border-image: initial; font-size: 14px; font: inherit; color: #4183c4; text-decoration: none; "><span style="font-size: 10pt; ">meta-python</span></a><span style="font-size: 10pt; ">: metamorphosis的python语言客户端。目前只支持发送消息功能。</span></li> 
              </ul> 
             </div> 
            </div> 
           </div> 
          </div> 
          <div id="gollum-footer" style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px; border-style: initial; border-color: initial; border-image: initial; font: inherit; line-height: 19px; color: #333333; font-family: Helvetica, arial, freesans, clean, sans-serif; background-color: #ffffff; "></div> &nbsp; &nbsp;&nbsp;
          <br /> 
          <div>
           <span style="font-size: 10pt; ">&nbsp; &nbsp; 后续还会继续补充。</span>
           <br /> 
          </div>
         </div> 
         <p class="postfoot"> posted @ <a href="http://www.blogjava.net/killme2008/archive/2012/04/13/374110.html" title="permalink">2012-04-13 22:43</a> dennis 阅读(41619) | <a href="http://www.blogjava.net/killme2008/archive/2012/04/13/374110.html#FeedBack" title="comments, pingbacks, trackbacks">评论 (13)</a> |&nbsp;<a href="http://www.blogjava.net/killme2008/admin/EditPosts.aspx?postid=374110">编辑</a>&nbsp;<a href="http://www.blogjava.net/killme2008/AddToFavorite.aspx?id=374110">收藏</a> </p> 
        </div> 
        <div class="post" style="filter:progid:DXImageTransform.Microsoft.Shadow(color='Blue', Direction=135, Strength=32)"> 
         <div class="posthead"> 
          <h2 style="padding-top:4px; padding-bottom:4px;"><a id="ArchiveDay1_SingleDay_DayList_ctl13_TitleUrl" href="http://www.blogjava.net/killme2008/archive/2012/03/23/372576.html">Clojure世界：静态代码分析</a></h2> 
         </div> 
         <div class="postbody">
          &nbsp; &nbsp; Java世界里有
          <a href="http://findbugs.sourceforge.net/">findbugs</a>这样的神器，可以让你避免很多“简单愚蠢”的bug。同样，Clojure世界里也有相应的替代品，这就是今天要介绍的
          <a href="https://github.com/jonase/kibit">kibit</a>。不过kibit现在还比较年轻，判断的规则较少，但是已经可以使用起来做clojure代码的静态检查。
          <br /> 
          <br /> 项目主页：
          <a href="https://github.com/jonase/kibit">https://github.com/jonase/kibit </a> 
          <br /> 使用：
          <br /> 1.安装lein插件：
          <br /> 
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br />
<br />
Code highlighting produced by Actipro CodeHighlighter (freeware)<br />
http://www.CodeHighlighter.com/<br />
<br />
-->lein&nbsp;plugin&nbsp;install&nbsp;jonase/kibit&nbsp;0.0.2
          </div> 
          <br /> 2.在项目的根目录运行
          <br /> 
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br />
<br />
Code highlighting produced by Actipro CodeHighlighter (freeware)<br />
http://www.CodeHighlighter.com/<br />
<br />
-->lein&nbsp;kibit
          </div> 
          <br /> kibit会分析项目里所有clojure源码，每个namespace分别分析，例如我分析
          <a href="http://github.com/killme2008/clojure-control">clojure-control</a>的输出：
          <br /> 
          <br /> 
          <div style="font-size: 13px; border-top-width: 1px; border-right-width: 1px; border-bottom-width: 1px; border-left-width: 1px; border-top-style: solid; border-right-style: solid; border-bottom-style: solid; border-left-style: solid; border-top-color: #cccccc; border-right-color: #cccccc; border-bottom-color: #cccccc; border-left-color: #cccccc; border-image: initial; padding-right: 5px; padding-bottom: 4px; padding-left: 4px; padding-top: 4px; width: 98%; word-break: break-all; background-color: #eeeeee; ">
           <!--<br />
<br />
Code highlighting produced by Actipro CodeHighlighter (freeware)<br />
http://www.CodeHighlighter.com/<br />
<br />
-->==&nbsp;control.commands&nbsp;==
           <br /> ==&nbsp;control.core&nbsp;==
           <br /> [186]&nbsp;Consider&nbsp;(zero?&nbsp;(:status&nbsp;(ssh&nbsp;host&nbsp;user&nbsp;cluster&nbsp;(str&nbsp;&quot;test&nbsp;-e&nbsp;&quot;&nbsp;file))))&nbsp;instead&nbsp;of&nbsp;(=&nbsp;(:status&nbsp;(ssh&nbsp;host&nbsp;user&nbsp;cluster&nbsp;(str&nbsp;&quot;test&nbsp;-e&nbsp;&quot;&nbsp;file)))&nbsp;0)
           <br /> ==&nbsp;control.main&nbsp;==
           <br /> ==&nbsp;leiningen.control&nbsp;==
           <br /> [
           <span style="color: #0000FF; ">null</span>]&nbsp;Consider&nbsp;Integer/parseInt&nbsp;instead&nbsp;of&nbsp;(fn*&nbsp;[p1__61444#]&nbsp;(Integer/parseInt&nbsp;p1__61444#))
           <br /> [
           <span style="color: #0000FF; ">null</span>]&nbsp;Consider&nbsp;Integer/parseInt&nbsp;instead&nbsp;of&nbsp;(fn*&nbsp;[p1__65254#]&nbsp;(Integer/parseInt&nbsp;p1__65254#))
          </div> 
          <br />&nbsp; &nbsp; 显然，kibit一个一个namespace分析过去，并且按照规则对它认为有问题的地方打印出来，并提出建议。例如这里它建议我用
          <br />
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->(zero?&nbsp;(:status&nbsp;(ssh&nbsp;host&nbsp;user&nbsp;cluster&nbsp;(str&nbsp;&quot;test&nbsp;-e&nbsp;&quot;&nbsp;file))))
          </div> &nbsp; &nbsp; 替换control.core里186行的：
          <br />
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->&nbsp;(=&nbsp;(:status&nbsp;(ssh&nbsp;host&nbsp;user&nbsp;cluster&nbsp;(str&nbsp;&quot;test&nbsp;-e&nbsp;&quot;&nbsp;file)))&nbsp;0)
          </div>
          <br />&nbsp; &nbsp; 目前kibit大多数是这类代码风格上的检查，还没有做到类似findbugs那样更丰富的检查，例如NPE异常检查等。此外kibit还提供反射检查，任何有反射调用的地方都给出警告。
          <br />&nbsp; &nbsp; kibit是基于
          <a href="https://github.com/clojure/core.logic">core.logic</a>实现的，它的规则都放在了
          <a href="https://github.com/jonase/kibit/tree/master/src/jonase/kibit/rules">这里</a>，通过defrules宏来定义检查规则，源码中对算术运算的规则定义：
          <br />
          <div style="font-size: 13px; border-top-width: 1px; border-right-width: 1px; border-bottom-width: 1px; border-left-width: 1px; border-top-style: solid; border-right-style: solid; border-bottom-style: solid; border-left-style: solid; border-top-color: #cccccc; border-right-color: #cccccc; border-bottom-color: #cccccc; border-left-color: #cccccc; border-image: initial; padding-right: 5px; padding-bottom: 4px; padding-left: 4px; padding-top: 4px; width: 98%; word-break: break-all; background-color: #eeeeee; ">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->(defrules&nbsp;rules
           <br />&nbsp;&nbsp;[(+&nbsp;?x&nbsp;1)&nbsp;(inc&nbsp;?x)]
           <br />&nbsp;&nbsp;[(+&nbsp;1&nbsp;?x)&nbsp;(inc&nbsp;?x)]
           <br />&nbsp;&nbsp;[(-&nbsp;?x&nbsp;1)&nbsp;(dec&nbsp;?x)]
           <br />
           <br />&nbsp;&nbsp;[(*&nbsp;?x&nbsp;(*&nbsp;.&nbsp;?xs))&nbsp;(*&nbsp;?x&nbsp;.&nbsp;?xs)]
           <br />&nbsp;&nbsp;[(+&nbsp;?x&nbsp;(+&nbsp;.&nbsp;?xs))&nbsp;(+&nbsp;?x&nbsp;.&nbsp;?xs)])
          </div>&nbsp; &nbsp;
          <br />&nbsp; &nbsp; 第一个规则，任何对类似(+ 1 x)的代码，都建议替换成(inc x)，后面的与此类似。理论上你也可以自定义规则，并提交给官方。总体上说kibit仍然是比不上findbugs的，期待未来发展的更好。
         </div> 
         <p class="postfoot"> posted @ <a href="http://www.blogjava.net/killme2008/archive/2012/03/23/372576.html" title="permalink">2012-03-23 21:28</a> dennis 阅读(4215) | <a href="http://www.blogjava.net/killme2008/archive/2012/03/23/372576.html#FeedBack" title="comments, pingbacks, trackbacks">评论 (0)</a> |&nbsp;<a href="http://www.blogjava.net/killme2008/admin/EditPosts.aspx?postid=372576">编辑</a>&nbsp;<a href="http://www.blogjava.net/killme2008/AddToFavorite.aspx?id=372576">收藏</a> </p> 
        </div> 
        <div class="post" style="filter:progid:DXImageTransform.Microsoft.Shadow(color='Blue', Direction=135, Strength=32)"> 
         <div class="posthead"> 
          <h2 style="padding-top:4px; padding-bottom:4px;"><a id="ArchiveDay1_SingleDay_DayList_ctl14_TitleUrl" href="http://www.blogjava.net/killme2008/archive/2012/03/22/372489.html">Clojure世界：如何做性能测试</a></h2> 
         </div> 
         <div class="postbody">
          <br /> &nbsp; &nbsp; 我们经常需要在程序中测量某段代码的性能，或者某个函数的性能，在Java中，我们可能简单地循环调用某个方法多少次，然后利用System.currentTimeMillis()方法测量下时间。在Ruby中，一般都是用
          <a href="http://www.ruby-doc.org/stdlib-1.9.3/libdoc/benchmark/rdoc/index.html">Benchmark module</a>做测试，提供了更详细的报告信息。
          <br /> 
          <br /> &nbsp; &nbsp; 同样，在Clojure里你可以做这些事情，你仍然可以使用System.currentTimeMillis()来测量运行时间，例如：
          <br /> 
          <br /> 
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br />
<br />
Code highlighting produced by Actipro CodeHighlighter (freeware)<br />
http://www.CodeHighlighter.com/<br />
<br />
-->user=&gt;&nbsp;(defn&nbsp;sum1&nbsp;[&amp;&nbsp;args]&nbsp;(reduce&nbsp;+&nbsp;0&nbsp;args))
           <br /> #'user/sum1
           <br /> 
           <br /> user=&gt;&nbsp;(defn&nbsp;sum2&nbsp;[&amp;&nbsp;args]
           <br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(loop&nbsp;[rt&nbsp;0
           <br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;args&nbsp;args]
           <br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(
           <span style="color: #0000FF; ">if</span>&nbsp;args
           <br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(recur&nbsp;(+&nbsp;rt&nbsp;(first&nbsp;args))&nbsp;(next&nbsp;args))
           <br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rt)))
           <br /> #'user/sum2
           <br /> 
           <br /> user=&gt;&nbsp;(defn&nbsp;bench&nbsp;[sum&nbsp;n]
           <br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(let&nbsp;[start&nbsp;(System/currentTimeMillis)
           <br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nums&nbsp;(range&nbsp;0&nbsp;(+&nbsp;n&nbsp;1))]
           <br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(dotimes&nbsp;[_&nbsp;n]&nbsp;(apply&nbsp;sum&nbsp;nums))
           <br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(println&nbsp;(-&nbsp;(System/currentTimeMillis)&nbsp;start))))
           <br /> 
           <br /> user=&gt;&nbsp;(bench&nbsp;sum1&nbsp;10000)
           <br /> 1818
           <br /> nil
           <br /> user=&gt;&nbsp;(bench&nbsp;sum2&nbsp;10000)
           <br /> 4220
           <br /> nil
          </div> &nbsp; &nbsp;
          <br /> &nbsp; &nbsp; 定义两个求和函数sum1和sum2，一个是利用reduce，一个是自己写loop，然后写了个bench函数循环一定次数执行sum函数并给出执行时间，利用System.currentTimeMillis()方法。显然sum1比sum2快了一倍多。为什么更快？这不是我们的话题，有兴趣可以自己看reduce函数的实现。
          <br /> 
          <br /> &nbsp; &nbsp; 除了用System.currentTimeMillis()这样的java方式测量运行时间外，clojure还提供了time宏来包装这一切：
          <br /> 
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br />
<br />
Code highlighting produced by Actipro CodeHighlighter (freeware)<br />
http://www.CodeHighlighter.com/<br />
<br />
-->user=&gt;&nbsp;(doc&nbsp;time)
           <br /> -------------------------
           <br /> clojure.core/time
           <br /> ([expr])
           <br /> Macro
           <br /> &nbsp;&nbsp;Evaluates&nbsp;expr&nbsp;and&nbsp;prints&nbsp;the&nbsp;time&nbsp;it&nbsp;took.&nbsp;&nbsp;Returns&nbsp;the&nbsp;value&nbsp;of
           <br /> &nbsp;expr.
           <br /> nil
          </div> 
          <br /> &nbsp; &nbsp; time宏用的不是currentTimeMillis方法，而是JDK5引入的nanoTime方法更精确。重写bench函数：
          <br /> 
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br />
<br />
Code highlighting produced by Actipro CodeHighlighter (freeware)<br />
http://www.CodeHighlighter.com/<br />
<br />
-->user=&gt;&nbsp;(defn&nbsp;bench&nbsp;[sum&nbsp;n]
           <br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(time&nbsp;(dotimes&nbsp;[_&nbsp;n]&nbsp;(apply&nbsp;sum&nbsp;(range&nbsp;0&nbsp;(+&nbsp;n&nbsp;1))))))
           <br /> #'user/bench
           <br /> 
           <br /> user=&gt;&nbsp;(bench&nbsp;sum1&nbsp;10000)
           <br /> &quot;Elapsed&nbsp;time:&nbsp;5425.074&nbsp;msecs&quot;
           <br /> nil
           <br /> user=&gt;&nbsp;(bench&nbsp;sum2&nbsp;10000)
           <br /> &quot;Elapsed&nbsp;time:&nbsp;7893.412&nbsp;msecs&quot;
           <br /> nil
          </div> &nbsp; &nbsp; &nbsp;尽管精度不一致，仍然可以看出来sum1比sum2快。
          <br /> &nbsp; &nbsp;&nbsp;
          <br /> &nbsp; &nbsp; &nbsp;这样的测试仍然是比较粗糙的，真正的性能测试需要考虑到JVM JIT、warm up以及gc带来的影响，例如我们可能需要预先执行函数多少次来让JVM“预热”这些代码。庆幸的是clojure世界里有一个开源库
          <span style="color: #333333; font-family: Helvetica, arial, freesans, clean, sans-serif; line-height: 22px; background-color: #ffffff; ">Criterium帮你自动搞定这一切，它的项目主页也在github上：</span>
          <a href="https://github.com/hugoduncan/criterium">https://github.com/hugoduncan/criterium </a>
          <br /> 
          <br /> &nbsp; &nbsp; &nbsp;首先在你的项目里添加criterium依赖：
          <br /> 
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br />
<br />
Code highlighting produced by Actipro CodeHighlighter (freeware)<br />
http://www.CodeHighlighter.com/<br />
<br />
-->:dependencies&nbsp;[[org.clojure/clojure&nbsp;&quot;1.3.0&quot;]
           <br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[criterium&nbsp;&quot;0.2.0&quot;]])
          </div> &nbsp; &nbsp;
          <br /> &nbsp; &nbsp; &nbsp;接下来引用criterium.core这个ns，因为criterium主要宏也叫bench，因此我们原来的bench函数不能用了，换个名字叫bench-sum:
          <br /> 
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br />
<br />
Code highlighting produced by Actipro CodeHighlighter (freeware)<br />
http://www.CodeHighlighter.com/<br />
<br />
-->user=&gt;&nbsp;(use&nbsp;'criterium.core)
           <br /> nil
           <br /> user=&gt;&nbsp;(defn&nbsp;bench-sum&nbsp;[sum&nbsp;n]
           <br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(with-progress-reporting&nbsp;(bench&nbsp;(apply&nbsp;sum&nbsp;(range&nbsp;0&nbsp;(+&nbsp;1&nbsp;n)))&nbsp;:verbose)))
           <br /> #'user/bench-sum
          </div> 
          <br /> &nbsp; &nbsp; &nbsp;调用criterium的
          <strong>bench</strong>宏执行测试，使用
          <strong>with-progress-reporting</strong>宏包装测试代码并汇报测试进展，测试进展会打印在标准输出上。请注意，我这里并没有利用dotimes做循环测试，因为criterium会自己计算应该运行的循环次数，我们并不需要明确指定，测试下结果：
          <br /> 
          <div style="font-size: 13px; border-top-width: 1px; border-right-width: 1px; border-bottom-width: 1px; border-left-width: 1px; border-top-style: solid; border-right-style: solid; border-bottom-style: solid; border-left-style: solid; border-top-color: #cccccc; border-right-color: #cccccc; border-bottom-color: #cccccc; border-left-color: #cccccc; border-image: initial; padding-right: 5px; padding-bottom: 4px; padding-left: 4px; padding-top: 4px; width: 98%; word-break: break-all; background-color: #eeeeee; ">
           <!--<br />
<br />
Code highlighting produced by Actipro CodeHighlighter (freeware)<br />
http://www.CodeHighlighter.com/<br />
<br />
-->
           <strong>user=&gt;&nbsp;(bench-sum&nbsp;sum1&nbsp;10000)</strong>
           <br /> Cleaning&nbsp;JVM&nbsp;allocations&nbsp;
           <img src="http://www.blogjava.net/Images/dot.gif" alt="" />
           <br /> Warming&nbsp;up&nbsp;
           <span style="color: #0000FF; ">for</span>&nbsp;JIT&nbsp;optimisations&nbsp;
           <img src="http://www.blogjava.net/Images/dot.gif" alt="" />
           <br /> Estimating&nbsp;execution&nbsp;count&nbsp;
           <img src="http://www.blogjava.net/Images/dot.gif" alt="" />
           <br /> Running&nbsp;with&nbsp;sample-count&nbsp;60&nbsp;exec-count&nbsp;1417&nbsp;
           <br /> Checking&nbsp;GC
           <img src="http://www.blogjava.net/Images/dot.gif" alt="" />
           <br /> Cleaning&nbsp;JVM&nbsp;allocations&nbsp;
           <img src="http://www.blogjava.net/Images/dot.gif" alt="" />
           <br /> Finding&nbsp;outliers&nbsp;
           <img src="http://www.blogjava.net/Images/dot.gif" alt="" />
           <br /> Bootstrapping&nbsp;
           <img src="http://www.blogjava.net/Images/dot.gif" alt="" />
           <br /> Checking&nbsp;outlier&nbsp;significance
           <br /> x86_64&nbsp;Mac&nbsp;OS&nbsp;X&nbsp;10.7.3&nbsp;4&nbsp;cpu(s)
           <br /> Java&nbsp;HotSpot(TM)&nbsp;64-Bit&nbsp;Server&nbsp;VM&nbsp;20.4-b02-402
           <br /> Runtime&nbsp;arguments:&nbsp;-Dclojure.compile.path=/Users/apple/programming/avos/logdashboard/test/classes&nbsp;-Dtest.version=1.0.0-SNAPSHOT&nbsp;-Dclojure.debug=
           <span style="color: #0000FF; ">false</span>
           <br /> Evaluation&nbsp;count&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;85020
           <br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Execution&nbsp;time&nbsp;mean&nbsp;:&nbsp;722.730169&nbsp;us&nbsp;&nbsp;95.0%&nbsp;CI:&nbsp;(722.552670&nbsp;us,&nbsp;722.957586&nbsp;us)
           <br /> &nbsp;&nbsp;&nbsp;&nbsp;Execution&nbsp;time&nbsp;std-deviation&nbsp;:&nbsp;1.042966&nbsp;ms&nbsp;&nbsp;95.0%&nbsp;CI:&nbsp;(1.034972&nbsp;ms,&nbsp;1.054015&nbsp;ms)
           <br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Execution&nbsp;time&nbsp;lower&nbsp;ci&nbsp;:&nbsp;692.122089&nbsp;us&nbsp;&nbsp;95.0%&nbsp;CI:&nbsp;(692.122089&nbsp;us,&nbsp;692.260198&nbsp;us)
           <br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Execution&nbsp;time&nbsp;upper&nbsp;ci&nbsp;:&nbsp;768.239944&nbsp;us&nbsp;&nbsp;95.0%&nbsp;CI:&nbsp;(768.239944&nbsp;us,&nbsp;768.305222&nbsp;us)
           <br /> 
           <br /> Found&nbsp;2&nbsp;outliers&nbsp;in&nbsp;60&nbsp;samples&nbsp;(3.3333&nbsp;%)
           <br /> &nbsp;&nbsp;&nbsp;&nbsp;low-severe&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2&nbsp;(3.3333&nbsp;%)
           <br /> &nbsp;Variance&nbsp;from&nbsp;outliers&nbsp;:&nbsp;25.4066&nbsp;%&nbsp;Variance&nbsp;is&nbsp;moderately&nbsp;inflated&nbsp;by&nbsp;outliers
           <br /> nil
           <br /> 
           <br /> 
           <br /> 
           <strong>user=&gt;&nbsp;(bench-sum&nbsp;sum2&nbsp;10000)</strong>
           <br /> Cleaning&nbsp;JVM&nbsp;allocations&nbsp;
           <img src="http://www.blogjava.net/Images/dot.gif" alt="" />
           <br /> Warming&nbsp;up&nbsp;
           <span style="color: #0000FF; ">for</span>&nbsp;JIT&nbsp;optimisations&nbsp;
           <img src="http://www.blogjava.net/Images/dot.gif" alt="" />
           <br /> Estimating&nbsp;execution&nbsp;count&nbsp;
           <img src="http://www.blogjava.net/Images/dot.gif" alt="" />
           <br /> Running&nbsp;with&nbsp;sample-count&nbsp;60&nbsp;exec-count&nbsp;917&nbsp;
           <br /> Checking&nbsp;GC
           <img src="http://www.blogjava.net/Images/dot.gif" alt="" />
           <br /> Cleaning&nbsp;JVM&nbsp;allocations&nbsp;
           <img src="http://www.blogjava.net/Images/dot.gif" alt="" />
           <br /> Finding&nbsp;outliers&nbsp;
           <img src="http://www.blogjava.net/Images/dot.gif" alt="" />
           <br /> Bootstrapping&nbsp;
           <img src="http://www.blogjava.net/Images/dot.gif" alt="" />
           <br /> Checking&nbsp;outlier&nbsp;significance
           <br /> x86_64&nbsp;Mac&nbsp;OS&nbsp;X&nbsp;10.7.3&nbsp;4&nbsp;cpu(s)
           <br /> Java&nbsp;HotSpot(TM)&nbsp;64-Bit&nbsp;Server&nbsp;VM&nbsp;20.4-b02-402
           <br /> Runtime&nbsp;arguments:&nbsp;-Dclojure.compile.path=/Users/apple/programming/avos/logdashboard/test/classes&nbsp;-Dtest.version=1.0.0-SNAPSHOT&nbsp;-Dclojure.debug=
           <span style="color: #0000FF; ">false</span>
           <br /> Evaluation&nbsp;count&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;55020
           <br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Execution&nbsp;time&nbsp;mean&nbsp;:&nbsp;1.070884&nbsp;ms&nbsp;&nbsp;95.0%&nbsp;CI:&nbsp;(1.070587&nbsp;ms,&nbsp;1.071136&nbsp;ms)
           <br /> &nbsp;&nbsp;&nbsp;&nbsp;Execution&nbsp;time&nbsp;std-deviation&nbsp;:&nbsp;1.057659&nbsp;ms&nbsp;&nbsp;95.0%&nbsp;CI:&nbsp;(1.050688&nbsp;ms,&nbsp;1.062877&nbsp;ms)
           <br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Execution&nbsp;time&nbsp;lower&nbsp;ci&nbsp;:&nbsp;1.024195&nbsp;ms&nbsp;&nbsp;95.0%&nbsp;CI:&nbsp;(1.024164&nbsp;ms,&nbsp;1.024195&nbsp;ms)
           <br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Execution&nbsp;time&nbsp;upper&nbsp;ci&nbsp;:&nbsp;1.145664&nbsp;ms&nbsp;&nbsp;95.0%&nbsp;CI:&nbsp;(1.145664&nbsp;ms,&nbsp;1.145741&nbsp;ms)
           <br /> 
           <br /> Found&nbsp;1&nbsp;outliers&nbsp;in&nbsp;60&nbsp;samples&nbsp;(1.6667&nbsp;%)
           <br /> &nbsp;&nbsp;&nbsp;&nbsp;low-severe&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1&nbsp;(1.6667&nbsp;%)
           <br /> &nbsp;Variance&nbsp;from&nbsp;outliers&nbsp;:&nbsp;19.0208&nbsp;%&nbsp;Variance&nbsp;is&nbsp;moderately&nbsp;inflated&nbsp;by&nbsp;outliers
           <br /> nil
          </div> 
          <br /> 
          <br /> &nbsp; &nbsp; 这个报告是不是相当专业？不是搞统计还不一定读的懂。大概解读下，sample-count是取样次数，默认是60次，exec-count是测试的执行次数（不包括前期warm up和JIT在内），CI是可信区间，这里取95％，Execution time mean是平均执行时间，而lower和upper是测试过程中执行时间的最小和最大值。而outliers是这一组测试中的异常值，比如执行sum1测试发现了2组异常结果。从结果来看,sum1的平均执行时间是722微秒，而sum2的平均执行时间是1.07毫秒，因此还是sum1更快一些。
          <br /> 
          <br /> &nbsp; &nbsp; 总结下，如果只是在开发过程中做一些小块代码的简单测试，可以直接利用内置的time宏，如果你希望做一次比较标准的性能测试，那么就应该利用
          <a href="https://github.com/hugoduncan/criterium">criterium</a>这个优秀的开源库。
         </div> 
         <p class="postfoot"> posted @ <a href="http://www.blogjava.net/killme2008/archive/2012/03/22/372489.html" title="permalink">2012-03-22 21:14</a> dennis 阅读(3704) | <a href="http://www.blogjava.net/killme2008/archive/2012/03/22/372489.html#FeedBack" title="comments, pingbacks, trackbacks">评论 (0)</a> |&nbsp;<a href="http://www.blogjava.net/killme2008/admin/EditPosts.aspx?postid=372489">编辑</a>&nbsp;<a href="http://www.blogjava.net/killme2008/AddToFavorite.aspx?id=372489">收藏</a> </p> 
        </div> 
        <div class="post" style="filter:progid:DXImageTransform.Microsoft.Shadow(color='Blue', Direction=135, Strength=32)"> 
         <div class="posthead"> 
          <h2 style="padding-top:4px; padding-bottom:4px;"><a id="ArchiveDay1_SingleDay_DayList_ctl15_TitleUrl" href="http://www.blogjava.net/killme2008/archive/2012/03/21/372409.html">Clojure世界：API文档生成</a></h2> 
         </div> 
         <div class="postbody">
          <br /> &nbsp; &nbsp; 继续Clojure世界之旅，介绍下我今天的探索成果，使用clojure生成clojure项目的API文档。在java里，我们是利用javadoc生成API文档，各种build工具都提供了集成，例如maven和ant都提供了javadoc插件或者task。在Clojure世界里，同样有一系列工具帮助你从源码中自动化生成API文档。今天主要介绍三个工具。不过我不会介绍怎么在clojure里写doc，具体怎么做请看一些开源项目，或者直接看clojure.core的源码。
          <br /> 
          <br /> &nbsp; &nbsp; 首先是
          <a href="https://github.com/weavejester/codox">codox</a>，使用相当简单，我们这里都假设你使用
          <a href="https://github.com/technomancy/leiningen">Leiningen</a>作为构建工具，在project.clj里添加codox依赖：
          <br /> 
          <div style="font-size: 13px; border-top-width: 1px; border-right-width: 1px; border-bottom-width: 1px; border-left-width: 1px; border-top-style: solid; border-right-style: solid; border-bottom-style: solid; border-left-style: solid; border-top-color: #cccccc; border-right-color: #cccccc; border-bottom-color: #cccccc; border-left-color: #cccccc; border-image: initial; padding-right: 5px; padding-bottom: 4px; padding-left: 4px; padding-top: 4px; width: 98%; word-break: break-all; background-color: #eeeeee; ">
           <!--<br />
<br />
Code highlighting produced by Actipro CodeHighlighter (freeware)<br />
http://www.CodeHighlighter.com/<br />
<br />
-->&nbsp; :dev-dependencies&nbsp;&nbsp;&nbsp;&nbsp;[[codox&nbsp;&quot;0.5.0&quot;]]
          </div> 
          <br /> &nbsp; &nbsp; 解下执行
          <strong><em>lein doc</em></strong>命令即可生成文档，生成的文档放在doc目录，在浏览器里打开index.html即可观察生成的文档。我给
          <a href="https://github.com/killme2008/clojure-control">clojure-control</a>生成的codox文档可以看
          <a href="http://fnil.net/docs/control/index.html">这个链接</a>，效果还是不错的。
          <br /> 
          <br /> &nbsp; &nbsp; 第二个要介绍的工具是
          <a href="https://github.com/fogus/marginalia">marginalia</a>，使用方法类似codox，首先还是添加依赖：
          <br /> 
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br />
<br />
Code highlighting produced by Actipro CodeHighlighter (freeware)<br />
http://www.CodeHighlighter.com/<br />
<br />
-->:dev-dependencies&nbsp;[lein-marginalia&nbsp;&quot;0.7.0&quot;]
          </div> &nbsp; &nbsp; 
          <br /> &nbsp;&nbsp;&nbsp;&nbsp;执行lein deps处理依赖关系，然后执行
          <strong><em>lein&nbsp;</em></strong>
          <span style="font-family: 'Bitstream Vera Sans Mono', Courier, monospace; line-height: normal; color: #333333; "><strong><em>marg</em></strong>命令即可在docs目录生成文档，与codox不同的是marginalia只生成一个html文件，没有带js和css，但是效果也不错，可以看我给clojure-control生成的<a href="http://fnil.net/docs/control/uberdoc.html">marg文档链接</a>。</span>
          <span style="color: #333333; font-family: 'Bitstream Vera Sans Mono', Courier, monospace; line-height: normal; ">marginalia生成的文档说明和源码左右对照，很利于阅读源码。<br /> <br /> &nbsp; &nbsp;最后要介绍的就是Clojure.org自己在使用的<a href="https://github.com/tomfaulhaber/autodoc">autodoc</a>，如果你喜欢clojure.org上的API文档格式可以采用这个工具。并且autodoc可以跟github pages结合起来，生成完整的项目文档并展示在github上。例如以clojure-control为例来介绍整个过程。首先你需要配置你的github pages，参照这个链接</span>
          <a href="http://pages.github.com/">http://pages.github.com/</a>。
          <span style="color: #333333; font-family: 'Bitstream Vera Sans Mono', Courier, monospace; line-height: normal; "><br /> </span>
          <span style="color: #333333; font-family: 'Bitstream Vera Sans Mono', Courier, monospace; line-height: normal; "> <br /> &nbsp; &nbsp; 第一步，仍然是在project.clj添加依赖：<br /> </span> 
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br />
<br />
Code highlighting produced by Actipro CodeHighlighter (freeware)<br />
http://www.CodeHighlighter.com/<br />
<br />
-->:dev-dependencies&nbsp;[[lein-autodoc&nbsp;&quot;0.9.0&quot;]]
          </div> &nbsp; &nbsp; &nbsp; &nbsp;第二步，在你的.gitignore里忽略autodoc目录：
          <br /> 
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br />
<br />
Code highlighting produced by Actipro CodeHighlighter (freeware)<br />
http://www.CodeHighlighter.com/<br />
<br />
-->autodoc
           <span style="color: #008000; ">/**</span>
          </div> &nbsp; &nbsp; &nbsp; &nbsp;将这些更改提交到github上，接下来在你的项目目录clone一份项目源码到&lt;project&gt;/autodoc目录：
          <br /> 
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br />
<br />
Code highlighting produced by Actipro CodeHighlighter (freeware)<br />
http://www.CodeHighlighter.com/<br />
<br />
-->&nbsp;git&nbsp;clone&nbsp;git@github.com:&lt;user&nbsp;name&gt;/&lt;project&nbsp;name&gt;.git&nbsp;autodoc
          </div> &nbsp; &nbsp; &nbsp; &nbsp;进入autodoc目录，执行下列命令创建一个
          <span style="line-height: normal; ">gh-pages分支：<br /> </span> 
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br />
<br />
Code highlighting produced by Actipro CodeHighlighter (freeware)<br />
http://www.CodeHighlighter.com/<br />
<br />
-->&nbsp;$&nbsp;cd&nbsp;autodoc
           <br /> &nbsp;$&nbsp;git&nbsp;symbolic-ref&nbsp;HEAD&nbsp;refs/heads/gh-pages
           <br /> &nbsp;$&nbsp;rm&nbsp;.git/index
           <br /> &nbsp;$&nbsp;git&nbsp;clean&nbsp;-fdx
           <br /> &nbsp;$&nbsp;cd&nbsp;..
          </div> &nbsp; &nbsp; &nbsp;回到项目根目录后，执行
          <strong><em>lein autodoc</em></strong>命令在autodoc目录生成文档：
          <br /> 
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br />
<br />
Code highlighting produced by Actipro CodeHighlighter (freeware)<br />
http://www.CodeHighlighter.com/<br />
<br />
-->lein&nbsp;autodoc
          </div> &nbsp; &nbsp; &nbsp;接下来将生成的文档推送到github分支上：
          <br /> 
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           &nbsp;$cd autodoc&nbsp;
           <br /> &nbsp;$&nbsp;git&nbsp;add&nbsp;-A
           <br /> &nbsp;$&nbsp;git&nbsp;commit&nbsp;-m&quot;Documentation&nbsp;update&quot;
           <br /> &nbsp;$&nbsp;git&nbsp;push&nbsp;origin&nbsp;gh-pages
          </div> &nbsp; &nbsp; 等上几分钟，让github渲染你的文档，最终的效果看这个链接&nbsp;
          <a href="http://killme2008.github.com/clojure-control">http://killme2008.github.com/clojure-control </a>&nbsp; &nbsp;&nbsp;
          <br />&nbsp; &nbsp; autodoc和
          <span style="color: #333333; font-family: 'Bitstream Vera Sans Mono', Courier, monospace; line-height: normal; ">marginalia都支持maven，具体使用请看他们的文档。</span>
         </div> 
         <p class="postfoot"> posted @ <a href="http://www.blogjava.net/killme2008/archive/2012/03/21/372409.html" title="permalink">2012-03-21 22:24</a> dennis 阅读(3892) | <a href="http://www.blogjava.net/killme2008/archive/2012/03/21/372409.html#FeedBack" title="comments, pingbacks, trackbacks">评论 (0)</a> |&nbsp;<a href="http://www.blogjava.net/killme2008/admin/EditPosts.aspx?postid=372409">编辑</a>&nbsp;<a href="http://www.blogjava.net/killme2008/AddToFavorite.aspx?id=372409">收藏</a> </p> 
        </div> 
        <div class="post" style="filter:progid:DXImageTransform.Microsoft.Shadow(color='Blue', Direction=135, Strength=32)"> 
         <div class="posthead"> 
          <h2 style="padding-top:4px; padding-bottom:4px;"><a id="ArchiveDay1_SingleDay_DayList_ctl16_TitleUrl" href="http://www.blogjava.net/killme2008/archive/2012/03/21/372405.html">淘宝开源metaq的python客户端</a></h2> 
         </div> 
         <div class="postbody">
          &nbsp; &nbsp; 前面一篇博客介绍了我在github上的一个
          <a href="https://github.com/killme2008/Metamorphosis">metaq</a>分支，今天下午写了个metaq的python客户端，目前仅支持发送消息功能，不过麻雀虽小，五脏俱全，客户端和zookeeper的交互和连接管理之类都还具备，不出意外，我们会首先用上。第一次正儿八经地写python代码，写的不好的地方请尽管拍砖，多谢。
          <br />&nbsp; &nbsp; 项目叫meta-python，仍然放在github上：
          <a href="https://github.com/killme2008/meta-python">https://github.com/killme2008/meta-python<br /><br /></a>&nbsp; &nbsp; 使用需要先安装zkpython这个库，具体安装
          <a href="http://www.zlovezl.cn/articles/40/" style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px; border-style: initial; border-color: initial; border-image: initial; font: inherit; color: #4183c4; text-decoration: none; font-family: Helvetica, arial, freesans, clean, sans-serif; line-height: 22px; background-color: #ffffff; ">这篇博客</a>，使用很简单，发送消息：
          <br />
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->&nbsp; &nbsp;&nbsp;
           <span style="color: #0000FF; ">from</span>&nbsp;metamorphosis&nbsp;
           <span style="color: #0000FF; ">import</span>&nbsp;Message,MessageProducer,SendResult
           <br />&nbsp;&nbsp;&nbsp;&nbsp;p=MessageProducer(
           <span style="color: #800000; ">&quot;</span>
           <span style="color: #800000; ">topic</span>
           <span style="color: #800000; ">&quot;</span>)
           <br />&nbsp;&nbsp;&nbsp;&nbsp;message=Message(
           <span style="color: #800000; ">&quot;</span>
           <span style="color: #800000; ">topic</span>
           <span style="color: #800000; ">&quot;</span>,
           <span style="color: #800000; ">&quot;</span>
           <span style="color: #800000; ">message&nbsp;body</span>
           <span style="color: #800000; ">&quot;</span>)
           <br />&nbsp;&nbsp;&nbsp;&nbsp;
           <span style="color: #0000FF; ">print</span>&nbsp;p.send(message)
           <br />&nbsp;&nbsp;&nbsp;&nbsp;p.close()
          </div>
          <br />&nbsp; &nbsp;&nbsp;
          <div style="display: inline-block; ">
           MessageProducer就是消息发送者，它的构造函数接受至少一个topic，默认的zk_servers为localhost:2181，可以通过zk_servers参数指定你的zookeeper集群:
           <br />
           <br />
           <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
            <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->p=MessageProducer(
            <span style="color: #800000; ">&quot;</span>
            <span style="color: #800000; ">topic</span>
            <span style="color: #800000; ">&quot;</span>,zk_servers=
            <span style="color: #800000; ">&quot;</span>
            <span style="color: #800000; ">192.168.1.100:2191,192.168.1.101:2181</span>
            <span style="color: #800000; ">&quot;</span>)
           </div>
           <span style="background-color: #eeeeee; "><br /></span>
           <span style="background-color: #eeeeee; ">更多参数请直接看源码吧。一个本机的性能测试（meta和客户端都跑在我的机器上，机器是Mac MC700，osx 10.7，磁盘没有升级过）：<br /></span>
           <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
            <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
            <span style="color: #0000FF; ">from</span>&nbsp;metamorphosis&nbsp;
            <span style="color: #0000FF; ">import</span>&nbsp;Message,MessageProducer
            <br />
            <span style="color: #0000FF; ">from</span>&nbsp;time&nbsp;
            <span style="color: #0000FF; ">import</span>&nbsp;time
            <br />p=MessageProducer(
            <span style="color: #800000; ">&quot;</span>
            <span style="color: #800000; ">avos-fetch-tasks</span>
            <span style="color: #800000; ">&quot;</span>)
            <br />message=Message(
            <span style="color: #800000; ">&quot;</span>
            <span style="color: #800000; ">avos-fetch-tasks</span>
            <span style="color: #800000; ">&quot;</span>,
            <span style="color: #800000; ">&quot;</span>
            <span style="color: #800000; ">http://www.taobao.com</span>
            <span style="color: #800000; ">&quot;</span>)
            <br />start=time()
            <br />
            <span style="color: #0000FF; ">for</span>&nbsp;i&nbsp;
            <span style="color: #0000FF; ">in</span>&nbsp;range(0,10000):
            <br />&nbsp;&nbsp;&nbsp;&nbsp;sent=p.send(message)
            <br />&nbsp;&nbsp;&nbsp;&nbsp;
            <span style="color: #0000FF; ">if</span>&nbsp;
            <span style="color: #0000FF; ">not</span>&nbsp;sent.success:
            <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <span style="color: #0000FF; ">print</span>&nbsp;
            <span style="color: #800000; ">&quot;</span>
            <span style="color: #800000; ">send&nbsp;failed</span>
            <span style="color: #800000; ">&quot;</span>
            <br />finish=time()
            <br />secs=finish-start
            <br />
            <span style="color: #0000FF; ">print</span>&nbsp;
            <span style="color: #800000; ">&quot;</span>
            <span style="color: #800000; ">duration:%s&nbsp;seconds</span>
            <span style="color: #800000; ">&quot;</span>&nbsp;%&nbsp;(secs)
            <br />
            <span style="color: #0000FF; ">print</span>&nbsp;
            <span style="color: #800000; ">&quot;</span>
            <span style="color: #800000; ">tps:%s&nbsp;msgs/second</span>
            <span style="color: #800000; ">&quot;</span>&nbsp;%&nbsp;(10000/secs)
            <br />p.close()
           </div>
           <span style="background-color: #eeeeee; "><br />&nbsp;结果：<br /><br /><br /></span>
           <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
            <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->duration:1.85962295532&nbsp;seconds
            <br />tps:5377.43415749&nbsp;msgs/second
           </div>
          </div>
         </div> 
         <p class="postfoot"> posted @ <a href="http://www.blogjava.net/killme2008/archive/2012/03/21/372405.html" title="permalink">2012-03-21 19:08</a> dennis 阅读(4955) | <a href="http://www.blogjava.net/killme2008/archive/2012/03/21/372405.html#FeedBack" title="comments, pingbacks, trackbacks">评论 (1)</a> |&nbsp;<a href="http://www.blogjava.net/killme2008/admin/EditPosts.aspx?postid=372405">编辑</a>&nbsp;<a href="http://www.blogjava.net/killme2008/AddToFavorite.aspx?id=372405">收藏</a> </p> 
        </div> 
        <div class="post" style="filter:progid:DXImageTransform.Microsoft.Shadow(color='Blue', Direction=135, Strength=32)"> 
         <div class="posthead"> 
          <h2 style="padding-top:4px; padding-bottom:4px;"><a id="ArchiveDay1_SingleDay_DayList_ctl17_TitleUrl" href="http://www.blogjava.net/killme2008/archive/2012/03/19/372179.html">xmemcached发布1.3.6</a></h2> 
         </div> 
         <div class="postbody">
          <p style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; font-family: Helvetica, Tahoma, Arial, sans-serif; line-height: 25px; text-align: left; background-color: #f7f7f7; ">&nbsp; &nbsp; 开源的memcached Java客户端――<a href="http://code.google.com/p/xmemcached/" target="_blank" style="color: #006699; ">xmemcached</a>发布1.3.6版本。</p> 
          <p style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; font-family: Helvetica, Tahoma, Arial, sans-serif; line-height: 25px; text-align: left; background-color: #f7f7f7; "><strong style="font-weight: bold; ">&nbsp; &nbsp; 主要改进如下：</strong>&nbsp;</p> 
          <p style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; font-family: Helvetica, Tahoma, Arial, sans-serif; line-height: 25px; text-align: left; background-color: #f7f7f7; ">1. &nbsp;为MemcachedClientBuilder添加两个新方法用于配置：<br /> </p>
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br />
<br />
Code highlighting produced by Actipro CodeHighlighter (freeware)<br />
http://www.CodeHighlighter.com/<br />
<br />
-->
           <span style="color: #0000FF; ">public</span>&nbsp;
           <span style="color: #0000FF; ">void</span>&nbsp;setConnectTimeout(
           <span style="color: #0000FF; ">long</span>&nbsp;connectTimeout);&nbsp;&nbsp;
           <br /> 
           <span style="color: #0000FF; ">public</span>&nbsp;
           <span style="color: #0000FF; ">void</span>&nbsp;setSanitizeKeys(
           <span style="color: #0000FF; ">boolean</span>&nbsp;sanitizeKeys);
          </div> 
          <p>&nbsp;</p> 
          <p style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; font-family: Helvetica, Tahoma, Arial, sans-serif; line-height: 25px; text-align: left; background-color: #f7f7f7; ">2. &nbsp;用于hibernate的XmemcachedClientFactoryd添加了connectTimeout属性，感谢网友<strong style="font-weight: bold; font-size: 13px; ">&nbsp;</strong><span style="font-size: 13px; ">Boli.Jiang的贡献。</span></p> 
          <p style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; font-family: Helvetica, Tahoma, Arial, sans-serif; line-height: 25px; text-align: left; background-color: #f7f7f7; ">3. &nbsp;添加新的枚举类型&nbsp;net.rubyeye.xmemcached.transcoders.CompressionMode，用于指定Transcoder的压缩类型，默认是ZIP压缩，可选择GZIP压缩。Transcoder接口添加setCompressionMode方法。</p> 
          <p style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; font-family: Helvetica, Tahoma, Arial, sans-serif; line-height: 25px; text-align: left; background-color: #f7f7f7; ">4. &nbsp;修改心跳规则，原来是在连接空闲的时候发起心跳，现在变成固定每隔5秒发起一次心跳检测连接。</p> 
          <p style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; font-family: Helvetica, Tahoma, Arial, sans-serif; line-height: 25px; text-align: left; background-color: #f7f7f7; ">5. &nbsp;修改默认参数，默认禁用nagle算法，默认将批量get的合并因子下降到50。</p> 
          <p style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; font-family: Helvetica, Tahoma, Arial, sans-serif; line-height: 25px; text-align: left; background-color: #f7f7f7; ">6. &nbsp;修复bug和改进，包括：<a href="http://code.google.com/p/xmemcached/issues/detail?id=161" target="_blank" style="color: #006699; ">161</a>、<a href="http://code.google.com/p/xmemcached/issues/detail?id=163" target="_blank" style="color: #006699; ">163</a>、<a href="http://code.google.com/p/xmemcached/issues/detail?id=165" target="_blank" style="color: #006699; ">165</a>、<a href="http://code.google.com/p/xmemcached/issues/detail?id=169" target="_blank" style="color: #006699; ">169</a>、<a href="http://code.google.com/p/xmemcached/issues/detail?id=172" target="_blank" style="color: #006699; ">172</a><a href="http://code.google.com/p/xmemcached/issues/detail?id=173" target="_blank" style="color: #006699; ">、173</a>、<a href="http://code.google.com/p/xmemcached/issues/detail?id=176" target="_blank" style="color: #006699; ">176</a>、<a href="http://code.google.com/p/xmemcached/issues/detail?id=179" target="_blank" style="color: #006699; ">179</a>和<a href="http://code.google.com/p/xmemcached/issues/detail?id=180" target="_blank" style="color: #006699; ">180</a>。</p> 
          <p style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; font-family: Helvetica, Tahoma, Arial, sans-serif; line-height: 25px; text-align: left; background-color: #f7f7f7; ">&nbsp;</p> 
          <p style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; font-family: Helvetica, Tahoma, Arial, sans-serif; line-height: 25px; text-align: left; background-color: #f7f7f7; ">项目主页：<a href="http://code.google.com/p/xmemcached/" target="_blank" style="color: #006699; ">http://code.google.com/p/xmemcached/</a></p> 
          <p style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; font-family: Helvetica, Tahoma, Arial, sans-serif; line-height: 25px; text-align: left; background-color: #f7f7f7; ">项目文档：<a href="http://code.google.com/p/xmemcached/w/list" target="_blank" style="color: #006699; ">http://code.google.com/p/xmemcached/w/list</a></p> 
          <p style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; font-family: Helvetica, Tahoma, Arial, sans-serif; line-height: 25px; text-align: left; background-color: #f7f7f7; ">下载：<a href="http://code.google.com/p/xmemcached/downloads/list" target="_blank" style="color: #006699; ">http://code.google.com/p/xmemcached/downloads/list</a></p> 
          <p style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; font-family: Helvetica, Tahoma, Arial, sans-serif; line-height: 25px; text-align: left; background-color: #f7f7f7; ">源码：<a href="https://github.com/killme2008/xmemcached" target="_blank" style="color: #006699; ">https://github.com/killme2008/xmemcached</a></p> 
          <p style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; font-family: Helvetica, Tahoma, Arial, sans-serif; line-height: 25px; text-align: left; background-color: #f7f7f7; ">&nbsp;</p> 
          <p style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; font-family: Helvetica, Tahoma, Arial, sans-serif; line-height: 25px; text-align: left; background-color: #f7f7f7; "><strong style="font-weight: bold; ">Maven依赖：</strong></p> 
          <p style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; font-family: Helvetica, Tahoma, Arial, sans-serif; line-height: 25px; text-align: left; background-color: #f7f7f7; ">&nbsp;<span style="background-color: #eeeeee; font-size: 13px; ">&lt;</span><span style="background-color: #eeeeee; font-size: 13px; ">dependency</span><span style="background-color: #eeeeee; font-size: 13px; ">&gt;</span><span style="background-color: #eeeeee; font-size: 13px; ">&nbsp;&nbsp;</span></p> 
          <div style="font-size: 13px; border-top-width: 1px; border-right-width: 1px; border-bottom-width: 1px; border-left-width: 1px; border-top-style: solid; border-right-style: solid; border-bottom-style: solid; border-left-style: solid; border-top-color: #cccccc; border-right-color: #cccccc; border-bottom-color: #cccccc; border-left-color: #cccccc; border-image: initial; padding-right: 5px; padding-bottom: 4px; padding-left: 4px; padding-top: 4px; width: 98%; word-break: break-all; background-color: #eeeeee; ">
           &nbsp;&nbsp;&nbsp;&nbsp;&lt;groupId&gt;com.googlecode.xmemcached&lt;/groupId&gt;&nbsp;&nbsp;
           <br /> &nbsp;&nbsp;&nbsp;&nbsp;&lt;artifactId&gt;xmemcached&lt;/artifactId&gt;&nbsp;&nbsp;
           <br /> &nbsp;&nbsp;&nbsp;&nbsp;&lt;version&gt;1.3.6&lt;/version&gt;&nbsp;&nbsp;
           <br /> &lt;/dependency&gt;&nbsp;
          </div> 
          <br />&nbsp; &nbsp; 最后感谢所有提出issue和改进意见的朋友们。
         </div> 
         <p class="postfoot"> posted @ <a href="http://www.blogjava.net/killme2008/archive/2012/03/19/372179.html" title="permalink">2012-03-19 10:51</a> dennis 阅读(4449) | <a href="http://www.blogjava.net/killme2008/archive/2012/03/19/372179.html#FeedBack" title="comments, pingbacks, trackbacks">评论 (3)</a> |&nbsp;<a href="http://www.blogjava.net/killme2008/admin/EditPosts.aspx?postid=372179">编辑</a>&nbsp;<a href="http://www.blogjava.net/killme2008/AddToFavorite.aspx?id=372179">收藏</a> </p> 
        </div> 
        <div class="post" style="filter:progid:DXImageTransform.Microsoft.Shadow(color='Blue', Direction=135, Strength=32)"> 
         <div class="posthead"> 
          <h2 style="padding-top:4px; padding-bottom:4px;"><a id="ArchiveDay1_SingleDay_DayList_ctl18_TitleUrl" href="http://www.blogjava.net/killme2008/archive/2012/03/16/372074.html">工作近况</a></h2> 
         </div> 
         <div class="postbody">
          &nbsp; &nbsp; 加入avos.com已经一个月多一点，很荣幸加入这个充满活力的跨国团队。去了趟北京，跟我的同事们终于当面认识了下，并且顺利举办了cn-clojure的第二次聚会。不过很悲剧的是在北京一周都在生病，哪也没去成，要见的人也没见到，要凑的饭局也没吃到，非常遗憾，希望以后再弥补。不过我暂时因为家庭的因素还在杭州远程办公，沟通都是通过gtalk和google＋ hangout，很多东西对我来说都是全新的经历。远程办公有利有弊，其实我还是更喜欢能在一个办公室里工作，交流方便，只要转个椅子就好。
          <br />
          <br />&nbsp; &nbsp; 正式介绍下我们公司，大boss是youtube创始人查德61赫利(Chad Hurley)和陈士骏(Steve Chen)，我们在中国的boss是前google员工/耶鲁的博士
          <a href="http://weibo.com/lazyseq">江宏帅哥</a>，更多关于团队成员的介绍请看
          <a href="http://team.mei.fm/about">这里</a>，我的同事们真的很强大，我要学习的地方很多。我们做的产品是从雅虎手上买下来的delicious.com，不过中国团队运作的是美味书签――
          <a href="http://mei.fm/">mei.fm</a>。我们刚在3月1号开始做public beta，预计会在4月份的时候正式对外开放注册。我们的团队博客在
          <a href="http://team.mei.fm/">这里</a>。
          <br />
          <br />&nbsp; &nbsp; 我在团队里做的事情还是偏向后端，这一个月来做的事情更偏向运维之类，搞搞solr复制、mysql复制、程序监控之类，将原来只是简单了解过的东西动手做了一遍，能亲手实践的感觉不错。在此过程中要感谢锋爷和刘帅哥的帮助，再次感谢。淘宝的同事们开源了metaq和gecko，我也做了点工作，都在
          <a href="http://www.blogjava.net/killme2008/archive/2012/03/16/372019.html">这里</a>。几个维护的开源项目都没有太大进展，很惭愧，还被人催发新版本，能承诺的是周末发xmemcached的新版本，主要还是修bug。本来要写个clojure世界的系列文章，因为响应寥寥，也不是很有动力写下去。杂七杂八读了几本书，都没读完，这一个月杭州太冷了，雨下个不停，不过终于这一周开始晴天了，希望老天爷别再掉眼泪。
          <br />
          <br />&nbsp; &nbsp; 收拾收拾心情，整装待发，希望新的一年里能做出点不同的东西。
          <br />&nbsp; &nbsp;&nbsp;
         </div> 
         <p class="postfoot"> posted @ <a href="http://www.blogjava.net/killme2008/archive/2012/03/16/372074.html" title="permalink">2012-03-16 22:59</a> dennis 阅读(2665) | <a href="http://www.blogjava.net/killme2008/archive/2012/03/16/372074.html#FeedBack" title="comments, pingbacks, trackbacks">评论 (7)</a> |&nbsp;<a href="http://www.blogjava.net/killme2008/admin/EditPosts.aspx?postid=372074">编辑</a>&nbsp;<a href="http://www.blogjava.net/killme2008/AddToFavorite.aspx?id=372074">收藏</a> </p> 
        </div> 
        <div class="post" style="filter:progid:DXImageTransform.Microsoft.Shadow(color='Blue', Direction=135, Strength=32)"> 
         <div class="posthead"> 
          <h2 style="padding-top:4px; padding-bottom:4px;"><a id="ArchiveDay1_SingleDay_DayList_ctl19_TitleUrl" href="http://www.blogjava.net/killme2008/archive/2012/03/16/372019.html">淘宝开源MQ――metamorphosis的github分支</a></h2> 
         </div> 
         <div class="postbody">
          <br /> &nbsp; &nbsp; 上周我在淘宝的同事开源了一个消息中间件
          <a href="http://metaq.taobao.org/">metamorphosis</a>，放在了
          <a href="http://metaq.taobao.org/">淘蝌蚪</a>上。我从淘蝌蚪的svn上fork了一个github的分支，放在了这里：
          <br /> 
          <div>
           &nbsp;1.主体工程：
           <a href="https://github.com/killme2008/Metamorphosis">https://github.com/killme2008/Metamorphosis<br /> </a> 
           <div style="display: inline !important; ">
            &nbsp;2.示例项目：
            <a href="https://github.com/killme2008/metamorphosis-example">https://github.com/killme2008/metamorphosis-example<br /> </a>
           </div> 
           <div>
            &nbsp;3.Twitter storm的spout项目：
            <a href="https://github.com/killme2008/storm-metamorphosis-spout">https://github.com/killme2008/storm-metamorphosis-spout<br /> </a>
           </div> &nbsp;&nbsp; &nbsp; 
           <br /> &nbsp; &nbsp; 主要做了一些pom文件的简化，发布1.4.0.2版本到maven central仓库，并且写了几个简单的入门文档，提供了一个完整打包可运行的下载，有兴趣的自己看github页面吧。 Wiki文档放在：
           <br /> &nbsp; &nbsp;&nbsp;
           <a href="https://github.com/killme2008/Metamorphosis/wiki">https://github.com/killme2008/Metamorphosis/wiki</a>
           <br /> &nbsp; &nbsp;
           <br /> &nbsp; &nbsp; &nbsp;客户端Maven依赖包括，可自行选择添加：
           <br /> 
           <div style="font-size: 13px; border-top-width: 1px; border-right-width: 1px; border-bottom-width: 1px; border-left-width: 1px; border-top-style: solid; border-right-style: solid; border-bottom-style: solid; border-left-style: solid; border-top-color: #cccccc; border-right-color: #cccccc; border-bottom-color: #cccccc; border-left-color: #cccccc; border-image: initial; padding-right: 5px; padding-bottom: 4px; padding-left: 4px; padding-top: 4px; width: 98%; word-break: break-all; background-color: #eeeeee; ">
            <!--<br />
<br />
Code highlighting produced by Actipro CodeHighlighter (freeware)<br />
http://www.CodeHighlighter.com/<br />
<br />
-->
            <span style="color: #0000FF; ">&lt;</span>
            <span style="color: #800000; ">dependency</span>
            <span style="color: #0000FF; ">&gt;</span>
            <br /> &nbsp;&nbsp;&nbsp;&nbsp;
            <span style="color: #0000FF; ">&lt;</span>
            <span style="color: #800000; ">groupId</span>
            <span style="color: #0000FF; ">&gt;</span>com.taobao.metamorphosis
            <span style="color: #0000FF; ">&lt;/</span>
            <span style="color: #800000; ">groupId</span>
            <span style="color: #0000FF; ">&gt;</span>
            <br /> &nbsp;&nbsp;&nbsp;&nbsp;
            <span style="color: #0000FF; ">&lt;</span>
            <span style="color: #800000; ">artifactId</span>
            <span style="color: #0000FF; ">&gt;</span>metamorphosis-client
            <span style="color: #0000FF; ">&lt;/</span>
            <span style="color: #800000; ">artifactId</span>
            <span style="color: #0000FF; ">&gt;</span>
            <br /> &nbsp;&nbsp;&nbsp;&nbsp;
            <span style="color: #0000FF; ">&lt;</span>
            <span style="color: #800000; ">version</span>
            <span style="color: #0000FF; ">&gt;</span>1.4.0.2
            <span style="color: #0000FF; ">&lt;/</span>
            <span style="color: #800000; ">version</span>
            <span style="color: #0000FF; ">&gt;</span>
            <br /> 
            <span style="color: #0000FF; ">&lt;/</span>
            <span style="color: #800000; ">dependency</span>
            <span style="color: #0000FF; ">&gt;</span>
            <br /> 
            <br /> 
            <span style="color: #0000FF; ">&lt;</span>
            <span style="color: #800000; ">dependency</span>
            <span style="color: #0000FF; ">&gt;</span>
            <br /> &nbsp;&nbsp;&nbsp;&nbsp;
            <span style="color: #0000FF; ">&lt;</span>
            <span style="color: #800000; ">groupId</span>
            <span style="color: #0000FF; ">&gt;</span>com.taobao.metamorphosis
            <span style="color: #0000FF; ">&lt;/</span>
            <span style="color: #800000; ">groupId</span>
            <span style="color: #0000FF; ">&gt;</span>
            <br /> &nbsp;&nbsp;&nbsp;&nbsp;
            <span style="color: #0000FF; ">&lt;</span>
            <span style="color: #800000; ">artifactId</span>
            <span style="color: #0000FF; ">&gt;</span>metamorphosis-client-extension
            <span style="color: #0000FF; ">&lt;/</span>
            <span style="color: #800000; ">artifactId</span>
            <span style="color: #0000FF; ">&gt;</span>
            <br /> &nbsp;&nbsp;&nbsp;&nbsp;
            <span style="color: #0000FF; ">&lt;</span>
            <span style="color: #800000; ">version</span>
            <span style="color: #0000FF; ">&gt;</span>1.4.0.2
            <span style="color: #0000FF; ">&lt;/</span>
            <span style="color: #800000; ">version</span>
            <span style="color: #0000FF; ">&gt;</span>
            <br /> 
            <span style="color: #0000FF; ">&lt;/</span>
            <span style="color: #800000; ">dependency</span>
            <span style="color: #0000FF; ">&gt;</span>
            <br /> 
            <br /> 
            <span style="color: #0000FF; ">&lt;</span>
            <span style="color: #800000; ">dependency</span>
            <span style="color: #0000FF; ">&gt;</span>
            <br /> &nbsp;&nbsp;&nbsp;&nbsp;
            <span style="color: #0000FF; ">&lt;</span>
            <span style="color: #800000; ">groupId</span>
            <span style="color: #0000FF; ">&gt;</span>com.taobao.metamorphosis
            <span style="color: #0000FF; ">&lt;/</span>
            <span style="color: #800000; ">groupId</span>
            <span style="color: #0000FF; ">&gt;</span>
            <br /> &nbsp;&nbsp;&nbsp;&nbsp;
            <span style="color: #0000FF; ">&lt;</span>
            <span style="color: #800000; ">artifactId</span>
            <span style="color: #0000FF; ">&gt;</span>storm-metamorphosis-spout
            <span style="color: #0000FF; ">&lt;/</span>
            <span style="color: #800000; ">artifactId</span>
            <span style="color: #0000FF; ">&gt;</span>
            <br /> &nbsp;&nbsp;&nbsp;&nbsp;
            <span style="color: #0000FF; ">&lt;</span>
            <span style="color: #800000; ">version</span>
            <span style="color: #0000FF; ">&gt;</span>1.0.0
            <span style="color: #0000FF; ">&lt;/</span>
            <span style="color: #800000; ">version</span>
            <span style="color: #0000FF; ">&gt;</span>
            <br /> 
            <span style="color: #0000FF; ">&lt;/</span>
            <span style="color: #800000; ">dependency</span>
            <span style="color: #0000ff; ">&gt;</span>
           </div> 
          </div> 
          <br />&nbsp; &nbsp; &nbsp;ps.我开通了新浪微博，有兴趣相互关注下：
          <a href="http://weibo.com/fnil">http://weibo.com/fnil</a>，你看，偏见是可以改变的。
         </div> 
         <p class="postfoot"> posted @ <a href="http://www.blogjava.net/killme2008/archive/2012/03/16/372019.html" title="permalink">2012-03-16 10:39</a> dennis 阅读(7590) | <a href="http://www.blogjava.net/killme2008/archive/2012/03/16/372019.html#FeedBack" title="comments, pingbacks, trackbacks">评论 (12)</a> |&nbsp;<a href="http://www.blogjava.net/killme2008/admin/EditPosts.aspx?postid=372019">编辑</a>&nbsp;<a href="http://www.blogjava.net/killme2008/AddToFavorite.aspx?id=372019">收藏</a> </p> 
        </div> 
        <div class="post" style="filter:progid:DXImageTransform.Microsoft.Shadow(color='Blue', Direction=135, Strength=32)"> 
         <div class="posthead"> 
          <h2 style="padding-top:4px; padding-bottom:4px;"><a id="ArchiveDay1_SingleDay_DayList_ctl20_TitleUrl" href="http://www.blogjava.net/killme2008/archive/2012/02/18/370260.html">Clojure-Control 0.3.0 is out</a></h2> 
         </div> 
         <div class="postbody">
          &nbsp;&nbsp;&nbsp; 
          <font><a href="https://github.com/killme2008/clojure-control" target="_blank">Clojure-control</a> is a clojure DSL for system admin and deployment with many remote machines via ssh.&nbsp; <br /></font>
          <font>&nbsp;&nbsp;&nbsp;&nbsp; <br />&nbsp;&nbsp;&nbsp; I am pleased to annoucment that clojure-control 0.3.0 is out.It adds some&nbsp; powerful features in this release ,includes:<br /> </font>
          <ul>
           <li><font>ssh and scp both have a new option :sudo&nbsp; to be executed as root on remote machines,for example:<br /></font><pre style="font-family:arial,helvetica,sans-serif"><font><code>(ssh &quot;/etc/init.d/ssh restart&quot; :sudo true)</code></font></pre> </li>
           <li><font>scp has a new&nbsp; option :mode to change file modes copied from local:&nbsp; <br /></font><pre style="font-family:arial,helvetica,sans-serif"><font><code>(scp &quot;start.sh&quot; &quot;/etc/init.d/start.sh&quot; :sudo true :mode 755)</code></font></pre> </li>
           <li><font>A&nbsp; new function &quot;exists?&quot; to test if a file exists on remote machines:&nbsp;&nbsp; <br /></font><pre style="font-family:arial,helvetica,sans-serif"><font><code>(if (not (exists? (str &quot;/home/deploy/.ssh&quot;))) (ssh (sudo (str &quot;mkdir -p /home/deploy/.ssh&quot;))))</code></font></pre></li>
           <li><font>Call other task in deftask with &quot;call&quot; function:</font><pre style="font-family:arial,helvetica,sans-serif"><font><code>(deftask :ps &quot;A task to grep process&quot; [process] (ssh (str &quot;ps aux | grep &quot; process))) (deftask :start_ha [] (ssh &quot;/etc/init.d/haproxy start&quot;) (call :ps &quot;haproxy&quot;))</code></font></pre></li>
           <li><font>A new function &quot;append&quot; to append a line to a file on remote machines:<br /></font><pre style="font-family:arial,helvetica,sans-serif"><font><code>(ssh (append &quot;/etc/hosts&quot; &quot;192.168.1.100 web&quot; :sudo true))</code></font></pre> </li>
           <li><font>A new function &quot;sed&quot; to replace lines in a file on remote machines,and comm/uncomm to comment/uncomment a line in a file:<br /></font><pre><font><code> <span style="font-family:arial,helvetica,sans-serif">(sed &lt;file&gt; &lt;before&gt; &lt;after&gt; :flags &lt;flags&gt; :limit &lt;limit&gt; :backup &lt;backup&gt;)</span> </code></font></pre> <p><font>Equivalent to</font></p> <pre style="font-family:arial,helvetica,sans-serif"><font><code> sed -i&lt;backup&gt; -r -e &quot;&lt;limit&gt; s/&lt;before&gt;/&lt;after&gt;/&lt;flags&gt;g &lt;filename&gt;&quot;</code></font></pre></li>
           <li><pre><font>Limits max output line to 10000.</font></pre> </li>
           <li><pre><font>Adds more documents in wiki: <span></span><a href="http://goog_909345399/" target="_blank">https://github.com/killme2008/<wbr />clojure-control/wiki</a><code><a> </a></code></font></pre></li>
          </ul>
          <font>&nbsp;&nbsp; You can install the new version by :<br /> </font> 
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br />
<br />
Code highlighting produced by Actipro CodeHighlighter (freeware)<br />
http://www.CodeHighlighter.com/<br />
<br />
-->
           <span style="color: #000000; ">&nbsp;&nbsp;&nbsp; lein&nbsp;plugin&nbsp;install&nbsp;control&nbsp;</span>
           <span style="color: #000000; ">0.3</span>
           <span style="color: #000000; ">.0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #008000; ">#</span>
           <span style="color: #008000; ">For&nbsp;clojure&nbsp;1.3</span>
           <span style="color: #008000; "><br /> </span>
           <span style="color: #000000; ">&nbsp;&nbsp;&nbsp; lein&nbsp;plugin&nbsp;install&nbsp;control&nbsp;</span>
           <span style="color: #000000; ">0.3</span>
           <span style="color: #000000; ">.</span>
           <span style="color: #000000; ">1</span>
           <span style="color: #000000; ">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #008000; ">#</span>
           <span style="color: #008000; ">For&nbsp;clojure&nbsp;1.2</span>
          </div>
          <font><code><br />&nbsp;&nbsp;&nbsp; More information please visit it on github: <a href="https://github.com/killme2008/clojure-control" target="_blank">https://github.com/killme2008/<wbr />clojure-control</a> </code><code></code></font>
         </div> 
         <p class="postfoot"> posted @ <a href="http://www.blogjava.net/killme2008/archive/2012/02/18/370260.html" title="permalink">2012-02-18 22:08</a> dennis 阅读(3220) | <a href="http://www.blogjava.net/killme2008/archive/2012/02/18/370260.html#FeedBack" title="comments, pingbacks, trackbacks">评论 (0)</a> |&nbsp;<a href="http://www.blogjava.net/killme2008/admin/EditPosts.aspx?postid=370260">编辑</a>&nbsp;<a href="http://www.blogjava.net/killme2008/AddToFavorite.aspx?id=370260">收藏</a> </p> 
        </div> 
        <div class="post" style="filter:progid:DXImageTransform.Microsoft.Shadow(color='Blue', Direction=135, Strength=32)"> 
         <div class="posthead"> 
          <h2 style="padding-top:4px; padding-bottom:4px;"><a id="ArchiveDay1_SingleDay_DayList_ctl21_TitleUrl" href="http://www.blogjava.net/killme2008/archive/2012/02/18/370233.html">Clojure世界：XML处理</a></h2> 
         </div> 
         <div class="postbody">
          &nbsp;&nbsp;&nbsp; XML处理也是个常见的编程工作，虽然说在Clojure里你很少使用XML做配置文件，但是跟遗留系统集成或者处理和其他系统通讯，可能都需要处理XML。
          <br />
          <br />&nbsp;&nbsp;&nbsp; Clojure的标准库clojure.xml就是用来干这个事情的。一个简单的例子如下，首先我们要解析的是下面这个简单的XML：
          <br />
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
           <span style="color: #0000FF; ">&lt;?</span>
           <span style="color: #FF00FF; ">xml&nbsp;version=&quot;1.0&quot;&nbsp;encoding=&quot;UTF-8&quot;</span>
           <span style="color: #0000FF; ">?&gt;</span>
           <span style="color: #000000; "><br /></span>
           <span style="color: #0000FF; ">&lt;</span>
           <span style="color: #800000; ">books</span>
           <span style="color: #0000FF; ">&gt;</span>
           <span style="color: #000000; "><br />&nbsp;&nbsp;</span>
           <span style="color: #0000FF; ">&lt;</span>
           <span style="color: #800000; ">book</span>
           <span style="color: #0000FF; ">&gt;</span>
           <span style="color: #000000; "><br />&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000FF; ">&lt;</span>
           <span style="color: #800000; ">title</span>
           <span style="color: #0000FF; ">&gt;</span>
           <span style="color: #000000; ">The&nbsp;joy&nbsp;of&nbsp;clojure</span>
           <span style="color: #0000FF; ">&lt;/</span>
           <span style="color: #800000; ">title</span>
           <span style="color: #0000FF; ">&gt;</span>
           <span style="color: #000000; "><br />&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000FF; ">&lt;</span>
           <span style="color: #800000; ">author</span>
           <span style="color: #0000FF; ">&gt;</span>
           <span style="color: #000000; ">Michael&nbsp;Fogus&nbsp;/&nbsp;Chris&nbsp;House</span>
           <span style="color: #0000FF; ">&lt;/</span>
           <span style="color: #800000; ">author</span>
           <span style="color: #0000FF; ">&gt;</span>
           <span style="color: #000000; "><br />&nbsp;&nbsp;</span>
           <span style="color: #0000FF; ">&lt;/</span>
           <span style="color: #800000; ">book</span>
           <span style="color: #0000FF; ">&gt;</span>
           <span style="color: #000000; "><br />&nbsp;&nbsp;</span>
           <span style="color: #0000FF; ">&lt;</span>
           <span style="color: #800000; ">book</span>
           <span style="color: #0000FF; ">&gt;</span>
           <span style="color: #000000; "><br />&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000FF; ">&lt;</span>
           <span style="color: #800000; ">title</span>
           <span style="color: #0000FF; ">&gt;</span>
           <span style="color: #000000; ">Programming&nbsp;clojure</span>
           <span style="color: #0000FF; ">&lt;/</span>
           <span style="color: #800000; ">title</span>
           <span style="color: #0000FF; ">&gt;</span>
           <span style="color: #000000; "><br />&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000FF; ">&lt;</span>
           <span style="color: #800000; ">author</span>
           <span style="color: #0000FF; ">&gt;</span>
           <span style="color: #000000; ">Stuart&nbsp;Halloway</span>
           <span style="color: #0000FF; ">&lt;/</span>
           <span style="color: #800000; ">author</span>
           <span style="color: #0000FF; ">&gt;</span>
           <span style="color: #000000; "><br />&nbsp;&nbsp;</span>
           <span style="color: #0000FF; ">&lt;/</span>
           <span style="color: #800000; ">book</span>
           <span style="color: #0000FF; ">&gt;</span>
           <span style="color: #000000; "><br />&nbsp;&nbsp;</span>
           <span style="color: #0000FF; ">&lt;</span>
           <span style="color: #800000; ">book</span>
           <span style="color: #0000FF; ">&gt;</span>
           <span style="color: #000000; "><br />&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000FF; ">&lt;</span>
           <span style="color: #800000; ">title</span>
           <span style="color: #0000FF; ">&gt;</span>
           <span style="color: #000000; ">Practical&nbsp;clojure</span>
           <span style="color: #0000FF; ">&lt;/</span>
           <span style="color: #800000; ">title</span>
           <span style="color: #0000FF; ">&gt;</span>
           <span style="color: #000000; "><br />&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000FF; ">&lt;</span>
           <span style="color: #800000; ">author</span>
           <span style="color: #0000FF; ">&gt;</span>
           <span style="color: #000000; ">Luke&nbsp;Van&nbsp;der&nbsp;Hart</span>
           <span style="color: #0000FF; ">&lt;/</span>
           <span style="color: #800000; ">author</span>
           <span style="color: #0000FF; ">&gt;</span>
           <span style="color: #000000; "><br />&nbsp;&nbsp;</span>
           <span style="color: #0000FF; ">&lt;/</span>
           <span style="color: #800000; ">book</span>
           <span style="color: #0000FF; ">&gt;</span>
           <span style="color: #000000; "><br /></span>
           <span style="color: #0000FF; ">&lt;/</span>
           <span style="color: #800000; ">books</span>
           <span style="color: #0000FF; ">&gt;</span>
          </div>
          <br />&nbsp;&nbsp;&nbsp; 解析xml用clojure.xml/parse方法即可，该方法返回一个clojure.xml/element这个struct-map组成的一棵树：
          <br />
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
           <span style="color: #000000; ">user</span>
           <span style="color: #000000; ">=&gt;</span>
           <span style="color: #000000; ">&nbsp;(use&nbsp;</span>
           <span style="color: #800000; ">'</span>
           <span style="color: #800000; ">[clojure.xml])</span>
           <span style="color: #800000; "><br /></span>
           <span style="color: #000000; ">nil<br />user</span>
           <span style="color: #000000; ">=&gt;</span>
           <span style="color: #000000; ">&nbsp;(parse&nbsp;</span>
           <span style="color: #800000; ">&quot;</span>
           <span style="color: #800000; ">test.xml</span>
           <span style="color: #800000; ">&quot;</span>
           <span style="color: #000000; ">)<br />{:tag&nbsp;:books,&nbsp;:attrs&nbsp;nil,&nbsp;:content <br />&nbsp;[{:tag&nbsp;:book,&nbsp;:attrs&nbsp;nil,&nbsp;:content&nbsp;[{:tag&nbsp;:title,&nbsp;:attrs&nbsp;nil,&nbsp;:content&nbsp;[</span>
           <span style="color: #800000; ">&quot;</span>
           <span style="color: #800000; ">The&nbsp;joy&nbsp;of&nbsp;clojure</span>
           <span style="color: #800000; ">&quot;</span>
           <span style="color: #000000; ">]}&nbsp;{:tag&nbsp;:author,&nbsp;:attrs&nbsp;nil,&nbsp;:content&nbsp;[</span>
           <span style="color: #800000; ">&quot;</span>
           <span style="color: #800000; ">Michael&nbsp;Fogus&nbsp;/&nbsp;Chris&nbsp;House</span>
           <span style="color: #800000; ">&quot;</span>
           <span style="color: #000000; ">]}]} <br />&nbsp;{:tag&nbsp;:book,&nbsp;:attrs&nbsp;nil,&nbsp;:content&nbsp;[{:tag&nbsp;:title,&nbsp;:attrs&nbsp;nil,&nbsp;:content&nbsp;[</span>
           <span style="color: #800000; ">&quot;</span>
           <span style="color: #800000; ">Programming&nbsp;clojure</span>
           <span style="color: #800000; ">&quot;</span>
           <span style="color: #000000; ">]}&nbsp;{:tag&nbsp;:author,&nbsp;:attrs&nbsp;nil,&nbsp;:content&nbsp;[</span>
           <span style="color: #800000; ">&quot;</span>
           <span style="color: #800000; ">Stuart&nbsp;Halloway</span>
           <span style="color: #800000; ">&quot;</span>
           <span style="color: #000000; ">]}]} <br />&nbsp;{:tag&nbsp;:book,&nbsp;:attrs&nbsp;nil,&nbsp;:content&nbsp;[{:tag&nbsp;:title,&nbsp;:attrs&nbsp;nil,&nbsp;:content&nbsp;[</span>
           <span style="color: #800000; ">&quot;</span>
           <span style="color: #800000; ">Practical&nbsp;clojure</span>
           <span style="color: #800000; ">&quot;</span>
           <span style="color: #000000; ">]}&nbsp;{:tag&nbsp;:author,&nbsp;:attrs&nbsp;nil,&nbsp;:content&nbsp;[</span>
           <span style="color: #800000; ">&quot;</span>
           <span style="color: #800000; ">Luke&nbsp;Van&nbsp;der&nbsp;Hart</span>
           <span style="color: #800000; ">&quot;</span>
           <span style="color: #000000; ">]}]}]}</span>
          </div>
          <br />这是一个嵌套的数据结构，每个节点都是clojure.xml/element结构，element包括：
          <br />
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
           <span style="color: #000000; ">(defstruct&nbsp;element&nbsp;:tag&nbsp;:attrs&nbsp;:content)</span>
          </div>&nbsp;&nbsp; tag、attrs和content属性，tag就是该节点的标签，attrs是一个属性的map，而content是它的内容或者子节点。element是一个struct map，它也定义了三个方法来分别获取这三个属性：
          <br />
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
           <span style="color: #000000; ">user</span>
           <span style="color: #000000; ">=&gt;</span>
           <span style="color: #000000; ">&nbsp;(</span>
           <span style="color: #0000FF; ">def</span>
           <span style="color: #000000; ">&nbsp;x&nbsp;(parse&nbsp;</span>
           <span style="color: #800000; ">&quot;</span>
           <span style="color: #800000; ">test.xml</span>
           <span style="color: #800000; ">&quot;</span>
           <span style="color: #000000; ">))<br /></span>
           <span style="color: #008000; ">#</span>
           <span style="color: #008000; ">'user/x</span>
           <span style="color: #008000; "><br /></span>
           <span style="color: #000000; ">user</span>
           <span style="color: #000000; ">=&gt;</span>
           <span style="color: #000000; ">&nbsp;(tag&nbsp;x)<br />:books<br />user</span>
           <span style="color: #000000; ">=&gt;</span>
           <span style="color: #000000; ">&nbsp;(attrs&nbsp;x)<br />nil<br />user</span>
           <span style="color: #000000; ">=&gt;</span>
           <span style="color: #000000; ">&nbsp;(content&nbsp;x)<br />[{:tag&nbsp;:book,&nbsp;:attrs&nbsp;nil,&nbsp;:content&nbsp;[{:tag&nbsp;:title,&nbsp;:attrs&nbsp;nil,&nbsp;:content&nbsp;[</span>
           <span style="color: #800000; ">&quot;</span>
           <span style="color: #800000; ">The&nbsp;joy&nbsp;of&nbsp;clojure</span>
           <span style="color: #800000; ">&quot;</span>
           <span style="color: #000000; ">]}&nbsp;{:tag&nbsp;:author,&nbsp;:attrs&nbsp;nil,&nbsp;:content&nbsp;[</span>
           <span style="color: #800000; ">&quot;</span>
           <span style="color: #800000; ">Michael&nbsp;Fogus&nbsp;/&nbsp;Chris&nbsp;House</span>
           <span style="color: #800000; ">&quot;</span>
           <span style="color: #000000; ">]}]} <br />{:tag&nbsp;:book,&nbsp;:attrs&nbsp;nil,&nbsp;:content&nbsp;[{:tag&nbsp;:title,&nbsp;:attrs&nbsp;nil,&nbsp;:content&nbsp;[</span>
           <span style="color: #800000; ">&quot;</span>
           <span style="color: #800000; ">Programming&nbsp;clojure</span>
           <span style="color: #800000; ">&quot;</span>
           <span style="color: #000000; ">]}&nbsp;{:tag&nbsp;:author,&nbsp;:attrs&nbsp;nil,&nbsp;:content&nbsp;[</span>
           <span style="color: #800000; ">&quot;</span>
           <span style="color: #800000; ">Stuart&nbsp;Halloway</span>
           <span style="color: #800000; ">&quot;</span>
           <span style="color: #000000;">]}]} <br />{:tag&nbsp;:book,&nbsp;:attrs&nbsp;nil,&nbsp;:content&nbsp;[{:tag&nbsp;:title,&nbsp;:attrs&nbsp;nil,&nbsp;:content&nbsp;[</span>
           <span style="color: #800000; ">&quot;</span>
           <span style="color: #800000; ">Practical&nbsp;clojure</span>
           <span style="color: #800000; ">&quot;</span>
           <span style="color: #000000; ">]}&nbsp;{:tag&nbsp;:author,&nbsp;:attrs&nbsp;nil,&nbsp;:content&nbsp;[</span>
           <span style="color: #800000; ">&quot;</span>
           <span style="color: #800000; ">Luke&nbsp;Van&nbsp;der&nbsp;Hart</span>
           <span style="color: #800000; ">&quot;</span>
           <span style="color: #000000; ">]}]}]</span>
          </div>&nbsp;&nbsp; books节点是root node，它的content就是三个book子节点，子节点组织成一个vector，我们可以随意操作：
          <br />
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
           <span style="color: #000000; ">user</span>
           <span style="color: #000000; ">=&gt;</span>
           <span style="color: #000000; ">&nbsp;(tag&nbsp;(first&nbsp;(content&nbsp;x)))<br />:book<br />user</span>
           <span style="color: #000000; ">=&gt;</span>
           <span style="color: #000000; ">&nbsp;(content&nbsp;(first&nbsp;(content&nbsp;x)))<br />[{:tag&nbsp;:title,&nbsp;:attrs&nbsp;nil,&nbsp;:content&nbsp;[</span>
           <span style="color: #800000; ">&quot;</span>
           <span style="color: #800000; ">The&nbsp;joy&nbsp;of&nbsp;clojure</span>
           <span style="color: #800000; ">&quot;</span>
           <span style="color: #000000; ">]}&nbsp;{:tag&nbsp;:author,&nbsp;:attrs&nbsp;nil,&nbsp;:content&nbsp;[</span>
           <span style="color: #800000; ">&quot;</span>
           <span style="color: #800000; ">Michael&nbsp;Fogus&nbsp;/&nbsp;Chris&nbsp;House</span>
           <span style="color: #800000; ">&quot;</span>
           <span style="color: #000000; ">]}]<br />user</span>
           <span style="color: #000000; ">=&gt;</span>
           <span style="color: #000000; ">&nbsp;(content&nbsp;(first&nbsp;(content&nbsp;(first&nbsp;(content&nbsp;x)))))<br />[</span>
           <span style="color: #800000; ">&quot;</span>
           <span style="color: #800000; ">The&nbsp;joy&nbsp;of&nbsp;clojure</span>
           <span style="color: #800000; ">&quot;</span>
           <span style="color: #000000; ">]</span>
          </div>
          <br />&nbsp;&nbsp;&nbsp;&nbsp; 额外提下，clojure.xml是利用SAX API做解析的。同样它还有个方法，可以将解析出来的结构还原成xml，通过emit：
          <br />
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
           <span style="color: #000000; ">user=&gt;&nbsp;(emit&nbsp;x)<br /><br /></span>
           <span style="color: #0000FF; ">&lt;?</span>
           <span style="color: #FF00FF; ">xml&nbsp;version='1.0'&nbsp;encoding='UTF-8'</span>
           <span style="color: #0000FF; ">?&gt;</span>
           <span style="color: #000000; "><br /></span>
           <span style="color: #0000FF; ">&lt;</span>
           <span style="color: #800000; ">books</span>
           <span style="color: #0000FF; ">&gt;</span>
           <span style="color: #000000; "><br /></span>
           <span style="color: #0000FF; ">&lt;</span>
           <span style="color: #800000; ">book</span>
           <span style="color: #0000FF; ">&gt;</span>
           <span style="color: #000000; "><br /></span>
           <span style="color: #0000FF; ">&lt;</span>
           <span style="color: #800000; ">title</span>
           <span style="color: #0000FF; ">&gt;</span>
           <span style="color: #000000; "><br />The&nbsp;joy&nbsp;of&nbsp;clojure<br /></span>
           <span style="color: #0000FF; ">&lt;/</span>
           <span style="color: #800000; ">title</span>
           <span style="color: #0000FF; ">&gt;</span>
           <span style="color: #000000; "><br /></span>
           <span style="color: #0000FF; ">&lt;</span>
           <span style="color: #800000; ">author</span>
           <span style="color: #0000FF; ">&gt;</span>
           <span style="color: #000000; "><br />Michael&nbsp;Fogus&nbsp;/&nbsp;Chris&nbsp;House<br /></span>
           <span style="color: #0000FF; ">&lt;/</span>
           <span style="color: #800000; ">author</span>
           <span style="color: #0000FF; ">&gt;</span>
           <span style="color: #000000; "><br /></span>
           <span style="color: #0000FF; ">&lt;/</span>
           <span style="color: #800000; ">book</span>
           <span style="color: #0000FF; ">&gt;</span>
           <span style="color: #000000; "><br /></span>
           <span style="color: #0000FF; ">&lt;</span>
           <span style="color: #800000; ">book</span>
           <span style="color: #0000FF; ">&gt;</span>
           <span style="color: #000000; "><br /><img src="http://www.blogjava.net/Images/dot.gif" alt="" /></span>
          </div>
          <br />&nbsp;&nbsp;&nbsp;&nbsp; 如果你要按照深度优先的顺序遍历xml，可以利用xml-seq将解析出来的树构成一个按照深度优先顺序排列节点的LazySeq，接下来就可以按照seq的方式处理，比如利用for来过滤节点：
          <br />
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
           <span style="color: #000000; ">user=&gt;&nbsp;(for&nbsp;[node&nbsp;(xml-seq&nbsp;x)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>:when&nbsp;(=&nbsp;:author&nbsp;(:tag&nbsp;node))</strong>]<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(first&nbsp;(:content&nbsp;node)))<br />(&quot;Michael&nbsp;Fogus&nbsp;/&nbsp;Chris&nbsp;House&quot;&nbsp;&quot;Stuart&nbsp;Halloway&quot;&nbsp;&quot;Luke&nbsp;Van&nbsp;der&nbsp;Hart&quot;)</span>
          </div>
          <br />&nbsp;&nbsp;&nbsp; 通过:when指定了条件，要求节点的tag是author，这样就可以查找出所有的author节点的content，是不是很方便？就像写英语描述一样。
          <br />
          <br />&nbsp;&nbsp;&nbsp; 更进一步，如果你想操作parse解析出来的这棵树，你还可以利用clojure.zip这个标准库，它有xml-zip函数将xml转换成zipper结构，并提供一系列方法来操作这棵树：
          <br />
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
           <strong><span style="color: #000000; ">user</span><span style="color: #000000; ">=&gt;</span><span style="color: #000000; ">(</span><span style="color: #0000FF; ">def</span><span style="color: #000000; ">&nbsp;xz&nbsp;(xml</span><span style="color: #000000; ">-</span></strong>
           <span style="color: #000000; "><strong>zip&nbsp;x))</strong><br /></span>
           <span style="color: #008000; ">#</span>
           <span style="color: #008000; ">'user/xz</span>
           <span style="color: #008000; "><br /></span>
           <strong><span style="color: #000000; ">user</span><span style="color: #000000; ">=&gt;</span></strong>
           <span style="color: #000000; "><strong>&nbsp;(node&nbsp;(down&nbsp;xz))</strong><br />{:tag&nbsp;:book,&nbsp;:attrs&nbsp;nil,&nbsp;:content&nbsp;[{:tag&nbsp;:title,&nbsp;:attrs&nbsp;nil,&nbsp;:content&nbsp;[</span>
           <span style="color: #800000; ">&quot;</span>
           <span style="color: #800000; ">The&nbsp;joy&nbsp;of&nbsp;clojure</span>
           <span style="color: #800000; ">&quot;</span>
           <span style="color: #000000; ">]}&nbsp;{:tag&nbsp;:author,&nbsp;:attrs&nbsp;nil,&nbsp;:content&nbsp;[</span>
           <span style="color: #800000; ">&quot;</span>
           <span style="color: #800000; ">Michael&nbsp;Fogus&nbsp;/&nbsp;Chris&nbsp;House</span>
           <span style="color: #800000; ">&quot;</span>
           <span style="color: #000000; ">]}]}<br /><strong>user</strong></span>
           <strong><span style="color: #000000; ">=&gt;</span><span style="color: #000000; ">&nbsp;(</span><span style="color: #000000; ">-&gt;</span></strong>
           <span style="color: #000000; "><strong>&nbsp;xz&nbsp;down&nbsp;right&nbsp;node)</strong><br />{:tag&nbsp;:book,&nbsp;:attrs&nbsp;nil,&nbsp;:content&nbsp;[{:tag&nbsp;:title,&nbsp;:attrs&nbsp;nil,&nbsp;:content&nbsp;[</span>
           <span style="color: #800000; ">&quot;</span>
           <span style="color: #800000; ">Programming&nbsp;clojure</span>
           <span style="color: #800000; ">&quot;</span>
           <span style="color: #000000; ">]}&nbsp;{:tag&nbsp;:author,&nbsp;:attrs&nbsp;nil,&nbsp;:content&nbsp;[</span>
           <span style="color: #800000; ">&quot;</span>
           <span style="color: #800000; ">Stuart&nbsp;Halloway</span>
           <span style="color: #800000; ">&quot;</span>
           <span style="color: #000000; ">]}]}<br /><strong>user</strong></span>
           <strong><span style="color: #000000; ">=&gt;</span><span style="color: #000000; ">&nbsp;(</span><span style="color: #000000; ">-&gt;</span></strong>
           <span style="color: #000000; "><strong>&nbsp;xz&nbsp;down&nbsp;right&nbsp;right&nbsp;node)</strong><br />{:tag&nbsp;:book,&nbsp;:attrs&nbsp;nil,&nbsp;:content&nbsp;[{:tag&nbsp;:title,&nbsp;:attrs&nbsp;nil,&nbsp;:content&nbsp;[</span>
           <span style="color: #800000; ">&quot;</span>
           <span style="color: #800000; ">Practical&nbsp;clojure</span>
           <span style="color: #800000; ">&quot;</span>
           <span style="color: #000000; ">]}&nbsp;{:tag&nbsp;:author,&nbsp;:attrs&nbsp;nil,&nbsp;:content&nbsp;[</span>
           <span style="color: #800000; ">&quot;</span>
           <span style="color: #800000; ">Luke&nbsp;Van&nbsp;der&nbsp;Hart</span>
           <span style="color: #800000; ">&quot;</span>
           <span style="color: #000000; ">]}]}<br /><strong>user</strong></span>
           <strong><span style="color: #000000; ">=&gt;</span><span style="color: #000000; ">&nbsp;(</span><span style="color: #000000; ">-&gt;</span></strong>
           <span style="color: #000000; "><strong>&nbsp;xz&nbsp;down&nbsp;right&nbsp;right&nbsp;lefts)</strong><br />({:tag&nbsp;:book,&nbsp;:attrs&nbsp;nil,&nbsp;:content&nbsp;[{:tag&nbsp;:title,&nbsp;:attrs&nbsp;nil,&nbsp;:content&nbsp;[</span>
           <span style="color: #800000; ">&quot;</span>
           <span style="color: #800000; ">The&nbsp;joy&nbsp;of&nbsp;clojure</span>
           <span style="color: #800000; ">&quot;</span>
           <span style="color: #000000; ">]}&nbsp;{:tag&nbsp;:author,&nbsp;:attrs&nbsp;nil,&nbsp;:content&nbsp;[</span>
           <span style="color: #800000; ">&quot;</span>
           <span style="color: #800000; ">Michael&nbsp;Fogus&nbsp;/&nbsp;Chris&nbsp;House</span>
           <span style="color: #800000; ">&quot;</span>
           <span style="color: #000000; ">]}]} <br />&nbsp;{:tag&nbsp;:book,&nbsp;:attrs&nbsp;nil,&nbsp;:content&nbsp;[{:tag&nbsp;:title,&nbsp;:attrs&nbsp;nil,&nbsp;:content&nbsp;[</span>
           <span style="color: #800000; ">&quot;</span>
           <span style="color: #800000; ">Programming&nbsp;clojure</span>
           <span style="color: #800000; ">&quot;</span>
           <span style="color: #000000; ">]}&nbsp;{:tag&nbsp;:author,&nbsp;:attrs&nbsp;nil,&nbsp;:content&nbsp;[</span>
           <span style="color: #800000; ">&quot;</span>
           <span style="color: #800000; ">Stuart&nbsp;Halloway</span>
           <span style="color: #800000; ">&quot;</span>
           <span style="color: #000000; ">]}]})<br /></span>
          </div>
          <br />&nbsp; 是不是酷得一塌糊涂？可以通过up,down,left,right,lefts,rights,来查找节点的邻近节点，可以通过node来得到节点本身。一切显得那么自然。更进一步，你还可以“编辑“这棵树，比如删除The joy of clojure这本书：
          <br />
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
           <span style="color: #000000; ">user</span>
           <span style="color: #000000; ">=&gt;</span>
           <span style="color: #000000; ">&nbsp;&nbsp;(</span>
           <span style="color: #0000FF; ">def</span>
           <span style="color: #000000; ">&nbsp;loc</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #0000FF; ">in</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">new</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">tree&nbsp;(remove&nbsp;(down&nbsp;xz)))<br /></span>
           <span style="color: #008000; ">#</span>
           <span style="color: #008000; ">'user/loc-in-new-tree</span>
           <span style="color: #008000; "><br /></span>
           <span style="color: #000000; ">user</span>
           <span style="color: #000000; ">=&gt;</span>
           <span style="color: #000000; ">&nbsp;(root&nbsp;loc</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #0000FF; ">in</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">new</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">tree)<br />{:tag&nbsp;:books,&nbsp;:attrs&nbsp;nil,&nbsp;:content <br />[{:tag&nbsp;:book,&nbsp;:attrs&nbsp;nil,&nbsp;:content&nbsp;[{:tag&nbsp;:title,&nbsp;:attrs&nbsp;nil,&nbsp;:content&nbsp;[</span>
           <span style="color: #800000; ">&quot;</span>
           <span style="color: #800000; ">Programming&nbsp;clojure</span>
           <span style="color: #800000; ">&quot;</span>
           <span style="color: #000000; ">]}&nbsp;{:tag&nbsp;:author,&nbsp;:attrs&nbsp;nil,&nbsp;:content&nbsp;[</span>
           <span style="color: #800000; ">&quot;</span>
           <span style="color: #800000; ">Stuart&nbsp;Halloway</span>
           <span style="color: #800000; ">&quot;</span>
           <span style="color: #000000; ">]}]} <br />{:tag&nbsp;:book,&nbsp;:attrs&nbsp;nil,&nbsp;:content&nbsp;[{:tag&nbsp;:title,&nbsp;:attrs&nbsp;nil,&nbsp;:content&nbsp;[</span>
           <span style="color: #800000; ">&quot;</span>
           <span style="color: #800000; ">Practical&nbsp;clojure</span>
           <span style="color: #800000; ">&quot;</span>
           <span style="color: #000000; ">]}&nbsp;{:tag&nbsp;:author,&nbsp;:attrs&nbsp;nil,&nbsp;:content&nbsp;[</span>
           <span style="color: #800000; ">&quot;</span>
           <span style="color: #800000; ">Luke&nbsp;Van&nbsp;der&nbsp;Hart</span>
           <span style="color: #800000; ">&quot;</span>
           <span style="color: #000000; ">]}]}]}</span>
          </div>
          <br />&nbsp;&nbsp; ok,只剩下两本书了，更多方法还包括replace做替换，edit更改节点等。因此编辑XML并重新生成，你一般可以利用clojure.zip来更改树，最后利用clojure.xml/emit将更改还原为xml。
          <br />
          <br />&nbsp;&nbsp;&nbsp; 生成xml除了emit方法，还有一个contrib库，也就是
          <a href="http://richhickey.github.com/clojure-contrib/prxml-api.html">prxml</a>，这个库的clojure 1.3版本有人维护了一个分支，在
          <a href="https://github.com/weissjeffm/clojure.prxml">这里</a>。主要方法就是prxml，它可以将clojure的数据结构转换成xml：
          <br />
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
           <span style="color: #000000; ">user</span>
           <span style="color: #000000; ">=&gt;</span>
           <span style="color: #000000; ">(prxml&nbsp;[:p&nbsp;[:raw!&nbsp;</span>
           <span style="color: #800000; ">&quot;</span>
           <span style="color: #800000; ">&lt;i&gt;here&nbsp;&amp;&nbsp;gone&lt;/i&gt;</span>
           <span style="color: #800000; ">&quot;</span>
           <span style="color: #000000; ">]])<br /></span>
           <span style="color: #000000; ">&lt;</span>
           <span style="color: #000000; ">p</span>
           <span style="color: #000000; ">&gt;&lt;</span>
           <span style="color: #000000; ">i</span>
           <span style="color: #000000; ">&gt;</span>
           <span style="color: #000000; ">here&nbsp;</span>
           <span style="color: #000000; ">&amp;</span>
           <span style="color: #000000; ">&nbsp;gone</span>
           <span style="color: #000000; ">&lt;/</span>
           <span style="color: #000000; ">i</span>
           <span style="color: #000000; ">&gt;&lt;/</span>
           <span style="color: #000000; ">p</span>
           <span style="color: #000000; ">&gt;</span>
          </div>&nbsp;&nbsp;&nbsp; 显然，它也可以用于生成HTML。
          <br />
          <br />&nbsp;&nbsp;&nbsp; xpath的支持可以使用
          <a href="https://github.com/kyleburton/clj-xpath">clj-xpath</a>这个开源库，遗憾的是它目前仅支持clojure 1.2。
          <br />
          <br />&nbsp;&nbsp;&nbsp; 转载请注明出处：
          <a href="http://www.blogjava.net/killme2008/archive/2012/02/18/370233.html">http://www.blogjava.net/killme2008/archive/2012/02/18/370233.html</a>&nbsp;&nbsp;&nbsp;
         </div> 
         <p class="postfoot"> posted @ <a href="http://www.blogjava.net/killme2008/archive/2012/02/18/370233.html" title="permalink">2012-02-18 12:21</a> dennis 阅读(3775) | <a href="http://www.blogjava.net/killme2008/archive/2012/02/18/370233.html#FeedBack" title="comments, pingbacks, trackbacks">评论 (0)</a> |&nbsp;<a href="http://www.blogjava.net/killme2008/admin/EditPosts.aspx?postid=370233">编辑</a>&nbsp;<a href="http://www.blogjava.net/killme2008/AddToFavorite.aspx?id=370233">收藏</a> </p> 
        </div> 
        <div class="post" style="filter:progid:DXImageTransform.Microsoft.Shadow(color='Blue', Direction=135, Strength=32)"> 
         <div class="posthead"> 
          <h2 style="padding-top:4px; padding-bottom:4px;"><a id="ArchiveDay1_SingleDay_DayList_ctl22_TitleUrl" href="http://www.blogjava.net/killme2008/archive/2012/02/16/370144.html">Clojure世界：文件IO</a></h2> 
         </div> 
         <div class="postbody">
          &nbsp;&nbsp;&nbsp; 文件读写是日常编程中最经常使用的操作之一。这篇blog将大概介绍下Clojure里对文件操作的常用类库。
          <br />
          <br />&nbsp;&nbsp;&nbsp; 首先介绍标准库
          <a href="http://richhickey.github.com/clojure/clojure.java.io-api.html">clojure.java.io</a>，这是最经常用的IO库，定义了常见的IO操作。
          <br />
          <br />&nbsp;&nbsp;&nbsp; 首先，直接看一个例子，可以熟悉下大多数常用的函数：
          <br />
          <div style="background-color: #eeeeee; font-size: 13px; border: 1px solid #cccccc; padding: 4px 5px 4px 4px; width: 98%;">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
           <span style="color: #000000;">(ns&nbsp;io<br />&nbsp;&nbsp;(:use&nbsp;[clojure.java.io]))<br /><br />;;file函数，获取一个java.io.File对象<br />(</span>
           <span style="color: #0000FF; ">def</span>
           <span style="color: #000000; ">&nbsp;f&nbsp;(file&nbsp;</span>
           <span style="color: #800000; ">&quot;</span>
           <span style="color: #800000; ">a.txt</span>
           <span style="color: #800000; ">&quot;</span>
           <span style="color: #000000; ">))<br /><br />;;拷贝文件使用copy<br />(copy&nbsp;f&nbsp;(file&nbsp;</span>
           <span style="color: #800000; ">&quot;</span>
           <span style="color: #800000; ">b.txt</span>
           <span style="color: #800000; ">&quot;</span>
           <span style="color: #000000; ">))<br /><br />;;删除文件，使用delete</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">file<br />(delete</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">file&nbsp;f)<br /><br />;;更经常使用reader和writer<br />(</span>
           <span style="color: #0000FF; ">def</span>
           <span style="color: #000000; ">&nbsp;rdr&nbsp;(reader&nbsp;</span>
           <span style="color: #800000; ">&quot;</span>
           <span style="color: #800000; ">b.txt</span>
           <span style="color: #800000; ">&quot;</span>
           <span style="color: #000000; ">&nbsp;:encoding&nbsp;</span>
           <span style="color: #800000; ">&quot;</span>
           <span style="color: #800000; ">utf-8</span>
           <span style="color: #800000; ">&quot;</span>
           <span style="color: #000000; ">))<br />(</span>
           <span style="color: #0000FF; ">def</span>
           <span style="color: #000000; ">&nbsp;wtr&nbsp;(writer&nbsp;</span>
           <span style="color: #800000; ">&quot;</span>
           <span style="color: #800000; ">c.txt</span>
           <span style="color: #800000; ">&quot;</span>
           <span style="color: #000000; ">&nbsp;:append&nbsp;true))<br /><br />;;copy可以接受多种类型的参数<br />(copy&nbsp;rdr&nbsp;wtr&nbsp;:buffer</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">size&nbsp;</span>
           <span style="color: #000000; ">4096</span>
           <span style="color: #000000; ">)<br /><br />;;关闭文件<br />(.close&nbsp;wtr)<br />(.close&nbsp;rdr)<br /><br /><br /></span>
          </div>
          <br />&nbsp;&nbsp;&nbsp; 这个例子基本上说明了大多数常见的操作。但是有些问题需要解释下。
          <br />
          <br />&nbsp;&nbsp;&nbsp; 首先，通过file这个函数可以将各种类型的对象转化为java.io.File对象，file可以接受String,URL,URI以及java.io.File本身作为参数，并返回java.io.File。有了File对象，你就可以调用java.io.File类中的各种方法，比如判断文件是否存在：
          <br />
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
           <span style="color: #000000; ">(.exists&nbsp;(file&nbsp;</span>
           <span style="color: #800000; ">&quot;</span>
           <span style="color: #800000; ">a.txt</span>
           <span style="color: #800000; ">&quot;</span>
           <span style="color: #000000; ">))&nbsp;</span>
           <span style="color: #000000; ">=&gt;</span>
           <span style="color: #000000; ">&nbsp;true&nbsp;</span>
           <span style="color: #0000FF; ">or</span>
           <span style="color: #000000; ">&nbsp;false</span>
          </div>
          <br />&nbsp;&nbsp;&nbsp; 其次，可以通过delete-file来删除一个文件，它是调用File的delete方法来执行的，但是File.delete会返回一个布尔值告诉你成功还是失败，如果返回false，那么delete-file会抛出IO异常，如果你不想被这个异常打扰，可以让它“保持安静”：
          <br />
          <div style="background-color: #eeeeee; font-size: 13px; border: 1px solid #cccccc; padding: 4px 5px 4px 4px; width: 98%;">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->&nbsp;&nbsp;&nbsp; 
           <span style="color: #000000; ">(delete</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">file&nbsp;f&nbsp;<strong>true</strong>)</span>
          </div>
          <br />&nbsp;&nbsp;&nbsp; 拷贝文件很简单，使用copy搞定，copy也可以很“宽容”，也可以接受多种类型的参数并帮你自动转换，input可以是InputStream, Reader, File, byte[] 或者String，而output可以是OutputStream, Writer或者File。是不是很给力？这都是通过Clojure的protocol和defmulti做到的。但是，copy并不帮你处理文件的关闭问题，假设你传入的input是一个File，output也是一个File，copy会自动帮你打开InputStream和OutputStream并建立缓冲区做拷贝，但是它不会帮你关闭这两个流，因此你要小心，如果你经常使用copy，这可能是个内存泄漏的隐患。
          <br />
          <br />&nbsp;&nbsp;&nbsp; 更常用的，我们一般都是用reader和writer函数来打开一个BufferedReader和BufferedWriter做读写，同样reader和writer也可以接受多种多样的参数类型，甚至包括Socket也可以。因为writer打开的通常是一个BufferedWriter，所以你如果用它写文件，有时候发现write之后文件还是没有内容，这是因为数据暂时写到了缓冲区里，没有刷入到磁盘，可以明确地调用(.flush wtr)来强制写入；或者在wtr关闭后系统帮你写入。reader和writer还可以传入一些配置项，如:encoding指定读写的字符串编码，writer可以指定是否为append模式等。
          <br />
          <br />&nbsp;&nbsp;&nbsp; Clojure并没有提供关闭文件的函数或者宏，你简单地调用close方法即可。clojure.java.io的设计很有原则，它不准备将java.io都封装一遍，而是提供一些最常用方法的简便wrapper供你使用。
          <br />
          <br />&nbsp;&nbsp;&nbsp; 刚才提到copy不会帮你关闭打开的文件流，但是我们可以利用with-open这个宏来自动帮你管理打开的流：
          <br />
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
           <span style="color: #000000; ">(with</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">open&nbsp;[rdr&nbsp;(reader&nbsp;</span>
           <span style="color: #800000; ">&quot;</span>
           <span style="color: #800000; ">b.txt</span>
           <span style="color: #800000; ">&quot;</span>
           <span style="color: #000000; ">)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;wtr&nbsp;(writer&nbsp;</span>
           <span style="color: #800000; ">&quot;</span>
           <span style="color: #800000; ">c.txt</span>
           <span style="color: #800000; ">&quot;</span>
           <span style="color: #000000; ">)]<br />&nbsp;&nbsp;(copy&nbsp;rdr&nbsp;wtr))</span>
          </div>
          <br />&nbsp;&nbsp; with-open宏会自动帮你关闭在binding vector里打开的流，你不再需要自己调用close，也不用担心不小心造成内存泄漏。因此我会推荐你尽量用reader和writer结合with-open来做文件操作，而不要使用file函数。file函数应该用在一些判断是否存在，判断文件是否为目录等操作上。
          <br />
          <br />&nbsp;&nbsp;&nbsp; 在clojure.core里，还有两个最常用的函数slurp和spit，一个吃，一个吐，也就是slurp读文件，而spit写文件，他们类似Ruby的File里的read和write，用来完整地读或者写文件：
          <br />
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->&nbsp;&nbsp;&nbsp; 
           <span style="color: #000000; ">(prn&nbsp;(slurp&nbsp;</span>
           <span style="color: #800000; ">&quot;</span>
           <span style="color: #800000; ">c.txt</span>
           <span style="color: #800000; ">&quot;</span>
           <span style="color: #000000;">))<br /></span>&nbsp;&nbsp;&nbsp; 
           <span style="color: #000000; ">(spit&nbsp;</span>
           <span style="color: #800000; ">&quot;</span>
           <span style="color: #800000; ">c.txt</span>
           <span style="color: #800000; ">&quot;</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #800000; ">&quot;</span>
           <span style="color: #800000; ">hello&nbsp;world</span>
           <span style="color: #800000; ">&quot;</span>
           <span style="color: #000000; ">)</span>
          </div>
          <br />&nbsp;&nbsp; 用法简单明了，slurp将文件完整地读出并返回字符串作为结果，它还接受:encoding参数来指定字符串编码，你猜的没错，它就是用reader和with-open实现的。spit同样很简单，将content转化为字符串写入文件，也接受:encoding和:append参数。
          <br />
          <br />&nbsp;&nbsp;&nbsp; 深度优先遍历目录，可以使用file-seq，返回一个深度优先顺序遍历的目录列表，这是一个LazySeq：
          <br />
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
           <span style="color: #000000; ">(user</span>
           <span style="color: #000000; ">=&gt;</span>
           <span style="color: #000000; ">&nbsp;(file</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">seq&nbsp;(java.io.File.&nbsp;</span>
           <span style="color: #800000; ">&quot;</span>
           <span style="color: #800000; ">.</span>
           <span style="color: #800000; ">&quot;</span>
           <span style="color: #000000; ">))<br /><br /><br />(</span>
           <span style="color: #008000; ">#</span>
           <span style="color: #008000; ">&lt;File&nbsp;.&gt;&nbsp;#&lt;File&nbsp;./.gitignore&gt;&nbsp;#&lt;File&nbsp;./.lein-deps-sum&gt;&nbsp;#&lt;File&nbsp;./b.txt&gt;&nbsp;#&lt;File&nbsp;./c.txt&gt;&nbsp;#&lt;File&nbsp;./classes&gt; 6868 )<br /></span>
          </div>
          <br />&nbsp;&nbsp;&nbsp; 上面的介绍已经足以让你对付大多数需求了。接下来，介绍下几个开源库。首先是
          <a href="https://github.com/Raynes/fs/">fs</a>这个库，它封装了java.io.File类的大多数方法，让你用起来很clojure way，很舒服，例如：
          <br />
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
           <span style="color: #000000; ">(exists?&nbsp;</span>
           <span style="color: #800000; ">&quot;</span>
           <span style="color: #800000; ">a.txt</span>
           <span style="color: #800000; ">&quot;</span>
           <span style="color: #000000; ">)<br />(directory?&nbsp;</span>
           <span style="color: #800000; ">&quot;</span>
           <span style="color: #800000; ">file</span>
           <span style="color: #800000; ">&quot;</span>
           <span style="color: #000000; ">)<br />(file?&nbsp;</span>
           <span style="color: #800000; ">&quot;</span>
           <span style="color: #800000; ">file</span>
           <span style="color: #800000; ">&quot;</span>
           <span style="color: #000000; ">)<br />(name&nbsp;</span>
           <span style="color: #800000; ">&quot;</span>
           <span style="color: #800000; ">/home/dennis/.inputrc</span>
           <span style="color: #800000; ">&quot;</span>
           <span style="color: #000000; ">)<br />(mkdir&nbsp;</span>
           <span style="color: #800000; ">&quot;</span>
           <span style="color: #800000; ">/var/data</span>
           <span style="color: #800000; ">&quot;</span>
           <span style="color: #000000; ">)<br />(rename&nbsp;</span>
           <span style="color: #800000; ">&quot;</span>
           <span style="color: #800000; ">a.txt</span>
           <span style="color: #800000; ">&quot;</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #800000; ">&quot;</span>
           <span style="color: #800000; ">b.txt</span>
           <span style="color: #800000; ">&quot;</span>
           <span style="color: #000000; ">)<br />(</span>
           <span style="color: #0000FF; ">def</span>
           <span style="color: #000000; ">&nbsp;tmp&nbsp;(temp</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">dir))<br />(glob&nbsp;</span>
           <span style="color: #008000; ">#</span>
           <span style="color: #008000; ">&quot;.*test.*&quot;)</span>
           <span style="color: #008000; "><br /></span>
           <span style="color: #000000; ">(chmod&nbsp;</span>
           <span style="color: #000000; ">744</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #800000; ">&quot;</span>
           <span style="color: #800000; ">a.txt</span>
           <span style="color: #800000; ">&quot;</span>
           <span style="color: #000000; ">)<br /><br />6868</span>
          </div>
          <br />&nbsp;&nbsp;&nbsp; 更多介绍请看它的
          <a href="https://github.com/Raynes/fs/">源码</a>。读写二进制文件也是一个很常见的需求，Clojure有几个DSL库干这个事情，可以很直观地定义二进制格式来encode/decode，比如
          <a href="https://github.com/rosejn/byte-spec">byte-spec</a>这个库，看看它的例子：
          <br />
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
           <span style="color: #000000; ">defspec&nbsp;basic</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">spec<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:a&nbsp;:int8<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:b&nbsp;:int16<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:c&nbsp;:int32<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:d&nbsp;:float32<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:e&nbsp;:float64<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:f&nbsp;:string)<br /><br />;;&nbsp;An&nbsp;object&nbsp;to&nbsp;serialize<br />(</span>
           <span style="color: #0000FF; ">def</span>
           <span style="color: #000000; ">&nbsp;foo&nbsp;{:a&nbsp;</span>
           <span style="color: #000000; ">10</span>
           <span style="color: #000000; ">&nbsp;:b&nbsp;</span>
           <span style="color: #000000; ">20</span>
           <span style="color: #000000; ">&nbsp;:c&nbsp;</span>
           <span style="color: #000000; ">40</span>
           <span style="color: #000000; ">&nbsp;:d&nbsp;</span>
           <span style="color: #000000; ">23.2</span>
           <span style="color: #000000; ">&nbsp;:e&nbsp;</span>
           <span style="color: #000000; ">23.2</span>
           <span style="color: #000000; ">&nbsp;:f&nbsp;</span>
           <span style="color: #800000; ">&quot;</span>
           <span style="color: #800000; ">asddf</span>
           <span style="color: #800000; ">&quot;</span>
           <span style="color: #000000; ">})<br /><br />;;&nbsp;And&nbsp;serialize&nbsp;it&nbsp;to&nbsp;a&nbsp;byte&nbsp;array&nbsp;like&nbsp;this:<br />(spec</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">write</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">bytes&nbsp;basic</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">spec&nbsp;foo)&nbsp;;;&nbsp;</span>
           <span style="color: #000000; ">=&gt;</span>
           <span style="color: #000000; ">&nbsp;[<img src="http://www.blogjava.net/Images/dot.gif" alt="" />bytes<img src="http://www.blogjava.net/Images/dot.gif" alt="" />]<br /><br />;;&nbsp;reading&nbsp;</span>
           <span style="color: #0000FF; ">in</span>
           <span style="color: #000000; ">&nbsp;a&nbsp;byte&nbsp;array&nbsp;with&nbsp;the&nbsp;basic</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">spec&nbsp;format&nbsp;works&nbsp;like&nbsp;this:<br />(spec</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">read</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">bytes&nbsp;basic</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">spec&nbsp;bytes)</span>
          </div>&nbsp;&nbsp;&nbsp; 相当直观和给力吧。
          <a href="https://github.com/ztellman/gloss/wiki/Introduction">Gloss</a>是一个更强大的DSL库，非常适合做网络通讯的协议处理。这里就不多做介绍了，你可以自己看它的例子和文档。
          <br />&nbsp;&nbsp;&nbsp; 
          <br />&nbsp;&nbsp;&nbsp; 转载请注明出处：
          <a id="Editor_Edit_hlEntryLink" title="view: Clojure世界：文件IO" href="../archive/2012/02/16/370144.html" target="_blank">http://www.blogjava.net/killme2008/archive/2012/02/16/370144.html</a>
          <br />&nbsp;&nbsp;&nbsp;
         </div> 
         <p class="postfoot"> posted @ <a href="http://www.blogjava.net/killme2008/archive/2012/02/16/370144.html" title="permalink">2012-02-16 22:38</a> dennis 阅读(5997) | <a href="http://www.blogjava.net/killme2008/archive/2012/02/16/370144.html#FeedBack" title="comments, pingbacks, trackbacks">评论 (3)</a> |&nbsp;<a href="http://www.blogjava.net/killme2008/admin/EditPosts.aspx?postid=370144">编辑</a>&nbsp;<a href="http://www.blogjava.net/killme2008/AddToFavorite.aspx?id=370144">收藏</a> </p> 
        </div> 
        <div class="post" style="filter:progid:DXImageTransform.Microsoft.Shadow(color='Blue', Direction=135, Strength=32)"> 
         <div class="posthead"> 
          <h2 style="padding-top:4px; padding-bottom:4px;"><a id="ArchiveDay1_SingleDay_DayList_ctl23_TitleUrl" href="http://www.blogjava.net/killme2008/archive/2012/02/15/370040.html">Clojure世界：单元测试</a></h2> 
         </div> 
         <div class="postbody">
          &nbsp;&nbsp;&nbsp; 单元测试也是一个开发中最常见的需求，在Java里我们用JUnit或者TestNG，在clojure里也内置了单元测试的库。标准库的
          <a href="http://richhickey.github.com/clojure/clojure.test-api.html">clojure.test</a>，以及第三方框架
          <a href="https://github.com/marick/Midje">midje</a>。这里我将主要介绍clojure.test这个标准库，midje是个更加强大的测试框架，广告下，midje的介绍在第二次cn-clojure聚会上将有个Topic，我就不画蛇添足了。通常来说，clojure.test足够让你对付日常的测试。
          <br />
          <br />&nbsp;&nbsp;&nbsp; 首先看一个最简单的例子，定义一个函数square来计算平方，然后我们测试这个函数：
          <br />
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
           <span style="color: #000000; ">;;引用clojure.test<br />(ns&nbsp;example<br />&nbsp;&nbsp;(:use&nbsp;[clojure.test&nbsp;:only&nbsp;[deftest&nbsp;</span>
           <span style="color: #0000FF; ">is</span>
           <span style="color: #000000; ">&nbsp;run</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">tests]]))<br />;;定义函数<br />(defn&nbsp;square&nbsp;[x]<br />&nbsp;&nbsp;(</span>
           <span style="color: #000000; ">*</span>
           <span style="color: #000000; ">&nbsp;x&nbsp;x))<br />;;测试函数<br />(deftest&nbsp;test</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">square </span>
           <span style="color: #800000; "></span>
           <span style="color: #000000; "><br />&nbsp;&nbsp;(</span>
           <span style="color: #0000FF; ">is</span>
           <span style="color: #000000; ">&nbsp;(</span>
           <span style="color: #000000; ">=</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #000000; ">4</span>
           <span style="color: #000000; ">&nbsp;(square&nbsp;</span>
           <span style="color: #000000; ">2</span>
           <span style="color: #000000; ">)))<br />&nbsp;&nbsp;(</span>
           <span style="color: #0000FF; ">is</span>
           <span style="color: #000000; ">&nbsp;(</span>
           <span style="color: #000000; ">=</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #000000; ">9</span>
           <span style="color: #000000; ">&nbsp;(square&nbsp;</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">3</span>
           <span style="color: #000000; ">))))<br />;;运行测试<br />(run</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">tests&nbsp;</span>
           <span style="color: #800000; ">'</span>
           <span style="color: #800000; ">example)</span>
          </div>
          <br />&nbsp;&nbsp;&nbsp; 执行输出：
          <br />
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
           <span style="color: #000000; "><br />Testing&nbsp;example<br /><br />Ran&nbsp;</span>
           <span style="color: #000000; ">1</span>
           <span style="color: #000000; ">&nbsp;tests&nbsp;containing&nbsp;</span>
           <span style="color: #000000; ">2</span>
           <span style="color: #000000; ">&nbsp;assertions.<br />0&nbsp;failures,&nbsp;0&nbsp;errors.</span>
          </div>
          <br />&nbsp;&nbsp;&nbsp; 这个小例子基本说明了clojure.test的主要功能。
          <strong>首先是断言is</strong>，类似JUnit里的assertTrue，用来判断form是否为true，它还可以接受一个额外的msg参数来描述断言：
          <br />
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
           <span style="color: #000000; ">&nbsp;(</span>
           <span style="color: #0000FF; ">is</span>
           <span style="color: #000000; ">&nbsp;(</span>
           <span style="color: #000000; ">=</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #000000; ">4</span>
           <span style="color: #000000; ">&nbsp;(square&nbsp;</span>
           <span style="color: #000000; ">2</span>
           <span style="color: #000000; ">))&nbsp;</span>
           <span style="color: #800000; ">&quot;</span>
           <span style="color: #800000; ">a&nbsp;test</span>
           <span style="color: #800000; ">&quot;</span>
           <span style="color: #000000; ">)</span>
          </div>&nbsp;&nbsp;&nbsp; 它还有两种变形，专门用来判断测试是否抛出异常：
          <br />
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
           <span style="color: #000000; ">&nbsp;(</span>
           <span style="color: #0000FF; ">is</span>
           <span style="color: #000000; ">&nbsp;(thrown?&nbsp;RuntimeException&nbsp;(square&nbsp;</span>
           <span style="color: #800000; ">&quot;</span>
           <span style="color: #800000; ">a</span>
           <span style="color: #800000; ">&quot;</span>
           <span style="color: #000000; ">)))<br />&nbsp;(</span>
           <span style="color: #0000FF; ">is</span>
           <span style="color: #000000; ">&nbsp;(thrown</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">with</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">msg?&nbsp;RuntimeException&nbsp;</span>
           <span style="color: #008000; ">#</span>
           <span style="color: #008000; ">&quot;java.lang.String&nbsp;cannot&nbsp;be&nbsp;cast&nbsp;to&nbsp;java.lang.Number&quot;&nbsp;&nbsp;(square&nbsp;&quot;a&quot;)))</span>
          </div>&nbsp;&nbsp;&nbsp; 上面的例子故意求&quot;a&quot;的平方，这会抛出一个java.lang.ClassCastException，一个运行时异常，并且异常信息为java.lang.String cannot be cast to java.lang.Number。我们可以通过上面的方式来测试这种意外情况。clojure.test还提供了另一个
          <strong>断言are</strong>，用来判断多个form：
          <br />
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
           <span style="color: #000000; ">&nbsp;(testing&nbsp;</span>
           <span style="color: #800000; ">&quot;</span>
           <span style="color: #800000; ">test&nbsp;zero&nbsp;or&nbsp;one</span>
           <span style="color: #800000; ">&quot;</span>
           <span style="color: #000000; "><br />&nbsp;&nbsp;&nbsp;&nbsp;(are<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(</span>
           <span style="color: #000000; ">=</span>
           <span style="color: #000000; ">&nbsp;0&nbsp;(square&nbsp;0))<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(</span>
           <span style="color: #000000; ">=</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #000000; ">1</span>
           <span style="color: #000000; ">&nbsp;(square&nbsp;</span>
           <span style="color: #000000; ">1</span>
           <span style="color: #000000; ">))))</span>
          </div>&nbsp;&nbsp;&nbsp; are接受多个form并判断是否正确。这里还用了testing这个宏来添加一段字符串来描述测试的内容。
          <br />
          <br />&nbsp;&nbsp;&nbsp; 
          <strong>其次，我们用deftest宏定义了一个测试用例</strong>，deftest定义的测试用例也可以组合起来：
          <br />
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
           <span style="color: #000000; ">&nbsp;&nbsp;&nbsp;(deftest&nbsp;addition<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(</span>
           <span style="color: #0000FF; ">is</span>
           <span style="color: #000000; ">&nbsp;(</span>
           <span style="color: #000000; ">=</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #000000; ">4</span>
           <span style="color: #000000; ">&nbsp;(</span>
           <span style="color: #000000; ">+</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #000000; ">2</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #000000; ">2</span>
           <span style="color: #000000; ">)))<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(</span>
           <span style="color: #0000FF; ">is</span>
           <span style="color: #000000; ">&nbsp;(</span>
           <span style="color: #000000; ">=</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #000000; ">7</span>
           <span style="color: #000000; ">&nbsp;(</span>
           <span style="color: #000000; ">+</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #000000; ">3</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #000000; ">4</span>
           <span style="color: #000000; ">))))<br />&nbsp;&nbsp;&nbsp;(deftest&nbsp;subtraction<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(</span>
           <span style="color: #0000FF; ">is</span>
           <span style="color: #000000; ">&nbsp;(</span>
           <span style="color: #000000; ">=</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #000000; ">1</span>
           <span style="color: #000000; ">&nbsp;(</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #000000; ">4</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #000000; ">3</span>
           <span style="color: #000000; ">)))<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(</span>
           <span style="color: #0000FF; ">is</span>
           <span style="color: #000000; ">&nbsp;(</span>
           <span style="color: #000000; ">=</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #000000; ">3</span>
           <span style="color: #000000; ">&nbsp;(</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #000000; ">7</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #000000; ">4</span>
           <span style="color: #000000; ">))))<br />&nbsp;&nbsp;&nbsp;(deftest&nbsp;arithmetic<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(addition)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(subtraction))</span>
          </div>
          <br />&nbsp;&nbsp;&nbsp; 但是组合后的tests运行就不能简单地传入一个ns，而需要定义一个test-ns-hook指定要跑的测试用例，否则组合的用例如上面的addition和subtraction会运行两次。我们马上谈到。
          <br />
          <br />&nbsp;&nbsp;&nbsp; 
          <strong>定义完用例后是运行测试，运行测试使用run-tests</strong>，可以指定要跑测试的ns，run-tests接受可变参数个的ns。刚才提到，组合tests的时候会有重复运行的问题，要防止重复运行，可以定义一个
          <strong>test-ns-hook</strong>的函数：
          <br />
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
           <span style="color: #000000; ">(defn&nbsp;test</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">ns</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">hook&nbsp;[]<br />&nbsp;&nbsp;(test</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">square)<br />&nbsp;&nbsp;(arithmetic))</span>
          </div>&nbsp;&nbsp;&nbsp; 这样run-tests就会调用test-ns-hook按照给定的顺序执行指定的用例，避免了重复执行。
          <br />
          <br />&nbsp;&nbsp;&nbsp; 在你的测试代码里明确调用run-tests执行测试是一种方式，不过我们在开发中更经常使用的是
          <a href="https://github.com/technomancy/leiningen">lein</a>来管理project，
          <a href="https://github.com/technomancy/leiningen">lein</a>会将src和test分开，将你的测试代码组织在专门的test目录，类似使用maven的时候我们将main和test分开一样。这时候就可以简单地调用:
          <br />
          <div style="background-color: #eeeeee; font-size: 13px; border: 1px solid #cccccc; padding: 4px 5px 4px 4px; width: 98%;">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; 
           <span style="color: #000000;">lein&nbsp;test</span>
          </div>命令来执行单元测试，而不需要明确地在测试代码里调用run-tests并指定ns。更实用的使用例子可以看一些开源项目的组织。
          <br />
          <br />&nbsp;&nbsp;&nbsp; 单元测试里做mock也是比较常见的需求，在clojure里做mock很容易，原来clojure.contrib有个mock库，基本的原理都是利用binding来动态改变被mock对象的功能，但是在clojure 1.3里，binding只能改变标注为dynamic的变量，并且clojure.contrib被废弃，部分被合并到core里面，Allen Rohner编译了一个可以用于clojure 1.3的clojure.contrib，不过需要你自己install到本地仓库，具体看
          <a href="https://github.com/arohner/clojure-contrib/tree/1.3-compat">这里</a>。不过clojure.contrib.mock哪怕使用1.2的编译版本其实也是可以的。
          <br />
          <br />&nbsp;&nbsp;&nbsp; clojure.contrib最重要的是expect宏，它类似EasyMock里的expect方法，看一个例子：
          <br />
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
           <span style="color: #000000; ">(use&nbsp;[clojure.contrib.mock&nbsp;:only&nbsp;[times&nbsp;returns&nbsp;has</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">args&nbsp;expect]])<br /><br />(deftest&nbsp;test</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">square2<br />&nbsp;&nbsp;(expect&nbsp;[square&nbsp;(has</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">args&nbsp;[number?]&nbsp;(times&nbsp;</span>
           <span style="color: #000000; ">2</span>
           <span style="color: #000000; ">&nbsp;(returns&nbsp;</span>
           <span style="color: #000000; ">9</span>
           <span style="color: #000000; ">)))]<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(</span>
           <span style="color: #0000FF; ">is</span>
           <span style="color: #000000; ">&nbsp;(</span>
           <span style="color: #000000; ">=</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #000000; ">9</span>
           <span style="color: #000000; ">&nbsp;(square&nbsp;</span>
           <span style="color: #000000; ">4</span>
           <span style="color: #000000; ">)))))</span>
          </div>
          <br />&nbsp;&nbsp;&nbsp; has-args用来检测square的参数是不是number，times用来指定预期调用的次数，而returns用来返回mock值，是不是很像EasyMock？因为我们这个测试只调用了square一次，所以这个用例将失败：
          <br />
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
           <span style="color: #000000; ">Testing&nbsp;example<br /></span>
           <span style="color: #800000; ">&quot;</span>
           <span style="color: #800000; ">Unexpected&nbsp;invocation&nbsp;count.&nbsp;Function&nbsp;name:&nbsp;square&nbsp;expected:&nbsp;2&nbsp;actual:&nbsp;1</span>
           <span style="color: #800000; ">&quot;</span>
          </div>&nbsp;&nbsp; 这个例子要在Clojure 1.3里运行，需要将square定义成dynamic：
          <br />
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
           <span style="color: #000000; ">(defn&nbsp;</span>
           <span style="color: #000000; ">^</span>
           <span style="color: #000000; ">:dynamic&nbsp;square&nbsp;[x]<br />&nbsp;&nbsp;(</span>
           <span style="color: #000000; ">*</span>
           <span style="color: #000000; ">&nbsp;x&nbsp;x))</span>
          </div>&nbsp;&nbsp; 否则会告诉你没办法绑定square:
          <br />
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
           <span style="color: #000000; ">actual:&nbsp;java.lang.IllegalStateException:&nbsp;Can</span>
           <span style="color: #800000; ">'</span>
           <span style="color: #800000; ">t&nbsp;dynamically&nbsp;bind&nbsp;non-dynamic&nbsp;var:&nbsp;example/square</span>
          </div>
          <br />
          <br />&nbsp;&nbsp;&nbsp; 额外提下，还有个轻量级的测试框架
          <a href="https://github.com/jaycfields/expectations">expections</a>可以看一下，类似Ruby Facker的
          <a href="https://github.com/paraseba/faker">facker</a>库提供一些常见的模拟数据，如名称地址等。
          <br />&nbsp;&nbsp;&nbsp; 
          <br />&nbsp;&nbsp;&nbsp;&nbsp; 转载请注明出处：
          <a id="Editor_Edit_hlEntryLink" title="view: Clojure世界：单元测试" href="../archive/2012/02/15/370040.html" target="_blank">http://www.blogjava.net/killme2008/archive/2012/02/15/370040.html</a>
          <br />
          <br />&nbsp;&nbsp;&nbsp;
         </div> 
         <p class="postfoot"> posted @ <a href="http://www.blogjava.net/killme2008/archive/2012/02/15/370040.html" title="permalink">2012-02-15 19:39</a> dennis 阅读(4165) | <a href="http://www.blogjava.net/killme2008/archive/2012/02/15/370040.html#FeedBack" title="comments, pingbacks, trackbacks">评论 (0)</a> |&nbsp;<a href="http://www.blogjava.net/killme2008/admin/EditPosts.aspx?postid=370040">编辑</a>&nbsp;<a href="http://www.blogjava.net/killme2008/AddToFavorite.aspx?id=370040">收藏</a> </p> 
        </div> 
        <div class="post" style="filter:progid:DXImageTransform.Microsoft.Shadow(color='Blue', Direction=135, Strength=32)"> 
         <div class="posthead"> 
          <h2 style="padding-top:4px; padding-bottom:4px;"><a id="ArchiveDay1_SingleDay_DayList_ctl24_TitleUrl" href="http://www.blogjava.net/killme2008/archive/2012/02/14/369976.html">Clojure世界：使用rlwrap增强REPL</a></h2> 
         </div> 
         <div class="postbody">
          &nbsp;&nbsp;&nbsp; Clojure的REPL非常方便，可以随时随地试验你的想法，REPL是read-eval-print-loop的简称。默认clojure.contrib有带一个shell脚本来启动REPL，具体看
          <a href="https://github.com/richhickey/clojure-contrib/blob/master/launchers/bash/clj-env-dir">这里</a>。你也可以用JLine来增强REPL：
          <br /> 
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br />
<br />
Code highlighting produced by Actipro CodeHighlighter (freeware)<br />
http://www.CodeHighlighter.com/<br />
<br />
-->
           <span style="color: #000000; ">java&nbsp;</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">cp&nbsp;</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">%CLOJURE_DIR%\jline-VERSION.jar;%CLOJURE_JAR%</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">&nbsp;jline.ConsoleRunner&nbsp;clojure.main</span>
          </div> 
          <br /> &nbsp;&nbsp;&nbsp; 不过，其实你还可以用
          <a href="http://utopia.knoware.nl/~hlub/rlwrap/#rlwrap">rlwrap</a>这个GNU库来增强clojure REPL。使用它有如下好处：
          <br /> 1.Tab completion，使用tab做代码提示。
          <br /> 2.括号匹配
          <br /> 3.历史记录，哪怕你重启REPL
          <br /> 4.通过
          <a href="http://tiswww.case.edu/php/chet/readline/readline.html#SEC9">.inputrc</a>来绑定vi或者emacs
          <br /> 
          <br /> &nbsp;&nbsp;&nbsp; 具体操作步骤如下：
          <br /> 
          <br /> 1.首先，你需要在你的机器上安装rlwrap，你可以通过apt或者port,homebrew等工具安装或者自己下载安装：
          <br /> 
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br />
<br />
Code highlighting produced by Actipro CodeHighlighter (freeware)<br />
http://www.CodeHighlighter.com/<br />
<br />
-->
           <span style="color: #000000; ">sudo&nbsp;port&nbsp;install&nbsp;rlwrap</span>
          </div> 
          <br /> 2.在你的home目录下创建一个clojure目录作为clojure home，并拷贝clojure.jar进去：
          <br /> 
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br />
<br />
Code highlighting produced by Actipro CodeHighlighter (freeware)<br />
http://www.CodeHighlighter.com/<br />
<br />
-->
           <span style="color: #000000; ">mkdir&nbsp;</span>
           <span style="color: #000000; ">~/</span>
           <span style="color: #000000; ">clojure<br /> cp&nbsp;.m2</span>
           <span style="color: #000000; ">/</span>
           <span style="color: #000000; ">repository</span>
           <span style="color: #000000; ">/</span>
           <span style="color: #000000; ">org</span>
           <span style="color: #000000; ">/</span>
           <span style="color: #000000; ">clojure</span>
           <span style="color: #000000; ">/</span>
           <span style="color: #000000; ">clojure</span>
           <span style="color: #000000; ">/</span>
           <span style="color: #000000; ">1.3</span>
           <span style="color: #000000; ">.</span>
           <span style="color: #000000; ">0</span>
           <span style="color: #000000; ">/</span>
           <span style="color: #000000; ">clojure</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">1.3</span>
           <span style="color: #000000; ">.</span>
           <span style="color: #000000; ">0</span>
           <span style="color: #000000; ">.jar&nbsp;</span>
           <span style="color: #000000; ">~/</span>
           <span style="color: #000000; ">clojure</span>
           <span style="color: #000000; ">/</span>
           <span style="color: #000000; ">clojure.jar <br /> </span>
          </div> 我是从maven的本地仓库里拷贝了clojure 1.3的jar包过去，重命名为clojure.jar
          <br /> 
          <br /> 3.创建一个shell脚本名为clj，并放入你的path变量，脚本内容：
          <br /> 
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br />
<br />
Code highlighting produced by Actipro CodeHighlighter (freeware)<br />
http://www.CodeHighlighter.com/<br />
<br />
-->
           <span style="color: #000000; ">#</span>
           <span style="color: #000000; ">!/</span>
           <span style="color: #000000; ">bin</span>
           <span style="color: #000000; ">/</span>
           <span style="color: #000000; ">sh<br /> breakchars</span>
           <span style="color: #000000; ">=</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">(){}[],^%$#@\</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">\</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">;:''|\\</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; "><br /> CLOJURE_DIR</span>
           <span style="color: #000000; ">=~/</span>
           <span style="color: #000000; ">clojure<br /> CLOJURE_JAR</span>
           <span style="color: #000000; ">=</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">$CLOJURE_DIR</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">/</span>
           <span style="color: #000000; ">clojure.jar<br /> JAVA_OPTS</span>
           <span style="color: #000000; ">=</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">-Xmx512m&nbsp;-XX:MaxPermSize=256m&nbsp;-XX:+UseConcMarkSweepGC&nbsp;-XX:+UseCMSCompactAtFullCollection&nbsp;-XX:+CMSClassUnloadingEnabled</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; "><br /> </span>
           <span style="color: #0000FF; ">if</span>
           <span style="color: #000000; ">&nbsp;[&nbsp;$#&nbsp;</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">eq&nbsp;</span>
           <span style="color: #000000; ">0</span>
           <span style="color: #000000; ">&nbsp;];&nbsp;then&nbsp;<br /> &nbsp;&nbsp;&nbsp;&nbsp;exec&nbsp;rlwrap&nbsp;</span>
           <span style="color: #000000; ">--</span>
           <span style="color: #000000; ">remember&nbsp;</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">c&nbsp;</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">b&nbsp;</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">$breakchars</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">&nbsp;\<br /> &nbsp;&nbsp;&nbsp;</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">f&nbsp;</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">$HOME</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">/</span>
           <span style="color: #000000; ">.clj_completions&nbsp;\<br /> &nbsp;&nbsp;&nbsp;</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">t&nbsp;</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">Clojure&nbsp;REPL</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">&nbsp;\<br /> &nbsp;&nbsp;&nbsp;</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">p&nbsp;red&nbsp;\<br /> &nbsp;&nbsp;&nbsp;</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">H&nbsp;</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">$CLOJURE_DIR</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">/</span>
           <span style="color: #000000; ">.repl_history&nbsp;</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">s&nbsp;</span>
           <span style="color: #000000; ">1000</span>
           <span style="color: #000000; ">\<br /> &nbsp;&nbsp;&nbsp;java&nbsp;</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">$JAVA_OPTS</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">&nbsp;&nbsp;</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">cp&nbsp;</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">$CLOJURE_JAR</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">&nbsp;clojure.main<br /> </span>
           <span style="color: #0000FF; ">else</span>
           <span style="color: #000000; "><br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exec&nbsp;java&nbsp;</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">cp&nbsp;</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">$CLOJURE_JAR</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">&nbsp;clojure.main&nbsp;$</span>
           <span style="color: #000000; ">1</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #000000; "></span>
           <span style="color: #000000; "></span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">$@</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; "><br /> fi</span>
          </div> 我们将命令历史输出到~/clojure/.repl_history文件中，并限制数目为1000。
          <br /> 
          <br /> 4.clj脚本中通过-f选项指定了completions文件为~/.clj_completions，执行下列clojure程序生成此文件：
          <br /> 
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br />
<br />
Code highlighting produced by Actipro CodeHighlighter (freeware)<br />
http://www.CodeHighlighter.com/<br />
<br />
-->
           <span style="color: #000000; ">(def&nbsp;completions&nbsp;(keys&nbsp;(ns</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">publics&nbsp;(find</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">ns&nbsp;'clojure.core))))<br /> ;(def&nbsp;completions&nbsp;(mapcat&nbsp;(comp&nbsp;keys&nbsp;ns</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">publics)&nbsp;(all</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">ns)))<br /> (</span>
           <span style="color: #0000FF; ">with</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">open&nbsp;[f&nbsp;(java.io.BufferedWriter.&nbsp;(java.io.FileWriter.&nbsp;(str&nbsp;(System</span>
           <span style="color: #000000; ">/</span>
           <span style="color: #000000; ">getenv&nbsp;</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">HOME</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">)&nbsp;</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">/.clj_completions</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">)))]<br /> &nbsp;&nbsp;(.write&nbsp;f&nbsp;(apply&nbsp;str&nbsp;(interpose&nbsp;\newline&nbsp;completions))))</span>
          </div> 这个程序只生成clojure.core的completions文件，如果你想将所有ns都加入进去，注释掉第一行，使用第二行程序。
          <br /> 
          <br /> 5.最后，配置下~/.inputrc文件：
          <br /> 
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br />
<br />
Code highlighting produced by Actipro CodeHighlighter (freeware)<br />
http://www.CodeHighlighter.com/<br />
<br />
-->
           <span style="color: #000000; ">set&nbsp;editing</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">mode&nbsp;emacs<br /> tab:&nbsp;complete<br /> set&nbsp;completion</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">query</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">items&nbsp;</span>
           <span style="color: #000000; ">150</span>
           <span style="color: #000000; "><br /> set&nbsp;completion</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">ignore</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #0000FF; ">case</span>
           <span style="color: #000000; ">&nbsp;on<br /> set&nbsp;blink</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">matching</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">paren&nbsp;on<br /> set&nbsp;bell</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">style&nbsp;visible</span>
          </div> 我绑定为emacs，你可以选择vi。
          <br /> 
          <br /> 6.一切搞定，接下来你可以敲入命令clj来使用rlwrap启动clojure REPL了，可以用tab做代码提示了，可以用Ctrl + r来搜索历史命令，运行截图：
          <br /> 
          <img alt="" src="/images/blogjava_net/killme2008/rlwrap.png" height="101" width="900" />
          <br /> 
          <br /> 参考：
          <a href="http://en.wikibooks.org/wiki/Clojure_Programming/Getting_Started#Enhancing_Clojure_REPL_with_rlwrap">http://en.wikibooks.org/wiki/Clojure_Programming/Getting_Started#Enhancing_Clojure_REPL_with_rlwrap</a>
          <br />转载请注明出处：
          <a id="Editor_Edit_hlEntryLink" title="view: Clojure世界：使用rlwrap增强REPL" href="../archive/2012/02/14/369976.html" target="_blank">http://www.blogjava.net/killme2008/archive/2012/02/14/369976.html</a>
         </div> 
         <p class="postfoot"> posted @ <a href="http://www.blogjava.net/killme2008/archive/2012/02/14/369976.html" title="permalink">2012-02-14 19:05</a> dennis 阅读(3184) | <a href="http://www.blogjava.net/killme2008/archive/2012/02/14/369976.html#FeedBack" title="comments, pingbacks, trackbacks">评论 (1)</a> |&nbsp;<a href="http://www.blogjava.net/killme2008/admin/EditPosts.aspx?postid=369976">编辑</a>&nbsp;<a href="http://www.blogjava.net/killme2008/AddToFavorite.aspx?id=369976">收藏</a> </p> 
        </div> 
        <div class="post" style="filter:progid:DXImageTransform.Microsoft.Shadow(color='Blue', Direction=135, Strength=32)"> 
         <div class="posthead"> 
          <h2 style="padding-top:4px; padding-bottom:4px;"><a id="ArchiveDay1_SingleDay_DayList_ctl25_TitleUrl" href="http://www.blogjava.net/killme2008/archive/2012/02/13/369890.html">Clojure世界：Http Client</a></h2> 
         </div> 
         <div class="postbody">
          <br />&nbsp;&nbsp;&nbsp; 使用http client提交表单或者下载网页也是非常常见的任务，比如使用Java的时候可以用标准库的HttpURLConnection，也可以选择
          <a href="http://hc.apache.org/">Apache Http Client</a>。在clojure里也有这样的类库，这里我将介绍三个各有特色的http client实现。
          <br />
          <br />&nbsp;&nbsp;&nbsp; 首先，我最先推荐使用clj-http这个类库，它是Apache HttpClient的clojure wrapper，是一个提供同步API的简单易用的Http Client。
          <br />
          <br />名称: clj-http
          <br />主页：
          <a href="https://github.com/dakrone/clj-http">https://github.com/dakrone/clj-http</a>
          <br />依赖：
          <br />
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
           <span style="color: #000000; ">[clj</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">http&nbsp;</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">0.3.1</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">]</span>
          </div>
          <br />例子：
          <br />
          <div style="background-color: #eeeeee; font-size: 13px; border: 1px solid #cccccc; padding: 4px 5px 4px 4px; width: 98%;">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
           <span style="color: #000000; ">(require&nbsp;</span>
           <span style="color: #000000; ">'</span>
           <span style="color: #000000; ">[clj-http.client&nbsp;:as&nbsp;client])</span>
           <span style="color: #000000; "><br /></span>
           <span style="color: #000000; ">(client</span>
           <span style="color: #000000; ">/</span>
           <span style="color: #000000; ">get&nbsp;</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">http://google.com</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000;">)</span>
          </div>结果：
          <br />
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
           <span style="color: #000000; ">=&gt;</span>
           <span style="color: #000000; "> ｛:cookies {&quot;NID&quot; {:domain &quot;.google.com.hk&quot;, :expires #&lt;Date Tue Aug 14 18:20:38 CST 2012&gt;, :path &quot;/&quot;, :value &quot;56=qn2OWtODE2D3fUKi_vbi44jZepOeLI9xC4Ta1JQLEicqUvIZAqr7TCmft_hq8i_FRwnFXdTK1jV2S5IrSZFyYhlAN2KcQEXgWX1iK36gM2iYPaKPihuUZDCqgiAamDOl&quot;, :version 0}, &quot;PREF&quot; {:domain &quot;.google.com.hk&quot;, :expires #&lt;Date Wed Feb 12 18:20:38 CST 2014&gt;, :path &quot;/&quot;, :value &quot;ID=8b73a654ff0a2783:FF=0:NW=1:TM=1329128438:LM=1329128438:S=uEM4SsFuHlkqtVhp&quot;, :version 0}},<br />&nbsp;&nbsp;&nbsp; :status&nbsp;</span>
           <span style="color: #000000; ">200</span>
           <span style="color: #000000; "><br />&nbsp;&nbsp;&nbsp;&nbsp;:headers&nbsp;{</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">date</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">Sun,&nbsp;01&nbsp;Aug&nbsp;2010&nbsp;07:03:49&nbsp;GMT</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; "><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">cache-control</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">private,&nbsp;max-age=0</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; "><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">content-type</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">text/html;&nbsp;charset=ISO-8859-1</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; "><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<img src="http://www.blogjava.net/Images/dot.gif" alt="" />}<br />&nbsp;&nbsp;&nbsp;&nbsp;:body&nbsp;</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">&lt;!doctype&nbsp;html&gt;<img src="http://www.blogjava.net/Images/dot.gif" alt="" /></span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; "><br />&nbsp;&nbsp;&nbsp;&nbsp;:trace</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">redirects&nbsp;[</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">http://google.com</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">http://www.google.com/</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">http://www.google.fr/</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">]}</span>
          </div>更多例子：
          <br />
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
           <span style="color: #000000; ">(client</span>
           <span style="color: #000000; ">/</span>
           <span style="color: #000000; ">get&nbsp;</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">http://site.com/resources/3</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">&nbsp;{:accept&nbsp;:json})<br /><br />;;&nbsp;Various&nbsp;options:<br />(client</span>
           <span style="color: #000000; ">/</span>
           <span style="color: #000000; ">post&nbsp;</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">http://site.com/api</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; "><br />&nbsp;&nbsp;{:basic</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">auth&nbsp;[</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">user</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">pass</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">]<br />&nbsp;&nbsp;&nbsp;:body&nbsp;</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">{\</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">json\</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">:&nbsp;\</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">input\</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">}</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; "><br />&nbsp;&nbsp;&nbsp;:headers&nbsp;{</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">X-Api-Version</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">2</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">}<br />&nbsp;&nbsp;&nbsp;:content</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">type&nbsp;:json<br />&nbsp;&nbsp;&nbsp;:socket</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">timeout&nbsp;</span>
           <span style="color: #000000; ">1000</span>
           <span style="color: #000000; "><br />&nbsp;&nbsp;&nbsp;:conn</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">timeout&nbsp;</span>
           <span style="color: #000000; ">1000</span>
           <span style="color: #000000; "><br />&nbsp;&nbsp;&nbsp;:accept&nbsp;:json})<br /><br />;;&nbsp;Need&nbsp;to&nbsp;contact&nbsp;a&nbsp;server&nbsp;with&nbsp;an&nbsp;untrusted&nbsp;SSL&nbsp;cert</span>
           <span style="color: #000000; ">?</span>
           <span style="color: #000000; "><br />(client</span>
           <span style="color: #000000; ">/</span>
           <span style="color: #000000; ">get&nbsp;</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">https://alioth.debian.org</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">&nbsp;{:insecure</span>
           <span style="color: #000000; ">?</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #0000FF; ">true</span>
           <span style="color: #000000; ">})<br /><br />;;&nbsp;If&nbsp;you&nbsp;don</span>
           <span style="color: #000000; ">'</span>
           <span style="color: #000000; ">t&nbsp;want&nbsp;to&nbsp;follow-redirects&nbsp;automatically:</span>
           <span style="color: #000000; "><br /></span>
           <span style="color: #000000; ">(client</span>
           <span style="color: #000000; ">/</span>
           <span style="color: #000000; ">get&nbsp;</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">http://site.come/redirects-somewhere</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">&nbsp;{:follow</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">redirects&nbsp;</span>
           <span style="color: #0000FF; ">false</span>
           <span style="color: #000000; ">})<br /><br />;;&nbsp;Only&nbsp;follow&nbsp;a&nbsp;certain&nbsp;number&nbsp;of&nbsp;redirects:<br />(client</span>
           <span style="color: #000000; ">/</span>
           <span style="color: #000000; ">get&nbsp;</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">http://site.come/redirects-somewhere</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">&nbsp;{:max</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">redirects&nbsp;</span>
           <span style="color: #000000; ">5</span>
           <span style="color: #000000; ">})<br /><br />;;&nbsp;Throw&nbsp;an&nbsp;exception&nbsp;</span>
           <span style="color: #0000FF; ">if</span>
           <span style="color: #000000; ">&nbsp;redirected&nbsp;too&nbsp;many&nbsp;times:<br />(client</span>
           <span style="color: #000000; ">/</span>
           <span style="color: #000000; ">get&nbsp;</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">http://site.come/redirects-somewhere</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">&nbsp;{:max</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">redirects&nbsp;</span>
           <span style="color: #000000; ">5</span>
           <span style="color: #000000; ">&nbsp;:</span>
           <span style="color: #0000FF; ">throw</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">exceptions&nbsp;</span>
           <span style="color: #0000FF; ">true</span>
           <span style="color: #000000; ">})<br /><br />;;&nbsp;Send&nbsp;form&nbsp;params&nbsp;as&nbsp;a&nbsp;urlencoded&nbsp;body<br />(client</span>
           <span style="color: #000000; ">/</span>
           <span style="color: #000000; ">post&nbsp;</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">http//site.com</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">&nbsp;{:form</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">params&nbsp;{:foo&nbsp;</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">bar</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">}})<br /><br />;;&nbsp;Multipart&nbsp;form&nbsp;uploads</span>
           <span style="color: #000000; ">/</span>
           <span style="color: #000000; ">posts<br />;;&nbsp;a&nbsp;map&nbsp;or&nbsp;vector&nbsp;works&nbsp;as&nbsp;the&nbsp;multipart&nbsp;object.&nbsp;Use&nbsp;a&nbsp;vector&nbsp;of<br />;;&nbsp;vectors&nbsp;</span>
           <span style="color: #0000FF; ">if</span>
           <span style="color: #000000; ">&nbsp;you&nbsp;need&nbsp;to&nbsp;preserve&nbsp;order,&nbsp;a&nbsp;map&nbsp;otherwise.<br />(client</span>
           <span style="color: #000000; ">/</span>
           <span style="color: #000000; ">post&nbsp;</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">http//example.org</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">&nbsp;{:multipart&nbsp;[[</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">title</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">My&nbsp;Awesome&nbsp;Picture</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">]<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">Content/type</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">image/jpeg</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">]<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">file</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">&nbsp;(clojure.java.io</span>
           <span style="color: #000000; ">/</span>
           <span style="color: #000000; ">file&nbsp;</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">pic.jpg</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">)]]})<br />;;&nbsp;Multipart&nbsp;values&nbsp;can&nbsp;be&nbsp;one&nbsp;of&nbsp;the&nbsp;following:<br />;;&nbsp;String,&nbsp;InputStream,&nbsp;File,&nbsp;or&nbsp;a&nbsp;</span>
           <span style="color: #0000FF; ">byte</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">array<br /><br />;;&nbsp;Basic&nbsp;authentication<br />(client</span>
           <span style="color: #000000; ">/</span>
           <span style="color: #000000; ">get&nbsp;</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">http://site.com/protected</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">&nbsp;{:basic</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">auth&nbsp;[</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">user</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">pass</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">]})<br />(client</span>
           <span style="color: #000000; ">/</span>
           <span style="color: #000000; ">get&nbsp;</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">http://site.com/protected</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">&nbsp;{:basic</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">auth&nbsp;</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">user:pass</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">})<br /><br />;;&nbsp;Query&nbsp;parameters<br />(client</span>
           <span style="color: #000000; ">/</span>
           <span style="color: #000000; ">get&nbsp;</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">http://site.com/search</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">&nbsp;{:query</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">params&nbsp;{</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">q</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">foo,&nbsp;bar</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">}})</span>
          </div>
          <br />&nbsp;&nbsp;&nbsp; clj-http的API相当的简洁漂亮，使用起来非常便利，强烈推荐。题外，学习clojure的一个好方法就是为现有的java类库实现一些方便的clojure wrapper。
          <br />
          <br />&nbsp;&nbsp;&nbsp; 如果你需要异步的http client，我会推荐http.async.client这个类库，它的API是异步形式的类似 Java的Future模式，对于clojure程序员来说应该更像是agent。
          <br />
          <br />名称：http.async.client
          <br />主页：
          <a href="https://github.com/neotyk/http.async.client">https://github.com/neotyk/http.async.client</a>
          <br />依赖：
          <br />
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
           <span style="color: #000000; ">[http.async.client&nbsp;</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">0.4.1</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">]</span>
          </div>例子：
          <br />
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
           <span style="color: #000000; ">(require&nbsp;</span>
           <span style="color: #000000; ">'</span>
           <span style="color: #000000; ">[http.async.client&nbsp;:as&nbsp;c])</span>
           <span style="color: #000000; "><br /></span>
           <span style="color: #000000; ">(with</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">open&nbsp;[client&nbsp;(c</span>
           <span style="color: #000000; ">/</span>
           <span style="color: #000000; ">create</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">client)]<br />&nbsp;&nbsp;(let&nbsp;[response&nbsp;(c</span>
           <span style="color: #000000; ">/</span>
           <span style="color: #000000; ">GET&nbsp;client&nbsp;</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">http://neotyk.github.com/http.async.client/</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">)]<br />&nbsp;&nbsp;&nbsp;&nbsp;(prn&nbsp;(c</span>
           <span style="color: #000000; ">/</span>
           <span style="color: #000000; ">done</span>
           <span style="color: #000000; ">?</span>
           <span style="color: #000000; ">&nbsp;response))<br />&nbsp;&nbsp;&nbsp; (c</span>
           <span style="color: #000000; ">/</span>
           <span style="color: #000000; ">await&nbsp;response)<br />&nbsp;&nbsp;&nbsp;&nbsp;(prn&nbsp;(c</span>
           <span style="color: #000000; ">/</span>
           <span style="color: #000000; ">string&nbsp;response))<br />&nbsp;&nbsp;&nbsp;&nbsp;(prn&nbsp;(c</span>
           <span style="color: #000000; ">/</span>
           <span style="color: #000000; ">status&nbsp;response))<br />&nbsp;&nbsp;&nbsp;&nbsp;(prn&nbsp;(c</span>
           <span style="color: #000000; ">/</span>
           <span style="color: #000000; ">done</span>
           <span style="color: #000000; ">?</span>
           <span style="color: #000000; ">&nbsp;response))))</span>
          </div>
          <br />输出：
          <br />
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
           <span style="color: #0000FF; ">false</span>
           <span style="color: #000000; "><br /></span>
           <span style="color: #000000; ">&lt;!</span>
           <span style="color: #000000; ">DOCTYPE&nbsp;html&nbsp;<img src="http://www.blogjava.net/Images/dot.gif" alt="" /><img src="http://www.blogjava.net/Images/dot.gif" alt="" /><br />{:code&nbsp;</span>
           <span style="color: #000000; ">200</span>
           <span style="color: #000000; ">,&nbsp;:msg&nbsp;</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">OK</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">,&nbsp;:protocol&nbsp;</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">HTTP/1.1</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">,&nbsp;:major&nbsp;</span>
           <span style="color: #000000; ">1</span>
           <span style="color: #000000; ">,&nbsp;:minor&nbsp;</span>
           <span style="color: #000000; ">1</span>
           <span style="color: #000000; ">}<br /></span>
           <span style="color: #0000FF; ">true</span>
          </div>
          <br />更多例子：
          <br />
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
           <span style="color: #000000; ">(c</span>
           <span style="color: #000000; ">/</span>
           <span style="color: #000000; ">POST&nbsp;client&nbsp;</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">http://example.com</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">&nbsp;:body&nbsp;</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">hello&nbsp;world</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">&nbsp;:timeout&nbsp;</span>
           <span style="color: #000000; ">3000</span>
           <span style="color: #000000; ">)<br />(c</span>
           <span style="color: #000000; ">/</span>
           <span style="color: #000000; ">DELETE&nbsp;client&nbsp;</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">http://example.com</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">)<br />(c</span>
           <span style="color: #000000; ">/</span>
           <span style="color: #000000; ">POST&nbsp;client&nbsp;</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">http://example.com</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">&nbsp;:body&nbsp;</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">hello&nbsp;world</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">&nbsp;:auth&nbsp;{:type&nbsp;:basic&nbsp;:user&nbsp;</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">admin</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">&nbsp;:password&nbsp;</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">admin</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">})</span>
          </div>
          <br />请注意，这些方法都是异步调用的，你需要通过await来等待调用完成，或者通过done?来判断调用是否完成。
          <br />http.async.client有个比较重要的特性就是对Http Chunked编码的支持，分别通过LazySeq和callback的方式支持，首先看将Http chunked变成一个lazy seq:
          <br />
          <br />
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
           <span style="color: #000000; ">(with</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">open&nbsp;[client&nbsp;(client</span>
           <span style="color: #000000; ">/</span>
           <span style="color: #000000; ">create</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">client)]&nbsp;;&nbsp;Create&nbsp;client<br />&nbsp;&nbsp;(let&nbsp;[resp&nbsp;(client</span>
           <span style="color: #000000; ">/</span>
           <span style="color: #000000; ">stream</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">seq&nbsp;client&nbsp;:get&nbsp;url)]<br />&nbsp;&nbsp;&nbsp;&nbsp;(doseq&nbsp;[s&nbsp;(s</span>
           <span style="color: #000000; ">/</span>
           <span style="color: #000000; ">string&nbsp;resp)]<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(println&nbsp;s))))</span>
          </div>
          <br />这里非常关键的一点是stream-seq返回的chunk序列，每取一个就少一个（通过first函数），也就是说每次调用first取到的chunk都不一样，是顺序递增，不可重复获取的。
          <br />
          <br />通过callback方式处理：
          <br />
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
           <span style="color: #000000; ">(with</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">open&nbsp;[client&nbsp;(client</span>
           <span style="color: #000000; ">/</span>
           <span style="color: #000000; ">create</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">client)]&nbsp;;&nbsp;Create&nbsp;client<br />&nbsp;&nbsp;(let&nbsp;[parts&nbsp;(ref&nbsp;#{})<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;resp&nbsp;(client</span>
           <span style="color: #000000; ">/</span>
           <span style="color: #000000; ">request</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">stream&nbsp;client&nbsp;:get&nbsp;url<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(fn&nbsp;[state&nbsp;body]<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(dosync&nbsp;(alter&nbsp;parts&nbsp;conj&nbsp;(string&nbsp;body)))<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[body&nbsp;:</span>
           <span style="color: #0000FF; ">continue</span>
           <span style="color: #000000; ">]))]<br />&nbsp;&nbsp;&nbsp;&nbsp;;;&nbsp;</span>
           <span style="color: #0000FF; ">do</span>
           <span style="color: #000000; ">&nbsp;something&nbsp;to&nbsp;@parts<br />&nbsp;&nbsp;&nbsp;&nbsp;))</span>
          </div>自己传入一个callback函数接收chunk，比如这里用一个ref累积。
          <br />
          <br />http.async.client的详细文档看这里：
          <a href="http://neotyk.github.com/http.async.client/docs.html">http://neotyk.github.com/http.async.client/docs.html</a>
          <br />
          <br />最后，有兴趣还可以看下
          <a href="https://github.com/ztellman/aleph">aleph</a>这个异步通讯的框架，它支持Http协议，也提供了http server和client的实现。不过它的API就没有那么简单明了，它的模型是类似go语言里利用channel做异步通讯的模型，http只是它的一个模块罢了，这是另一个话题了。
          <br />
          <br />转载请注明出处：
          <a id="Editor_Edit_hlEntryLink" title="view: Clojure世界：Http Client" href="../archive/2012/02/13/369890.html" target="_blank">http://www.blogjava.net/killme2008/archive/2012/02/13/369890.html</a>
         </div> 
         <p class="postfoot"> posted @ <a href="http://www.blogjava.net/killme2008/archive/2012/02/13/369890.html" title="permalink">2012-02-13 18:57</a> dennis 阅读(4855) | <a href="http://www.blogjava.net/killme2008/archive/2012/02/13/369890.html#FeedBack" title="comments, pingbacks, trackbacks">评论 (1)</a> |&nbsp;<a href="http://www.blogjava.net/killme2008/admin/EditPosts.aspx?postid=369890">编辑</a>&nbsp;<a href="http://www.blogjava.net/killme2008/AddToFavorite.aspx?id=369890">收藏</a> </p> 
        </div> 
        <div class="post" style="filter:progid:DXImageTransform.Microsoft.Shadow(color='Blue', Direction=135, Strength=32)"> 
         <div class="posthead"> 
          <h2 style="padding-top:4px; padding-bottom:4px;"><a id="ArchiveDay1_SingleDay_DayList_ctl26_TitleUrl" href="http://www.blogjava.net/killme2008/archive/2012/02/12/369822.html">Clojure世界：日志管理――clojure.tools.logging</a></h2> 
         </div> 
         <div class="postbody">
          <br />&nbsp;&nbsp;&nbsp; 处理日志是任何一个产品级的程序都需要仔细处理的模块。在Java中，我们经常使用的是log4j就是一个日志框架。在clojure里，同样有一套日志框架――clojure.tools.logging，它不仅提供了常用的日志输出功能，还屏蔽了Java各种日志框架之间的差异，如slf4j,commons-logging,log4j,java.util.logging等，让你可以透明地使用这些框架来处理日志。
          <br />
          <br />名称：clojure.tools.logging
          <br />主页：
          <a href="https://github.com/clojure/tools.logging">https://github.com/clojure/tools.logging</a>
          <br />依赖：
          <br />
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
           <span style="color: #000000; ">[org.clojure/tools.logging&nbsp;&quot;0.2.3&quot;]<br /><br /></span>
           <span style="color: #0000FF; ">&lt;</span>
           <span style="color: #800000; ">dependency</span>
           <span style="color: #0000FF; ">&gt;</span>
           <span style="color: #000000; "><br />&nbsp;&nbsp;</span>
           <span style="color: #0000FF; ">&lt;</span>
           <span style="color: #800000; ">groupId</span>
           <span style="color: #0000FF; ">&gt;</span>
           <span style="color: #000000; ">org.clojure</span>
           <span style="color: #0000FF; ">&lt;/</span>
           <span style="color: #800000; ">groupId</span>
           <span style="color: #0000FF; ">&gt;</span>
           <span style="color: #000000; "><br />&nbsp;&nbsp;</span>
           <span style="color: #0000FF; ">&lt;</span>
           <span style="color: #800000; ">artifactId</span>
           <span style="color: #0000FF; ">&gt;</span>
           <span style="color: #000000; ">tools.logging</span>
           <span style="color: #0000FF; ">&lt;/</span>
           <span style="color: #800000; ">artifactId</span>
           <span style="color: #0000FF; ">&gt;</span>
           <span style="color: #000000; "><br />&nbsp;&nbsp;</span>
           <span style="color: #0000FF; ">&lt;</span>
           <span style="color: #800000; ">version</span>
           <span style="color: #0000FF; ">&gt;</span>
           <span style="color: #000000; ">0.2.3</span>
           <span style="color: #0000FF; ">&lt;/</span>
           <span style="color: #800000; ">version</span>
           <span style="color: #0000FF; ">&gt;</span>
           <span style="color: #000000; "><br /></span>
           <span style="color: #0000FF; ">&lt;/</span>
           <span style="color: #800000; ">dependency</span>
           <span style="color: #0000FF; ">&gt;</span>
          </div>
          <br />使用：
          <br />
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
           <span style="color: #000000; ">(ns&nbsp;example.core<br />&nbsp;&nbsp;(:use&nbsp;[clojure.tools.logging&nbsp;:only&nbsp;(info&nbsp;error)]))<br /><br />(defn&nbsp;divide&nbsp;[x&nbsp;y]<br />&nbsp;&nbsp;(try<br />&nbsp;&nbsp;&nbsp;&nbsp;(info&nbsp;&quot;dividing&quot;&nbsp;x&nbsp;&quot;by&quot;&nbsp;y)<br />&nbsp;&nbsp;&nbsp;&nbsp;(/&nbsp;x&nbsp;y)<br />&nbsp;&nbsp;&nbsp;&nbsp;(catch&nbsp;Exception&nbsp;ex&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(error&nbsp;ex&nbsp;&quot;There&nbsp;was&nbsp;an&nbsp;error&nbsp;in&nbsp;calculation&quot;))))<br /></span>
          </div>
          <br />常用宏和方法：
          <br />1.除了上面例子的info和error宏，还可以包括warn,trace,debug,fatal等常用宏，分别对应相应的日志级别。这些方法会自动判断当前logger的级别是否有效，有效的前提下才会输出日志。也就是说在Java里，你经常需要这样：
          <br />
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
           <span style="color: #0000FF; ">if</span>
           <span style="color: #000000; ">&nbsp;(logger.isDebugEnabled())&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;logger.debug(x&nbsp;</span>
           <span style="color: #000000; ">+</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">&nbsp;plus&nbsp;</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #000000; ">+</span>
           <span style="color: #000000; ">&nbsp;y&nbsp;</span>
           <span style="color: #000000; ">+</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">&nbsp;is&nbsp;</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #000000; ">+</span>
           <span style="color: #000000; ">&nbsp;(x&nbsp;</span>
           <span style="color: #000000; ">+</span>
           <span style="color: #000000; ">&nbsp;y));<br />}</span>
          </div>在使用 tools.logging的时候是不需要的，因为这些宏帮你做了这个判断。另外，我们在使用log4j的时候需要指定log的namespace，在tools.logging里不需要，默认会取当前的namespace也就是*ns*。
          <br />最后，info还有个infof的方法，用于输出格式化日志：
          <br />
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
           <span style="color: #000000; ">(infof&nbsp;</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">%s&nbsp;is&nbsp;%d&nbsp;years&nbsp;old</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">kid</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #000000; ">3</span>
           <span style="color: #000000; ">)</span>
          </div>日志输出：
          <br />
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
           <span style="color: #000000; ">2012</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">02</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">12</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #000000; ">20</span>
           <span style="color: #000000; ">:</span>
           <span style="color: #000000; ">23</span>
           <span style="color: #000000; ">:</span>
           <span style="color: #000000; ">07</span>
           <span style="color: #000000; ">,</span>
           <span style="color: #000000; ">394</span>
           <span style="color: #000000; ">&nbsp;INFO&nbsp;&nbsp;log:&nbsp;kid&nbsp;is&nbsp;</span>
           <span style="color: #000000; ">3</span>
           <span style="color: #000000; ">&nbsp;years&nbsp;old</span>
          </div>其他方法也有类似的如warnf,debugf等。
          <br />2.spy宏，同时输出表达式的form和结果，例如
          <br />
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
           <span style="color: #000000; ">（spy&nbsp;(</span>
           <span style="color: #000000; ">+</span>
           <span style="color: #000000; ">1</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #000000; ">2</span>
           <span style="color: #000000; ">))</span>
          </div>输出日志
          <br />
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
           <span style="color: #000000; ">2012</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">02</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">12</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #000000; ">20</span>
           <span style="color: #000000; ">:</span>
           <span style="color: #000000; ">11</span>
           <span style="color: #000000; ">:</span>
           <span style="color: #000000; ">47</span>
           <span style="color: #000000; ">,</span>
           <span style="color: #000000; ">415</span>
           <span style="color: #000000; ">&nbsp;DEBUG&nbsp;log:&nbsp;(</span>
           <span style="color: #000000; ">+</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #000000; ">1</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #000000; ">2</span>
           <span style="color: #000000; ">)<br /></span>
           <span style="color: #000000; ">=&gt;</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #000000; ">3</span>
          </div>
          <br />3.with-logs宏可以在将*out*和*err*流重定向到日志的情况下求值表达式，例如：
          <br />
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
           <span style="color: #000000; ">(with</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">logs&nbsp;</span>
           <span style="color: #000000; ">*</span>
           <span style="color: #000000; ">ns</span>
           <span style="color: #000000; ">*</span>
           <span style="color: #000000; ">&nbsp;(prn&nbsp;</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">hello&nbsp;world</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">))</span>
          </div>输出日志：
          <br />
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
           <span style="color: #000000; ">2012</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">02</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">12</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #000000; ">20</span>
           <span style="color: #000000; ">:</span>
           <span style="color: #000000; ">17</span>
           <span style="color: #000000; ">:</span>
           <span style="color: #000000; ">32</span>
           <span style="color: #000000; ">,</span>
           <span style="color: #000000; ">592</span>
           <span style="color: #000000; ">&nbsp;INFO&nbsp;&nbsp;log:&nbsp;</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">hello&nbsp;world</span>
           <span style="color: #000000; ">&quot;</span>
          </div>with-logs需要明确指定log-ns，默认out的输出级别是info，而err的级别是error，可以指定输出级别(with-logs [*ns* :info :error] ......)
          <br />
          <br />4.事务中（dosync中）的日志输出，tools.logging做了特殊处理，默认情况下当且仅当事务成功提交的时候并且日志级别是warn或者info会通过agent异步写入日志。tools.logging定义了一个全局的agent――*logging-agent*。当判断当前是在事务中调用log宏，并且日志级别在集合*tx-agent-levels*内，就会在事务提交成功的时候将日志发送给*logging-agent*异步处理。可以通过*tx-agent-levels*改变使用agent输出日志的级别范围，默认是#{:info :warn}。还可以通过改变*force*变量来强制使用direct或者agent的方式输出日志,*force*可以为:agent或者:direct。
          <br />
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
           <span style="color: #000000; ">(binding&nbsp;[</span>
           <span style="color: #000000; ">*</span>
           <span style="color: #000000; ">force</span>
           <span style="color: #000000; ">*</span>
           <span style="color: #000000; ">&nbsp;:agent]<br />&nbsp;&nbsp;(log&nbsp;:info&nbsp;</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">hello&nbsp;world</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">))</span>
          </div>这里特别使用了log宏，需要明确指定日志级别为info。
          <br />
          <br />5.默认日志框架的是从classpath查找的，查找的顺序是sl4j,commons-logging,log4j,java.util.logging，找到哪个可用就用哪个。如果你的classpath里存在多个日志框架，如同时存在sl4j和commons-logging，那么如果你希望强制使用commons-logging，可以通过改变*logger-factory*变量来使用：
          <br />
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
           <span style="color: #000000; ">(ns&nbsp;example<br />&nbsp;&nbsp;(:use&nbsp;[clojure.tools.logging.impl&nbsp;:only&nbsp;[cl</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">factory]]))<br />(binding&nbsp;[</span>
           <span style="color: #000000; ">*</span>
           <span style="color: #000000; ">logger</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">factory</span>
           <span style="color: #000000; ">*</span>
           <span style="color: #000000; ">&nbsp;(cl</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">factory)]<br />&nbsp;&nbsp;(info&nbsp;</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">hello&nbsp;world</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">))<br /><br /></span>
          </div>*logger-factory*是dynamic变量，可以通过binding改变（前面提到的*force*等变量也一样），如果不希望每次都用binding，而是全局改变，则需要特殊处理：
          <br />
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
           <span style="color: #000000; ">(alter</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">var</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">root&nbsp;(var&nbsp;</span>
           <span style="color: #000000; ">*</span>
           <span style="color: #000000; ">logger</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">factory</span>
           <span style="color: #000000; ">*</span>
           <span style="color: #000000; ">)&nbsp;(constantly&nbsp;(cl</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">factory))) <br /></span>
          </div>其他logger factory还包括slf4j-factory,log4j-factory,jul-factory。
          <br />
          <br />6.每个日志框架的配置跟使用java没有什么两样，比如你用log4j，就需要在classpath下放置一个log4j.properties等。如果你希望用编程的方式配置，可以使用
          <a href="http://github.com/malcolmsparks/clj-logging-config">clj-logging-config</a>。
          <br />
          <br />转载请注明出处：
          <a id="Editor_Edit_hlEntryLink" title="view: Clojure世界：日志管理――clojure.tools.logging" href="../archive/2012/02/12/369822.html" target="_blank">http://www.blogjava.net/killme2008/archive/2012/02/12/369822.html</a>
         </div> 
         <p class="postfoot"> posted @ <a href="http://www.blogjava.net/killme2008/archive/2012/02/12/369822.html" title="permalink">2012-02-12 20:53</a> dennis 阅读(3535) | <a href="http://www.blogjava.net/killme2008/archive/2012/02/12/369822.html#FeedBack" title="comments, pingbacks, trackbacks">评论 (4)</a> |&nbsp;<a href="http://www.blogjava.net/killme2008/admin/EditPosts.aspx?postid=369822">编辑</a>&nbsp;<a href="http://www.blogjava.net/killme2008/AddToFavorite.aspx?id=369822">收藏</a> </p> 
        </div> 
        <div class="post" style="filter:progid:DXImageTransform.Microsoft.Shadow(color='Blue', Direction=135, Strength=32)"> 
         <div class="posthead"> 
          <h2 style="padding-top:4px; padding-bottom:4px;"><a id="ArchiveDay1_SingleDay_DayList_ctl27_TitleUrl" href="http://www.blogjava.net/killme2008/archive/2012/02/09/369694.html">Clojure世界： STM的统计</a></h2> 
         </div> 
         <div class="postbody">
          &nbsp;&nbsp;&nbsp; 年前一篇blog提过，写了一个stm-profiler用于统计clojure STM的运行状况，放在了github上：
          <br /> 
          <a href="https://github.com/killme2008/stm-profiler">https://github.com/killme2008/stm-profiler</a>
          <br /> 
          <br /> &nbsp;&nbsp; STM的事务在遇到写冲突（多个事务写同一个ref的时候）就会回滚事务并重试，通过stm-profiler你可以查看事务的重试次数，重试原因，以及每个reference的使用情况。使用很简单，在lein的project.clj引用stm-profiler:
          <br /> 
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br />
<br />
Code highlighting produced by Actipro CodeHighlighter (freeware)<br />
http://www.CodeHighlighter.com/<br />
<br />
-->
           <span style="color: #000000; ">[stm-profiler&nbsp;&quot;1.0.2-SNAPSHOT&quot;]</span>
          </div> 
          <br /> 注意，目前stm profiler仅支持clojure 1.3。
          <br /> 
          <br /> 我们写一个简单例子：
          <br /> 
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br />
<br />
Code highlighting produced by Actipro CodeHighlighter (freeware)<br />
http://www.CodeHighlighter.com/<br />
<br />
-->
           <span style="color: #000000;">(use&nbsp;'stm)<br /> (def&nbsp;a&nbsp;(ref&nbsp;1))<br /> (def&nbsp;b&nbsp;(ref&nbsp;2))<br /> <br /> (dotimes&nbsp;[_&nbsp;100]&nbsp;(future&nbsp;(dosync&nbsp;(alter&nbsp;a&nbsp;+&nbsp;1)&nbsp;(alter&nbsp;b&nbsp;-&nbsp;1))))<br /> (Thread/sleep&nbsp;1000)<br /> (prn&nbsp;@a)<br /> (prn&nbsp;@b)<br /> (Thread/sleep&nbsp;1000)<br /> (prn&nbsp;&quot;stm&nbsp;statistics&quot;&nbsp;(stm-stats))<br /> (prn&nbsp;&quot;reference&nbsp;a&nbsp;statistics&quot;&nbsp;(ref-stats&nbsp;a))<br /> (prn&nbsp;&quot;reference&nbsp;b&nbsp;statistics&quot;&nbsp;(ref-stats&nbsp;b))<br /> </span>
          </div> 
          <br /> 定义了两个ref：a和b，然后用future启动100个线程并发地发起同一个事务操作，对a加一，对b减一。最后打印a和b的值，使用stm-stats函数获取stm的统计信息并打印，使用ref-stats获取a和b两个reference的统计信息并打印。
          <br /> 
          <br /> 运行这个例子，在启动的时候会有些警告信息，忽略即可（主要是因为stm profiler重新定义了一些跟STM相关的函数和宏，如dosync等，但是仅仅是添加了统计功能，并没有修改他们原本的功能）。
          <br /> 
          <br /> 在我机器上的一次输出：
          <br /> 
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br />
<br />
Code highlighting produced by Actipro CodeHighlighter (freeware)<br />
http://www.CodeHighlighter.com/<br />
<br />
-->
           <span style="color: #000000; ">101<br /> -98<br /> &quot;stm&nbsp;statistics&quot;&nbsp;{&quot;(alter&nbsp;a&nbsp;+&nbsp;1)(alter&nbsp;b&nbsp;-&nbsp;1)&quot;&nbsp;{:not-running&nbsp;11,&nbsp;:average-retry&nbsp;5,&nbsp;:total-cost&nbsp;1233,&nbsp;:get-fault&nbsp;44,&nbsp;:barge-fail&nbsp;224,&nbsp;:change-committed&nbsp;227,&nbsp;:total-times&nbsp;100,&nbsp;:average-cost&nbsp;12}}<br /> &quot;reference&nbsp;a&nbsp;statistics&quot;&nbsp;{&quot;(alter&nbsp;a&nbsp;+&nbsp;1)(alter&nbsp;b&nbsp;-&nbsp;1)&quot;&nbsp;{:alter&nbsp;609,&nbsp;:get-fault&nbsp;44,&nbsp;:barge-fail&nbsp;224,&nbsp;:change-committed&nbsp;227}}<br /> &quot;reference&nbsp;b&nbsp;statistics&quot;&nbsp;{&quot;(alter&nbsp;a&nbsp;+&nbsp;1)(alter&nbsp;b&nbsp;-&nbsp;1)&quot;&nbsp;{:alter&nbsp;114,&nbsp;:not-running&nbsp;11}}</span>
          </div> 
          <br /> a和b的结果都没问题。重点看打印的统计信息，(stm-stats)的输出结果是：
          <br /> 
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br />
<br />
<br />
<br />
Code highlighting produced by Actipro CodeHighlighter (freeware)<br />
http://www.CodeHighlighter.com/<br />
<br />
-->
           <span style="color: #000000; ">{&quot;(alter&nbsp;a&nbsp;+&nbsp;1)(alter&nbsp;b&nbsp;-&nbsp;1)&quot;&nbsp;{:not-running&nbsp;11,&nbsp;:average-retry&nbsp;5,&nbsp;:total-cost&nbsp;1233,&nbsp;:get-fault&nbsp;44,&nbsp;:barge-fail&nbsp;224,&nbsp;:change-committed&nbsp;227,&nbsp;:total-times&nbsp;100,&nbsp;:average-cost&nbsp;12}}</span>
          </div> 
          <br /> 这个结果是一个map,key是事务的form，而value就是该form的统计信息，也是一个map，具体各项的含义如下：
          <br /> 
          <table bgcolor="#C0C0C0" border="3" bordercolor="#000000" cellpadding="2" cellspacing="2" height="102" width="722"> 
           <tbody> 
            <tr> 
             <td> total-cost<br /> </td> 
             <td> 所有事务的总耗时<br /> </td> 
             <td> 100个事务耗时1233毫秒<br /> </td> 
            </tr> 
            <tr> 
             <td> total-times<br /> </td> 
             <td> 事务运行次数<br /> </td> 
             <td> 100次<br /> </td> 
            </tr> 
            <tr> 
             <td> average-cost<br /> </td> 
             <td> 平均每个事务耗时<br /> </td> 
             <td> 平均一个事务耗时12毫秒<br /> </td> 
            </tr> 
            <tr> 
             <td>average-retry<br /> </td> 
             <td>平均每个事务的重试次数</td> 
             <td>&nbsp;平均每个事务重试了5次才成功</td> 
            </tr> 
            <tr> 
             <td>not-running</td> 
             <td>&nbsp;当前事务不处于running状态，可能是被其他事务打断（barge)，需要重试</td> 
             <td>&nbsp;因为not-running的原因重试了11次</td> 
            </tr> 
            <tr> 
             <td>get-fault<br /> </td> 
             <td>&nbsp;读取ref值的时候没有找到read point之前的值，被认为是一次读错误，需要重试<br /> </td> 
             <td>&nbsp;因为读ref错误重试了44次<br /> </td> 
            </tr> 
            <tr> 
             <td>barge-fail</td> 
             <td>&nbsp;打断其他事务失败次数，需要重试</td> 
             <td>&nbsp;尝试打断其他事务失败而重试了224次</td> 
            </tr> 
            <tr> 
             <td>change-committed</td> 
             <td>&nbsp;在本事务read point之后有ref值获得提交，则需要重试<br /> </td> 
             <td>&nbsp;因为ref值被其他事务提交而重试了227次</td> 
            </tr> 
           </tbody> 
          </table> 
          <br /> &nbsp;&nbsp;&nbsp; 从输出结果来看，这么简单的一个事务操作，每次事务要成功平均都需要经过5次的重试，最大的原因是因为ref的值在事务中被其他事务更改了，或者尝试打断其他正在运行的事务失败而重试。关于clojure STM的具体原理推荐看这篇文章《
          <a href="http://java.ociweb.com/mark/stm/article.html#barge">Software transactional memory</a>》。STM不是完美的，事务重试和保存每个reference的历史版本的代价都不低。
          <br />
          <br />&nbsp;&nbsp;&nbsp; 再看
          <span style="color: #000000;">(ref-stats&nbsp;a)的输出：<br /></span>
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
           <span style="color: #000000; ">{&quot;(alter&nbsp;a&nbsp;+&nbsp;1)(alter&nbsp;b&nbsp;-&nbsp;1)&quot;&nbsp;{:alter&nbsp;609,&nbsp;:get-fault&nbsp;44,&nbsp;:barge-fail&nbsp;224,&nbsp;:change-committed&nbsp;227}}</span>
          </div>&nbsp;&nbsp;&nbsp; 可以看到a在所有事务中的统计信息，返回的结果同样是个map，key是使用了a的事务，value是具体的统计信息。各项的含义类似上表，不过这里精确到了具体的reference。其中alter项是指对a调用alter函数了609次。ref-stats会输出所有在事务中调用了a的函数的调用次数。
          <br />
          <br />&nbsp;&nbsp;&nbsp; 通过stm profiler你可以分析具体每个事务的执行状况，甚至每个reference的运行状况，查找热点事务和热点reference等。stm-profiler还不完善，目前还不支持1.2（1.4测试是可以的）。希望有兴趣的朋友加入进来一起完善。
          <br />
          <br />转载请注明出处：
          <a id="Editor_Edit_hlEntryLink" title="view: Clojure世界： STM的统计" href="../archive/2012/02/09/369694.html" target="_blank">http://www.blogjava.net/killme2008/archive/2012/02/09/369694.html</a>
         </div> 
         <p class="postfoot"> posted @ <a href="http://www.blogjava.net/killme2008/archive/2012/02/09/369694.html" title="permalink">2012-02-09 20:55</a> dennis 阅读(3071) | <a href="http://www.blogjava.net/killme2008/archive/2012/02/09/369694.html#FeedBack" title="comments, pingbacks, trackbacks">评论 (2)</a> |&nbsp;<a href="http://www.blogjava.net/killme2008/admin/EditPosts.aspx?postid=369694">编辑</a>&nbsp;<a href="http://www.blogjava.net/killme2008/AddToFavorite.aspx?id=369694">收藏</a> </p> 
        </div> 
        <div class="post" style="filter:progid:DXImageTransform.Microsoft.Shadow(color='Blue', Direction=135, Strength=32)"> 
         <div class="posthead"> 
          <h2 style="padding-top:4px; padding-bottom:4px;"><a id="ArchiveDay1_SingleDay_DayList_ctl28_TitleUrl" href="http://www.blogjava.net/killme2008/archive/2012/02/09/369655.html">第二次cn-clojure线下聚会</a></h2> 
         </div> 
         <div class="postbody">
          <br />&nbsp;&nbsp;&nbsp; 去年（我靠，已经是去年了）首次在上海组织了第一次cn-clojure的线下聚会，详细可以看
          <a href="http://www.blogjava.net/killme2008/archive/2011/08/09/356106.html">这篇blog</a>。今年，我们将在北京举行第二次cn-clojure的聚会，时间大概在2月底或者3月初，具体地点待定，欢迎任何对clojure语言或者Lisp语言感兴趣的朋友参加，如果有想分享的技术topic更好 :D。
          <br />
          <br />&nbsp;&nbsp;&nbsp; 如果你要参加，请参加下面的报名调查，填写真实的姓名和邮箱。如果有想分享的topic，可以填写调查或者直接邮件给我。
          <br />&nbsp;&nbsp;&nbsp; 报名链接：
          <a href="http://www.diaochapai.com/survey584561">http://www.diaochapai.com/survey584561</a>
          <br />
          <br />&nbsp;&nbsp;&nbsp; 我们将在议程、时间和地点确定后发邮件给报名的朋友，确认参会的具体时间和地点。
          <br />&nbsp;&nbsp;&nbsp; 邮件列表：
          <a href="http://groups.google.com/group/cn-clojure">http://groups.google.com/group/cn-clojure</a>
         </div> 
         <p class="postfoot"> posted @ <a href="http://www.blogjava.net/killme2008/archive/2012/02/09/369655.html" title="permalink">2012-02-09 12:37</a> dennis 阅读(2639) | <a href="http://www.blogjava.net/killme2008/archive/2012/02/09/369655.html#FeedBack" title="comments, pingbacks, trackbacks">评论 (0)</a> |&nbsp;<a href="http://www.blogjava.net/killme2008/admin/EditPosts.aspx?postid=369655">编辑</a>&nbsp;<a href="http://www.blogjava.net/killme2008/AddToFavorite.aspx?id=369655">收藏</a> </p> 
        </div> 
        <div class="post" style="filter:progid:DXImageTransform.Microsoft.Shadow(color='Blue', Direction=135, Strength=32)"> 
         <div class="posthead"> 
          <h2 style="padding-top:4px; padding-bottom:4px;"><a id="ArchiveDay1_SingleDay_DayList_ctl29_TitleUrl" href="http://www.blogjava.net/killme2008/archive/2012/01/15/368548.html">最近做的一些事情</a></h2> 
         </div> 
         <div class="postbody">
          <br />&nbsp;&nbsp;&nbsp; 很久没写blog了，写写最近做的一些工作，给感兴趣的朋友做参考。
          <br />&nbsp;&nbsp;&nbsp; 首先是我们的
          <a href="http://sna-projects.com/kafka/projects.php">kafka</a>的“复制品”metamorphosis做了1.4版本，实现了同步复制方案，broker本身也做了很多优化，总体而言meta是一个非常成熟可用的产品了。甚至可以说是我在淘宝做的最好的一个产品。有些朋友总是问我们为什么不直接用kafka，而要另写一个？这里做个统一的解答。
          <br />（1）kafka是scala写的，我对scala不熟悉，也不待见，考虑到维护和语言熟悉程度，用java重写仍然是最好的选择。
          <br />（2）其次，kafka的整个社区非常不活跃，发展太慢，而我又不愿意去学习scala来参与社区发展，那么唯一的出路就是自己写。
          <br />（3）kafka的一些工作不能满足我们的要求，比如一开始它连producer的负载均衡都没有，它的消费者API设计还是比较蛋疼的。它也不支持事务，没有考虑作为一个通用的MQ系统来使用。并且它也没有高可用和数据高可靠的方案。
          <br />（4）我们做了什么呢？
          <br />a.用java彻底重写整个系统，除了原理一致，整个实现是彻底重新实现的。
          <br />b.我们提供了生产者的负载均衡（仍然是基于zk），重新设计了消费者API，更符合 JMS的使用习惯。
          <br />c.我们提供了事务实现，包括producer和consumer端的，包括本地事务和符合XA规范的分布式事务实现。
          <br />d.我们提供了两种数据高可靠方案：类似mysql的异步复制和同步复制方案。通过将消息复制到多个节点上来保证数据的高可靠。
          <br />e.我们提供了http协议的实现，并且本身使用协议也是类似memcached的文本协议，内部也增加了很多统计项目，可以以memcached的stats协议的方式来获取纯文本的统计信息。整个系统运维很方便。
          <br />f.提供了很多扩展应用：广播消费者的实现，多种offset存储的实现（默认的zookeeper，还有文件和mysql)，tail4j用于作为agent发送日志，log4j appender扩展用于透明地使用log4j发送消息，hdfs writer用于将消息写入hdfs，storm spout用于将消息接入storm做实时分析，基本上形成一套完整的工具链和扩展。
          <br />g.一些其他功能点：group commit提升数据可靠性和吞吐量，连接复用，集群下的顺序消息发送，消息数据的无痛迁移和水平扩展，web管理平台等。
          <br />
          <br />&nbsp;&nbsp;&nbsp; meta未来会走开源的路子，不过不会是我来推动的，估计是在今年会有进展。
          <br />
          <br />&nbsp;&nbsp;&nbsp; 我最近还写了一些小项目值得一提，首先是
          <a href="http://code.google.com/p/aviator/">aviator</a>这个轻量级的表达式执行引擎发布了2.2.1版本，主要是这么几个改进：
          <br />（1）支持多维数组变量的访问，如a[0][0]
          <br />（2）添加Expression#getVariableNames()用于返回表达式的变量列表
          <br />（3）添加AviatorEvaluator#exec方法来简化调用
          <br />（4）bug修正等。
          <br />&nbsp;&nbsp;&nbsp; maven直接升级：
          <br />
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #0000FF; ">&lt;</span>
           <span style="color: #800000; ">dependency</span>
           <span style="color: #0000FF; ">&gt;</span>
           <span style="color: #000000; "><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000FF; ">&lt;</span>
           <span style="color: #800000; ">groupId</span>
           <span style="color: #0000FF; ">&gt;</span>
           <span style="color: #000000; ">com.googlecode.aviator</span>
           <span style="color: #0000FF; ">&lt;/</span>
           <span style="color: #800000; ">groupId</span>
           <span style="color: #0000FF; ">&gt;</span>
           <span style="color: #000000; "><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000FF; ">&lt;</span>
           <span style="color: #800000; ">artifactId</span>
           <span style="color: #0000FF; ">&gt;</span>
           <span style="color: #000000; ">aviator</span>
           <span style="color: #0000FF; ">&lt;/</span>
           <span style="color: #800000; ">artifactId</span>
           <span style="color: #0000FF; ">&gt;</span>
           <span style="color: #000000; "><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000FF; ">&lt;</span>
           <span style="color: #800000; ">version</span>
           <span style="color: #0000FF; ">&gt;</span>
           <span style="color: #000000; ">2.2.1</span>
           <span style="color: #0000FF; ">&lt;/</span>
           <span style="color: #800000; ">version</span>
           <span style="color: #0000FF; ">&gt;</span>
           <span style="color: #000000; "><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000FF; ">&lt;/</span>
           <span style="color: #800000; ">dependency</span>
           <span style="color: #0000FF; ">&gt;</span>
          </div>
          <br />&nbsp;&nbsp;&nbsp; 其次，
          <a href="https://github.com/killme2008/hs4j">hs4j</a>这个handler socket的客户端，由新浪微博的@赵鹏城实现了inc/dec协议，添加了incr和decr方法用于更新计数，感谢他的贡献，如果你需要这两个功能可以自己从github拉取源码并构建打包，暂时不准备发布到maven。
          <br />
          <br />&nbsp;&nbsp;&nbsp; 第三，关注高可用的Transaction Manager实现的可以关注下我的
          <a href="https://github.com/killme2008/ewok">ewok</a>项目，这是一个基于
          <a href="http://docs.codehaus.org/display/BTM/Home">BTM</a>这个开源JTA实现，提供基于bookkeeper的高可用的TM项目。将事务日志写到高可用的bookkeeper上，并利用zookeeper来做到故障的透明迁移，某个TM挂了，可以在其他机器上从bookkeeper拉取日志并恢复。代码已经稳定并做了性能测试，没有做进一步的破坏性测试。
          <a href="http://docs.codehaus.org/display/BTM/Home">BTM</a>是一个比JOTM和atomikos更靠谱的开源JTA实现，并且性能也好上很多，代码质量更不用说，建议有兴趣的可以看一下。我也为它贡献了
          <a href="https://jira.codehaus.org/browse/BTM-113">一个事务日志写入优化的patch</a>，日志写入性能提升了近一倍。
          <br />
          <br />&nbsp;&nbsp;&nbsp; 最后，我在clojure上做了一些事情，首先是为
          <a href="https://github.com/nathanmarz/storm">storm</a>项目贡献了两个patch：利用curator做zookeeper交互和添加storm.ui.context.path选项，前者被作者接受，后者暂时只对我们有用。前者让storm跟zk的交互更可用，后者是为storm ui添加了可选的相对路径。你都可以在
          <a href="https://github.com/killme2008/storm">我fork的分支上</a>尝试，curator的patch在storm 0.6.2上发布，现在还是snapshot状态。昨天晚上牙痛睡不着，半夜写了个
          <a href="https://github.com/killme2008/stm-profiler">clojure STM profiler</a>，用于统计分析clojure STM运行状况，诸如事务运行次数和时间，事务的重试原因和次数等，可以针对每个dosync的form做统计，有兴趣也可以看下。不过我其实更想将这个功能加入到clojure核心，会尝试提交下pull request。
          <br />
          <br />&nbsp;&nbsp; 还有个工作上的变迁，我将在2月1号正式从呆了近三年的淘宝离职，加入一支充满活力的创业团队。从稳定的大公司出来，去加入一家初创公司，不能说没有风险，但是我还是想去接受新的挑战，愿意更新我的知识结构，愿意向牛人们学习。我在某个blog上说我今年遇到了人生中最大的挑战和转折，并不是说这个事情，而是我的儿子今年患了一场重病，庆幸在很多人的帮助和关心下，他勇敢地挺了过来，度过最困难的一关，现在还在继续治疗。我要感谢很多人，感谢淘宝，感谢我的TL华黎和锋寒，感谢我的同事和朋友林轩，感谢我们的HR，感谢三年后打交道的很多同事。没有他们，我今年真的过不了关，没有他们，我也不能进入淘宝并呆上快三年。
          <br />
          <br />&nbsp;&nbsp; 最后的最后，我要特别感谢我的儿子，谢谢你的降生，谢谢你今年的勇敢，谢谢你给我们全家带来的快乐，谢谢你继续陪着我们 ，也希望你新年继续勇敢地坚持下去，我们必将战胜一切。&nbsp; &nbsp;&nbsp;&nbsp; 
          <br />&nbsp;&nbsp;&nbsp;
         </div> 
         <p class="postfoot"> posted @ <a href="http://www.blogjava.net/killme2008/archive/2012/01/15/368548.html" title="permalink">2012-01-15 12:50</a> dennis 阅读(5091) | <a href="http://www.blogjava.net/killme2008/archive/2012/01/15/368548.html#FeedBack" title="comments, pingbacks, trackbacks">评论 (20)</a> |&nbsp;<a href="http://www.blogjava.net/killme2008/admin/EditPosts.aspx?postid=368548">编辑</a>&nbsp;<a href="http://www.blogjava.net/killme2008/AddToFavorite.aspx?id=368548">收藏</a> </p> 
        </div> 
        <div class="post" style="filter:progid:DXImageTransform.Microsoft.Shadow(color='Blue', Direction=135, Strength=32)"> 
         <div class="posthead"> 
          <h2 style="padding-top:4px; padding-bottom:4px;"><a id="ArchiveDay1_SingleDay_DayList_ctl30_TitleUrl" href="http://www.blogjava.net/killme2008/archive/2011/12/19/366763.html">storm常见问题解答</a></h2> 
         </div> 
         <div class="postbody">
          &nbsp;&nbsp;&nbsp; 最近有朋友给我邮件问一些storm的问题，集中解答在这里。
          <br />
          <strong>一、我有一个数据文件，或者我有一个系统里面有数据，怎么导入storm做计算？</strong>
          <br />
          <br />你需要实现一个Spout，Spout负责将数据emit到storm系统里，交给bolts计算。怎么实现spout可以参考官方的kestrel spout实现：
          <br />
          <a href="https://github.com/nathanmarz/storm-kestrel">https://github.com/nathanmarz/storm-kestrel</a>
          <br />
          <br />如果你的数据源不支持事务性消费，那么就无法得到storm提供的可靠处理的保证，也没必要实现ISpout接口中的ack和fail方法。
          <br />
          <br />
          <strong>二、Storm为了保证tuple的可靠处理，需要保存tuple信息，这会不会导致内存OOM？</strong>
          <br />
          <br />Storm为了保证tuple的可靠处理，acker会保存该节点创建的tuple id的xor值，这称为ack value，那么每ack一次，就将tuple id和ack value做异或(xor)。当所有产生的tuple都被ack的时候， ack value一定为0。这是个很简单的策略，对于每一个tuple也只要占用约20个字节的内存。对于100万tuple，也才20M左右。关于可靠处理看这个：
          <br />
          <a href="https://github.com/nathanmarz/storm/wiki/Guaranteeing-message-processing">https://github.com/nathanmarz/storm/wiki/Guaranteeing-message-processing</a>
          <br />
          <br />
          <strong>三、Storm计算后的结果保存在哪里？可以保存在外部存储吗？</strong>
          <br />
          <br />Storm不处理计算结果的保存，这是应用代码需要负责的事情，如果数据不大，你可以简单地保存在内存里，也可以每次都更新数据库，也可以采用NoSQL存储。storm并没有像s4那样提供一个Persist API，根据时间或者容量来做存储输出。这部分事情完全交给用户。
          <br />
          <br />数据存储之后的展现，也是你需要自己处理的，storm UI只提供对topology的监控和统计。
          <br />
          <br />
          <strong>四、Storm怎么处理重复的tuple？</strong>
          <br />
          <br />因为Storm要保证tuple的可靠处理，当tuple处理失败或者超时的时候，spout会fail并重新发送该tuple，那么就会有tuple重复计算的问题。这个问题是很难解决的，storm也没有提供机制帮助你解决。一些可行的策略：
          <br />（1）不处理，这也算是种策略。因为实时计算通常并不要求很高的精确度，后续的批处理计算会更正实时计算的误差。
          <br />（2）使用第三方集中存储来过滤，比如利用mysql,memcached或者redis根据逻辑主键来去重。
          <br />（3）使用bloom filter做过滤，简单高效。
          <br />
          <br />
          <strong>五、Storm的动态增删节点</strong>
          <br />
          <br />我在storm和s4里比较里谈到的动态增删节点，是指storm可以动态地添加和减少supervisor节点。对于减少节点来说，被移除的supervisor上的worker会被nimbus重新负载均衡到其他supervisor节点上。在storm 0.6.1以前的版本，增加supervisor节点不会影响现有的topology，也就是现有的topology不会重新负载均衡到新的节点上，在扩展集群的时候很不方便，需要重新提交topology。因此我在storm的邮件列表里提了这个问题，storm的开发者nathanmarz创建了一个issue 54并在0.6.1提供了rebalance命令来让正在运行的topology重新负载均衡，具体见：
          <br />
          <a href="https://github.com/nathanmarz/storm/issues/54">https://github.com/nathanmarz/storm/issues/54</a>
          <br />和0.6.1的变更：
          <br />
          <a href="http://groups.google.com/group/storm-user/browse_thread/thread/24a8fce0b2e53246">http://groups.google.com/group/storm-user/browse_thread/thread/24a8fce0b2e53246</a>
          <br />
          <br />storm并不提供机制来动态调整worker和task数目。
          <br />
          <br />
          <strong>六、Storm UI里spout统计的complete latency的具体含义是什么？为什么emit的数目会是acked的两倍？</strong>
          <br />这个事实上是storm邮件列表里的一个问题。Storm作者marz的解答：
          <br />
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
           <span style="color: #000000; ">The&nbsp;complete&nbsp;latency&nbsp;is&nbsp;the&nbsp;time&nbsp;<strong>from&nbsp;the&nbsp;spout&nbsp;emitting&nbsp;a&nbsp;tuple&nbsp;to&nbsp;that<br />tuple&nbsp;being&nbsp;acked&nbsp;on&nbsp;the&nbsp;spout</strong>.&nbsp;So&nbsp;it&nbsp;tracks&nbsp;the&nbsp;time&nbsp;</span>
           <span style="color: #0000FF; ">for</span>
           <span style="color: #000000; ">&nbsp;the&nbsp;whole&nbsp;tuple<br />tree&nbsp;to&nbsp;be&nbsp;processed.<br /><br />If&nbsp;you&nbsp;dive&nbsp;into&nbsp;the&nbsp;spout&nbsp;component&nbsp;in&nbsp;the&nbsp;UI,&nbsp;you</span>
           <span style="color: #000000; ">'</span>
           <span style="color: #000000; ">ll&nbsp;see&nbsp;that&nbsp;a&nbsp;lot&nbsp;of</span>
           <span style="color: #000000; "><br /></span>
           <span style="color: #000000; ">the&nbsp;emitted</span>
           <span style="color: #000000; ">/</span>
           <span style="color: #000000; ">transferred&nbsp;is&nbsp;on&nbsp;the&nbsp;__ack</span>
           <span style="color: #000000; ">*</span>
           <span style="color: #000000; ">&nbsp;stream.&nbsp;<strong>This&nbsp;is&nbsp;the&nbsp;spout<br />communicating&nbsp;with&nbsp;the&nbsp;ackers&nbsp;which&nbsp;take&nbsp;care&nbsp;of&nbsp;tracking&nbsp;the&nbsp;tuple&nbsp;trees. </strong><br /></span>
          </div>
          <br />简单地说，complete latency表示了tuple从emit到被acked经过的时间，可以认为是tuple以及该tuple的后续子孙（形成一棵树）整个处理时间。其次spout的emit和transfered还统计了spout和acker之间内部的通信信息，比如对于可靠处理的spout来说，会在emit的时候同时发送一个_ack_init给acker，记录tuple id到task id的映射，以便ack的时候能找到正确的acker task。
          <br />
          <br />
         </div> 
         <p class="postfoot"> posted @ <a href="http://www.blogjava.net/killme2008/archive/2011/12/19/366763.html" title="permalink">2011-12-19 15:25</a> dennis 阅读(13097) | <a href="http://www.blogjava.net/killme2008/archive/2011/12/19/366763.html#FeedBack" title="comments, pingbacks, trackbacks">评论 (9)</a> |&nbsp;<a href="http://www.blogjava.net/killme2008/admin/EditPosts.aspx?postid=366763">编辑</a>&nbsp;<a href="http://www.blogjava.net/killme2008/AddToFavorite.aspx?id=366763">收藏</a> </p> 
        </div> 
        <div class="post" style="filter:progid:DXImageTransform.Microsoft.Shadow(color='Blue', Direction=135, Strength=32)"> 
         <div class="posthead"> 
          <h2 style="padding-top:4px; padding-bottom:4px;"><a id="ArchiveDay1_SingleDay_DayList_ctl31_TitleUrl" href="http://www.blogjava.net/killme2008/archive/2011/12/01/364112.html">Storm源码浅析之topology的提交</a></h2> 
         </div> 
         <div class="postbody">
          &nbsp;&nbsp;&nbsp; 原文：
          <a href="http://www.blogjava.net/killme2008/archive/2011/11/17/364112.html">http://www.blogjava.net/killme2008/archive/2011/11/17/364112.html</a>
          <br />&nbsp;&nbsp;&nbsp; 作者：dennis (killme2008@gmail.com)
          <br />&nbsp;&nbsp;&nbsp; 转载请注明出处。
          <br />
          <br />&nbsp;&nbsp;&nbsp; 最近一直在读twitter开源的这个分布式流计算框架――storm的源码，还是有必要记录下一些比较有意思的地方。我按照storm的主要概念进行组织，并且只分析我关注的东西，因此称之为浅析。&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; 
          <br />
          <br />一、介绍
          <br />&nbsp;&nbsp;&nbsp; Storm的开发语言主要是Java和Clojure，其中Java定义骨架，而Clojure编写核心逻辑。源码统计结果：
          <br />
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
           <span style="color: #000000; ">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #000000; ">180</span>
           <span style="color: #000000; ">&nbsp;text&nbsp;files.<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #000000; ">177</span>
           <span style="color: #000000; ">&nbsp;unique&nbsp;files.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #000000; ">7</span>
           <span style="color: #000000; ">&nbsp;files&nbsp;ignored.<br /><br />http:</span>
           <span style="color: #008000; ">//</span>
           <span style="color: #008000; ">cloc.sourceforge.net&nbsp;v&nbsp;1.55&nbsp;&nbsp;T=1.0&nbsp;s&nbsp;(171.0&nbsp;files/s,&nbsp;46869.0&nbsp;lines/s)</span>
           <span style="color: #008000; "><br /></span>
           <span style="color: #000000; ">-------------------------------------------------------------------------------</span>
           <span style="color: #000000; "><br />Language&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;files&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;blank&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;comment&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;code<br /></span>
           <span style="color: #000000; ">-------------------------------------------------------------------------------</span>
           <span style="color: #000000; "><br />Java&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #000000; ">125</span>
           <span style="color: #000000; ">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #000000; ">5010</span>
           <span style="color: #000000; ">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #000000; ">2414</span>
           <span style="color: #000000; ">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #000000; ">25661</span>
           <span style="color: #000000; "><br />Lisp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #000000; ">33</span>
           <span style="color: #000000; ">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #000000; ">732</span>
           <span style="color: #000000; ">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #000000; ">283</span>
           <span style="color: #000000; ">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #000000; ">4871</span>
           <span style="color: #000000; "><br />Python&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #000000; ">7</span>
           <span style="color: #000000; ">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #000000; ">742</span>
           <span style="color: #000000; ">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #000000; ">433</span>
           <span style="color: #000000; ">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #000000; ">4675</span>
           <span style="color: #000000; "><br />CSS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #000000; ">1</span>
           <span style="color: #000000; ">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #000000; ">12</span>
           <span style="color: #000000; ">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #000000; ">45</span>
           <span style="color: #000000; ">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #000000; ">1837</span>
           <span style="color: #000000; "><br /><a title="" href="http://www.ruby-lang.org">ruby</a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #000000; ">2</span>
           <span style="color: #000000; ">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #000000; ">22</span>
           <span style="color: #000000; ">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #000000; ">0</span>
           <span style="color: #000000; ">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #000000; ">104</span>
           <span style="color: #000000; "><br />Bourne&nbsp;Shell&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #000000; ">1</span>
           <span style="color: #000000; ">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #000000; ">0</span>
           <span style="color: #000000; ">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #000000; ">0</span>
           <span style="color: #000000; ">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #000000; ">6</span>
           <span style="color: #000000; "><br />Javascript&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #000000; ">2</span>
           <span style="color: #000000; ">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #000000; ">1</span>
           <span style="color: #000000; ">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #000000; ">15</span>
           <span style="color: #000000; ">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #000000; ">6</span>
           <span style="color: #000000; "><br /></span>
           <span style="color: #000000; ">-------------------------------------------------------------------------------</span>
           <span style="color: #000000; "><br />SUM:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #000000; ">171</span>
           <span style="color: #000000; ">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #000000; ">6519</span>
           <span style="color: #000000; ">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #000000; ">3190</span>
           <span style="color: #000000; ">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #000000; ">37160</span>
           <span style="color: #000000; "><br /></span>
           <span style="color: #000000; ">-------------------------------------------------------------------------------</span>
          </div>
          <br />&nbsp; &nbsp; Java代码25000多行，而Clojure(Lisp)只有4871行，说语言不重要再次证明是扯淡。
          <br />&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; 
          <br />二、Topology和Nimbus &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; 
          <br />&nbsp;&nbsp;&nbsp; Topology是storm的核心理念，将spout和bolt组织成一个topology，运行在storm集群里，完成实时分析和计算的任务。这里我主要想介绍下topology部署到storm集群的大概过程。提交一个topology任务到Storm集群是通过StormSubmitter.submitTopology方法提交：
          <br />
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
           <span style="color: #000000; ">StormSubmitter.submitTopology(name,&nbsp;conf,&nbsp;builder.createTopology());</span>
          </div>&nbsp;&nbsp;&nbsp; 我们将topology打成jar包后，利用bin/storm这个python脚本，执行如下命令：
          <br />
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
           <span style="color: #000000; ">bin</span>
           <span style="color: #000000; ">/</span>
           <span style="color: #000000; ">storm&nbsp;jar&nbsp;xxxx.jar&nbsp;com.taobao.MyTopology&nbsp;args</span>
          </div>&nbsp;&nbsp;&nbsp; 将jar包提交给storm集群。storm脚本会启动JVM执行Topology的main方法，执行submitTopology的过程。而submitTopology会将jar文件上传到nimbus，上传是通过socket传输。在storm这个python脚本的jar方法里可以看到：
          <br />
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
           <span style="color: #0000FF; ">def</span>
           <span style="color: #000000; ">&nbsp;jar(jarfile,&nbsp;klass,&nbsp;</span>
           <span style="color: #000000; ">*</span>
           <span style="color: #000000; ">args):&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;exec_storm_class(&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;klass,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jvmtype</span>
           <span style="color: #000000; ">=</span>
           <span style="color: #800000; ">&quot;</span>
           <span style="color: #800000; ">-client</span>
           <span style="color: #800000; ">&quot;</span>
           <span style="color: #000000; ">,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;extrajars</span>
           <span style="color: #000000; ">=</span>
           <span style="color: #000000; ">[jarfile,&nbsp;CONF_DIR,&nbsp;STORM_DIR&nbsp;</span>
           <span style="color: #000000; ">+</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #800000; ">&quot;</span>
           <span style="color: #800000; ">/bin</span>
           <span style="color: #800000; ">&quot;</span>
           <span style="color: #000000; ">],&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;args</span>
           <span style="color: #000000; ">=</span>
           <span style="color: #000000; ">args,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>prefix</strong></span>
           <strong><span style="color: #000000; ">=</span><span style="color: #800000; ">&quot;</span><span style="color: #800000; ">export&nbsp;STORM_JAR=</span><span style="color: #800000; ">&quot;</span><span style="color: #000000; ">&nbsp;</span><span style="color: #000000; ">+</span><span style="color: #000000; ">&nbsp;jarfile&nbsp;</span><span style="color: #000000; ">+</span><span style="color: #000000; ">&nbsp;</span><span style="color: #800000; ">&quot;</span><span style="color: #800000; ">;</span><span style="color: #800000; ">&quot;</span></strong>
           <span style="color: #000000; "><strong>)</strong> <br /></span>
          </div>&nbsp;&nbsp;&nbsp;&nbsp; 将jar文件的地址设置为环境变量STORM_JAR，这个环境变量在执行submitTopology的时候用到：
          <br />
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
           <span style="color: #008000; ">//</span>
           <span style="color: #008000; ">StormSubmitter.java&nbsp;</span>
           <span style="color: #008000; "><br /></span>
           <span style="color: #0000FF; ">private</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #0000FF; ">static</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #0000FF; ">void</span>
           <span style="color: #000000; ">&nbsp;submitJar(Map&nbsp;conf)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000FF; ">if</span>
           <span style="color: #000000; ">(submittedJar</span>
           <span style="color: #000000; ">==</span>
           <span style="color: #0000FF; ">null</span>
           <span style="color: #000000; ">)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOG.info(</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">Jar&nbsp;not&nbsp;uploaded&nbsp;to&nbsp;master&nbsp;yet.&nbsp;Submitting&nbsp;jar<img src="http://www.blogjava.net/Images/dot.gif" alt="" /></span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String&nbsp;localJar&nbsp;</span>
           <span style="color: #000000; ">=</span>
           <strong><span style="color: #000000; ">&nbsp;System.getenv(</span><span style="color: #000000; ">&quot;</span><span style="color: #000000; ">STORM_JAR</span><span style="color: #000000; ">&quot;</span></strong>
           <span style="color: #000000; "><strong>)</strong>;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;submittedJar&nbsp;</span>
           <span style="color: #000000; ">=</span>
           <span style="color: #000000; ">&nbsp;submitJar(conf,&nbsp;localJar);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;</span>
           <span style="color: #0000FF; ">else</span>
           <span style="color: #000000; ">&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOG.info(</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">Jar&nbsp;already&nbsp;uploaded&nbsp;to&nbsp;master.&nbsp;Not&nbsp;submitting&nbsp;jar.</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;}</span>
          </div>&nbsp;&nbsp;&nbsp; 通过环境变量找到jar包的地址，然后上传。利用环境变量传参是个小技巧。
          <br />
          <br />&nbsp;&nbsp;&nbsp; 其次，nimbus在接收到jar文件后，存放到数据目录的inbox目录，
          <strong>nimbus数据目录的结构</strong>：
          <br />
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">nimbus<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">inbox<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">stormjar</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">57f1d694</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">2865</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">4b3b</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">8a7c</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">99104fc0aea3.jar<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">stormjar</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">76b4e316</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">b430</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">4215</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">9e26</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">4f33ba4ee520.jar<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">stormdist<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">storm</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">id<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">stormjar.jar<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">stormconf.ser<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">stormcode.ser</span>
          </div>&nbsp;&nbsp;&nbsp;&nbsp; 其中inbox用于存放提交的jar文件，每个jar文件都重命名为stormjar加上一个32位的UUID。而stormdist存放的是启动topology后生成的文件，每个topology都分配一个唯一的id，ID的规则是“name-计数-时间戳”。启动后的topology的jar文件名命名为storm.jar ,而它的配置经过java序列化后存放在stormconf.ser文件，而stormcode.ser是将topology本身序列化后存放的文件。
          <strong>这些文件在部署的时候，supervisor会从这个目录下载这些文件，然后在supervisor本地执行这些代码。</strong>
          <br />&nbsp;&nbsp;&nbsp; 进入重点，topology任务的分配过程(zookeeper路径说明忽略root):
          <br />1.在zookeeper上创建/taskheartbeats/{storm id} 路径，用于任务的心跳检测。storm对zookeeper的一个重要应用就是利用zk的临时节点做存活检测。task将定时刷新节点的时间戳，然后nimbus会检测这个时间戳是否超过timeout设置。
          <br />2.从topology中获取bolts,spouts设置的并行数目以及全局配置的最大并行数，然后产生task id列表，如[1 2 3 4]
          <br />3.在zookeeper上创建/tasks/{strom id}/{task id}路径，并存储task信息
          <br />4.开始分配任务（内部称为assignment)， 具体步骤：
          <br />&nbsp;(1)从zk上获得已有的assignment(新的toplogy当然没有了）
          <br />&nbsp;(2)查找所有可用的slot，所谓slot就是可用的worker，在所有supervisor上配置的多个worker的端口。
          <br />&nbsp;(3)将任务均匀地分配给可用的worker，这里有两种情况：
          <br />&nbsp;(a)task数目比worker多，例如task是[1 2 3 4],可用的slot只有[host1:port1 host2:port1]，那么最终是这样分配
          <br />
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
           <span style="color: #000000; ">{</span>
           <span style="color: #000000; ">1</span>
           <span style="color: #000000; ">:&nbsp;[host1:port1]&nbsp;</span>
           <span style="color: #000000; ">2</span>
           <span style="color: #000000; ">&nbsp;:&nbsp;[host2:port1]<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #000000; ">3</span>
           <span style="color: #000000; ">&nbsp;:&nbsp;[host1:port1]&nbsp;</span>
           <span style="color: #000000; ">4</span>
           <span style="color: #000000; ">&nbsp;:&nbsp;[host2:port1]}</span>
          </div>，可以看到任务平均地分配在两个worker上。
          <br />(b)如果task数目比worker少，例如task是[1 2]，而worker有[host1:port1 host1:port2 host2:port1 host2:port2]，那么首先会将woker排序，
          <strong>将不同host间隔排列</strong>，保证task不会全部分配到同一个worker上，也就是将worker排列成
          <br />
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
           <span style="color: #000000; ">[host1:port1&nbsp;host2:port1&nbsp;host1:port2&nbsp;host2:port2]</span>
          </div>，然后分配任务为
          <br />
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
           <span style="color: #000000; ">{</span>
           <span style="color: #000000; ">1</span>
           <span style="color: #000000; ">:&nbsp;host1:port1&nbsp;,&nbsp;</span>
           <span style="color: #000000; ">2</span>
           <span style="color: #000000; ">&nbsp;:&nbsp;host2:port2}</span>
          </div>
          <br />(4)记录启动时间
          <br />(5)判断现有的assignment是否跟重新分配的assignment相同，如果相同，不需要变更，否则更新assignment到zookeeper的/assignments/{storm id}上。
          <br />5.启动topology，所谓启动，只是将zookeeper上/storms/{storm id}对应的数据里的active设置为true。
          <br />6.nimbus会检查task的心跳，如果发现task心跳超过超时时间，那么会重新跳到第4步做re-assignment。
          <br />
         </div> 
         <p class="postfoot"> posted @ <a href="http://www.blogjava.net/killme2008/archive/2011/12/01/364112.html" title="permalink">2011-12-01 21:48</a> dennis 阅读(13771) | <a href="http://www.blogjava.net/killme2008/archive/2011/12/01/364112.html#FeedBack" title="comments, pingbacks, trackbacks">评论 (10)</a> |&nbsp;<a href="http://www.blogjava.net/killme2008/admin/EditPosts.aspx?postid=364112">编辑</a>&nbsp;<a href="http://www.blogjava.net/killme2008/AddToFavorite.aspx?id=364112">收藏</a> </p> 
        </div> 
        <div class="post" style="filter:progid:DXImageTransform.Microsoft.Shadow(color='Blue', Direction=135, Strength=32)"> 
         <div class="posthead"> 
          <h2 style="padding-top:4px; padding-bottom:4px;"><a id="ArchiveDay1_SingleDay_DayList_ctl32_TitleUrl" href="http://www.blogjava.net/killme2008/archive/2011/12/01/365329.html">storm集群的监控</a></h2> 
         </div> 
         <div class="postbody">
          <br />&nbsp;&nbsp;&nbsp; 所谓兵马未动，粮草先行，准备将
          <a href="https://github.com/nathanmarz/storm/wiki">storm</a>用在某个项目中做实时数据分析。无论任何系统，一定要有监控系统并存，当故障发生的时候你能第一个知道，而不是让别人告诉你，那处理故障就很被动了。
          <br />
          <br />&nbsp;&nbsp;&nbsp; 因此我写了这么个项目，取名叫storm-monitor，放在了github上
          <br />
          <br />&nbsp;&nbsp;&nbsp;&nbsp; 
          <a href="https://github.com/killme2008/storm-monitor">https://github.com/killme2008/storm-monitor</a>
          <br />
          <br />&nbsp;&nbsp;&nbsp; 主要功能如下：
          <br />1.监控supervisor数目是否正确，当supervisor挂掉的时候会发送警告。
          <br />2.监控nimbus是否正常运行，monitor会尝试连接nimbus，如果连接失败就认为nimbus挂掉。
          <br />3.监控topology是否正常运行，包括它是否正常部署，是否有运行中的任务。
          <br />
          <br />&nbsp;&nbsp;&nbsp; 当故障发生的时候通过alarm方法警告用户，开放出去的只是简单地打日志。因为每个公司的告警接口不一样，所以你需要自己扩展，修改alarm.clj即可。我们这儿就支持旺旺告警和手机短信告警。
          <br />
          <br />&nbsp;&nbsp;&nbsp; 基本的原理很简单，对supervisor和topology的监控是通过zookeeper来间接地监控，通过定期查看path是否存在。对nimbus的监控是每次起一个短连接连上去，连不上去即认为挂掉。
          <br />
          <br />&nbsp;&nbsp;&nbsp; 整个项目也是用clojure写。你的机器需要安装
          <a href="https://github.com/technomancy/leiningen">lein</a>和
          <a href="https://github.com/kumarshantanu/lein-exec">exec</a>插件，然后将你的storm.yaml拷贝到conf目录下，编辑monitor.yaml设定监控参数如检查间隔等，最后启动start.sh脚本即可。默认日志输出在logs/monitor.log。
          <br />
         </div> 
         <p class="postfoot"> posted @ <a href="http://www.blogjava.net/killme2008/archive/2011/12/01/365329.html" title="permalink">2011-12-01 21:02</a> dennis 阅读(9106) | <a href="http://www.blogjava.net/killme2008/archive/2011/12/01/365329.html#FeedBack" title="comments, pingbacks, trackbacks">评论 (0)</a> |&nbsp;<a href="http://www.blogjava.net/killme2008/admin/EditPosts.aspx?postid=365329">编辑</a>&nbsp;<a href="http://www.blogjava.net/killme2008/AddToFavorite.aspx?id=365329">收藏</a> </p> 
        </div> 
        <div class="post" style="filter:progid:DXImageTransform.Microsoft.Shadow(color='Blue', Direction=135, Strength=32)"> 
         <div class="posthead"> 
          <h2 style="padding-top:4px; padding-bottom:4px;"><a id="ArchiveDay1_SingleDay_DayList_ctl33_TitleUrl" href="http://www.blogjava.net/killme2008/archive/2011/11/30/365238.html">我的一些“偏见”</a></h2> 
         </div> 
         <div class="postbody">
          <br />&nbsp; &nbsp; 在豆瓣发了一些牢骚，索性多说一些我个人对人对事的偏见，既然是偏见，就不会让人舒服，事先声明是扯淡，不想浪费时间的人略过。
          <br />
          <br />1.我们要远离新浪微博，新浪微博跟twitter不一样，twitter是为了让每个人的信息的更好更快地传播而设计的，而新浪微博是为了让权威的声音更好更快地传播而设计的。迷恋上新浪微博，你要么是权威，要么是跟随权威。成为权威的，免不了沾沾自喜，真以为自己成了“权威”。更可怕的是你不可避免地要生活在相互吹捧和喧嚣中。
          <br />
          <br />2.在编写代码之外，我们可能需要更多的手艺傍身，例如木匠或者厨师，以免在乱世的时候因为不需要程序员而饿死。ps.计算弹道轨迹的程序员除外。
          <br />
          <br />3.据说真正的牛人从不跳槽，作为大多数不是牛人，以及已经远离牛人行列的我们（跳槽超过3次以上），跳槽仍然是你提升自己的有效途径，无论是薪水还是技术。
          <br />
          <br />4.写简历的技巧，我慢慢领悟到了，少点技术术语，多点成效和应用，打动了HR过了第一关之后，再去跟技术人员扯淡。
          <br />
          <br />5.简历要定时更新，你可以理解成定时提醒下猎头和HR，关注我啊，关注我啊。
          <br />
          <br />6.强烈地拥抱文本化，配置文本化（没人会脑残地用二进制当配置文件吧？），协议文本化，婚姻文本化。
          <br />
          <br />7.一切不以加薪为目的的挽留，都是耍流氓，这不是我的原创。
          <br />
          <br />8.有趣比实用重要，没趣味的东西，给钱也不去做（好吧，我说假话）。
          <br />
          <br />9.对新潮的东西保持一点警惕，如果这个东西三个月后还有人在谈论，那可以关注下
          <br />
          <br />10.代码永远比文档、博客真实和靠谱，阅读代码习惯了，跟阅读文档没啥区别。
          <br />
          <br />11.少关注博客和新闻，戒掉看google reader的习惯。现在更多地看maillist上的讨论和问题，真正重要的东西你永远不会错过。
          <br />
          <br />12.不追求完美，等你完美的时候别人已经是事实标准。
          <br />
          <br />13.大型的技术聚会不是为技术人员准备的，这是大公司给员工的度假福利和领导们的吹水时间。只有在小型的技术聚会上才能看到一些有价值的东西，任何稍微跟商业沾一点边的几乎都没有太大价值，我说的是国内。
          <br />
          <br />14.80%的分享都只对演讲者有益，该sb的还是sb，该牛b的还是牛b。最有效的分享是结对编程和结对review。分享和培训最大的意义是让行政们觉的自己的存在价值很大。
          <br />
          <br />15.国内翻译国外经典&gt;国内原创精品&gt;国外原版，这个原则对英语好的人除外。
          <br />
          <br />16.极其讨厌要求强制缩进的语言，比如python。
          <br />
          <br />17.标榜是一种人生态度，装B装久了你就真牛B了。
          <br />
          <br />18.凭啥不造轮子，你们造轮子舒坦了，爽快了，就不让别人造了。我造轮子我快乐。
          <br />
          <br />19.偏见不全是坏事，坏的是不愿意改变偏见。
          <br />
          <br />
          <br />&nbsp;&nbsp;&nbsp;&nbsp;扯淡时间结束。
         </div> 
         <p class="postfoot"> posted @ <a href="http://www.blogjava.net/killme2008/archive/2011/11/30/365238.html" title="permalink">2011-11-30 22:50</a> dennis 阅读(4157) | <a href="http://www.blogjava.net/killme2008/archive/2011/11/30/365238.html#FeedBack" title="comments, pingbacks, trackbacks">评论 (14)</a> |&nbsp;<a href="http://www.blogjava.net/killme2008/admin/EditPosts.aspx?postid=365238">编辑</a>&nbsp;<a href="http://www.blogjava.net/killme2008/AddToFavorite.aspx?id=365238">收藏</a> </p> 
        </div> 
        <div class="post" style="filter:progid:DXImageTransform.Microsoft.Shadow(color='Blue', Direction=135, Strength=32)"> 
         <div class="posthead"> 
          <h2 style="padding-top:4px; padding-bottom:4px;"><a id="ArchiveDay1_SingleDay_DayList_ctl34_TitleUrl" href="http://www.blogjava.net/killme2008/archive/2011/11/16/363913.html">演示TCP慢启动和滑动窗口机制的动画</a></h2> 
         </div> 
         <div class="postbody">
          今天看到的一个演示TCP慢启动和滑动窗口机制的动画，很形象
          <br /> 
          <a href="http://www.osischool.com" target="_blank">osischool.com</a>
          <br /> 
          <embed type="application/x-shockwave-flash" width="620" height="400" src="http://www.blogjava.net/Files/killme2008/tcp_slow_start.zip" />
         </div> 
         <p class="postfoot"> posted @ <a href="http://www.blogjava.net/killme2008/archive/2011/11/16/363913.html" title="permalink">2011-11-16 07:34</a> dennis 阅读(5985) | <a href="http://www.blogjava.net/killme2008/archive/2011/11/16/363913.html#FeedBack" title="comments, pingbacks, trackbacks">评论 (3)</a> |&nbsp;<a href="http://www.blogjava.net/killme2008/admin/EditPosts.aspx?postid=363913">编辑</a>&nbsp;<a href="http://www.blogjava.net/killme2008/AddToFavorite.aspx?id=363913">收藏</a> </p> 
        </div> 
        <div class="post" style="filter:progid:DXImageTransform.Microsoft.Shadow(color='Blue', Direction=135, Strength=32)"> 
         <div class="posthead"> 
          <h2 style="padding-top:4px; padding-bottom:4px;"><a id="ArchiveDay1_SingleDay_DayList_ctl35_TitleUrl" href="http://www.blogjava.net/killme2008/archive/2011/11/08/363238.html">Yahoo! s4和Twitter storm的粗略比较</a></h2> 
         </div> 
         <div class="postbody">
          <table border="2" cellpadding="2" cellspacing="2" width="804">
           <tbody>
            <tr>
             <td>Items\Projects<br /></td> 
             <td>Yahoo! s4<br /></td> 
             <td>Twitter Storm<br /></td> 
            </tr> 
            <tr> 
             <td>协议<br /></td> 
             <td>Apache license 2.0<br /></td> 
             <td>Eclipse Public License 1.0<br /></td> 
            </tr> 
            <tr> 
             <td>开发语言<br /></td> 
             <td>Java<br /></td> 
             <td>Clojure,Java,Clojure编写了核心代码</td> 
            </tr> 
            <tr> 
             <td>结构<br /></td> 
             <td>去中心化的对等结构<br /></td> 
             <td>有中心节点nimbus，但非关键</td> 
            </tr> 
            <tr> 
             <td>通信<br /></td> 
             <td>可插拔的通讯层，目前是基于UDP的实现</td> 
             <td>基于facebook开源的thrift框架</td> 
            </tr> 
            <tr> 
             <td>事件/Stream<br /></td> 
             <td>&lt;K,A&gt;序列，用户可自定义事件类</td> 
             <td>提供Tuple类，用户不可自定义事件类，<br />但是可以命名field和注册序列化器</td> 
            </tr> 
            <tr> 
             <td>处理单元</td> 
             <td>Processing Elements，内置PE处理<br />count,join和aggregate等常见任务</td> 
             <td>Bolt，没有内置任务，提供IBasicBolt处理<br />自动ack</td> 
            </tr> 
            <tr> 
             <td>第三方交互<br /></td> 
             <td>提供API,Client Adapter/Driver，第三方客户端输入或者输出事件</td> 
             <td>定义Spout用于产生Stream，没有标准输出API</td> 
            </tr> 
            <tr> 
             <td>持久化</td> 
             <td>提供Persist API规范，可根据频率或者次数做<br />持久化<br /></td> 
             <td>无特定API，用户可自行选择处理<br /></td>
            </tr>
            <tr>
             <td>可靠处理</td>
             <td>&nbsp;无，可能会丢失事件</td>
             <td>&nbsp;提供对事件处理的可靠保证（可选）</td>
            </tr>
            <tr>
             <td>路由</td>
             <td>EventType + Keyed attribute + value匹配<br />内置count,join和aggregate标准任务</td>
             <td>Stream Groupings:<br />Shuffle,Fields,All,Global,None,Direct<br />非常灵活的路由方式</td>
            </tr>
            <tr>
             <td>多语言支持</td>
             <td>&nbsp;暂时只支持Java</td>
             <td>多语言支持良好，本身支持Java,Clojure，<br />其他非JVM语言通过thrift和进程间通讯</td>
            </tr>
            <tr>
             <td>Failover<br /></td>
             <td>&nbsp;部分支持，数据无法failover</td>
             <td>&nbsp;部分支持，数据同样无法failover</td>
            </tr>
            <tr>
             <td>Load Balance<br /></td>
             <td>不支持</td>
             <td>&nbsp;不支持</td>
            </tr>
            <tr>
             <td>&nbsp;并行处理</td>
             <td>&nbsp;取决于节点数目，不可调节</td>
             <td>&nbsp;可配置worker和task数目，storm会尽量将worker和task均匀分布</td>
            </tr>
            <tr>
             <td>动态增删节点</td>
             <td>不支持 <br /></td>
             <td>&nbsp;支持</td>
            </tr>
            <tr>
             <td>动态部署<br /></td>
             <td>&nbsp;不支持</td>
             <td>&nbsp;支持</td>
            </tr>
            <tr>
             <td>web管理</td>
             <td>&nbsp;不支持</td>
             <td>&nbsp;支持</td>
            </tr>
            <tr>
             <td>代码成熟度</td>
             <td>&nbsp;半成品</td>
             <td>&nbsp;成熟</td>
            </tr>
            <tr>
             <td>活跃度</td>
             <td>&nbsp;低</td>
             <td>&nbsp;活跃</td>
            </tr>
            <tr>
             <td>编程</td>
             <td>&nbsp;编程 + XML配置<br /></td>
             <td>&nbsp; 纯编程<br /></td>
            </tr>
            <tr>
             <td>参考文档</td>
             <td>&nbsp;<a href="http://docs.s4.io/">http://docs.s4.io/</a></td>
             <td><a href="https://github.com/nathanmarz/storm/wiki/">https://github.com/nathanmarz/storm/wiki/</a><br /><a href="http://xumingming.sinaapp.com/category/storm/">http://xumingming.sinaapp.com/category/storm/</a> （非常好的中文翻译)<br /></td>
            </tr>
           </tbody>
          </table>
         </div> 
         <p class="postfoot"> posted @ <a href="http://www.blogjava.net/killme2008/archive/2011/11/08/363238.html" title="permalink">2011-11-08 22:25</a> dennis 阅读(12455) | <a href="http://www.blogjava.net/killme2008/archive/2011/11/08/363238.html#FeedBack" title="comments, pingbacks, trackbacks">评论 (14)</a> |&nbsp;<a href="http://www.blogjava.net/killme2008/admin/EditPosts.aspx?postid=363238">编辑</a>&nbsp;<a href="http://www.blogjava.net/killme2008/AddToFavorite.aspx?id=363238">收藏</a> </p> 
        </div> 
        <div class="post" style="filter:progid:DXImageTransform.Microsoft.Shadow(color='Blue', Direction=135, Strength=32)"> 
         <div class="posthead"> 
          <h2 style="padding-top:4px; padding-bottom:4px;"><a id="ArchiveDay1_SingleDay_DayList_ctl36_TitleUrl" href="http://www.blogjava.net/killme2008/archive/2011/10/30/362315.html">clj-xmemcached: memcached client for clojure</a></h2> 
         </div> 
         <div class="postbody">
          <div class="wikistyle">
           <h1><a href="https://github.com/killme2008/clj-xmemcached">clj-xmemcached</a></h1> 
           <p>&nbsp;&nbsp;&nbsp; <a href="https://github.com/killme2008/clj-xmemcached">Clj-xmemcached</a> is an opensource memcached client for clojure wrapping <a href="http://code.google.com/p/xmemcached/">xmemcached</a>. <a href="http://code.google.com/p/xmemcached/">Xmemcached</a> is an opensource high performance memcached client for java.</p> 
           <h2>Leiningen Usage</h2> 
           <p>To include clj-xmemcached,add:</p> 
           <pre><code>     [clj-xmemcached &quot;0.1.1&quot;]
</code></pre> 
           <p>to your project.clj.</p> 
           <h2>Usage</h2> 
           <h3>Create a client<code></code></h3>
           <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
            <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
            <span style="color: #000000; ">(use&nbsp;[clj</span>
            <span style="color: #000000; ">-</span>
            <span style="color: #000000; ">xmemcached.core])<br />(def&nbsp;client&nbsp;(xmemcached&nbsp;</span>
            <span style="color: #000000; ">&quot;</span>
            <span style="color: #000000; ">host:port</span>
            <span style="color: #000000; ">&quot;</span>
            <span style="color: #000000; ">))<br />(def&nbsp;client&nbsp;(xmemcached&nbsp;</span>
            <span style="color: #000000; ">&quot;</span>
            <span style="color: #000000; ">host1:port1&nbsp;host2:port2</span>
            <span style="color: #000000; ">&quot;</span>
            <span style="color: #000000; ">&nbsp;:protocol&nbsp;</span>
            <span style="color: #000000; ">&quot;</span>
            <span style="color: #000000; ">binary</span>
            <span style="color: #000000; ">&quot;</span>
            <span style="color: #000000; ">))</span>
           </div> 
           <p>Then we create a memcached client using binary protocol to talk with memcached servers host1:port1 and host2:port2. Valid options including:</p> 
           <pre><code>  :name       Client's name
  :protocol  Protocol to talk with memcached,a string value in text,binary or kestrel,default is text protocol.
  :hash          Hash algorithm,a string value in consistent or standard,default is standard hash.
  :timeout    Operation timeout in milliseconds,default is five seconds.
  :pool          Connection pool size,default is one.
</code></pre> 
           <h3>Store items<code></code></h3>
           <br />
           <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
            <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
            <span style="color: #000000; ">(xset&nbsp;client&nbsp;</span>
            <span style="color: #000000; ">&quot;</span>
            <span style="color: #000000; ">key</span>
            <span style="color: #000000; ">&quot;</span>
            <span style="color: #000000; ">&nbsp;</span>
            <span style="color: #000000; ">&quot;</span>
            <span style="color: #000000; ">dennis</span>
            <span style="color: #000000; ">&quot;</span>
            <span style="color: #000000; ">)<br />(xset&nbsp;client&nbsp;</span>
            <span style="color: #000000; ">&quot;</span>
            <span style="color: #000000; ">key</span>
            <span style="color: #000000; ">&quot;</span>
            <span style="color: #000000; ">&nbsp;</span>
            <span style="color: #000000; ">&quot;</span>
            <span style="color: #000000; ">dennis</span>
            <span style="color: #000000; ">&quot;</span>
            <span style="color: #000000; ">&nbsp;</span>
            <span style="color: #000000; ">100</span>
            <span style="color: #000000; ">)<br />(xappend&nbsp;client&nbsp;</span>
            <span style="color: #000000; ">&quot;</span>
            <span style="color: #000000; ">key</span>
            <span style="color: #000000; ">&quot;</span>
            <span style="color: #000000; ">&nbsp;</span>
            <span style="color: #000000; ">&quot;</span>
            <span style="color: #000000; ">&nbsp;zhuang</span>
            <span style="color: #000000; ">&quot;</span>
            <span style="color: #000000; ">)<br />(xprepend&nbsp;client&nbsp;</span>
            <span style="color: #000000; ">&quot;</span>
            <span style="color: #000000; ">key</span>
            <span style="color: #000000; ">&quot;</span>
            <span style="color: #000000; ">&nbsp;</span>
            <span style="color: #000000; ">&quot;</span>
            <span style="color: #000000; ">hello,</span>
            <span style="color: #000000; ">&quot;</span>
            <span style="color: #000000; ">)</span>
           </div>
           <br /> 
           <p>The value 100 is the expire time for the item in seconds.Store functions include xset,xadd,xreplace,xappend and xprepend.Please use doc to print documentation for these functions.</p> 
           <h3>Get items</h3> 
           <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
            <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
            <span style="color: #000000; ">(xget&nbsp;client&nbsp;</span>
            <span style="color: #000000; ">&quot;</span>
            <span style="color: #000000; ">key</span>
            <span style="color: #000000; ">&quot;</span>
            <span style="color: #000000; ">)<br />(xget&nbsp;client&nbsp;</span>
            <span style="color: #000000; ">&quot;</span>
            <span style="color: #000000; ">key1</span>
            <span style="color: #000000; ">&quot;</span>
            <span style="color: #000000; ">&nbsp;</span>
            <span style="color: #000000; ">&quot;</span>
            <span style="color: #000000; ">key2</span>
            <span style="color: #000000; ">&quot;</span>
            <span style="color: #000000; ">&nbsp;</span>
            <span style="color: #000000; ">&quot;</span>
            <span style="color: #000000; ">key3</span>
            <span style="color: #000000; ">&quot;</span>
            <span style="color: #000000; ">)<br />(xgets&nbsp;client&nbsp;</span>
            <span style="color: #000000; ">&quot;</span>
            <span style="color: #000000; ">key</span>
            <span style="color: #000000; ">&quot;</span>
            <span style="color: #000000; ">)</span>
            <code> </code>
           </div> 
           <p>xgets returns a value including a cas value,for example:</p> 
           <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
            <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
            <span style="color: #000000; ">&nbsp;&nbsp;{:value&nbsp;</span>
            <span style="color: #000000; ">&quot;</span>
            <span style="color: #000000; ">hello,dennis&nbsp;zhuang</span>
            <span style="color: #000000; ">&quot;</span>
            <span style="color: #000000; ">,&nbsp;:</span>
            <span style="color: #0000FF; ">class</span>
            <span style="color: #000000; ">&nbsp;net.rubyeye.xmemcached.GetsResponse,&nbsp;:cas&nbsp;</span>
            <span style="color: #000000; ">396</span>
            <span style="color: #000000; ">}</span>
            <code> </code>
           </div> 
           <p>And bulk get returns a HashMap contains existent items.</p> 
           <h3>Increase/Decrease numbers<code></code></h3>
           <br />
           <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
            <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
            <span style="color: #000000; ">(xincr&nbsp;client&nbsp;</span>
            <span style="color: #000000; ">&quot;</span>
            <span style="color: #000000; ">num</span>
            <span style="color: #000000; ">&quot;</span>
            <span style="color: #000000; ">&nbsp;</span>
            <span style="color: #000000; ">1</span>
            <span style="color: #000000; ">)<br />(xdecr&nbsp;client&nbsp;</span>
            <span style="color: #000000; ">&quot;</span>
            <span style="color: #000000; ">num</span>
            <span style="color: #000000; ">&quot;</span>
            <span style="color: #000000; ">&nbsp;</span>
            <span style="color: #000000; ">1</span>
            <span style="color: #000000; ">)<br />(xincr&nbsp;client&nbsp;</span>
            <span style="color: #000000; ">&quot;</span>
            <span style="color: #000000; ">num</span>
            <span style="color: #000000; ">&quot;</span>
            <span style="color: #000000; ">&nbsp;</span>
            <span style="color: #000000; ">1</span>
            <span style="color: #000000; ">&nbsp;</span>
            <span style="color: #000000; ">0</span>
            <span style="color: #000000; ">)</span>
           </div>
           <br /> 
           <p>Above codes try to increase/decrease a number in memcached with key &quot;num&quot;,and if the item is not exists,then set it to zero.</p> 
           <h3>Delete items</h3> 
           <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
            <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
            <span style="color: #000000; ">(xdelete&nbsp;client&nbsp;</span>
            <span style="color: #000000; ">&quot;</span>
            <span style="color: #000000; ">num</span>
            <span style="color: #000000; ">&quot;</span>
            <span style="color: #000000; ">)</span>
            <code> </code>
           </div> 
           <h3>Compare and set</h3> 
           <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
            <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
            <span style="color: #000000; ">(xcas&nbsp;client&nbsp;</span>
            <span style="color: #000000; ">&quot;</span>
            <span style="color: #000000; ">key</span>
            <span style="color: #000000; ">&quot;</span>
            <span style="color: #000000; ">&nbsp;inc)</span>
            <code> </code>
           </div> 
           <p>We use inc function to increase the current value in memcached and try to compare and set it at most Integer.MAX_VALUE times. xcas can be called as:<code><br /></code></p>
           <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
            <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
            <span style="color: #000000; ">&nbsp;(xcas&nbsp;client&nbsp;key&nbsp;cas</span>
            <span style="color: #000000; ">-</span>
            <span style="color: #000000; ">fn&nbsp;max</span>
            <span style="color: #000000; ">-</span>
            <span style="color: #000000; ">times)</span>
           </div>
           <p><code> </code></p> 
           <p>The cas-fn is a function to return a new value,set the new value to </p> 
           <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
            <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
            <span style="color: #000000; ">(cas</span>
            <span style="color: #000000; ">-</span>
            <span style="color: #000000; ">fn&nbsp;current</span>
            <span style="color: #000000; ">-</span>
            <span style="color: #000000; ">value)</span>
            <code> </code>
           </div> 
           <h3>Shutdown</h3> 
           <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
            <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
            <span style="color: #000000; ">(xshutdown&nbsp;client)</span>
            <code> </code>
           </div> 
           <h3>Flush</h3> 
           <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
            <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
            <span style="color: #000000; ">(xflush&nbsp;client)<br />(xflush&nbsp;client&nbsp;(InetSocketAddress.&nbsp;host&nbsp;port))</span>
            <code> </code>
           </div> 
           <h3>Statistics</h3> 
           <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
            <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
            <span style="color: #000000; ">(xstats&nbsp;client)</span>
            <code> </code>
           </div> 
           <h3>Example</h3> 
           <p>Please see the example code in <a href="https://github.com/killme2008/clj-xmemcached/blob/master/example/demo.clj">example/demo.clj</a></p> 
           <h2>License</h2> 
           <p>Copyright (C) 2011-2014 dennis zhuang[<a href="mailto:killme2008@gmail.com">killme2008@gmail.com</a>]</p> 
           <p>Distributed under the Eclipse Public License, the same as Clojure.</p>
          </div>
         </div> 
         <p class="postfoot"> posted @ <a href="http://www.blogjava.net/killme2008/archive/2011/10/30/362315.html" title="permalink">2011-10-30 13:03</a> dennis 阅读(3011) | <a href="http://www.blogjava.net/killme2008/archive/2011/10/30/362315.html#FeedBack" title="comments, pingbacks, trackbacks">评论 (0)</a> |&nbsp;<a href="http://www.blogjava.net/killme2008/admin/EditPosts.aspx?postid=362315">编辑</a>&nbsp;<a href="http://www.blogjava.net/killme2008/AddToFavorite.aspx?id=362315">收藏</a> </p> 
        </div> 
        <div class="post" style="filter:progid:DXImageTransform.Microsoft.Shadow(color='Blue', Direction=135, Strength=32)"> 
         <div class="posthead"> 
          <h2 style="padding-top:4px; padding-bottom:4px;"><a id="ArchiveDay1_SingleDay_DayList_ctl37_TitleUrl" href="http://www.blogjava.net/killme2008/archive/2011/10/09/360311.html">我写的这些opensource项目</a></h2> 
         </div> 
         <div class="postbody">
          <br />&nbsp;&nbsp;&nbsp; 将自己在googlecode和github上的所有项目过了一遍，整理一张列表，列下一些还有点价值和用处的项目，都不是什么great job，纯粹是为了工作需要或者乐趣写的东西，看官要是有兴趣也可以瞧瞧。
          <br />
          <br />&nbsp;一 Java相关
          <br />
          <br />1.
          <a href="http://code.google.com/p/xmemcached/">Xmemcached</a>，还算是比较多人使用的一个java memcached client，优点是效率和易用性，缺点是代码写的不怎么样，两年前发展到现在的东西，以后还会继续维护。
          <br />
          <br />2.
          <a href="http://code.google.com/p/hs4j/">HS4J</a>，看
          <a href="https://github.com/ahiguti/HandlerSocket-Plugin-for-MySQL">handlersocket</a>的时候顺手写的客户端，我们公司内部某些项目在用，可能还有其他公司外的朋友在用，后来同事聚石贡献了一个扩展项目
          <a href="https://github.com/killme2008/hs4j/tree/master/contributes">hs4j-kit</a>，更易于使用，他写的代码很优雅漂亮，推荐一看。暂时没有精力维护。
          <br />
          <br />3.
          <a href="http://code.google.com/p/aviator/">Aviator</a>，一个很初级的表达式执行引擎，行家看到肯定要笑话我。不过语法上很符合我自己的口味，我们自己的项目在用，也有几个朋友在用，会继续维护。
          <br />
          <br />4.
          <a href="https://github.com/killme2008/jevent">Jevent</a>，一个玩具，其实是模仿libevent的一个java实现，对nio或者libevent的实现机制感兴趣的还可以看看。
          <br />
          <br />5. 
          <a href="https://github.com/killme2008/kilim">Kilim</a>，我fork的kilim实现，修改了nio调度器，使用多个reactor做调度效率更高，并添加了一个HttpClient的实现。
          <br />
          <br />二 Android项目
          <br />
          <br />学习android完全是玩票性质，有3个项目，对初学android开发的可能有点参考价值。
          <br />
          <br />1.
          <a href="https://github.com/killme2008/whetherweather">WhetherWeather</a>，一个天气预报和告警的widget插件，UI太丑了。
          <br />2.
          <a href="https://github.com/killme2008/UniqRecorder">UniqRecorder</a>，写来记录儿子体重变化的小工具，可以自定义项目和生成曲线图，我自己还在用。
          <br />3.
          <a href="https://github.com/killme2008/UniqTask">UniqTask</a>，最近写的杀进程工具，绝对轻量级，没广告，也是我自己在用。
          <br />
          <br />三 Clojure项目
          <br />
          <br />1.
          <a href="https://github.com/killme2008/cscheme">cscheme</a>，一个用clojure实现的scheme解释器，基于sicp这本书的解释器实现。
          <br />2.
          <a href="https://github.com/killme2008/clojure-control">clojure-control</a>，类似
          <a href="https://github.com/tsmith/node-control">node-control</a>的分布式部署和管理的DSL实现，挺好玩的，也有朋友在用，我自己还用不上,sunny有写了个很方便的lein插件
          <a href="https://github.com/sunng87/lein-control">node-control</a>。
          <br />
          <br />clojure还写了一堆烂尾项目，就不拿出来恶心人了。
          <br />
          <br />四 其他
          <br />
          <br />1.
          <a href="https://github.com/killme2008/node-zk-browser">node-zk-browser</a>，一个展现和管理zookeeper的web应用，我们自己在用，基于node.js实现。
          <br />2.
          <a href="https://github.com/killme2008/erlwsh">erlwsh</a>，一个erlang的web shell实现，可以在浏览器里做erlang编程，被一些开源项目比如membase用到了。
          <br />
          <br />&nbsp;&nbsp;&nbsp; 写这些东西对我自己最有好处，如果能顺便给他人带来好处，那是额外的好处。最近正处于我自己一生中也许是最大的转折关头，不能更新blog了，最后，祈求诸天神佛能带来奇迹。
         </div> 
         <p class="postfoot"> posted @ <a href="http://www.blogjava.net/killme2008/archive/2011/10/09/360311.html" title="permalink">2011-10-09 20:23</a> dennis 阅读(6178) | <a href="http://www.blogjava.net/killme2008/archive/2011/10/09/360311.html#FeedBack" title="comments, pingbacks, trackbacks">评论 (15)</a> |&nbsp;<a href="http://www.blogjava.net/killme2008/admin/EditPosts.aspx?postid=360311">编辑</a>&nbsp;<a href="http://www.blogjava.net/killme2008/AddToFavorite.aspx?id=360311">收藏</a> </p> 
        </div> 
        <div class="post" style="filter:progid:DXImageTransform.Microsoft.Shadow(color='Blue', Direction=135, Strength=32)"> 
         <div class="posthead"> 
          <h2 style="padding-top:4px; padding-bottom:4px;"><a id="ArchiveDay1_SingleDay_DayList_ctl38_TitleUrl" href="http://www.blogjava.net/killme2008/archive/2011/10/01/359898.html">紧急发布xmemcached 1.3.5</a></h2> 
         </div> 
         <div class="postbody">
          <br />&nbsp;&nbsp;&nbsp; xmemcached紧急发布1.3.5版本，主要是修复两个相对严重的bug:
          <br />
          <br />
          <a href="http://code.google.com/p/xmemcached/issues/detail?id=154">Issue 154</a>: 在重连本地memcached的时候，有可能出现重连无法成功的情况，导致连接丢失，详情见
          <a href="http://code.google.com/p/xmemcached/issues/detail?id=154">这里</a>。
          <br />
          <a href="http://code.google.com/p/xmemcached/issues/detail?id=155">Issue 155:</a> 重连导致文件句柄数超过限制的bug，这是由于重连失败情况下没有合理关闭socket引起的，详情见
          <a href="http://code.google.com/p/xmemcached/issues/detail?id=155">这里</a>。
          <br />
          <br />&nbsp;&nbsp;&nbsp; 如果你使用maven，简单升级版本即可：
          <br />
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #0000FF; ">&lt;</span>
           <span style="color: #800000; ">dependency</span>
           <span style="color: #0000FF; ">&gt;</span>
           <span style="color: #000000; "><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000FF; ">&lt;</span>
           <span style="color: #800000; ">groupId</span>
           <span style="color: #0000FF; ">&gt;</span>
           <span style="color: #000000; ">com.googlecode.xmemcached</span>
           <span style="color: #0000FF; ">&lt;/</span>
           <span style="color: #800000; ">groupId</span>
           <span style="color: #0000FF; ">&gt;</span>
           <span style="color: #000000; "><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000FF; ">&lt;</span>
           <span style="color: #800000; ">artifactId</span>
           <span style="color: #0000FF; ">&gt;</span>
           <span style="color: #000000; ">xmemcached</span>
           <span style="color: #0000FF; ">&lt;/</span>
           <span style="color: #800000; ">artifactId</span>
           <span style="color: #0000FF; ">&gt;</span>
           <span style="color: #000000; "><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000FF; ">&lt;</span>
           <span style="color: #800000; ">version</span>
           <span style="color: #0000FF; ">&gt;</span>
           <span style="color: #000000; ">1.3.5</span>
           <span style="color: #0000FF; ">&lt;/</span>
           <span style="color: #800000; ">version</span>
           <span style="color: #0000FF; ">&gt;</span>
           <span style="color: #000000; "><br />&nbsp;</span>
           <span style="color: #0000FF; ">&lt;/</span>
           <span style="color: #800000; ">dependency</span>
           <span style="color: #0000FF; ">&gt;</span>
          </div>
          <br />
          <br />&nbsp;&nbsp;&nbsp; 下载地址：
          <a href="http://code.google.com/p/xmemcached/downloads/list">http://code.google.com/p/xmemcached/downloads/list</a>
          <br />
          <br />&nbsp;&nbsp;&nbsp; 此版本推荐升级，最后感谢两位老外开发者的帮助： 
          <a style="white-space: nowrap" href="http://code.google.com/u/ilkinulas/">ilkinulas</a>和
          <a href="http://code.google.com/u/@VBZVQFxQBxJNXgV0/">MrRubato</a>
         </div> 
         <p class="postfoot"> posted @ <a href="http://www.blogjava.net/killme2008/archive/2011/10/01/359898.html" title="permalink">2011-10-01 15:11</a> dennis 阅读(3907) | <a href="http://www.blogjava.net/killme2008/archive/2011/10/01/359898.html#FeedBack" title="comments, pingbacks, trackbacks">评论 (6)</a> |&nbsp;<a href="http://www.blogjava.net/killme2008/admin/EditPosts.aspx?postid=359898">编辑</a>&nbsp;<a href="http://www.blogjava.net/killme2008/AddToFavorite.aspx?id=359898">收藏</a> </p> 
        </div> 
        <div class="post" style="filter:progid:DXImageTransform.Microsoft.Shadow(color='Blue', Direction=135, Strength=32)"> 
         <div class="posthead"> 
          <h2 style="padding-top:4px; padding-bottom:4px;"><a id="ArchiveDay1_SingleDay_DayList_ctl39_TitleUrl" href="http://www.blogjava.net/killme2008/archive/2011/09/20/359033.html">UniqTask for android</a></h2> 
         </div> 
         <div class="postbody">
          &nbsp;&nbsp;&nbsp; 好吧，我知道现在是凌晨4点了，写完这个就睡觉。
          <br />
          <br />&nbsp;&nbsp;&nbsp; 我一直很不爽android的ES任务管理器，它的广告设置的地方非常恶心，就放在kill键的下面，而且每次都突然跳出来，让你很容易错误点击。我很佩服他们能想出这种提高点击率的办法，但是又无比鄙视这种做法。今天（哦，不是昨天）晚上在twitter上说了，我想自己写个任务管理器，类似ES任务管理器，并且没有广告。那好吧，说干就干，奋斗了一个晚上，终于搞出了成果，这就是隆重登场的UniqTask，先看看运行时截图：
          <br />
          <br />
          <div align="center">
           <img alt="" src="/images/blogjava_net/killme2008/SC20110920-040819.png" height="800" width="480" />
          </div>
          <br />
          <br />&nbsp;&nbsp;&nbsp; 这是运行在我的GS2上的截图。
          <br />
          <br />&nbsp;&nbsp;&nbsp; UniqTask的功能跟ES任务管理器的功能完全一致，可以记录kill的历史，每次启动UniqTask的时候自动标记过去kill过的进程。但是UniqTask完全绿色无毒，绝对没有广告，咔咔。
          <br />
          <br />&nbsp;&nbsp;&nbsp; 许久没写android程序，拿起手来不是很顺利，折腾到现在才搞定，我将代码放到了github上，也提供了APK下载，非常欢迎试用啊。
          <br />
          <br />&nbsp;&nbsp;&nbsp; 源码地址：
          <br />&nbsp;&nbsp;&nbsp; 
          <a href="https://github.com/killme2008/UniqTask">https://github.com/killme2008/UniqTask</a>
          <br />&nbsp;&nbsp;&nbsp; APK下载：
          <br />&nbsp;&nbsp;&nbsp; 
          <a href="https://github.com/killme2008/UniqTask/blob/master/UniqTask.apk">https://github.com/killme2008/UniqTask/blob/master/UniqTask.apk</a>
          <br />
          <br />&nbsp;&nbsp;&nbsp; 白天还有重要的事情要处理，睡觉去了。
         </div> 
         <p class="postfoot"> posted @ <a href="http://www.blogjava.net/killme2008/archive/2011/09/20/359033.html" title="permalink">2011-09-20 04:10</a> dennis 阅读(2899) | <a href="http://www.blogjava.net/killme2008/archive/2011/09/20/359033.html#FeedBack" title="comments, pingbacks, trackbacks">评论 (5)</a> |&nbsp;<a href="http://www.blogjava.net/killme2008/admin/EditPosts.aspx?postid=359033">编辑</a>&nbsp;<a href="http://www.blogjava.net/killme2008/AddToFavorite.aspx?id=359033">收藏</a> </p> 
        </div> 
        <div class="post" style="filter:progid:DXImageTransform.Microsoft.Shadow(color='Blue', Direction=135, Strength=32)"> 
         <div class="posthead"> 
          <h2 style="padding-top:4px; padding-bottom:4px;"><a id="ArchiveDay1_SingleDay_DayList_ctl40_TitleUrl" href="http://www.blogjava.net/killme2008/archive/2011/09/17/358863.html">高性能EL――Fel探秘，兼谈EL</a></h2> 
         </div> 
         <div class="postbody">
          &nbsp;&nbsp;&nbsp; Fel是最近javaeye比较火的关键词，这是由网友
          <a href="http://lotusyu.iteye.com/">lotusyu</a>开发的一个高性能的EL，从作者给出的数据来看，性能非常优异，跟前段时间温少开源的
          <a href="http://www.iteye.com/topic/993292">Simple EL</a>有的一拼。首先要说，这是个好现象，国内的开源项目越来越多，可以看出开发者的水平是越来越高了，比如我最近还看到有人开源的类似kestel的轻量级MQ――
          <a href="http://code.google.com/p/fqueue/">fqueue</a>也非常不错，有兴趣可以看下我的分析《
          <a href="../archive/2011/09/16/358827.html">fqueue初步分析</a>》。
          <br /> 
          <br /> 
          <p>&nbsp;&nbsp;&nbsp; 进入正文，本文是尝试分析下Fel的实现原理，以及优缺点和<a href="http://code.google.com/p/aviator/">aviator</a>――我自己开源的EL之间的简单比较。</p> 
          <p>&nbsp; &nbsp; Fel的实现原理跟Simple EL是类似，都是使用template生成中间代码――也就是普通的java代码，然后利用javac编译成class，最后运行，当然，这个过程都是动 态的。JDK6已经引入了编译API，在此之前的版本可以调用sun的类来编译，因为javac其实就是用java实现的。回到Fel里 面，FelCompiler15就是用 <em><strong>com.sun.tools.javac.Main</strong></em>来编译，而FelCompiler16用标准的<a href="http://download.oracle.com/javase/6/docs/api/javax/tools/JavaCompiler.html">javax.tools.JavaCompiler</a>来编译的。</p> 
          <p> &nbsp; &nbsp; 文法和语法解释这块是使用antlr这个parse generator生成的，这块不多说，有兴趣可以看下antlr，整体一个运行的过程是这样：</p> 
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <span style="color: #000000; ">&nbsp;&nbsp;&nbsp;&nbsp;expression&nbsp;string&nbsp;</span>
           <span style="color: #000000; ">-&gt;</span>
           <span style="color: #000000; ">&nbsp;antlr&nbsp;</span>
           <span style="color: #000000; ">-&gt;</span>
           <span style="color: #000000; ">&nbsp;AST&nbsp;</span>
           <span style="color: #000000; ">-&gt;</span>
           <span style="color: #000000; ">&nbsp;comiple&nbsp;</span>
           <span style="color: #000000; ">-&gt;</span>
           <span style="color: #000000; ">&nbsp;java&nbsp;source&nbsp;template&nbsp;</span>
           <span style="color: #000000; ">-&gt;</span>
           <span style="color: #000000; ">&nbsp;java&nbsp;</span>
           <span style="color: #0000FF; ">class</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #000000; ">-&gt;</span>
           <span style="color: #000000; ">&nbsp;Expression&nbsp; <br /> </span>
          </div> 
          <p>&nbsp;&nbsp;&nbsp; 这个思路我在实现<a href="http://code.google.com/p/aviator/">aviator</a>之前就想过，但是后来考虑到API需要用的sun独有的类，而且要求classpath必须有tools.jar这个依赖包，就放弃了这个思路，还是采用ASM生成字节码的方式。题外，velocity的优化可以采用这个思路，我们有这么一个项目是这么做的，也准备开源了。</p> 
          <p>&nbsp;</p> 
          <p>&nbsp;&nbsp;&nbsp; 看看Fel生成的中间代码，例如a+b这样的一个简单的表达式，假设我一开始不知道a和b的类型，编译是这样：</p> 
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <span style="color: #000000; ">&nbsp;&nbsp;&nbsp;&nbsp;FelEngine&nbsp;fel&nbsp;</span>
           <span style="color: #000000; ">=</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #0000FF; ">new</span>
           <span style="color: #000000; ">&nbsp;FelEngineImpl();&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;Expression&nbsp;exp&nbsp;</span>
           <span style="color: #000000; ">=</span>
           <span style="color: #000000;">&nbsp; </span>
           <span style="color: #000000; ">fel.compile(</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">a+b</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">,&nbsp;</span>
           <span style="color: #0000FF; ">null</span>
           <span style="color: #000000; ">);&nbsp; <br /></span>
          </div> 
          <p> </p> 
          <p>&nbsp;&nbsp;&nbsp; 我稍微改了下FEL的源码，让它打印中间生成的java代码，a+b生成的中间结果为：</p> 
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <span style="color: #000000; ">&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000FF; ">package</span>
           <span style="color: #000000; ">&nbsp;com.greenpineyu.fel.compile;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000FF; ">import</span>
           <span style="color: #000000; ">&nbsp;com.greenpineyu.fel.common.NumberUtil;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000FF; ">import</span>
           <span style="color: #000000; ">&nbsp;com.greenpineyu.fel.Expression;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000FF; ">import</span>
           <span style="color: #000000; ">&nbsp;com.greenpineyu.fel.context.FelContext;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000FF; ">import</span>
           <span style="color: #000000; ">&nbsp;org.apache.commons.lang.ObjectUtils;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000FF; ">import</span>
           <span style="color: #000000; ">&nbsp;org.apache.commons.lang.StringUtils;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000FF; ">public</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #0000FF; ">class</span>
           <span style="color: #000000; ">&nbsp;Fel_0&nbsp;&nbsp;</span>
           <span style="color: #0000FF; ">implements</span>
           <span style="color: #000000; ">&nbsp;Expression{&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000FF; ">public</span>
           <span style="color: #000000; ">&nbsp;Object&nbsp;eval(FelContext&nbsp;context)&nbsp;{&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;java.lang.Object&nbsp;var_1&nbsp;</span>
           <span style="color: #000000; ">=</span>
           <span style="color: #000000; ">&nbsp;(java.lang.Object)context.get(</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">b</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">);&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #008000; ">//</span>
           <span style="color: #008000; ">b&nbsp;&nbsp;</span>
           <span style="color: #008000; "><br /></span>
           <span style="color: #000000; ">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;java.lang.Object&nbsp;var_0&nbsp;</span>
           <span style="color: #000000; ">=</span>
           <span style="color: #000000; ">&nbsp;(java.lang.Object)context.get(</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">a</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">);&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #008000; ">//</span>
           <span style="color: #008000; ">a&nbsp;&nbsp;</span>
           <span style="color: #008000; "><br /></span>
           <span style="color: #000000; ">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000FF; ">return</span>
           <span style="color: #000000; ">&nbsp;(ObjectUtils.toString(var_0))</span>
           <span style="color: #000000; ">+</span>
           <span style="color: #000000; ">(ObjectUtils.toString(var_1));&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp; <br /> </span>
          </div> 
          <p>&nbsp;&nbsp;&nbsp;&nbsp; 可见，FEL对表达式解析和解释后，利用template生成这么一个普通的java类，而a和b都从context中获取并转化为<strong>Object</strong>类型，这里没有做任何判断就直接认为a和b是要做字符串相加，然后拼接字符串并返回。</p> 
          <p>&nbsp;</p> 
          <p>&nbsp;&nbsp;&nbsp;&nbsp; 问题出来了，因为没有在编译的时候传入context（我们这里是null），FEL会将a和b的类型默认都为java.lang.Object，a+b解释为字符串拼接。但是运行的时候，我完全可以传入a和b都为数字，那么结果就非常诡异了：</p> 
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <span style="color: #000000; ">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FelEngine&nbsp;fel&nbsp;</span>
           <span style="color: #000000; ">=</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #0000FF; ">new</span>
           <span style="color: #000000; ">&nbsp;FelEngineImpl();&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;Expression&nbsp;exp&nbsp;</span>
           <span style="color: #000000; ">=</span>
           <span style="color: #000000; ">&nbsp;fel.compile(</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">a+b</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">,&nbsp;</span>
           <span style="color: #0000FF; ">null</span>
           <span style="color: #000000; ">);&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;Map</span>
           <span style="color: #000000; ">&lt;</span>
           <span style="color: #000000; ">String,&nbsp;Object</span>
           <span style="color: #000000; ">&gt;</span>
           <span style="color: #000000; ">&nbsp;env</span>
           <span style="color: #000000; ">=</span>
           <span style="color: #0000FF; ">new</span>
           <span style="color: #000000; ">&nbsp;HashMap</span>
           <span style="color: #000000; ">&lt;</span>
           <span style="color: #000000; ">String,&nbsp;Object</span>
           <span style="color: #000000; ">&gt;</span>
           <span style="color: #000000; ">();&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;env.put(</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">a</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">,&nbsp;</span>
           <span style="color: #000000; ">1</span>
           <span style="color: #000000; ">);&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;env.put(</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">b</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">,&nbsp;</span>
           <span style="color: #000000; ">3.14</span>
           <span style="color: #000000; ">);&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;System.out.println(exp.eval(</span>
           <span style="color: #0000FF; ">new</span>
           <span style="color: #000000; ">&nbsp;MapContext(env)));&nbsp; <br /> </span>
          </div> 
          <p>输出：</p> 
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <span style="color: #000000; ">&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #000000; ">13.14</span>
           <span style="color: #000000; ">&nbsp; <br /> </span>
          </div> 
          <p>&nbsp;&nbsp;&nbsp; 1+3.14的结果，作为字符串拼接就是13.14，而不是我们想要的4.14。如果将表达式换成a*b，就完全运行不了</p> 
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <span style="color: #000000; ">&nbsp;&nbsp;&nbsp;&nbsp;com.greenpineyu.fel.exception.CompileException:&nbsp;</span>
           <span style="color: #0000FF; ">package</span>
           <span style="color: #000000; ">&nbsp;com.greenpineyu.fel.compile;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000FF; ">import</span>
           <span style="color: #000000; ">&nbsp;com.greenpineyu.fel.common.NumberUtil;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000FF; ">import</span>
           <span style="color: #000000; ">&nbsp;com.greenpineyu.fel.Expression;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000FF; ">import</span>
           <span style="color: #000000; ">&nbsp;com.greenpineyu.fel.context.FelContext;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000FF; ">import</span>
           <span style="color: #000000; ">&nbsp;org.apache.commons.lang.ObjectUtils;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000FF; ">import</span>
           <span style="color: #000000; ">&nbsp;org.apache.commons.lang.StringUtils;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000FF; ">public</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #0000FF; ">class</span>
           <span style="color: #000000; ">&nbsp;Fel_0&nbsp;&nbsp;</span>
           <span style="color: #0000FF; ">implements</span>
           <span style="color: #000000; ">&nbsp;Expression{&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000FF; ">public</span>
           <span style="color: #000000; ">&nbsp;Object&nbsp;eval(FelContext&nbsp;context)&nbsp;{&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;java.lang.Object&nbsp;var_1&nbsp;</span>
           <span style="color: #000000; ">=</span>
           <span style="color: #000000; ">&nbsp;(java.lang.Object)context.get(</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">b</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">);&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #008000; ">//</span>
           <span style="color: #008000; ">b&nbsp;&nbsp;</span>
           <span style="color: #008000; "><br /></span>
           <span style="color: #000000; ">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;java.lang.Object&nbsp;var_0&nbsp;</span>
           <span style="color: #000000; ">=</span>
           <span style="color: #000000; ">&nbsp;(java.lang.Object)context.get(</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">a</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">);&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #008000; ">//</span>
           <span style="color: #008000; ">a&nbsp;&nbsp;</span>
           <span style="color: #008000; "><br /></span>
           <span style="color: #000000; ">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000FF; ">return</span>
           <span style="color: #000000; ">&nbsp;(var_0)</span>
           <span style="color: #000000; ">*</span>
           <span style="color: #000000; ">(var_1);&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;[Fel_0.java:</span>
           <span style="color: #000000; ">14</span>
           <span style="color: #000000; ">:&nbsp;运算符&nbsp;</span>
           <span style="color: #000000; ">*</span>
           <span style="color: #000000; ">&nbsp;不能应用于&nbsp;java.lang.Object,java.lang.Object]&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;at&nbsp;com.greenpineyu.fel.compile.FelCompiler16.compileToClass(FelCompiler16.java:</span>
           <span style="color: #000000; ">113</span>
           <span style="color: #000000; ">)&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;at&nbsp;com.greenpineyu.fel.compile.FelCompiler16.compile(FelCompiler16.java:</span>
           <span style="color: #000000; ">87</span>
           <span style="color: #000000; ">)&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;at&nbsp;com.greenpineyu.fel.compile.CompileService.compile(CompileService.java:</span>
           <span style="color: #000000; ">66</span>
           <span style="color: #000000; ">)&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;at&nbsp;com.greenpineyu.fel.FelEngineImpl.compile(FelEngineImpl.java:</span>
           <span style="color: #000000; ">62</span>
           <span style="color: #000000; ">)&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;at&nbsp;TEst.main(TEst.java:</span>
           <span style="color: #000000; ">14</span>
           <span style="color: #000000; ">)&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;Exception&nbsp;in&nbsp;thread&nbsp;</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">main</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">&nbsp;java.lang.NullPointerException&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;at&nbsp;TEst.main(TEst.java:</span>
           <span style="color: #000000; ">18</span>
           <span style="color: #000000; ">)&nbsp; <br /> </span>
          </div> 
          <p>&nbsp;</p> 
          <p>&nbsp;&nbsp;&nbsp; 这个问题对于Simple EL同样存在，如果没有在编译的时候能确定变量类型，这无法生成正确的中间代码，导致运行时出错，并且有可能造成非常诡异的bug。</p> 
          <p>&nbsp;</p> 
          <p>&nbsp;&nbsp;&nbsp; 这个问题的本质是<strong>因为Fel和Simple EL没有自己的类型系统，他们都是直接使用java的类型的系统，并且必须在编译的时候确定变量类型，才能生成高效和正确的代码，我们可以将它们称为“强类型的EL“。</strong></p> 
          <p>&nbsp;</p> 
          <p>&nbsp;&nbsp;&nbsp; 现在让我们在编译的时候给a和b加上类型，看看生成的中间代码：</p> 
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <span style="color: #000000; ">&nbsp;&nbsp;&nbsp;&nbsp;FelEngine&nbsp;fel&nbsp;</span>
           <span style="color: #000000; ">=</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #0000FF; ">new</span>
           <span style="color: #000000; ">&nbsp;FelEngineImpl();&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;fel.getContext().set(</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">a</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">,&nbsp;</span>
           <span style="color: #000000; ">1</span>
           <span style="color: #000000; ">);&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;fel.getContext().set(</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">b</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">,&nbsp;</span>
           <span style="color: #000000; ">3.14</span>
           <span style="color: #000000; ">);&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;Expression&nbsp;exp&nbsp;</span>
           <span style="color: #000000; ">=</span>
           <span style="color: #000000; ">&nbsp;fel.compile(</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">a+b</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">,&nbsp;</span>
           <span style="color: #0000FF; ">null</span>
           <span style="color: #000000; ">);&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;Map</span>
           <span style="color: #000000; ">&lt;</span>
           <span style="color: #000000; ">String,&nbsp;Object</span>
           <span style="color: #000000; ">&gt;</span>
           <span style="color: #000000; ">&nbsp;env&nbsp;</span>
           <span style="color: #000000; ">=</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #0000FF; ">new</span>
           <span style="color: #000000; ">&nbsp;HashMap</span>
           <span style="color: #000000; ">&lt;</span>
           <span style="color: #000000; ">String,&nbsp;Object</span>
           <span style="color: #000000; ">&gt;</span>
           <span style="color: #000000; ">();&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;env.put(</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">a</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">,&nbsp;</span>
           <span style="color: #000000; ">1</span>
           <span style="color: #000000; ">);&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;env.put(</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">b</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">,&nbsp;</span>
           <span style="color: #000000; ">3.14</span>
           <span style="color: #000000; ">);&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;System.out.println(exp.eval(</span>
           <span style="color: #0000FF; ">new</span>
           <span style="color: #000000; ">&nbsp;MapContext(env)));&nbsp; <br /> </span>
          </div> 
          <p>&nbsp;&nbsp;&nbsp; 查看中间代码：</p> 
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <span style="color: #000000; ">&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000FF; ">package</span>
           <span style="color: #000000; ">&nbsp;com.greenpineyu.fel.compile;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000FF; ">import</span>
           <span style="color: #000000; ">&nbsp;com.greenpineyu.fel.common.NumberUtil;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000FF; ">import</span>
           <span style="color: #000000; ">&nbsp;com.greenpineyu.fel.Expression;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000FF; ">import</span>
           <span style="color: #000000; ">&nbsp;com.greenpineyu.fel.context.FelContext;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000FF; ">import</span>
           <span style="color: #000000; ">&nbsp;org.apache.commons.lang.ObjectUtils;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000FF; ">import</span>
           <span style="color: #000000; ">&nbsp;org.apache.commons.lang.StringUtils;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000FF; ">public</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #0000FF; ">class</span>
           <span style="color: #000000; ">&nbsp;Fel_0&nbsp;&nbsp;</span>
           <span style="color: #0000FF; ">implements</span>
           <span style="color: #000000; ">&nbsp;Expression{&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000FF; ">public</span>
           <span style="color: #000000; ">&nbsp;Object&nbsp;eval(FelContext&nbsp;context)&nbsp;{&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000FF; ">double</span>
           <span style="color: #000000; ">&nbsp;var_1&nbsp;</span>
           <span style="color: #000000; ">=</span>
           <span style="color: #000000; ">&nbsp;((java.lang.Number)context.get(</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">b</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">)).doubleValue();&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #008000; ">//</span>
           <span style="color: #008000; ">b&nbsp;&nbsp;</span>
           <span style="color: #008000; "><br /></span>
           <span style="color: #000000; ">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000FF; ">double</span>
           <span style="color: #000000; ">&nbsp;var_0&nbsp;</span>
           <span style="color: #000000; ">=</span>
           <span style="color: #000000; ">&nbsp;((java.lang.Number)context.get(</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">a</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">)).doubleValue();&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #008000; ">//</span>
           <span style="color: #008000; ">a&nbsp;&nbsp;</span>
           <span style="color: #008000; "><br /></span>
           <span style="color: #000000; ">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000FF; ">return</span>
           <span style="color: #000000; ">&nbsp;(var_0)</span>
           <span style="color: #000000; ">+</span>
           <span style="color: #000000; ">(var_1);&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp; <br /> </span>
          </div> 
          <p>可以看到这次将a和b都强制转为double类型了，做数值相加，结果也正确了：</p> 
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <span style="color: #000000; ">&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #000000; ">4.140000000000001</span>
           <span style="color: #000000; ">&nbsp; <br /> </span>
          </div> 
          <p> </p> 
          <p>&nbsp;&nbsp;&nbsp; Simple EL我没看过代码，这里猜测它的实现也应该是类似的，也应该有同样的问题。</p> 
          <p>&nbsp;&nbsp;&nbsp; 相比来说，<a href="http://code.google.com/p/aviator/">aviator</a>这是<strong>一个弱类型的EL</strong>，<strong>在编译的时候不对变量类型做任何假设，而是在运行时做类型判断和自动转化</strong>。过去提过，我给aviator的定位是一个介于EL和script之间的东西，<strong>它有自己的类型系统</strong>。 例如，3这个数字，在java里可能是long,int,short,byte，而aviator统一为AviatorLong这个类型。为了在这两个类 型之间做适配，就需要做很多的判断和box,unbox操作。这些判断和转化都是运行时进行的，因此aviator没有办法做到Fel这样的高效，但是已 经做到至少跟groovy这样的弱类型脚本语言一个级别，也超过了JXEL这样的纯解释EL，具体可以看这个<a href="http://code.google.com/p/aviator/wiki/Performance">性能测试</a>。</p> 
          <p>&nbsp;</p> 
          <p>&nbsp;&nbsp; 强类型还是弱类型，这是一个选择问题，如果你能在运行前就确定变量的类型，那么使用Fel应该可以达到或者接近于原生java执行的效率，但是失去了灵活性；如果你无法确定变量类型，则只能采用弱类型的EL。</p> 
          <p>&nbsp;</p> 
          <p>&nbsp;&nbsp; EL涌现的越来越多，这个现象有点类似消息中间件领域，越来越多面向特定领域的轻量级MQ的出现，而不是原来那种大而笨重的通用MQ大行其道，一方面是互 联网应用的发展，需求不是通用系统能够满足的，另一方面我认为也是开发者素质的提高，大家都能造适合自己的轮子。从EL这方面来说，我也认为会有越来越多 特定于领域的，优点和缺点一样鲜明的EL出现，它们包含设计者自己的目标和口味，选择很多，就看取舍。</p>
         </div> 
         <p class="postfoot"> posted @ <a href="http://www.blogjava.net/killme2008/archive/2011/09/17/358863.html" title="permalink">2011-09-17 12:52</a> dennis 阅读(6773) | <a href="http://www.blogjava.net/killme2008/archive/2011/09/17/358863.html#FeedBack" title="comments, pingbacks, trackbacks">评论 (5)</a> |&nbsp;<a href="http://www.blogjava.net/killme2008/admin/EditPosts.aspx?postid=358863">编辑</a>&nbsp;<a href="http://www.blogjava.net/killme2008/AddToFavorite.aspx?id=358863">收藏</a> </p> 
        </div> 
        <div class="post" style="filter:progid:DXImageTransform.Microsoft.Shadow(color='Blue', Direction=135, Strength=32)"> 
         <div class="posthead"> 
          <h2 style="padding-top:4px; padding-bottom:4px;"><a id="ArchiveDay1_SingleDay_DayList_ctl41_TitleUrl" href="http://www.blogjava.net/killme2008/archive/2011/09/16/358827.html">fqueue初步分析</a></h2> 
         </div> 
         <div class="postbody">
          <br />&nbsp;&nbsp;&nbsp; fqueue是国产的一个类似memcacheq,kestrel这样的支持memcached协议的轻量级开源MQ。它的项目主页：
          <br />
          <a href="http://code.google.com/p/fqueue/downloads/list" target="_blank">http://code.google.com/p/<wbr />fqueue/downloads/list</a>，介绍和特点都可以看主页，我就不废话了。
          <br />
          <br />&nbsp;&nbsp;&nbsp; 今天老大提到， co了源码看了下，写个初步分析报告。
          <br />
          <br />&nbsp;&nbsp;&nbsp; 首先是它的存储层，主要是一个FQueue这么一个抽象队列，内部实现是FSQueue，也就是基于文件的FIFO队列。这个队列是多个文件组成的。每个文件默认大小在150M，超过即切换一个新文件来写。读的时候如果读到尾部，则查找下一个文件进行读取。数据文件名以idb为后缀，并且从编号1开始递增，除了数据文件外，每个队列还有个db为后缀的索引文件，记录当前写和读的数据文件编号和偏移量。目录结构大概是这样：
          <br />&nbsp;&nbsp;&nbsp; --fqueue
          <br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; --fqueuedata_1.idb
          <br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; --fqueuedata_2.idb
          <br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; --……
          <br />&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; --icqueue.db
          <br />
          <br />&nbsp;&nbsp;&nbsp; 文件的存储比较有特色，采用
          <a href="http://download.oracle.com/javase/1.4.2/docs/api/java/nio/MappedByteBuffer.html">MappedByteBuffer</a>做文件读写，
          <a href="http://download.oracle.com/javase/1.4.2/docs/api/java/nio/MappedByteBuffer.html">MappedByteBuffer</a>是java nio引入的文件内存映射方案，读写性能极高，但是也有一定的问题，比如说内存占用，以及数据刷入设备的不确定性和关闭问题。在fqueue中，每隔10毫秒会强制force一次buffer，将修改过的数据刷入设备。对于关闭问题，则采用那个技巧，示例代码：
          <br />
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
           <span style="color: #008000; ">/**</span>
           <span style="color: #008000; "><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;关闭索引文件<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #008000; ">*/</span>
           <span style="color: #000000; "><br />&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000FF; ">public</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #0000FF; ">void</span>
           <span style="color: #000000; ">&nbsp;close()&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000FF; ">try</span>
           <span style="color: #000000; ">&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mappedByteBuffer.force();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AccessController.doPrivileged(</span>
           <span style="color: #0000FF; ">new</span>
           <span style="color: #000000; ">&nbsp;PrivilegedAction</span>
           <span style="color: #000000; ">&lt;</span>
           <span style="color: #000000; ">Object</span>
           <span style="color: #000000; ">&gt;</span>
           <span style="color: #000000; ">()&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000FF; ">public</span>
           <span style="color: #000000; ">&nbsp;Object&nbsp;run()&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000FF; ">try</span>
           <span style="color: #000000; ">&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Method&nbsp;getCleanerMethod&nbsp;</span>
           <span style="color: #000000; ">=</span>
           <span style="color: #000000; ">&nbsp;mappedByteBuffer.getClass().getMethod(</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">cleaner</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">,&nbsp;</span>
           <span style="color: #0000FF; ">new</span>
           <span style="color: #000000; ">&nbsp;Class[</span>
           <span style="color: #000000; ">0</span>
           <span style="color: #000000; ">]);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;getCleanerMethod.setAccessible(</span>
           <span style="color: #0000FF; ">true</span>
           <span style="color: #000000; ">);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sun.misc.Cleaner&nbsp;cleaner&nbsp;</span>
           <span style="color: #000000; ">=</span>
           <span style="color: #000000; ">&nbsp;(sun.misc.Cleaner)&nbsp;getCleanerMethod.invoke(mappedByteBuffer,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000FF; ">new</span>
           <span style="color: #000000; ">&nbsp;Object[</span>
           <span style="color: #000000; ">0</span>
           <span style="color: #000000; ">]);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cleaner.clean();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;</span>
           <span style="color: #0000FF; ">catch</span>
           <span style="color: #000000; ">&nbsp;(Exception&nbsp;e)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;log.error(</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">close&nbsp;logindexy&nbsp;file&nbsp;error:</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">,&nbsp;e);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000FF; ">return</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #0000FF; ">null</span>
           <span style="color: #000000; ">;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fc.close();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dbRandFile.close();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mappedByteBuffer&nbsp;</span>
           <span style="color: #000000; ">=</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #0000FF; ">null</span>
           <span style="color: #000000; ">;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fc&nbsp;</span>
           <span style="color: #000000; ">=</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #0000FF; ">null</span>
           <span style="color: #000000; ">;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dbRandFile&nbsp;</span>
           <span style="color: #000000; ">=</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #0000FF; ">null</span>
           <span style="color: #000000; ">;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;</span>
           <span style="color: #0000FF; ">catch</span>
           <span style="color: #000000; ">&nbsp;(IOException&nbsp;e)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;log.error(</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">close&nbsp;logindex&nbsp;file&nbsp;error:</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">,&nbsp;e);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;}</span>
          </div>
          <br />&nbsp;&nbsp;&nbsp; 利用反射，并且使用了sun特有的类，不具有可移植性。MappedByteBuffer还有一个问题是map的代价比较高，可能在切换文件的时候fqueue会有一定程度的阻塞现象。
          <br />
          <br />&nbsp;&nbsp;&nbsp; 存储的性能，我在我的机器测试了下，似乎没有作者宣称的那么高，我的机器是5400转的普通SATA盘，写入1K数据的平均QPS在8000左右。我估计fqueue的性能跟磁盘有很大关系，如果使用15000转的SAS盘应该能有很大改观。
          <br />
          <br />&nbsp;&nbsp;&nbsp; 网络层直接使用了jmemcached的实现，
          <a href="http://code.google.com/p/jmemcache-daemon/">jmemcached</a>是一个java实现的memcached，通常用于单元测试之类。看情况fqueue也支持memcached的二进制协议了。网络框架使用了netty3，这些就不多说了。自己看都明白。额外提一下，作者做的单元测试使用了
          <a href="http://code.google.com/p/xmemcached">xmemcached</a>，咔咔，广而告之。
          <br />
          <br />&nbsp;&nbsp;&nbsp; 总体来说fqueue是一个整体上很清爽和轻量级的MQ实现，适合一些特定的场景，至于性能，我们下周准备做个压测，到时候再谈吧。
         </div> 
         <p class="postfoot"> posted @ <a href="http://www.blogjava.net/killme2008/archive/2011/09/16/358827.html" title="permalink">2011-09-16 20:10</a> dennis 阅读(7720) | <a href="http://www.blogjava.net/killme2008/archive/2011/09/16/358827.html#FeedBack" title="comments, pingbacks, trackbacks">评论 (7)</a> |&nbsp;<a href="http://www.blogjava.net/killme2008/admin/EditPosts.aspx?postid=358827">编辑</a>&nbsp;<a href="http://www.blogjava.net/killme2008/AddToFavorite.aspx?id=358827">收藏</a> </p> 
        </div> 
        <div class="post" style="filter:progid:DXImageTransform.Microsoft.Shadow(color='Blue', Direction=135, Strength=32)"> 
         <div class="posthead"> 
          <h2 style="padding-top:4px; padding-bottom:4px;"><a id="ArchiveDay1_SingleDay_DayList_ctl42_TitleUrl" href="http://www.blogjava.net/killme2008/archive/2011/09/08/358317.html">xmemcached发布1.3.4</a></h2> 
         </div> 
         <div class="postbody">
          <div id="news_content"> 
           <p>&nbsp;&nbsp;&nbsp; 开源的java memcached client―― <a href="http://code.google.com/p/xmemcached/">xmemcached</a>发布1.3.4版本，主要改进如下：</p> 
           <p>&nbsp;</p> 
           <p>1、修复一个相对严重的bug，在解析二进制协议时如果遇到从服务端返回的错误信息，会导致连接异常断开；如果你没有使用binary协议，不会遇到此问题。<strong><strong>建议使用xmemcached并且使用二进制协议的朋友升级到此版本</strong>。</strong></p> 
           <p>2、允许XMemcachedClientFactoryBean配置opTimeout选项。 <br /></p> 
           <p>3、添加RoundRobinMemcachedSessionLocator，轮询的连接选择器，仅用于kestrel或者memcacheq集群，这些应用都不要求同一个key要保存在固定的服务器上，而仅是作为集群分担负载。</p> 
           <p>4、<a href="http://xmemcached.googlecode.com/svn/trunk/apidocs/net/rubyeye/xmemcached/impl/KetamaMemcachedSessionLocator.html">KetamaMemcachedSessionLocator</a>添加额外选项，允许配置是否兼容 <a href="https://github.com/dctrwatson/nginx-upstream-consistent">nginx-upstream-consistent</a>，这个是网友<strong> </strong> <span> <a href="http://code.google.com/u/wolfg1969/">wolfg1969</a>贡献的patch。如果要使得xmc的一致性哈希算法兼容</span>nginx-upstream-consistent，只要设置cwNginxUpstreamConsistent为true即可，示范代码：</p> 
           <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
            <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
            <span style="color: #000000; ">&nbsp;&nbsp;&nbsp;&nbsp;MemcachedClientBuilder&nbsp;builder&nbsp;</span>
            <span style="color: #000000; ">=</span>
            <span style="color: #000000; ">&nbsp;</span>
            <span style="color: #0000FF; ">new</span>
            <span style="color: #000000; ">&nbsp;XMemcachedClientBuilder(&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AddrUtil.getAddresses(servers));&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;builder.setSessionLocator(</span>
            <span style="color: #0000FF; ">new</span>
            <span style="color: #000000; ">&nbsp;KetamaMemcachedSessionLocator(&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
            <span style="color: #0000FF; ">true</span>
            <span style="color: #000000; ">));&nbsp; <br /></span>
           </div>
           <p>5、修复bug，包括<a class="closed_ref" title="Typo in INFO message: log.info(&quot;Creating &quot; + selectorPoolSize + &quot; rectors...&quot;);" href="http://code.google.com/p/xmemcached/issues/detail?id=132">issue 132&nbsp;</a>,<a class="closed_ref" title="Counter的问题，请确认是否为BUG" href="http://code.google.com/p/xmemcached/issues/detail?id=142">&nbsp;issue 142&nbsp;</a>,<a class="closed_ref" title="XMemcachedClientFactoryBean doesn't allow overriding of certain client properties" href="http://code.google.com/p/xmemcached/issues/detail?id=133">&nbsp;issue 133&nbsp;</a>,<a class="closed_ref" title="Network layout exception" href="http://code.google.com/p/xmemcached/issues/detail?id=139">&nbsp;issue 139&nbsp;</a>,<a class="closed_ref" title="Counter的问题，请确认是否为BUG" href="http://code.google.com/p/xmemcached/issues/detail?id=142">&nbsp;issue 142&nbsp;</a>,<a class="closed_ref" title="为配合nginx-upstream-consistent模块做了一个patch" href="http://code.google.com/p/xmemcached/issues/detail?id=145">&nbsp;issue 145&nbsp;</a>,<a title="Throw &quot;Not a proper response&quot; MemcachedException when using binary protocol" href="http://code.google.com/p/xmemcached/issues/detail?id=150">issue 150</a>等。</p> 
           <p>&nbsp;</p> 
           <p>如果你使用maven，只要简单升级版本即可：&nbsp; <br /></p>
           <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
            <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
            <span style="color: #000000; ">&nbsp;&nbsp;</span>
            <span style="color: #0000FF; ">&lt;</span>
            <span style="color: #800000; ">dependency</span>
            <span style="color: #0000FF; ">&gt;</span>
            <span style="color: #000000; ">&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
            <span style="color: #0000FF; ">&lt;</span>
            <span style="color: #800000; ">groupId</span>
            <span style="color: #0000FF; ">&gt;</span>
            <span style="color: #000000; ">com.googlecode.xmemcached</span>
            <span style="color: #0000FF; ">&lt;/</span>
            <span style="color: #800000; ">groupId</span>
            <span style="color: #0000FF; ">&gt;</span>
            <span style="color: #000000; ">&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
            <span style="color: #0000FF; ">&lt;</span>
            <span style="color: #800000; ">artifactId</span>
            <span style="color: #0000FF; ">&gt;</span>
            <span style="color: #000000; ">xmemcached</span>
            <span style="color: #0000FF; ">&lt;/</span>
            <span style="color: #800000; ">artifactId</span>
            <span style="color: #0000FF; ">&gt;</span>
            <span style="color: #000000; ">&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
            <span style="color: #0000FF; ">&lt;</span>
            <span style="color: #800000; ">version</span>
            <span style="color: #0000FF; ">&gt;</span>
            <span style="color: #000000; ">1.3.4</span>
            <span style="color: #0000FF; ">&lt;/</span>
            <span style="color: #800000; ">version</span>
            <span style="color: #0000FF; ">&gt;</span>
            <span style="color: #000000; ">&nbsp;&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;</span>
            <span style="color: #0000FF; ">&lt;/</span>
            <span style="color: #800000; ">dependency</span>
            <span style="color: #0000FF; ">&gt;</span>
            <span style="color: #000000; ">&nbsp; <br /></span>
           </div>
           <p>下载地址：</p> 
           <p><a href="http://code.google.com/p/xmemcached/downloads/list">http://code.google.com/p/xmemcached/downloads/list</a></p> 
          </div>
         </div> 
         <p class="postfoot"> posted @ <a href="http://www.blogjava.net/killme2008/archive/2011/09/08/358317.html" title="permalink">2011-09-08 18:55</a> dennis 阅读(2987) | <a href="http://www.blogjava.net/killme2008/archive/2011/09/08/358317.html#FeedBack" title="comments, pingbacks, trackbacks">评论 (3)</a> |&nbsp;<a href="http://www.blogjava.net/killme2008/admin/EditPosts.aspx?postid=358317">编辑</a>&nbsp;<a href="http://www.blogjava.net/killme2008/AddToFavorite.aspx?id=358317">收藏</a> </p> 
        </div> 
        <div class="post" style="filter:progid:DXImageTransform.Microsoft.Shadow(color='Blue', Direction=135, Strength=32)"> 
         <div class="posthead"> 
          <h2 style="padding-top:4px; padding-bottom:4px;"><a id="ArchiveDay1_SingleDay_DayList_ctl43_TitleUrl" href="http://www.blogjava.net/killme2008/archive/2011/09/02/357774.html">找bug记(2)</a></h2> 
         </div> 
         <div class="postbody">
          <br />&nbsp;&nbsp;&nbsp; 这篇blog迟到了很久，本来是想写另一个跟网络相关bug的查找过程，偷偷懒，写下最近印象比较深刻的bug。这个bug是我的同事水寒最终定位到的。
          <br />&nbsp;&nbsp;&nbsp; 前几个月同事报告称有一个线上MQ集群会同一时间抛出ArrayIndexOutOfBoundsException这个异常，也就是数组越界。查看源码，除去一些无关紧要的细节大概是这样子：
          <br />
          <div style="background-color: #eeeeee; font-size: 13px; border: 1px solid #cccccc; padding: 4px 5px 4px 4px; width: 98%;">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
           <span style="color: #0000FF; ">public</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #0000FF; ">class</span>
           <span style="color: #000000; ">&nbsp;ConnectionSelector{<br />&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000FF; ">private</span>
           <span style="color: #000000; ">&nbsp;AtomicInteger&nbsp;sets</span>
           <span style="color: #000000; ">=</span>
           <span style="color: #0000FF; ">new</span>
           <span style="color: #000000; ">&nbsp;AtomicInteger(</span>
           <span style="color: #000000; ">0</span>
           <span style="color: #000000; ">);<br /><br />&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000FF; ">public</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #0000FF; ">void</span>
           <span style="color: #000000; ">&nbsp;selectConnection(List</span>
           <span style="color: #000000; ">&lt;</span>
           <span style="color: #000000; ">Connection</span>
           <span style="color: #000000; ">&gt;</span>
           <span style="color: #000000; ">&nbsp;connList){<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000FF; ">if</span>
           <span style="color: #000000; ">(connList</span>
           <span style="color: #000000; ">==</span>
           <span style="color: #0000FF; ">null</span>
           <span style="color: #000000; ">)｛<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000FF; ">return</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #0000FF; ">null</span>
           <span style="color: #000000;">;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ｝<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000FF; ">final</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #0000FF; ">int</span>
           <span style="color: #000000; ">&nbsp;size&nbsp;</span>
           <span style="color: #000000; ">=</span>
           <span style="color: #000000; ">&nbsp;connList.size();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000FF; ">if</span>
           <span style="color: #000000; ">&nbsp;(size&nbsp;</span>
           <span style="color: #000000; ">==</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #000000; ">0</span>
           <span style="color: #000000; ">)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000FF; ">return</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #0000FF; ">null</span>
           <span style="color: #000000;">;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: red;">return</span>
           <span style="color: red;">&nbsp;connList.get(sets.incrementAndGet()&nbsp;</span>
           <span style="color: red;">%</span>
           <span style="color: red;">&nbsp;size);<br /></span>
           <span>}</span>
           <span style="color: #000000;"><br /><br />&nbsp;&nbsp;&nbsp;}</span>
          </div>
          <br />&nbsp;&nbsp;&nbsp; 很显然，这里的本意是实现一个轮询的连接选择器，返回一个选中的连接。使用AtomicInteger递增并对链表大小取模，返回结果索引位置的连接。异常抛出的位置就是我代码中标红的位置。
          <br />
          <br />&nbsp;&nbsp;&nbsp; 显然，这里有两种可能，一种情况下是说在执行那一行代码的时候，connList的大小缩小了（也就是说连接可能被其他线程移出），那么导致取模的结果越界。另一种可能是取模的结果本身确实超过了列表范围。
          <br />
          <br />&nbsp;&nbsp;&nbsp; 第一种情况是完全可能的，因为服务器的连接可能随时断开或者重连，但是这种情况相对非常少见，因此我们这里并没有对这个选择过程做同步，主要是从性能的角度出发，偶尔的失败可以接受。很遗憾的是，我被我的思维惯性误导了，从来没有怀疑过第二种情况，总是认为是不是真的连接恰巧断开导致这个异常，但是却无法解释这个异常发生后就一直错误下去，无法自行恢复。
          <br />&nbsp;&nbsp;&nbsp; 为什么说思维惯性误导呢？这里的问题其实是负数取模的问题，对一个负数进行取模，结果会是正数还是负数？答案是结果因语言而异。
          <br />&nbsp;&nbsp;&nbsp; 我很早以前在使用Ruby的时候做过测试，负数取模结果为正数，例如在irb里尝试下：
          <br />
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
           <span style="color: #000000; ">&gt;&gt;</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">1000</span>
           <span style="color: #000000; ">%</span>
           <span style="color: #000000; ">3</span>
           <span style="color: #000000; "><br /></span>
           <span style="color: #000000; ">=&gt;</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #000000; ">2</span>
           <span style="color: #000000; "><br /></span>
           <span style="color: #000000; ">&gt;&gt;</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">2001</span>
           <span style="color: #000000; ">%</span>
           <span style="color: #000000; ">4</span>
           <span style="color: #000000; "><br /></span>
           <span style="color: #000000; ">=&gt;</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #000000; ">3</span>
          </div>
          <br />&nbsp;&nbsp;&nbsp; 这个印象持续至今，在clojure里结果也是这样子：
          <br />
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
           <span style="color: #000000; ">Clojure&nbsp;</span>
           <span style="color: #000000; ">1.2</span>
           <span style="color: #000000; ">.</span>
           <span style="color: #000000; ">1</span>
           <span style="color: #000000; "><br />user</span>
           <span style="color: #000000; ">=&gt;</span>
           <span style="color: #000000; ">&nbsp;(mod&nbsp;</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">1000</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #000000; ">3</span>
           <span style="color: #000000; ">)<br /></span>
           <span style="color: #000000; ">2</span>
           <span style="color: #000000; "><br />user</span>
           <span style="color: #000000; ">=&gt;</span>
           <span style="color: #000000; ">&nbsp;(mod&nbsp;</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">2001</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #000000; ">4</span>
           <span style="color: #000000; ">)<br /></span>
           <span style="color: #000000; ">3</span>
          </div>
          <br />&nbsp;&nbsp;&nbsp; 可以再试试python:
          <br />
          <div style="background-color: #eeeeee; font-size: 13px; border: 1px solid #cccccc; padding: 4px 5px 4px 4px; width: 98%;">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
           <span style="color: #000000; ">Python&nbsp;</span>
           <span style="color: #000000; ">2.7</span>
           <span style="color: #000000; ">.</span>
           <span style="color: #000000; ">1</span>
           <span style="color: #000000; ">&nbsp;(r271:</span>
           <span style="color: #000000; ">86832</span>
           <span style="color: #000000; ">,&nbsp;Jun&nbsp;</span>
           <span style="color: #000000; ">16</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #000000; ">2011</span>
           <span style="color: #000000; ">,&nbsp;</span>
           <span style="color: #000000; ">16</span>
           <span style="color: #000000; ">:</span>
           <span style="color: #000000; ">59</span>
           <span style="color: #000000; ">:</span>
           <span style="color: #000000; ">05</span>
           <span style="color: #000000; ">)&nbsp;<br />[GCC&nbsp;</span>
           <span style="color: #000000; ">4.2</span>
           <span style="color: #000000; ">.</span>
           <span style="color: #000000; ">1</span>
           <span style="color: #000000; ">&nbsp;(Based&nbsp;on&nbsp;Apple&nbsp;Inc.&nbsp;build&nbsp;</span>
           <span style="color: #000000; ">5658</span>
           <span style="color: #000000; ">)&nbsp;(LLVM&nbsp;build&nbsp;</span>
           <span style="color: #000000; ">2335.15</span>
           <span style="color: #000000; ">.</span>
           <span style="color: #000000; ">00</span>
           <span style="color: #000000; ">)]&nbsp;on&nbsp;darwin<br />Type&nbsp;</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">help</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">,&nbsp;</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">copyright</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">,&nbsp;</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">credits</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">&nbsp;or&nbsp;</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">license</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #0000FF; ">for</span>
           <span style="color: #000000; ">&nbsp;more&nbsp;information.<br /></span>
           <span style="color: #000000; ">&gt;&gt;&gt;</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">10000</span>
           <span style="color: #000000; ">%</span>
           <span style="color: #000000; ">3</span>
           <span style="color: #000000; "><br /></span>
           <span style="color: #000000; ">2</span>
           <span style="color: #000000; "><br /></span>
           <span style="color: #000000; ">&gt;&gt;&gt;</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">2001</span>
           <span style="color: #000000; ">%</span>
           <span style="color: #000000; ">4</span>
           <span style="color: #000000; "><br /></span>
           <span style="color: #000000; ">3</span>
          </div>
          <br />&nbsp;&nbsp;&nbsp; 这三种语言的结果完全一致，结果都为正数。这个惯性思维延续到java却不成立了，可惜我根本没做测试，让我们试下：
          <br />
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
           <span style="color: #000000; ">&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000FF; ">public</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #0000FF; ">static</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #0000FF; ">void</span>
           <span style="color: #000000; ">&nbsp;main(</span>
           <span style="color: #0000FF; ">final</span>
           <span style="color: #000000; ">&nbsp;String[]&nbsp;args)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;System.out.println(</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">1000</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #000000; ">%</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #000000; ">3</span>
           <span style="color: #000000; ">);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;System.out.println(</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">2001</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #000000; ">%</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #000000; ">4</span>
           <span style="color: #000000; ">);<br />&nbsp;&nbsp;&nbsp;&nbsp;}</span>
          </div>
          <br />打印结果为：
          <br />
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">1</span>
           <span style="color: #000000; "><br /></span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">1</span>
          </div>
          <br />&nbsp;&nbsp;&nbsp; 果然，在java里负数取模的结果为负数，而不是我习惯性地认为是正数。因此最终的定位到的原因就是sets这个变量递增超过Integer.MAX_VALUE后越界变成负数了，取模的结果为负数，导致抛出数组越界的异常，这也解释了为什么同一个集群都在同一时间出问题，因为这个集群内的机器启动时间相邻并且调用这个方法次数相对平均。
          <strike>
           修正问题很简单，加个Math.abs就好。
          </strike>
          <br />
          <br />&nbsp;&nbsp;&nbsp; Update:加个abs是不够的，因为Math.abs的javadoc提醒了：
          <br />
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
           <span style="color: #000000; ">Note&nbsp;that&nbsp;</span>
           <span style="color: #0000FF; ">if</span>
           <span style="color: #000000; ">&nbsp;the&nbsp;argument&nbsp;is&nbsp;equal&nbsp;to&nbsp;the&nbsp;value&nbsp;of&nbsp;Integer.MIN_VALUE,&nbsp;the&nbsp;most&nbsp;negative&nbsp;representable&nbsp;</span>
           <span style="color: #0000FF; ">int</span>
           <span style="color: #000000; ">&nbsp;value,&nbsp;the&nbsp;result&nbsp;is&nbsp;that&nbsp;same&nbsp;value,&nbsp;which&nbsp;is&nbsp;negative. <br /></span>
          </div>
          <br />&nbsp;&nbsp;&nbsp; 也就是说对Integer.MIN_VALUE做abs结果仍然是负数。尽管在这个场景中失败一次可以接受，但是最好的办法还是回复中steven提到的抵消符号位的做法：
          <br />
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
           <span style="color: #000000; ">(sets.incrementAndGet()&nbsp;</span>
           <span style="color: #000000; ">&amp;</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #000000; ">0x7FFFFFFF</span>
           <span style="color: #000000; ">)&nbsp;</span>
           <span style="color: #000000; ">%</span>
           <span style="color: #000000; ">&nbsp;size</span>
          </div>&nbsp;&nbsp;&nbsp; 
          <br />&nbsp;&nbsp;&nbsp; 这个问题更详细的讨论后来我找到
          <a href="http://ceeji.net/blog/mod-in-real/">这篇博客</a>，作者讨论几种语言和计算器的这个问题的结果，给出了一些结论。不过我觉的这个结论可能也不是那么可靠，特别是对c/c++来说，很大程度上应该还是依赖于实现，最可靠的办法还是强制结果为正。
          <br />
          <br />&nbsp;&nbsp;&nbsp; 这个bug的几个教训：
          <br />1、首先是第一次出现的时候没有引起足够重视，重启解决问题后没有深究。有句玩笑话：99％的程序问题都可以通过重启解决。但是事实上问题仍然存在，该发生的终究还会发生。不管你信不信，它就是发生了，这是一个奇迹。
          <br />2、注意大脑的思维惯性，经验主义和教条主义都不可取。最近在读一本好书《
          <a href="http://book.douban.com/subject/6709809/">暗时间</a>》，大脑误导我们的手段可是多种多样。
          <br />3、最后就是这个负数取模的结果因语言而异，不要依赖于特定实现。
          <br />&nbsp;&nbsp;&nbsp;
         </div> 
         <p class="postfoot"> posted @ <a href="http://www.blogjava.net/killme2008/archive/2011/09/02/357774.html" title="permalink">2011-09-02 00:02</a> dennis 阅读(3711) | <a href="http://www.blogjava.net/killme2008/archive/2011/09/02/357774.html#FeedBack" title="comments, pingbacks, trackbacks">评论 (5)</a> |&nbsp;<a href="http://www.blogjava.net/killme2008/admin/EditPosts.aspx?postid=357774">编辑</a>&nbsp;<a href="http://www.blogjava.net/killme2008/AddToFavorite.aspx?id=357774">收藏</a> </p> 
        </div> 
        <div class="post" style="filter:progid:DXImageTransform.Microsoft.Shadow(color='Blue', Direction=135, Strength=32)"> 
         <div class="posthead"> 
          <h2 style="padding-top:4px; padding-bottom:4px;"><a id="ArchiveDay1_SingleDay_DayList_ctl44_TitleUrl" href="http://www.blogjava.net/killme2008/archive/2011/08/09/356106.html">记首次cn-clojure线下聚会</a></h2> 
         </div> 
         <div class="postbody">
          &nbsp;&nbsp;&nbsp; 没有耐心看经过的请直接拉到末尾看slide列表。
          <br />
          <br />&nbsp;&nbsp;&nbsp; 这个聚会是由江宏首先提议的，我参与协助。目的是让长三角地区对
          <a href="http://clojure.org">clojure语言</a>感兴趣，或者正在使用的朋友当面认识和交流一下。会议的组织过程一波三折，首先是会议地点本来定在了上海google办公室，但是后来google那边又说不让过去，我再联系了原来淘宝网的同事火狐，经过他的努力和帮助，最终将地点确定在了上海大众点评。要感谢大众点评网和火狐的帮助，不然这次活动估计就黄了。会议的日期选定也比较偶然，跟七夕撞在了一天，并且8月6号这天说台风“梅花”要在江浙一带登陆，上海要刮多少级多少级的大风，加上我和杭州的几个朋友过去要坐高铁，那心里就七上八下了，搞不好就要被“掩埋”了。我们还开玩笑说最好买火车中段车厢的票为妙。
          <br />
          <br />&nbsp;&nbsp;&nbsp; 8月6日一早，和同在淘宝的杨冬，加上两位做ROR的朋友一起出发，天气没有想象的糟糕，高铁一个小时就到了，转地铁到大众点评网大概也才中午12点左右。打了电话给火狐，一起吃了饭然后就直奔大众点评网。大众点评网的前台大厅装修也是非常熟悉的橙色，很意外周6有很多人，后来才知道是在搞招聘会和培训。这时候，江宏他们也从昆山赶到了，火狐帮我们定的会议室很大，足够容纳20号人左右。陆续有人达到，到约定的1点的时候，我记的是来了大概11还是12个人，还有几个朋友在路上，因此我们决定推迟到1点半再开始。最终来的人估计有15个以上，估计报名的都来了。
          <br />
          <br />&nbsp;&nbsp;&nbsp; 1点半正式开始，首先是我来讲《clojure概览》这个topic，主要是一个clojure语言的介绍。这个是我上周开始准备的，在去年《clojure的魅力》的基础上做了删减和增加，听取江宏的意见增加了示例和引子。上周也在我们的团队讲过一次。轻车熟路，也为了给后面的topic留出时间，我讲的比较快，大概40分钟就结束了。
          <br />
          <br />&nbsp;&nbsp;&nbsp; 接下来是孙宁（sunng87)讲《clojure开发的生命周期管理》，我对clojure的周边工具并不熟悉，趁机更好地了解了很多 clojure开发过程中用到的工具和资料，推荐对clojure开发感兴趣的朋友看下。尝试了下
          <a href="https://github.com/arthuredelstein/clooj">clooj</a>，比我预期的要好，遗憾的是还没有语法高亮，推荐初学clojure的朋友可以尝试下这个轻量级的IDE。目前最好的clojure IDE还是idea里的La Clojure插件。最后孙宁顺便广告了下
          <a href="https://github.com/sunng87/lein-control">lein-control</a>插件，这是孙宁构建的一个
          <a href="https://github.com/killme2008/clojure-control">clojure-control</a>的lein插件，他还贡献了一个类似python里
          <a href="http://docs.fabfile.org/en/1.2.0/api/core/context_managers.html">fabric</a>的clojure DSL实现，让clojure-control更易用。
          <br />
          <br />&nbsp;&nbsp;&nbsp; 接下来是江宏介绍他们开发
          <a href="https://trakrapp.com/">trakrapp.com</a>这个纯clojure实现的网站中使用的技术，以及遇到的问题和经验。这个网站基于
          <a href="https://github.com/weavejester/compojure">compojure</a>这个框架实现的，前端采用backbone.js，后端是MongoDB和postgresql，可以说都是非常“新潮”的技术。他在谈遇到问题的时候，提到clojure的stack trace又长又丑，这一点深有体会，clojure的异常堆栈包含了java和clojure的，整个调用链相对较长，非常不利于问题的排查，不知道后续clojure会不会对这一点做出改进。
          <br />
          <br />&nbsp;&nbsp;&nbsp; 接下来是林晴介绍他们一个用scala实现的类似domino的企业OA系统，不过他这个例子给我的感觉更多是发挥了mongodb的schema free的特点，没有体现出使用scala的好处来。我对scala的观点一直很明确，scala想做JVM上的c++，从个人角度不喜欢这种多范式的语言，并且语法不符合我的胃口，特别是类型系统这块特别复杂，我怕我在写scala的时候还要参考一本厚厚的reference，这不是我想要的。而clojure的核心就非常小，相对符合我的期望。
          <br />
          <br />&nbsp;&nbsp;&nbsp; 作为东道主的火狐介绍了
          <a href="http://www.dianping.com">大众点评网</a>的新架构以及他们从.net往java迁移的经验，他们的新架构也是做服务化和中心化，对于.net和java平台来说，迁移更多是从人力成本和一些其他因素决定的，当然，迁移最重要的还是要有公司高层的全力支持，特别重要的一点是如何让老员工也参与这个过程。因为老员工对现有系统和业务最熟悉，将他们排除在外闭门造车是注定要失败的。
          <br />
          <br />&nbsp;&nbsp;&nbsp; 最后是同样来自昆山文石的吴哲介绍如何在半天内实现一个HTML 5的游戏，他介绍的
          <a href="http://processingjs.org/">processing.js</a>非常有趣，processing本身是一门编程语言，有人将它移植到了js上，可以直接在支持html5上浏览器展现，效果相当cool。巧合的是我在回去后的第二天去书店的时候，竟然在某个角落看到《
          <a href="http://book.douban.com/subject/6517501/">processing互动编程艺术</a>》这本书，买了下来准备了解下。做数据图形化的同学可以关注下。
          <br />
          <br />&nbsp;&nbsp;&nbsp; 总体来讲，这次聚会的效果超过我的预期，在超强台风的阴影下和七夕爱情的感召下还有这么多人赶过来，作为组织者之一非常感动。并且topic讲座也让我学习了一些东西，最重要的是当面认识了一些网上交流过的朋友，给我印象深刻的是看起来非常老成的孙宁，完全不像个85后。还有个印象深刻的细节是现场的5，6台mbp，这里面还是因为有同学是在搞ROR的因素。
          <br />
          <br />&nbsp;&nbsp;&nbsp; 最后，给下slide的链接如下：
          <br />
          <br />1，我的《
          <a href="http://www.slideshare.net/killme2008/clojure-8785955">clojure概览</a>》，源码在
          <a href="https://github.com/killme2008/clojure-overview">github</a>上。
          <br />2，孙宁的《
          <a href="http://www.slideshare.net/sunng87/clojure-cnclojuremeetup">Clojure开发的生命周期管理</a>》，
          <a href="https://github.com/sunng87/lein-control">lein-control</a>和
          <a href="https://github.com/killme2008/clojure-control">clojure-control</a>。
          <br />3，江宏的《
          <a href="http://www.slideshare.net/jiangxhong/clojure-web-development-8800348">Clojure web development</a>》，他们开发的网站
          <br />4，吴哲的《
          <a href="http://www.slideshare.net/jiangxhong/how-to-build-an-html5-game-in-half-a-day">How to build a html5 game in half a day</a>》
          <br />5，火狐的《
          <a href="http://www.slideshare.net/killme2008/ss-8805669">大众点评网新架构</a>》
          <br />6，
          <a href="http://cnlojure.org/">cn-clojure主页</a>
          <br />&nbsp;
         </div> 
         <p class="postfoot"> posted @ <a href="http://www.blogjava.net/killme2008/archive/2011/08/09/356106.html" title="permalink">2011-08-09 14:09</a> dennis 阅读(7000) | <a href="http://www.blogjava.net/killme2008/archive/2011/08/09/356106.html#FeedBack" title="comments, pingbacks, trackbacks">评论 (3)</a> |&nbsp;<a href="http://www.blogjava.net/killme2008/admin/EditPosts.aspx?postid=356106">编辑</a>&nbsp;<a href="http://www.blogjava.net/killme2008/AddToFavorite.aspx?id=356106">收藏</a> </p> 
        </div> 
        <div class="post" style="filter:progid:DXImageTransform.Microsoft.Shadow(color='Blue', Direction=135, Strength=32)"> 
         <div class="posthead"> 
          <h2 style="padding-top:4px; padding-bottom:4px;"><a id="ArchiveDay1_SingleDay_DayList_ctl45_TitleUrl" href="http://www.blogjava.net/killme2008/archive/2011/08/06/355926.html">编程语言的选择很重要</a></h2> 
         </div> 
         <div class="postbody">
          &nbsp;&nbsp;&nbsp; 最近看了篇在google reader里分享非常多的文章，我表示很无语，文章在
          <a href="http://simple-is-better.com/news/580">这里</a>，题目是《
          <a href="http://simple-is-better.com/news/580">Peter Norvig：编程语言的选择并不重要</a>》。简单来讲这文章就是鼓吹python的，然后举了很多例子说python描述算法比Lisp容易。这个无需多说，图灵模型本来就比lambda演算更适合描述算法。
          <br />
          <br />&nbsp;&nbsp;&nbsp; 我想说的是，文中明明提了，Peter norvig说的是：
          <br />
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
           <span style="color: #000000; ">就更一般意义上的编程而言，在Google和其他地方，我认为语言的选择并不如其他方面的选择那么重要：如果你有了正确的总体架构、正确的程序员团队、正确的开发过程（能够快速开发、持续改善），那么很多语言都能胜任；但如果以上的东西你没有，那无论选择什么语言，你都会陷入一团糟。</span>
          </div>
          <br />&nbsp;&nbsp; 这句话的意思很明显，在google或者其他什么地方，编程语言的选择，比之正确的架构，正确的团队以及正确的开发过程，对最终任务的完成影响不是那么大。但并非所谓&quot;编程语言的选择不重要“，这种断章取义的题目除了吸引眼球外，没有任何益处。
          <br />&nbsp;&nbsp;&nbsp; 很多编程语言都可以胜任你要完成的编程任务，你完全可以用C去写CGI，用汇编去写消息中间件，只要你有正确的架构，正确的团队和开发过程，你应该总能完成任务。但是选择适当的编程语言可以让你事半功倍，更少的代码，更高的开发效率。从ROR以及动态语言的流行来看，选择编程语言，真的很重要。
          <br />
          <br />&nbsp;&nbsp;&nbsp; 除非你的规模达到google的程度，性能意味着美元，一秒的优化意味着成千甚至上亿的dollar的时候，也许你可以说下编程语言的选择不重要。
          <br />
          <br />&nbsp;&nbsp;&nbsp; 最后，我还想鄙视下分享这篇文章的大爷们，你们真的看了文章吗？还只是冲着这标题，急急忙忙地献宝式地分享了？咱们淡定点行不？
         </div> 
         <p class="postfoot"> posted @ <a href="http://www.blogjava.net/killme2008/archive/2011/08/06/355926.html" title="permalink">2011-08-06 23:51</a> dennis 阅读(5644) | <a href="http://www.blogjava.net/killme2008/archive/2011/08/06/355926.html#FeedBack" title="comments, pingbacks, trackbacks">评论 (10)</a> |&nbsp;<a href="http://www.blogjava.net/killme2008/admin/EditPosts.aspx?postid=355926">编辑</a>&nbsp;<a href="http://www.blogjava.net/killme2008/AddToFavorite.aspx?id=355926">收藏</a> </p> 
        </div> 
        <div class="post" style="filter:progid:DXImageTransform.Microsoft.Shadow(color='Blue', Direction=135, Strength=32)"> 
         <div class="posthead"> 
          <h2 style="padding-top:4px; padding-bottom:4px;"><a id="ArchiveDay1_SingleDay_DayList_ctl46_TitleUrl" href="http://www.blogjava.net/killme2008/archive/2011/07/27/355154.html">长三角地区的技术交流活动</a></h2> 
         </div> 
         <div class="postbody">
          转自 
          <a href="http://hjiang.net/archives/484">http://hjiang.net/archives/484</a>
          <br />
          <br />Clojure-CN要组织周期性的线下技术交流活动了。如果你热爱程序设计的相关技术，并且住在长三角一带，欢迎来参与活动。只要填一下这个调查表就可以：
          <br />
          <a href=" http://www.diaochapai.com/survey548296">&nbsp;http://www.diaochapai.com/survey548296</a>
          <br />
          <br />更多：
          <br />&nbsp;&nbsp;&nbsp; 关注我的blog的朋友应该都知道我这一年都一直在关注
          <a href="http://clojure.org/">clojure</a>这门语言，后来还搞了个
          <a href="http://groups.google.com/group/cn-clojure">cn-clojure的google group</a>。
          <a href="http://hjiang.net/">hjiang</a>的公司在使用clojure做商业项目，他们公司可能是国内唯一在使用clojure的商业团体，他上周跟我提起想搞这么个活动，促进对clojure学习和使用的交流，并且不局限在clojure语言本身。今年其实给自己一个目标也是去尝试推动一些事情，我对clojure纯粹是技术上的兴趣，未来也不排除去找一份专职写clojure的工作，如果你或者他（她）对clojure语言(或者函数式语言）感兴趣，欢迎来参加这次聚会，填写下这个调查表：
          <a href="http://www.diaochapai.com/survey548296"> http://www.diaochapai.com/survey548296</a>。
          <br />
          <br />&nbsp;&nbsp;&nbsp; 我们在调查完成后统计下大家的兴趣点和地理分布，最后决定在哪里举办，以及确定talk列表和聚会形式等。
          <br />
          <br />&nbsp;&nbsp;&nbsp; 我还申请了一个域名 
          <a href="http://cnlojure.org">http://cnlojure.org</a>，在github上建了个page，这件事的进展会放到这个网页上。
          <br />
          <br />
         </div> 
         <p class="postfoot"> posted @ <a href="http://www.blogjava.net/killme2008/archive/2011/07/27/355154.html" title="permalink">2011-07-27 16:19</a> dennis 阅读(3606) | <a href="http://www.blogjava.net/killme2008/archive/2011/07/27/355154.html#FeedBack" title="comments, pingbacks, trackbacks">评论 (1)</a> |&nbsp;<a href="http://www.blogjava.net/killme2008/admin/EditPosts.aspx?postid=355154">编辑</a>&nbsp;<a href="http://www.blogjava.net/killme2008/AddToFavorite.aspx?id=355154">收藏</a> </p> 
        </div> 
        <div class="post" style="filter:progid:DXImageTransform.Microsoft.Shadow(color='Blue', Direction=135, Strength=32)"> 
         <div class="posthead"> 
          <h2 style="padding-top:4px; padding-bottom:4px;"><a id="ArchiveDay1_SingleDay_DayList_ctl47_TitleUrl" href="http://www.blogjava.net/killme2008/archive/2011/07/26/355041.html">Emacs之一键格式化</a></h2> 
         </div> 
         <div class="postbody">
          <br />&nbsp;&nbsp;&nbsp; 格式化源码是很常见的需求，emacs有个indent-region函数用于格式化选定的代码，前提是你处在某个非text mode下，如c-mode或者java-mode之类。如果要格式化整个文件，你需要先选定整个文件(C-x-h)，然后调用indent-region（或者 C-M-\ )。两个命令总是麻烦，我们可以定义个函数搞定这一切，并绑定在一个特定键上，实现一键格式化：
          <br />
          <br />
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
           <span style="color: #000000; ">;;格式化整个文件函数<br />(defun&nbsp;indent</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">whole&nbsp;()<br />&nbsp;&nbsp;(interactive)<br />&nbsp;&nbsp;(indent</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">region&nbsp;(point</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">min)&nbsp;(point</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">max))<br />&nbsp;&nbsp;(message&nbsp;</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">format&nbsp;successfully</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">))<br />;;绑定到F7键<br />(global</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">set</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">key&nbsp;[f7]&nbsp;</span>
           <span style="color: #000000; ">'</span>
           <span style="color: #000000; ">indent-whole)</span>
          </div>
          <br />&nbsp;&nbsp;&nbsp; 将这段代码添加到你的emacs配置文件（~/.emacs)，重启emacs，以后格式化源码都可以用F7一键搞定。
         </div> 
         <p class="postfoot"> posted @ <a href="http://www.blogjava.net/killme2008/archive/2011/07/26/355041.html" title="permalink">2011-07-26 11:24</a> dennis 阅读(6921) | <a href="http://www.blogjava.net/killme2008/archive/2011/07/26/355041.html#FeedBack" title="comments, pingbacks, trackbacks">评论 (4)</a> |&nbsp;<a href="http://www.blogjava.net/killme2008/admin/EditPosts.aspx?postid=355041">编辑</a>&nbsp;<a href="http://www.blogjava.net/killme2008/AddToFavorite.aspx?id=355041">收藏</a> </p> 
        </div> 
        <div class="post" style="filter:progid:DXImageTransform.Microsoft.Shadow(color='Blue', Direction=135, Strength=32)"> 
         <div class="posthead"> 
          <h2 style="padding-top:4px; padding-bottom:4px;"><a id="ArchiveDay1_SingleDay_DayList_ctl48_TitleUrl" href="http://www.blogjava.net/killme2008/archive/2011/07/25/355010.html">写DSL的步骤</a></h2> 
         </div> 
         <div class="postbody">
          <br />1.选定宿主语言，最好选用元编程能力强悍的语言作为宿主语言。
          <br />2.确定DSL的样子，
          <strong>让脑袋空白，不去考虑任何实现问题</strong>，纯粹思考你想要实现的dsl是什么样子
          <br />3.用你想要的DSL写一个
          <strong>最基本的例子，只包括最基本的功能</strong>。
          <br />4.开始实现DSL，尽快让你的DSL例子以
          <strong>dirty and quick</strong>的方式跑起来。
          <br />5.写更多DSL的例子，慢慢包括你想要的所有功能，并一一实现，在这个过程中你可能改变DSL的样子，原来模糊的东西渐渐清楚。
          <br />6.大功告成，review你的代码并添加
          <strong>自动化测试</strong>，将代码中dirty和bad smell的部分一一剔除。
          <br />7.让你的DSL接受实际应用的考验吧。
          <br />
         </div> 
         <p class="postfoot"> posted @ <a href="http://www.blogjava.net/killme2008/archive/2011/07/25/355010.html" title="permalink">2011-07-25 19:30</a> dennis 阅读(3259) | <a href="http://www.blogjava.net/killme2008/archive/2011/07/25/355010.html#FeedBack" title="comments, pingbacks, trackbacks">评论 (1)</a> |&nbsp;<a href="http://www.blogjava.net/killme2008/admin/EditPosts.aspx?postid=355010">编辑</a>&nbsp;<a href="http://www.blogjava.net/killme2008/AddToFavorite.aspx?id=355010">收藏</a> </p> 
        </div> 
        <div class="post" style="filter:progid:DXImageTransform.Microsoft.Shadow(color='Blue', Direction=135, Strength=32)"> 
         <div class="posthead"> 
          <h2 style="padding-top:4px; padding-bottom:4px;"><a id="ArchiveDay1_SingleDay_DayList_ctl49_TitleUrl" href="http://www.blogjava.net/killme2008/archive/2011/07/24/354938.html">A clojure DSL for system admin and deployment with many remote machines</a></h2> 
         </div> 
         <div class="postbody">
          <strong>update: Allow passing command line arguments to task now.<br /><br />1.What is clojure-control? </strong>
          <br /> 
          <p>&nbsp;&nbsp;&nbsp; The idea came from <a href="https://github.com/tsmith/node- control">node-control</a>. <br /> &nbsp;&nbsp;&nbsp; Define clusters and tasks for system administration or code deployment, then execute them on one or many remote machines. <br /> &nbsp;&nbsp;&nbsp; Clojure-control depends only on OpenSSH and clojure on the local control machine.Remote machines simply need a standard sshd daemon. <br /> </p>
          <p><strong>2.Quick example </strong><br /> </p>
          <p>Get the current date from the two machines listed in the 'mycluster'&nbsp; config with a single command: <br /></p>
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
           <span style="color: #000000; ">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(ns&nbsp;samples<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(:use&nbsp;[control.core&nbsp;:only&nbsp;[task&nbsp;cluster&nbsp;scp&nbsp;ssh&nbsp;begin]]))<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;;define&nbsp;clusters<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(cluster&nbsp;:mycluster<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:clients&nbsp;[<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;:host&nbsp;</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">a.domain.com</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">&nbsp;:user&nbsp;</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">alogin</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;:host&nbsp;</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">b.domain.com</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">&nbsp;:user&nbsp;</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">blogin</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;])<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;;define&nbsp;tasks<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(task&nbsp;:date&nbsp;</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">Get&nbsp;date</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; "><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; []<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(ssh&nbsp;</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">date</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">))<br />&nbsp;&nbsp;&nbsp;&nbsp;;;start&nbsp;running<br />&nbsp;&nbsp;&nbsp;&nbsp;(begin) <br /></span>
          </div>
          <p>&nbsp;&nbsp;&nbsp; If saved in a file named &quot;controls.clj&quot;,run with &nbsp;&nbsp; <br /></p>
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
           <span style="color: #000000; ">java&nbsp;</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">cp&nbsp;clojure.jar:clojure</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">contrib.jar:control</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">0.1</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">SNAPSHOT.jar&nbsp;clojure.main&nbsp;controls.clj&nbsp;mycluster&nbsp;date <br /></span>
          </div>
          <p> </p>
          <p>&nbsp;&nbsp;&nbsp; Each machine execute &quot;date&quot; command ,and the output form the remote machine is printed to the console.Exmaple console output <br /> </p>
          <p>&nbsp;</p>
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
           <span style="color: #000000; ">&nbsp;&nbsp;&nbsp;&nbsp;Performing&nbsp;mycluster<br />&nbsp;&nbsp;&nbsp;&nbsp;Performing&nbsp;date&nbsp;</span>
           <span style="color: #0000FF; ">for</span>
           <span style="color: #000000; ">&nbsp;a.domain.com<br />&nbsp;&nbsp;&nbsp;&nbsp;a.domain.com:ssh:&nbsp;date<br />&nbsp;&nbsp;&nbsp;&nbsp;a.domain.com:stdout:&nbsp;Sun&nbsp;Jul&nbsp;</span>
           <span style="color: #000000; ">24</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #000000; ">19</span>
           <span style="color: #000000; ">:</span>
           <span style="color: #000000; ">14</span>
           <span style="color: #000000; ">:</span>
           <span style="color: #000000; ">09</span>
           <span style="color: #000000; ">&nbsp;CST&nbsp;</span>
           <span style="color: #000000; ">2011</span>
           <span style="color: #000000; "><br />&nbsp;&nbsp;&nbsp;&nbsp;a.domain.com:exit:&nbsp;</span>
           <span style="color: #000000; ">0</span>
           <span style="color: #000000; "><br />&nbsp;&nbsp;&nbsp;&nbsp;Performing&nbsp;date&nbsp;</span>
           <span style="color: #0000FF; ">for</span>
           <span style="color: #000000; ">&nbsp;b.domain.com<br />&nbsp;&nbsp;&nbsp;&nbsp;b.domain.com:ssh:&nbsp;date<br />&nbsp;&nbsp;&nbsp;&nbsp;b.domain.com:stdout:&nbsp;Sun&nbsp;Jul&nbsp;</span>
           <span style="color: #000000; ">24</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #000000; ">19</span>
           <span style="color: #000000; ">:</span>
           <span style="color: #000000; ">14</span>
           <span style="color: #000000; ">:</span>
           <span style="color: #000000; ">09</span>
           <span style="color: #000000; ">&nbsp;CST&nbsp;</span>
           <span style="color: #000000; ">2011</span>
           <span style="color: #000000; "><br />&nbsp;&nbsp;&nbsp;&nbsp;b.domain.com:exit:&nbsp;</span>
           <span style="color: #000000; ">0</span>
           <span style="color: #000000; "> <br /></span>
          </div>
          <p>&nbsp;&nbsp;&nbsp; Each line of output is labeled with the address of the machine the command was executed on. The actual command sent and the user used to send it is displayed. stdout and stderr output of the remote process is identified as well as the final exit code of the local ssh command. <br /> </p>
          <p><strong><br /></strong></p>
          <p><strong>3.How to scp files? </strong><br /> &nbsp;&nbsp;&nbsp; Let's define a new task named deploy <br /> </p>
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
           <span style="color: #000000; ">&nbsp;&nbsp;(task&nbsp;:deploy&nbsp;</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">scp&nbsp;files&nbsp;to&nbsp;remote&nbsp;machines</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; "><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; []<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(scp&nbsp;(</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">release1.tar.gz</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">release2.tar.gz</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">)&nbsp;</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">/home/alogin/</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">)) <br /></span>
          </div>
          <p> </p>
          <p>&nbsp;&nbsp;&nbsp; Then it will copy release1.tar.gz and release2.tar.gz to remote machine's /home/alogin directory. <br /> </p>
          <p><strong>4.Where is it?</strong><br /> </p>&nbsp;&nbsp;&nbsp; It's on github,
          <a title="https://github.com/killme2008/clojure-control" href="https://github.com/killme2008/clojure-control">https://github.com/killme2008/clojure-control</a>
          <br />
          <br />&nbsp;&nbsp;&nbsp; Any suggestion or bug reports welcomed.
         </div> 
         <p class="postfoot"> posted @ <a href="http://www.blogjava.net/killme2008/archive/2011/07/24/354938.html" title="permalink">2011-07-24 21:48</a> dennis 阅读(2822) | <a href="http://www.blogjava.net/killme2008/archive/2011/07/24/354938.html#FeedBack" title="comments, pingbacks, trackbacks">评论 (0)</a> |&nbsp;<a href="http://www.blogjava.net/killme2008/admin/EditPosts.aspx?postid=354938">编辑</a>&nbsp;<a href="http://www.blogjava.net/killme2008/AddToFavorite.aspx?id=354938">收藏</a> </p> 
        </div> 
        <div class="post" style="filter:progid:DXImageTransform.Microsoft.Shadow(color='Blue', Direction=135, Strength=32)"> 
         <div class="posthead"> 
          <h2 style="padding-top:4px; padding-bottom:4px;"><a id="ArchiveDay1_SingleDay_DayList_ctl50_TitleUrl" href="http://www.blogjava.net/killme2008/archive/2011/07/13/354296.html">轻量级高性能的表达式求值器――aviator发布2.0</a></h2> 
         </div> 
         <div class="postbody">
          <p>&nbsp;</p> 
          <p>&nbsp;&nbsp;&nbsp; <a href="http://code.google.com/p/aviator/">aviator</a>是一个轻量级的、高性能的Java表达式求值器，主要应用在如工作流引擎节点条件判断、MQ中的消息过滤以及某些特定的业务场景。</p> 
          <p>&nbsp;&nbsp;&nbsp; 自从上次发布1.0后，还发过1.01版本，不过都没怎么宣传。这次发布一个2.0的里程碑版本，主要改进如下：</p> 
          <br /> 
          <p>1、完整支持位运算符，与java完全一致。位预算符对实现bit set之类的需求还是非常必须的。 <br /> </p> 
          <p>2、性能优化，平均性能提升100%，函数调用性能提升200%，最新的与groovy和JEXL的性能测试看这里</p> 
          <p><a href="http://code.google.com/p/aviator/wiki/Performance">http://code.google.com/p/aviator/wiki/Performance</a> <br /> </p> 
          <p>3、添加了新函数，包括long、double、str用于类型转换，添加了string.indexOf函数。</p> 
          <p>4、完善了用户手册，更新性能测试。</p> 
          <p>&nbsp;</p> 
          <p>下载地址：&nbsp;<a href="http://code.google.com/p/aviator/downloads/list"> http://code.google.com/p/aviator/downloads/list</a></p> 
          <p>项目主页：&nbsp; <a href="http://code.google.com/p/aviator/">http://code.google.com/p/aviator/</a></p> 
          <p>用户指南：&nbsp; <a href="http://code.google.com/p/aviator/w/list">http://code.google.com/p/aviator/w/list</a></p> 
          <p>性能报告：&nbsp; <a href="http://code.google.com/p/aviator/wiki/Performance">http://code.google.com/p/aviator/wiki/Performance</a></p> 
          <p>源码：&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <a href="https://github.com/killme2008/aviator">https://github.com/killme2008/aviator</a></p> 
          <p>&nbsp;</p>
          <p>Maven引用（感谢许老大的帮助）：</p>
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
           <span style="color: #000000; ">&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000FF; ">&lt;</span>
           <span style="color: #800000; ">dependency</span>
           <span style="color: #0000FF; ">&gt;</span>
           <span style="color: #000000; "><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000FF; ">&lt;</span>
           <span style="color: #800000; ">groupId</span>
           <span style="color: #0000FF; ">&gt;</span>
           <span style="color: #000000; ">com.googlecode.aviator</span>
           <span style="color: #0000FF; ">&lt;/</span>
           <span style="color: #800000; ">groupId</span>
           <span style="color: #0000FF; ">&gt;</span>
           <span style="color: #000000; "><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000FF; ">&lt;</span>
           <span style="color: #800000; ">artifactId</span>
           <span style="color: #0000FF; ">&gt;</span>
           <span style="color: #000000; ">aviator</span>
           <span style="color: #0000FF; ">&lt;/</span>
           <span style="color: #800000; ">artifactId</span>
           <span style="color: #0000FF; ">&gt;</span>
           <span style="color: #000000; "><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000FF; ">&lt;</span>
           <span style="color: #800000; ">version</span>
           <span style="color: #0000FF; ">&gt;</span>
           <span style="color: #000000; ">2.0</span>
           <span style="color: #0000FF; ">&lt;/</span>
           <span style="color: #800000; ">version</span>
           <span style="color: #0000FF; ">&gt;</span>
           <span style="color: #000000; "><br />&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000FF; ">&lt;/</span>
           <span style="color: #800000; ">dependency</span>
           <span style="color: #0000FF; ">&gt;</span>
          </div> 
          <p>&nbsp;&nbsp;&nbsp;&nbsp; 这个项目目前用在我们的MQ产品中做消息过滤，也有几个公司外的用户告诉我他们也在用，不过估计不会很多。有这种需求的场景还是比较少的。这个项目实际上是为我们的MQ定制的，我主要想做到这么几点：</p> 
          <p>（1）控制用户能够使用的函数，不允许调用任何不受控制的函数。</p> 
          <p>（2）轻量级，不需要嵌入groovy这么大的脚本引擎，我们只需要一个剪裁过的表达式语法即可。</p> 
          <p>（3）高性能，最终的性能在某些场景比groovy略差，但是已经非常接近。</p> 
          <p>（4）易于扩展，可以容易地添加函数扩展功能。语法相对固定。</p> 
          <p>（5）函数的调用避免使用反射。因此没使用dot运算符的函数调用方式，而是更类似c语言和lua语言的函数调用风格。函数是一等公民，seq库的风格很符合我的喜好。</p> 
          <p>&nbsp; seq这概念来自clojure，我将实现了java.util.Collection接口的类和数组都称为seq集合，可以统一使用seq库操作。例如假设我有个list:</p> 
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br />
<br />
Code highlighting produced by Actipro CodeHighlighter (freeware)<br />
http://www.CodeHighlighter.com/<br />
<br />
-->
           <span style="color: #000000; ">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Map</span>
           <span style="color: #000000; ">&lt;</span>
           <span style="color: #000000; ">String,&nbsp;Object</span>
           <span style="color: #000000; ">&gt;</span>
           <span style="color: #000000; ">&nbsp;env&nbsp;</span>
           <span style="color: #000000; ">=</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #0000FF; ">new</span>
           <span style="color: #000000; ">&nbsp;HashMap</span>
           <span style="color: #000000; ">&lt;</span>
           <span style="color: #000000; ">String,&nbsp;Object</span>
           <span style="color: #000000; ">&gt;</span>
           <span style="color: #000000; ">();<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ArrayList</span>
           <span style="color: #000000; ">&lt;</span>
           <span style="color: #000000; ">Integer</span>
           <span style="color: #000000; ">&gt;</span>
           <span style="color: #000000; ">&nbsp;list&nbsp;</span>
           <span style="color: #000000; ">=</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #0000FF; ">new</span>
           <span style="color: #000000; ">&nbsp;ArrayList</span>
           <span style="color: #000000; ">&lt;</span>
           <span style="color: #000000; ">Integer</span>
           <span style="color: #000000; ">&gt;</span>
           <span style="color: #000000; ">();<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;list.add(</span>
           <span style="color: #000000; ">3</span>
           <span style="color: #000000; ">);<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;list.add(</span>
           <span style="color: #000000; ">100</span>
           <span style="color: #000000; ">);<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;list.add(</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">100</span>
           <span style="color: #000000; ">);<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;env.put(</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">list</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">,&nbsp;list);</span>
          </div> 
          <br />&nbsp;&nbsp; 可以做这么几个事情，度量大小：
          <br />
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
           <span style="color: #000000; ">count(list)</span>
          </div>&nbsp;&nbsp; 判断元素是否存在：
          <br />
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
           <span style="color: #000000; ">include(list,</span>
           <span style="color: #000000; ">3</span>
           <span style="color: #000000; ">)</span>
          </div>&nbsp;&nbsp; 过滤元素，返回大于0的元素组成的seq：
          <br />
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
           <span style="color: #000000; ">filter(list,seq.gt(</span>
           <span style="color: #000000; ">0</span>
           <span style="color: #000000; ">))<br /></span>
          </div>&nbsp;&nbsp; 对集合里的元素求和，应用reduce:
          <br />
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
           <span style="color: #000000; ">reduce(list,</span>
           <span style="color: #000000; ">+</span>
           <span style="color: #000000; ">,</span>
           <span style="color: #000000; ">0</span>
           <span style="color: #000000; ">)</span>
          </div>&nbsp;&nbsp; 遍历集合元素并打印：
          <br />
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
           <span style="color: #000000; ">map(list,println)</span>
          </div>&nbsp;&nbsp; 最后，你还可以排序:
          <br />
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
           <span style="color: #000000; ">sort(list)</span>
          </div>
          <br />&nbsp;&nbsp;&nbsp; 这些函数类似FP里的高阶函数，使用起来还是非常爽的。
          <br />
          <br />&nbsp;&nbsp;&nbsp; 对函数调用的优化，其实只干了一个事情，原来函数调用我是将所有参数收集到一个list里面，然后再转成数组元素交给AviatorFunction调用。这里创建了两个临时对象：list和数组。这其实是没有必要的，我只要在AviatorFunction里定义一系列重载方法，如：
          <br />
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
           <span style="color: #000000; ">&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000FF; ">public</span>
           <span style="color: #000000; ">&nbsp;AviatorObject&nbsp;call(Map</span>
           <span style="color: #000000; ">&lt;</span>
           <span style="color: #000000; ">String,&nbsp;Object</span>
           <span style="color: #000000; ">&gt;</span>
           <span style="color: #000000; ">&nbsp;env);<br /><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000FF; ">public</span>
           <span style="color: #000000; ">&nbsp;AviatorObject&nbsp;call(Map</span>
           <span style="color: #000000; ">&lt;</span>
           <span style="color: #000000; ">String,&nbsp;Object</span>
           <span style="color: #000000; ">&gt;</span>
           <span style="color: #000000; ">&nbsp;env,&nbsp;AviatorObject&nbsp;arg1);<br /><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000FF; ">public</span>
           <span style="color: #000000; ">&nbsp;AviatorObject&nbsp;call(Map</span>
           <span style="color: #000000; ">&lt;</span>
           <span style="color: #000000; ">String,&nbsp;Object</span>
           <span style="color: #000000; ">&gt;</span>
           <span style="color: #000000; ">&nbsp;env,&nbsp;AviatorObject&nbsp;arg1,&nbsp;AviatorObject&nbsp;arg2);<br /><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000FF; ">public</span>
           <span style="color: #000000; ">&nbsp;AviatorObject&nbsp;call(Map</span>
           <span style="color: #000000; ">&lt;</span>
           <span style="color: #000000; ">String,&nbsp;Object</span>
           <span style="color: #000000; ">&gt;</span>
           <span style="color: #000000; ">&nbsp;env,&nbsp;AviatorObject&nbsp;arg1,&nbsp;AviatorObject&nbsp;arg2,&nbsp;AviatorObject&nbsp;arg3);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;<img src="http://www.blogjava.net/Images/dot.gif" alt="" /><img src="http://www.blogjava.net/Images/dot.gif" alt="" /></span>
          </div>
          <br />&nbsp;&nbsp; 就不需要收集参数，而是直接invokeinterface调用AviatorFunction相应的重载方法即可。我看到在JRuby和Clojure里的方法调用都这样干的。过去的思路走岔了。最终也不需要区分内部的method和外部的function，统一为一个对象即可，进一步减少了对象创建的开销。
         </div> 
         <p class="postfoot"> posted @ <a href="http://www.blogjava.net/killme2008/archive/2011/07/13/354296.html" title="permalink">2011-07-13 22:34</a> dennis 阅读(3393) | <a href="http://www.blogjava.net/killme2008/archive/2011/07/13/354296.html#FeedBack" title="comments, pingbacks, trackbacks">评论 (0)</a> |&nbsp;<a href="http://www.blogjava.net/killme2008/admin/EditPosts.aspx?postid=354296">编辑</a>&nbsp;<a href="http://www.blogjava.net/killme2008/AddToFavorite.aspx?id=354296">收藏</a> </p> 
        </div> 
        <div class="post" style="filter:progid:DXImageTransform.Microsoft.Shadow(color='Blue', Direction=135, Strength=32)"> 
         <div class="posthead"> 
          <h2 style="padding-top:4px; padding-bottom:4px;"><a id="ArchiveDay1_SingleDay_DayList_ctl51_TitleUrl" href="http://www.blogjava.net/killme2008/archive/2011/07/10/354062.html">找bug记（1）</a></h2> 
         </div> 
         <div class="postbody">
          <br /> &nbsp;&nbsp;&nbsp; 转载请注明出处 
          <a href="http://www.blogjava.net/killme2008/archive/2011/07/10/354062.html">http://www.blogjava.net/killme2008/archive/2011/07/10/354062.html</a>
          <br /> 
          <br /> &nbsp;&nbsp;&nbsp; 上周在线上系统发现了两个bug，值得记录下查找的过程和原因。以后如果还有查找bug比较有价值的经历，我也会继续分享。
          <br /> &nbsp;&nbsp;&nbsp; 第一个bug的起始，是在线上日志发现一个频繁打印的异常――java.lang.ArrayIndexOutOfBoundsException。但是却没有堆栈，只有一行一行的ArrayIndexOutOfBoundsException。没有堆栈，不知道异常是从什么地方抛出来的，也就不能找到问题的根源，更谈不上解决。题外，工程师在用log4j记录错误异常的时候，我看到很多人这样用（假设e是异常对象）：
          <br /> 
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br />
<br />
Code highlighting produced by Actipro CodeHighlighter (freeware)<br />
http://www.CodeHighlighter.com/<br />
<br />
-->
           <span style="color: #000000; ">log.error(</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">发生错误:</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">+</span>
           <span style="color: #000000; ">e);<br /> </span>
          </div> 或者：
          <br /> 
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br />
<br />
Code highlighting produced by Actipro CodeHighlighter (freeware)<br />
http://www.CodeHighlighter.com/<br />
<br />
-->
           <span style="color: #000000; ">log.error(</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">发生错误:</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">+</span>
           <span style="color: #000000; ">e.getMessage());</span>
          </div> &nbsp;&nbsp;&nbsp; 这样的写法是不对，只记录了异常的信息，而没有将堆栈输出到日志，正确的写法是利用error的重载方法：
          <br /> 
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br />
<br />
Code highlighting produced by Actipro CodeHighlighter (freeware)<br />
http://www.CodeHighlighter.com/<br />
<br />
-->
           <span style="color: #000000; ">log.error(</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">xxx发生错误</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">,e);</span>
          </div> 
          <br /> &nbsp;&nbsp;&nbsp; 这样才能在日志中完整地输出异常堆栈来。如何写好日志是另一个话题，这里不展开。继续我们的找bug经历。刚才提到，我们线上日志一直出现一行错误信息ArrayIndexOutOfBoundsException却没有堆栈，是我们没有正确地写日志吗？检查代码不是的，这个问题其实是跟JDK5引入的一个新特性有关，对于一些频繁抛出的异常，JDK为了性能会做一个优化，在JIT重新编译后会抛出没有堆栈的异常。在使用server模式的时候，这个优化是开启的，我们的服务器跑在server模式下并且jdk版本是6，因此在频繁抛出ArrayIndexOutOfBoundsException异常一段时间后优化开始起作用，只抛出没有堆栈的异常信息了。
          <br /> 
          <br /> &nbsp;&nbsp;&nbsp; 那么怎么解决这个问题呢？因为这个优化是在JIT重新编译后才起作用，因此一开始抛出异常的时候还是有堆栈的，所以可以查看较旧的日志，寻找有完整堆栈的异常信息。但是由于我们的日志太大，会定期删除，我们的服务器也启动了很长时间，因此查找日志不是很靠谱的方法。
          <br /> &nbsp;&nbsp;&nbsp; 另一个解决办法是暂时禁用这个优化，强制要求每次都要抛出有堆栈的异常。幸好JDK提供了选项来关闭这个优化，配置JVM参数
          <br /> 
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br />
<br />
Code highlighting produced by Actipro CodeHighlighter (freeware)<br />
http://www.CodeHighlighter.com/<br />
<br />
-->
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">XX:</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">OmitStackTraceInFastThrow</span>
          </div> &nbsp;&nbsp;&nbsp; 就可以禁止这个优化（注意选项中的减号，加号是启用）。
          <br /> 
          <br /> &nbsp;&nbsp;&nbsp; 我们找了台机器，配置了这个参数并重启一下。过了一会就找到问题所在，堆栈类似这样
          <br /> 
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br />
<br />
Code highlighting produced by Actipro CodeHighlighter (freeware)<br />
http://www.CodeHighlighter.com/<br />
<br />
-->
           <span style="color: #000000; ">Caused&nbsp;by:&nbsp;java.lang.ArrayIndexOutOfBoundsException:&nbsp;</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">1831238</span>
           <span style="color: #000000; "><br /> &nbsp;&nbsp;&nbsp;&nbsp;at&nbsp;sun.util.calendar.BaseCalendar.getCalendarDateFromFixedDate(BaseCalendar.java:</span>
           <span style="color: #000000; ">436</span>
           <span style="color: #000000;">)<br /> &nbsp;&nbsp;&nbsp;&nbsp;at&nbsp;java.util.GregorianCalendar.computeFields(GregorianCalendar.java:</span>
           <span style="color: #000000; ">2081</span>
           <span style="color: #000000; ">)<br /> &nbsp;&nbsp;&nbsp;&nbsp;at&nbsp;java.util.GregorianCalendar.computeFields(GregorianCalendar.java:</span>
           <span style="color: #000000; ">1996</span>
           <span style="color: #000000; ">)<br /> &nbsp;&nbsp;&nbsp;&nbsp;at&nbsp;java.util.Calendar.setTimeInMillis(Calendar.java:</span>
           <span style="color: #000000; ">1109</span>
           <span style="color: #000000; ">)<br /> &nbsp;&nbsp;&nbsp;&nbsp;at&nbsp;java.util.Calendar.setTime(Calendar.java:</span>
           <span style="color: #000000; ">1075</span>
           <span style="color: #000000; ">)<br /> &nbsp;&nbsp;&nbsp;&nbsp;at&nbsp;java.text.SimpleDateFormat.format(SimpleDateFormat.java:</span>
           <span style="color: #000000; ">876</span>
           <span style="color: #000000; ">)<br /> &nbsp;&nbsp;&nbsp;&nbsp;at&nbsp;java.text.SimpleDateFormat.format(SimpleDateFormat.java:</span>
           <span style="color: #000000; ">869</span>
           <span style="color: #000000; ">)<br /> &nbsp;&nbsp;&nbsp;&nbsp;at&nbsp;java.text.DateFormat.format(DateFormat.java:</span>
           <span style="color: #000000; ">316</span>
           <span style="color: #000000; ">)</span>
          </div> 
          <br /> &nbsp;&nbsp;&nbsp; 读者肯定猜到了，这个问题是由于SimpleDateFormat的误用引起的。
          <a href="http://download.oracle.com/javase/6/docs/api/java/text/SimpleDateFormat.html">SimpleDateFormat</a>的
          <a href="http://download.oracle.com/javase/6/docs/api/java/text/SimpleDateFormat.html">javadoc</a>中有这么句话：
          <br /> 
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br />
<br />
Code highlighting produced by Actipro CodeHighlighter (freeware)<br />
http://www.CodeHighlighter.com/<br />
<br />
-->
           <span style="color: #000000; ">Date&nbsp;formats&nbsp;are&nbsp;not&nbsp;</span>
           <span style="color: #0000FF; ">synchronized</span>
           <span style="color: #000000; ">.&nbsp;It&nbsp;is&nbsp;recommended&nbsp;to&nbsp;create&nbsp;separate&nbsp;format&nbsp;instances&nbsp;</span>
           <span style="color: #0000FF; ">for</span>
           <span style="color: #000000; ">&nbsp;each&nbsp;thread. <br /> If&nbsp;multiple&nbsp;threads&nbsp;access&nbsp;a&nbsp;format&nbsp;concurrently,&nbsp;it&nbsp;must&nbsp;be&nbsp;</span>
           <span style="color: #0000FF; ">synchronized</span>
           <span style="color: #000000; ">&nbsp;externally. <br /> </span>
          </div> &nbsp;&nbsp;&nbsp; 但是很悲剧的是这句话是放在整个doc的最后面，在我看来，这句话应该放在最前面才对。简单来说就是SimpleDateFormat不是线程安全的，你要么每次都new一个来用，要么做加锁来同步使用。
          <br /> 
          <br /> &nbsp;&nbsp;&nbsp; 出问题的代码就是由于工程师认为SimpleDateFormat的创建代价很高，然后搞了个map做缓存，所有线程共用这个instance做format，同时没有做同步。悲剧就诞生了。
          <br /> &nbsp;&nbsp;&nbsp; 这里就引出我想提到的第二点问题，在使用一个类或者方法的时候
          <strong>，最好能详细地看下该类的javadoc，JDK的javadoc是做的非常好的</strong>，javadoc除了做说明之外，通常还会给示例，并且会点出一些关键问题，如线程安全性和平台移植性。
          <br /> 
          <br /> &nbsp;&nbsp;&nbsp; 最后，我将做个测试，到底在使用SimpleDateFormat怎么做才是最好的方式？假设我们要实现一个formatDate方法将日期格式化成&quot;yyyy-MM-dd&quot;的格式。
          <br /> &nbsp;&nbsp;&nbsp; 第一个方法是每次使用都创建一个instance，并调用format方法：
          <br /> 
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br />
<br />
Code highlighting produced by Actipro CodeHighlighter (freeware)<br />
http://www.CodeHighlighter.com/<br />
<br />
-->
           <span style="color: #000000; ">&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000FF; ">public</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #0000FF; ">static</span>
           <span style="color: #000000; ">&nbsp;String&nbsp;formatDate1(Date&nbsp;date)&nbsp;{<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SimpleDateFormat&nbsp;format&nbsp;</span>
           <span style="color: #000000; ">=</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #0000FF; ">new</span>
           <span style="color: #000000; ">&nbsp;SimpleDateFormat(</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">yyyy-MM-dd</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">);<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000FF; ">return</span>
           <span style="color: #000000; ">&nbsp;format.format(date);<br /> &nbsp;&nbsp;&nbsp;&nbsp;}<br /> </span>
          </div> 
          <br /> &nbsp;&nbsp;&nbsp; 第二个方法是只创建一个instance，但是在调用方法的时候做同步：
          <br /> 
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br />
<br />
Code highlighting produced by Actipro CodeHighlighter (freeware)<br />
http://www.CodeHighlighter.com/<br />
<br />
-->
           <span style="color: #000000; "> &nbsp;&nbsp; </span>
           <span style="color: #0000FF; ">private</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #0000FF; ">static</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #0000FF; ">final</span>
           <span style="color: #000000; ">&nbsp;SimpleDateFormat&nbsp;formatter&nbsp;</span>
           <span style="color: #000000; ">=</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #0000FF; ">new</span>
           <span style="color: #000000; ">&nbsp;SimpleDateFormat(</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">yyyy-MM-dd</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">);<br /> <br /> &nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000FF; ">public</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #0000FF; ">static</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #0000FF; ">synchronized</span>
           <span style="color: #000000; ">&nbsp;String&nbsp;formatDate2(Date&nbsp;date)&nbsp;{<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000FF; ">return</span>
           <span style="color: #000000; ">&nbsp;formatter.format(date);<br /> &nbsp;&nbsp;&nbsp;&nbsp;}</span>
          </div> 
          <br /> &nbsp;&nbsp;&nbsp; 第三个方法比较特殊，我们为每个线程都缓存一个instance，存放在ThreadLocal里，使用的时候从ThreadLocal里取就可以了:
          <br /> 
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br />
<br />
Code highlighting produced by Actipro CodeHighlighter (freeware)<br />
http://www.CodeHighlighter.com/<br />
<br />
-->
           <span style="color: #000000; ">&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000FF; ">private</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #0000FF; ">static</span>
           <span style="color: #000000; ">&nbsp;ThreadLocal</span>
           <span style="color: #000000; ">&lt;</span>
           <span style="color: #000000; ">SimpleDateFormat</span>
           <span style="color: #000000; ">&gt;</span>
           <span style="color: #000000; ">&nbsp;formatCache&nbsp;</span>
           <span style="color: #000000; ">=</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #0000FF; ">new</span>
           <span style="color: #000000; ">&nbsp;ThreadLocal</span>
           <span style="color: #000000; ">&lt;</span>
           <span style="color: #000000; ">SimpleDateFormat</span>
           <span style="color: #000000; ">&gt;</span>
           <span style="color: #000000; ">()&nbsp;{<br /> <br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000FF; ">protected</span>
           <span style="color: #000000; ">&nbsp;SimpleDateFormat&nbsp;initialValue()&nbsp;{<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000FF; ">return</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #0000FF; ">new</span>
           <span style="color: #000000; ">&nbsp;SimpleDateFormat(</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">yyyy-MM-dd</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">);<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br /> <br /> &nbsp;&nbsp;&nbsp;&nbsp;};<br /> <br /> &nbsp;&nbsp;&nbsp; </span>
           <span style="color: #0000FF; ">public</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #0000FF; ">static</span>
           <span style="color: #000000; ">&nbsp;String&nbsp;formatDate3(Date&nbsp;date)&nbsp;{<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SimpleDateFormat&nbsp;format&nbsp;</span>
           <span style="color: #000000; ">=</span>
           <span style="color: #000000; ">&nbsp;formatCache.get();<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000FF; ">return</span>
           <span style="color: #000000; ">&nbsp;format.format(date);<br /> &nbsp;&nbsp;&nbsp;&nbsp;}</span>
          </div> 
          <br /> &nbsp;&nbsp;&nbsp; 然后我们测试下三个方法并发调用下的性能并做一个比较，并发100个线程循环调用1000万次，记录耗时。我们设置了JVM参数：
          <br /> 
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br />
<br />
Code highlighting produced by Actipro CodeHighlighter (freeware)<br />
http://www.CodeHighlighter.com/<br />
<br />
-->
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">Xmx512m&nbsp;</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">XX:CompileThreshold</span>
           <span style="color: #000000; ">=</span>
           <span style="color: #000000; ">10000</span>
          </div> &nbsp;&nbsp;&nbsp; 设置堆最大为512M，设置当一个方法被调用1万次的时候就被JIT编译。测试的结果如下：
          <br /> 
          <table style="border: 1px none; margin: 1px;" bgcolor="#C0C0C0" border="1" bordercolor="#000000" cellpadding="2" cellspacing="2" width="500"> 
           <tbody> 
            <tr> 
             <td>&nbsp; <br /> </td> 
             <td> 第1次测试<br /> </td> 
             <td> 第2次测试<br /> </td> 
             <td> 第3次测试<br /> </td> 
            </tr> 
            <tr> 
             <td> formatDate1<br /> </td> 
             <td> 50545<br /> </td> 
             <td> 49365<br /> </td> 
             <td> 53532<br /> </td> 
            </tr> 
            <tr> 
             <td> formatDate2<br /> </td> 
             <td> 10895<br /> </td> 
             <td> 10761<br /> </td> 
             <td> 10673<br /> </td> 
            </tr> 
            <tr> 
             <td>formatDate3</td> 
             <td>10386</td> 
             <td>9919</td> 
             <td>9527</td> 
            </tr> 
           </tbody> 
          </table>(单位：毫秒）
          <br />&nbsp;&nbsp;&nbsp; 
          <br />&nbsp;&nbsp;&nbsp; 从结果来看，方法1最慢，方法3最快，但是就算是最慢的方法1也可以达到每秒钟
          <strike>
           200
          </strike> 20万次的调用量，很少有系统能达到这个量级。这个点很难成为你系统的瓶颈所在。从我的角度出发，我会建议你用方法1或者方法2，如果你追求那么一点性能提升的话，可以考虑用方法3，也就是用ThreadLocal做缓存。
          <br />
          <br />&nbsp;&nbsp;&nbsp; 总结下本文找bug经历想表达的几点想法：
          <br />（1）正确地打印错误日志
          <br />（2）在server模式下，最好都设置
          <span style="color: #000000; ">-</span>
          <span style="color: #000000; ">XX:</span>
          <span style="color: #000000; ">-</span>
          <span style="color: #000000;">OmitStackTraceInFastThrow<br />（3）使用类或者方法的时候，最好能详细阅读下javadoc，很多问题都能找到答案<br />（4）使用SimpleDateFormat的时候要注意线程安全性，要么每次new，要么做同步，两者的性能有差距，但是这个差距很难成为你的性能瓶颈。<br /><br /></span>&nbsp;&nbsp;&nbsp; 下篇文章我再分享另一个bug的查找经历，也是比较有趣，可以看到一些工具的使用。
          <br />
          <span style="color: #000000; "><br /></span>
         </div> 
         <p class="postfoot"> posted @ <a href="http://www.blogjava.net/killme2008/archive/2011/07/10/354062.html" title="permalink">2011-07-10 23:29</a> dennis 阅读(7009) | <a href="http://www.blogjava.net/killme2008/archive/2011/07/10/354062.html#FeedBack" title="comments, pingbacks, trackbacks">评论 (16)</a> |&nbsp;<a href="http://www.blogjava.net/killme2008/admin/EditPosts.aspx?postid=354062">编辑</a>&nbsp;<a href="http://www.blogjava.net/killme2008/AddToFavorite.aspx?id=354062">收藏</a> </p> 
        </div> 
        <div class="post" style="filter:progid:DXImageTransform.Microsoft.Shadow(color='Blue', Direction=135, Strength=32)"> 
         <div class="posthead"> 
          <h2 style="padding-top:4px; padding-bottom:4px;"><a id="ArchiveDay1_SingleDay_DayList_ctl52_TitleUrl" href="http://www.blogjava.net/killme2008/archive/2011/06/30/353441.html">网络编程中Nagle算法和Delayed ACK的测试</a></h2> 
         </div> 
         <div class="postbody">
          <br />&nbsp;&nbsp;&nbsp; 
          <a href="http://en.wikipedia.org/wiki/Nagle%27s_algorithm">Nagle算法</a>的立意是良好的，避免网络中充塞小封包，提高网络的利用率。但是当Nagle算法遇到
          <a href="http://en.wikipedia.org/wiki/TCP_delayed_acknowledgment">delayed ACK</a>悲剧就发生了。Delayed ACK的本意也是为了提高TCP性能，跟应答数据捎带上ACK，同时避免
          <a href="http://hi.baidu.com/iruler/blog/item/ac2661f4c4aabe63ddc474ae.html">糊涂窗口综合症</a>，也可以一个ack确认多个段来节省开销。
          <br />&nbsp;&nbsp;&nbsp; 悲剧发生在这种情况，假设一端发送数据并等待另一端应答，协议上分为头部和数据，发送的时候不幸地选择了write-write，然后再read，也就是先发送头部，再发送数据，最后等待应答。发送端的伪代码是这样
          <br />
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
           <span style="color: #000000;">write(head);<br />write(body);<br />read(response);</span>
          </div>
          <br />接收端的处理代码类似这样：
          <br />
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
           <span style="color: #000000; ">read(request);<br />process(request);<br />write(response);</span>
          </div>
          <br />&nbsp;&nbsp; 这里假设head和body都比较小，当默认启用nagle算法，并且是第一次发送的时候，根据nagle算法，第一个段head可以立即发送，因为没有等待确认的段；接收端收到head，但是包不完整，继续等待body达到并延迟ACK；发送端继续写入body，这时候nagle算法起作用了，因为head还没有被ACK，所以body要延迟发送。这就造成了发送端和接收端都在等待对方发送数据的现象，发送端等待接收端ACK head以便继续发送body，而接收端在等待发送方发送body并延迟ACK，悲剧的无以言语。这种时候只有等待一端超时并发送数据才能继续往下走。
          <br />
          <br />&nbsp;&nbsp; 正因为nagle算法和delayed ack的影响，再加上这种write-write-read的编程方式造成了很多网贴在讨论为什么自己写的网络程序性能那么差。然后很多人会在帖子里建议禁用Nagle算法吧，设置TCP_NODELAY为true即可禁用nagle算法。但是这真的是解决问题的唯一办法和最好办法吗？
          <br />
          <br />&nbsp;&nbsp; 其实问题不是出在nagle算法身上的，问题是出在write-write-read这种应用编程上。禁用nagle算法可以暂时解决问题，但是禁用nagle算法也带来很大坏处，网络中充塞着小封包，网络的利用率上不去，在极端情况下，大量小封包导致网络拥塞甚至崩溃。因此，能不禁止还是不禁止的好，后面我们会说下什么情况下才需要禁用nagle算法。对大多数应用来说，一般都是连续的请求――应答模型，有请求同时有应答，那么请求包的ACK其实可以延迟到跟响应一起发送，在这种情况下，其实你只要避免write-write-read形式的调用就可以避免延迟现象，利用writev做聚集写或者将head和body一起写，然后再read，变成write-read-write-read的形式来调用，就无需禁用nagle算法也可以做到不延迟。
          <br />
          <br />&nbsp;&nbsp; writev是系统调用，在Java里是用到
          <a href="http://download.oracle.com/javase/1.5.0/docs/api/java/nio/channels/GatheringByteChannel.html">GatheringByteChannel</a>.write(ByteBuffer[] srcs, int offset, int length)方法来做聚集写。这里可能还有一点值的提下，很多同学看java nio框架几乎都不用这个writev调用，这是有原因的。主要是因为Java的write本身对ByteBuffer有做临时缓存，而writev没有做缓存，导致测试来看write反而比writev更高效，因此通常会更推荐用户将head和body放到同一个Buffer里来避免调用writev。
          <br />
          <br />&nbsp;&nbsp; 下面我们将做个实际的代码测试来结束讨论。这个例子很简单，客户端发送一行数据到服务器，服务器简单地将这行数据返回。客户端发送的时候可以选择分两次发，还是一次发送。分两次发就是write-write-read，一次发就是write-read-write-read，可以看看两种形式下延迟的差异。
          <strong>注意，在windows上测试下面的代码，客户端和服务器必须分在两台机器上，似乎winsock对loopback连接的处理不一样。</strong>
          <br />
          <br />&nbsp;&nbsp;&nbsp; 服务器源码：
          <br />
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
           <span style="color: #0000FF; ">package</span>
           <span style="color: #000000; ">&nbsp;net.fnil.nagle;<br /><br /></span>
           <span style="color: #0000FF; ">import</span>
           <span style="color: #000000; ">&nbsp;java.io.BufferedReader;<br /></span>
           <span style="color: #0000FF; ">import</span>
           <span style="color: #000000; ">&nbsp;java.io.InputStream;<br /></span>
           <span style="color: #0000FF; ">import</span>
           <span style="color: #000000; ">&nbsp;java.io.InputStreamReader;<br /></span>
           <span style="color: #0000FF; ">import</span>
           <span style="color: #000000; ">&nbsp;java.io.OutputStream;<br /></span>
           <span style="color: #0000FF; ">import</span>
           <span style="color: #000000; ">&nbsp;java.net.InetSocketAddress;<br /></span>
           <span style="color: #0000FF; ">import</span>
           <span style="color: #000000; ">&nbsp;java.net.ServerSocket;<br /></span>
           <span style="color: #0000FF; ">import</span>
           <span style="color: #000000; ">&nbsp;java.net.Socket;<br /><br /><br /></span>
           <span style="color: #0000FF; ">public</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #0000FF; ">class</span>
           <span style="color: #000000; ">&nbsp;Server&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000FF; ">public</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #0000FF; ">static</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #0000FF; ">void</span>
           <span style="color: #000000; ">&nbsp;main(String[]&nbsp;args)&nbsp;</span>
           <span style="color: #0000FF; ">throws</span>
           <span style="color: #000000; ">&nbsp;Exception&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServerSocket&nbsp;serverSocket&nbsp;</span>
           <span style="color: #000000; ">=</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #0000FF; ">new</span>
           <span style="color: #000000; ">&nbsp;ServerSocket();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;serverSocket.bind(</span>
           <span style="color: #0000FF; ">new</span>
           <span style="color: #000000; ">&nbsp;InetSocketAddress(</span>
           <span style="color: #000000; ">8000</span>
           <span style="color: #000000; ">));<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;System.out.println(</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">Server&nbsp;startup&nbsp;at&nbsp;8000</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000FF; ">for</span>
           <span style="color: #000000; ">&nbsp;(;;)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Socket&nbsp;socket&nbsp;</span>
           <span style="color: #000000; ">=</span>
           <span style="color: #000000; ">&nbsp;serverSocket.accept();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;InputStream&nbsp;in&nbsp;</span>
           <span style="color: #000000; ">=</span>
           <span style="color: #000000; ">&nbsp;socket.getInputStream();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OutputStream&nbsp;out&nbsp;</span>
           <span style="color: #000000; ">=</span>
           <span style="color: #000000; ">&nbsp;socket.getOutputStream();<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000FF; ">while</span>
           <span style="color: #000000; ">&nbsp;(</span>
           <span style="color: #0000FF; ">true</span>
           <span style="color: #000000; ">)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000FF; ">try</span>
           <span style="color: #000000; ">&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BufferedReader&nbsp;reader&nbsp;</span>
           <span style="color: #000000; ">=</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #0000FF; ">new</span>
           <span style="color: #000000; ">&nbsp;BufferedReader(</span>
           <span style="color: #0000FF; ">new</span>
           <span style="color: #000000; ">&nbsp;InputStreamReader(in));<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String&nbsp;line&nbsp;</span>
           <span style="color: #000000; ">=</span>
           <span style="color: #000000; ">&nbsp;reader.readLine();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;out.write((line&nbsp;</span>
           <span style="color: #000000; ">+</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">\r\n</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">).getBytes());<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000FF; ">catch</span>
           <span style="color: #000000; ">&nbsp;(Exception&nbsp;e)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000FF; ">break</span>
           <span style="color: #000000; ">;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />}<br /></span>
          </div>
          <br />服务端绑定到本地8000端口，并监听连接，连上来的时候就阻塞读取一行数据，并将数据返回给客户端。
          <br />
          <br />客户端代码：
          <br />
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
           <span style="color: #0000FF; ">package</span>
           <span style="color: #000000; ">&nbsp;net.fnil.nagle;<br /><br /></span>
           <span style="color: #0000FF; ">import</span>
           <span style="color: #000000; ">&nbsp;java.io.BufferedReader;<br /></span>
           <span style="color: #0000FF; ">import</span>
           <span style="color: #000000; ">&nbsp;java.io.InputStream;<br /></span>
           <span style="color: #0000FF; ">import</span>
           <span style="color: #000000; ">&nbsp;java.io.InputStreamReader;<br /></span>
           <span style="color: #0000FF; ">import</span>
           <span style="color: #000000; ">&nbsp;java.io.OutputStream;<br /></span>
           <span style="color: #0000FF; ">import</span>
           <span style="color: #000000; ">&nbsp;java.net.InetSocketAddress;<br /></span>
           <span style="color: #0000FF; ">import</span>
           <span style="color: #000000; ">&nbsp;java.net.Socket;<br /><br /><br /></span>
           <span style="color: #0000FF; ">public</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #0000FF; ">class</span>
           <span style="color: #000000; ">&nbsp;Client&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000FF; ">public</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #0000FF; ">static</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #0000FF; ">void</span>
           <span style="color: #000000; ">&nbsp;main(String[]&nbsp;args)&nbsp;</span>
           <span style="color: #0000FF; ">throws</span>
           <span style="color: #000000; ">&nbsp;Exception&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #008000; ">//</span>
           <span style="color: #008000; ">&nbsp;是否分开写head和body</span>
           <span style="color: #008000; "><br /></span>
           <span style="color: #000000; ">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000FF; ">boolean</span>
           <span style="color: #000000; ">&nbsp;writeSplit&nbsp;</span>
           <span style="color: #000000; ">=</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #0000FF; ">false</span>
           <span style="color: #000000; ">;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String&nbsp;host&nbsp;</span>
           <span style="color: #000000; ">=</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">localhost</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000FF; ">if</span>
           <span style="color: #000000; ">&nbsp;(args.length&nbsp;</span>
           <span style="color: #000000; ">&gt;=</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #000000; ">1</span>
           <span style="color: #000000; ">)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;host&nbsp;</span>
           <span style="color: #000000; ">=</span>
           <span style="color: #000000; ">&nbsp;args[</span>
           <span style="color: #000000; ">0</span>
           <span style="color: #000000; ">];<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000FF; ">if</span>
           <span style="color: #000000; ">&nbsp;(args.length&nbsp;</span>
           <span style="color: #000000; ">&gt;=</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #000000; ">2</span>
           <span style="color: #000000; ">)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;writeSplit&nbsp;</span>
           <span style="color: #000000; ">=</span>
           <span style="color: #000000; ">&nbsp;Boolean.valueOf(args[</span>
           <span style="color: #000000; ">1</span>
           <span style="color: #000000; ">]);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;System.out.println(</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">WriteSplit:</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #000000; ">+</span>
           <span style="color: #000000; ">&nbsp;writeSplit);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Socket&nbsp;socket&nbsp;</span>
           <span style="color: #000000; ">=</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #0000FF; ">new</span>
           <span style="color: #000000; ">&nbsp;Socket();<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;socket.connect(</span>
           <span style="color: #0000FF; ">new</span>
           <span style="color: #000000; ">&nbsp;InetSocketAddress(host,&nbsp;</span>
           <span style="color: #000000; ">8000</span>
           <span style="color: #000000; ">));<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;InputStream&nbsp;in&nbsp;</span>
           <span style="color: #000000; ">=</span>
           <span style="color: #000000; ">&nbsp;socket.getInputStream();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OutputStream&nbsp;out&nbsp;</span>
           <span style="color: #000000; ">=</span>
           <span style="color: #000000; ">&nbsp;socket.getOutputStream();<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BufferedReader&nbsp;reader&nbsp;</span>
           <span style="color: #000000; ">=</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #0000FF; ">new</span>
           <span style="color: #000000; ">&nbsp;BufferedReader(</span>
           <span style="color: #0000FF; ">new</span>
           <span style="color: #000000; ">&nbsp;InputStreamReader(in));<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String&nbsp;head&nbsp;</span>
           <span style="color: #000000; ">=</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">hello&nbsp;</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String&nbsp;body&nbsp;</span>
           <span style="color: #000000; ">=</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">world\r\n</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000FF; ">for</span>
           <span style="color: #000000; ">&nbsp;(</span>
           <span style="color: #0000FF; ">int</span>
           <span style="color: #000000; ">&nbsp;i&nbsp;</span>
           <span style="color: #000000; ">=</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #000000; ">0</span>
           <span style="color: #000000; ">;&nbsp;i&nbsp;</span>
           <span style="color: #000000; ">&lt;</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #000000; ">10</span>
           <span style="color: #000000; ">;&nbsp;i</span>
           <span style="color: #000000; ">++</span>
           <span style="color: #000000; ">)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000FF; ">long</span>
           <span style="color: #000000; ">&nbsp;label&nbsp;</span>
           <span style="color: #000000; ">=</span>
           <span style="color: #000000; ">&nbsp;System.currentTimeMillis();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000FF; ">if</span>
           <span style="color: #000000; ">&nbsp;(writeSplit)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;out.write(head.getBytes());<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;out.write(body.getBytes());<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000FF; ">else</span>
           <span style="color: #000000; ">&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;out.write((head&nbsp;</span>
           <span style="color: #000000; ">+</span>
           <span style="color: #000000; ">&nbsp;body).getBytes());<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String&nbsp;line&nbsp;</span>
           <span style="color: #000000; ">=</span>
           <span style="color: #000000; ">&nbsp;reader.readLine();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;System.out.println(</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">RTT:</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #000000; ">+</span>
           <span style="color: #000000; ">&nbsp;(System.currentTimeMillis()&nbsp;</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">&nbsp;label)&nbsp;</span>
           <span style="color: #000000; ">+</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">&nbsp;,receive:</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #000000; ">+</span>
           <span style="color: #000000; ">&nbsp;line);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;in.close();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;out.close();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;socket.close();<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br /><br />}<br /></span>
          </div>
          <br />
          <br />&nbsp;&nbsp; 客户端通过一个writeSplit变量来控制是否分开写head和body，如果为true，则先写head再写body，否则将head加上body一次写入。客户端的逻辑也很简单，连上服务器，发送一行，等待应答并打印RTT，循环10次最后关闭连接。
          <br />
          <br />&nbsp;&nbsp; 首先，我们将writeSplit设置为true，也就是分两次写入一行，在我本机测试的结果，我的机器是ubuntu 11.10：
          <br />
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
           <span style="color: #000000; ">WriteSplit:</span>
           <span style="color: #0000FF; ">true</span>
           <span style="color: #000000; "><br />RTT:</span>
           <span style="color: #000000; ">8</span>
           <span style="color: #000000; ">&nbsp;,receive:hello&nbsp;world<br />RTT:</span>
           <span style="color: #000000; ">40</span>
           <span style="color: #000000; ">&nbsp;,receive:hello&nbsp;world<br />RTT:</span>
           <span style="color: #000000; ">40</span>
           <span style="color: #000000; ">&nbsp;,receive:hello&nbsp;world<br />RTT:</span>
           <span style="color: #000000; ">40</span>
           <span style="color: #000000; ">&nbsp;,receive:hello&nbsp;world<br />RTT:</span>
           <span style="color: #000000; ">39</span>
           <span style="color: #000000; ">&nbsp;,receive:hello&nbsp;world<br />RTT:</span>
           <span style="color: #000000; ">40</span>
           <span style="color: #000000; ">&nbsp;,receive:hello&nbsp;world<br />RTT:</span>
           <span style="color: #000000; ">40</span>
           <span style="color: #000000; ">&nbsp;,receive:hello&nbsp;world<br />RTT:</span>
           <span style="color: #000000; ">40</span>
           <span style="color: #000000; ">&nbsp;,receive:hello&nbsp;world<br />RTT:</span>
           <span style="color: #000000; ">40</span>
           <span style="color: #000000; ">&nbsp;,receive:hello&nbsp;world<br />RTT:</span>
           <span style="color: #000000; ">40</span>
           <span style="color: #000000; ">&nbsp;,receive:hello&nbsp;world<br /></span>
          </div>
          <br />&nbsp;&nbsp;&nbsp; 可以看到，每次请求到应答的时间间隔都在40ms，除了第一次。linux的delayed ack是40ms，而不是原来以为的200ms。第一次立即ACK，似乎跟linux的quickack mode有关，这里我不是特别清楚，有比较清楚的同学请指教。
          <br />
          <br />&nbsp;&nbsp;&nbsp;&nbsp; 接下来，我们还是将writeSplit设置为true，但是客户端禁用nagle算法，也就是客户端代码在connect之前加上一行：
          <br />
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
           <span style="color: #000000; ">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Socket&nbsp;socket&nbsp;</span>
           <span style="color: #000000; ">=</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #0000FF; ">new</span>
           <span style="color: #000000; ">&nbsp;Socket();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;socket.setTcpNoDelay(</span>
           <span style="color: #0000FF; ">true</span>
           <span style="color: #000000; ">);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;socket.connect(</span>
           <span style="color: #0000FF; ">new</span>
           <span style="color: #000000; ">&nbsp;InetSocketAddress(host,&nbsp;</span>
           <span style="color: #000000; ">8000</span>
           <span style="color: #000000; ">));</span>
          </div>
          <br />&nbsp;&nbsp;&nbsp; 再跑下测试：
          <br />
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
           <span style="color: #000000; ">WriteSplit:</span>
           <span style="color: #0000FF; ">true</span>
           <span style="color: #000000; "><br />RTT:</span>
           <span style="color: #000000; ">0</span>
           <span style="color: #000000; ">&nbsp;,receive:hello&nbsp;world<br />RTT:</span>
           <span style="color: #000000; ">0</span>
           <span style="color: #000000; ">&nbsp;,receive:hello&nbsp;world<br />RTT:</span>
           <span style="color: #000000; ">0</span>
           <span style="color: #000000; ">&nbsp;,receive:hello&nbsp;world<br />RTT:</span>
           <span style="color: #000000; ">0</span>
           <span style="color: #000000; ">&nbsp;,receive:hello&nbsp;world<br />RTT:</span>
           <span style="color: #000000; ">1</span>
           <span style="color: #000000; ">&nbsp;,receive:hello&nbsp;world<br />RTT:</span>
           <span style="color: #000000; ">0</span>
           <span style="color: #000000; ">&nbsp;,receive:hello&nbsp;world<br />RTT:</span>
           <span style="color: #000000; ">0</span>
           <span style="color: #000000; ">&nbsp;,receive:hello&nbsp;world<br />RTT:</span>
           <span style="color: #000000; ">0</span>
           <span style="color: #000000; ">&nbsp;,receive:hello&nbsp;world<br />RTT:</span>
           <span style="color: #000000; ">0</span>
           <span style="color: #000000; ">&nbsp;,receive:hello&nbsp;world<br />RTT:</span>
           <span style="color: #000000; ">0</span>
           <span style="color: #000000; ">&nbsp;,receive:hello&nbsp;world<br /></span>
          </div>
          <br />&nbsp;&nbsp; 这时候就正常多了，大部分RTT时间都在1毫秒以下。果然禁用Nagle算法可以解决延迟问题。
          <br />&nbsp;&nbsp; 如果我们不禁用nagle算法，而将writeSplit设置为false，也就是将head和body一次写入，再次运行测试（记的将setTcpNoDelay这行删除）：
          <br />
          <div style="background-color: #eeeeee; font-size: 13px; border: 1px solid #cccccc; padding: 4px 5px 4px 4px; width: 98%;">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
           <span style="color: #000000; ">WriteSplit:</span>
           <span style="color: #0000FF; ">false</span>
           <span style="color: #000000; "><br />RTT:</span>
           <span style="color: #000000; ">7</span>
           <span style="color: #000000; ">&nbsp;,receive:hello&nbsp;world<br />RTT:</span>
           <span style="color: #000000; ">1</span>
           <span style="color: #000000; ">&nbsp;,receive:hello&nbsp;world<br />RTT:</span>
           <span style="color: #000000; ">0</span>
           <span style="color: #000000;">&nbsp;,receive:hello&nbsp;world<br />RTT:</span>
           <span style="color: #000000; ">0</span>
           <span style="color: #000000; ">&nbsp;,receive:hello&nbsp;world<br />RTT:</span>
           <span style="color: #000000; ">0</span>
           <span style="color: #000000; ">&nbsp;,receive:hello&nbsp;world<br />RTT:</span>
           <span style="color: #000000; ">0</span>
           <span style="color: #000000; ">&nbsp;,receive:hello&nbsp;world<br />RTT:</span>
           <span style="color: #000000; ">0</span>
           <span style="color: #000000; ">&nbsp;,receive:hello&nbsp;world<br />RTT:</span>
           <span style="color: #000000; ">0</span>
           <span style="color: #000000; ">&nbsp;,receive:hello&nbsp;world<br />RTT:</span>
           <span style="color: #000000; ">0</span>
           <span style="color: #000000; ">&nbsp;,receive:hello&nbsp;world<br />RTT:</span>
           <span style="color: #000000; ">0</span>
           <span style="color: #000000; ">&nbsp;,receive:hello&nbsp;world<br /></span>
          </div>
          <br />&nbsp;&nbsp; 结果跟禁用nagle算法的效果类似。既然这样，我们还有什么理由一定要禁用nagle算法呢？通过我在
          <a href="http://code.google.com/p/xmemcached/downloads/list">xmemcached</a>的压测中的测试，启用nagle算法在小数据的存取上甚至有一定的效率优势，memcached协议本身就是个连续的请求应答的模型。上面的测试如果在windows上跑，会发现RTT最大会在200ms以上，可见winsock的delayed ack超时是200ms。
          <br />
          <br />&nbsp;&nbsp; 最后一个问题，什么情况下才应该禁用nagle算法？当你的应用不是这种连续的请求――应答模型，而是需要实时地单向发送很多小数据的时候或者请求是有间隔的，则应该禁用nagle算法来提高响应性。一个最明显是例子是telnet应用，你总是希望敲入一行数据后能立即发送给服务器，然后马上看到应答，而不是说我要连续敲入很多命令或者等待200ms才能看到应答。
          <br />
          <br />&nbsp;&nbsp; 上面是我对nagle算法和delayed ack的理解和测试，有错误的地方请不吝赐教。
          <br />
          <br />&nbsp;&nbsp; 转载请注明出处：
          <a id="Editor_Edit_hlEntryLink" title="view: Nagle算法和Delayed ACK的一个测试" href="../archive/2011/06/30/353441.html" target="_blank">http://www.blogjava.net/killme2008/archive/2011/06/30/353441.html</a>
          <br />&nbsp;&nbsp; 
          <br />&nbsp;&nbsp;
         </div> 
         <p class="postfoot"> posted @ <a href="http://www.blogjava.net/killme2008/archive/2011/06/30/353441.html" title="permalink">2011-06-30 16:01</a> dennis 阅读(6797) | <a href="http://www.blogjava.net/killme2008/archive/2011/06/30/353441.html#FeedBack" title="comments, pingbacks, trackbacks">评论 (5)</a> |&nbsp;<a href="http://www.blogjava.net/killme2008/admin/EditPosts.aspx?postid=353441">编辑</a>&nbsp;<a href="http://www.blogjava.net/killme2008/AddToFavorite.aspx?id=353441">收藏</a> </p> 
        </div> 
        <div class="post" style="filter:progid:DXImageTransform.Microsoft.Shadow(color='Blue', Direction=135, Strength=32)"> 
         <div class="posthead"> 
          <h2 style="padding-top:4px; padding-bottom:4px;"><a id="ArchiveDay1_SingleDay_DayList_ctl53_TitleUrl" href="http://www.blogjava.net/killme2008/archive/2011/06/30/353422.html">Java NIO编程的技巧和陷阱</a></h2> 
         </div> 
         <div class="postbody">
          <br /> 去年做的分享，一直上传slideshare失败，今天又试了下，成功了。这个主题主要介绍Java NIO编程的技巧和陷阱，解读了一些NIO框架的源码，以及编写高性能NIO网络框架所需要注意的技巧和缺陷。关注这方面的朋友可以看一下。去年写了篇blog提供了pdf版本的下载，看
          <a href="http://www.blogjava.net/killme2008/archive/2010/11/22/338420.html">这里</a>。
          <br /> 
          <br /> 
          <div style="width:500px" id="__ss_8464155"> 
           <strong style="display:block;margin:12px 0 4px"><a href="http://www.slideshare.net/killme2008/nio-trick-and-trap-8464155" title="Nio trick and trap" target="_blank">Nio trick and trap</a></strong> 
           <iframe src="http://www.slideshare.net/slideshow/embed_code/8464155" marginwidth="0" marginheight="0" frameborder="0" height="450" scrolling="no" width="500"></iframe> 
           <div style="padding:5px 0 12px">
             View more 
            <a href="http://www.slideshare.net/" target="_blank">presentations</a> from 
            <a href="http://www.slideshare.net/killme2008" target="_blank">dennis zhuang</a> 
           </div> 
          </div>
         </div> 
         <p class="postfoot"> posted @ <a href="http://www.blogjava.net/killme2008/archive/2011/06/30/353422.html" title="permalink">2011-06-30 11:07</a> dennis 阅读(5612) | <a href="http://www.blogjava.net/killme2008/archive/2011/06/30/353422.html#FeedBack" title="comments, pingbacks, trackbacks">评论 (4)</a> |&nbsp;<a href="http://www.blogjava.net/killme2008/admin/EditPosts.aspx?postid=353422">编辑</a>&nbsp;<a href="http://www.blogjava.net/killme2008/AddToFavorite.aspx?id=353422">收藏</a> </p> 
        </div> 
        <div class="post" style="filter:progid:DXImageTransform.Microsoft.Shadow(color='Blue', Direction=135, Strength=32)"> 
         <div class="posthead"> 
          <h2 style="padding-top:4px; padding-bottom:4px;"><a id="ArchiveDay1_SingleDay_DayList_ctl54_TitleUrl" href="http://www.blogjava.net/killme2008/archive/2011/06/12/352120.html">xmemcached发布1.3.3版本――支持touch和GAT</a></h2> 
         </div> 
         <div class="postbody">
          &nbsp;&nbsp;&nbsp; 开源memcached的java客户端
          <a href="http://code.google.com/p/xmemcached/">xmemcached</a>发布1.3.3，主要改进如下：
          <br />
          <br />1、memcached 1.6添加了不少新特性，具体可以参考《what's new in memcached》(
          <a href="http://groups.google.com/group/memcached/browse_thread/thread/10253a6996735f2">1</a>) (
          <a href="http://groups.google.com/group/memcached/browse_thread/thread/4041bead80c8f14c">2</a>)这两个帖子。xmemcached将及时跟进这些新特性。1.3.3这个版本
          <strong>实现了二进制协议中新的两个命令touch和GAT</strong>（get and touch)。这两个功能可以说是千呼万唤始出来，终于可以不用get-set来重新设置数据的超时时间，利用touch或者GAT可以简单地更新数据的超时时间。1.3.3新增加四个方法：
          <br />
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
           <span style="color: #000000; ">&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000FF; ">public</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #0000FF; ">boolean</span>
           <span style="color: #000000; ">&nbsp;touch(</span>
           <span style="color: #0000FF; ">final</span>
           <span style="color: #000000; ">&nbsp;String&nbsp;key,&nbsp;</span>
           <span style="color: #0000FF; ">int</span>
           <span style="color: #000000; ">&nbsp;exp,&nbsp;</span>
           <span style="color: #0000FF; ">long</span>
           <span style="color: #000000; ">&nbsp;opTimeout)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000FF; ">throws</span>
           <span style="color: #000000;">&nbsp;TimeoutException,&nbsp;InterruptedException,&nbsp;MemcachedException;<br />&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000FF; ">public</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #0000FF; ">boolean</span>
           <span style="color: #000000; ">&nbsp;touch(</span>
           <span style="color: #0000FF; ">final</span>
           <span style="color: #000000; ">&nbsp;String&nbsp;key,&nbsp;</span>
           <span style="color: #0000FF; ">int</span>
           <span style="color: #000000; ">&nbsp;exp)&nbsp;</span>
           <span style="color: #0000FF; ">throws</span>
           <span style="color: #000000; ">&nbsp;TimeoutException,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;InterruptedException,&nbsp;MemcachedException;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000FF; ">public</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #000000; ">&lt;</span>
           <span style="color: #000000; ">T</span>
           <span style="color: #000000; ">&gt;</span>
           <span style="color: #000000; ">&nbsp;T&nbsp;getAndTouch(</span>
           <span style="color: #0000FF; ">final</span>
           <span style="color: #000000; ">&nbsp;String&nbsp;key,&nbsp;</span>
           <span style="color: #0000FF; ">int</span>
           <span style="color: #000000; ">&nbsp;newExp,&nbsp;</span>
           <span style="color: #0000FF; ">long</span>
           <span style="color: #000000; ">&nbsp;opTimeout)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000FF; ">throws</span>
           <span style="color: #000000; ">&nbsp;TimeoutException,&nbsp;InterruptedException,&nbsp;MemcachedException;<br />&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000FF; ">public</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #000000; ">&lt;</span>
           <span style="color: #000000; ">T</span>
           <span style="color: #000000; ">&gt;</span>
           <span style="color: #000000; ">&nbsp;T&nbsp;getAndTouch(</span>
           <span style="color: #0000FF; ">final</span>
           <span style="color: #000000; ">&nbsp;String&nbsp;key,&nbsp;</span>
           <span style="color: #0000FF; ">int</span>
           <span style="color: #000000; ">&nbsp;newExp)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000FF; ">throws</span>
           <span style="color: #000000;">&nbsp;TimeoutException,&nbsp;InterruptedException,&nbsp;MemcachedException;</span>
          </div>
          <br />其中touch用于设置数据新的超时时间，getAndTouch则是在获取数据的同时更新超时时间。例如用memcached存储session，可以在每次get的时候更新下数据的超时时间来保活。
          <strong>请注意，这四个方法仅在使用memcached 1.6并且使用二进制协议的时候有效</strong>。
          <br />
          <strong><br />2、setLoggingLevelVerbosity方法可以作用于二进制协议。</strong>
          <br />
          <strong><br />3、重构错误处理模块，使得异常信息更友好。</strong>
          <br />
          <br />
          <strong>4、将KeyIterator和getKeyIterator声明为deprecated，</strong>因为memached 1.6将移除stats cachedump协议，并且stats cachedump返回数据有大小限制，遍历功能不具实用性。
          <br />
          <br />
          <strong>5、修复Bug</strong>，包括
          <a title="Error getting memcached Detail Statistics" class="closed_ref" href="http://code.google.com/p/xmemcached/issues/detail?id=126">issue 126&nbsp;</a>,
          <a title="Unknow Response status:130" href="http://code.google.com/p/xmemcached/issues/detail?id=127">issue 127</a>,
          <a title="&quot;SERVER_ERROR out of memory storing object&quot; cause session disconnected" href="http://code.google.com/p/xmemcached/issues/detail?id=128">issue 128</a>,
          <a title="Memory leak after shutdown" href="http://code.google.com/p/xmemcached/issues/detail?id=129">issue 129</a>。
          <br />
          <br />下载地址：
          <a href="http://code.google.com/p/xmemcached/downloads/list">http://code.google.com/p/xmemcached/downloads/list</a>
          <br />源码：&nbsp; 
          <a href="https://github.com/killme2008/xmemcached">https://github.com/killme2008/xmemcached</a>
          <br />maven引用：
          <br />
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #0000FF; ">&lt;</span>
           <span style="color: #800000; ">dependency</span>
           <span style="color: #0000FF; ">&gt;</span>
           <span style="color: #000000; "><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000FF; ">&lt;</span>
           <span style="color: #800000; ">groupId</span>
           <span style="color: #0000FF; ">&gt;</span>
           <span style="color: #000000; ">com.googlecode.xmemcached</span>
           <span style="color: #0000FF; ">&lt;/</span>
           <span style="color: #800000; ">groupId</span>
           <span style="color: #0000FF; ">&gt;</span>
           <span style="color: #000000; "><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000FF; ">&lt;</span>
           <span style="color: #800000; ">artifactId</span>
           <span style="color: #0000FF; ">&gt;</span>
           <span style="color: #000000; ">xmemcached</span>
           <span style="color: #0000FF; ">&lt;/</span>
           <span style="color: #800000; ">artifactId</span>
           <span style="color: #0000FF; ">&gt;</span>
           <span style="color: #000000; "><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000FF; ">&lt;</span>
           <span style="color: #800000; ">version</span>
           <span style="color: #0000FF; ">&gt;</span>
           <span style="color: #000000; ">1.3.3</span>
           <span style="color: #0000FF; ">&lt;/</span>
           <span style="color: #800000; ">version</span>
           <span style="color: #0000FF; ">&gt;</span>
           <span style="color: #000000; "><br />&nbsp;</span>
           <span style="color: #0000FF; ">&lt;/</span>
           <span style="color: #800000; ">dependency</span>
           <span style="color: #0000FF; ">&gt;</span>
          </div>
         </div> 
         <p class="postfoot"> posted @ <a href="http://www.blogjava.net/killme2008/archive/2011/06/12/352120.html" title="permalink">2011-06-12 13:32</a> dennis 阅读(3751) | <a href="http://www.blogjava.net/killme2008/archive/2011/06/12/352120.html#FeedBack" title="comments, pingbacks, trackbacks">评论 (3)</a> |&nbsp;<a href="http://www.blogjava.net/killme2008/admin/EditPosts.aspx?postid=352120">编辑</a>&nbsp;<a href="http://www.blogjava.net/killme2008/AddToFavorite.aspx?id=352120">收藏</a> </p> 
        </div> 
        <div class="post" style="filter:progid:DXImageTransform.Microsoft.Shadow(color='Blue', Direction=135, Strength=32)"> 
         <div class="posthead"> 
          <h2 style="padding-top:4px; padding-bottom:4px;"><a id="ArchiveDay1_SingleDay_DayList_ctl55_TitleUrl" href="http://www.blogjava.net/killme2008/archive/2011/06/06/351793.html">Zookeeper的web管理应用</a></h2> 
         </div> 
         <div class="postbody">
          &nbsp; &nbsp; Update: 如果遇到在search不存在的path报段错误，这是node-zookeeper的一个bug，我暂时修复了下并提交了pull request，你可以暂时用我修改的node-zookeeper &nbsp;
          <a href="https://github.com/killme2008/node-zookeeper">https://github.com/killme2008/node-zookeeper<br /></a>
          <br />&nbsp;&nbsp;&nbsp; 我们已经开始在产品使用
          <a href="http://zookeeper.apache.org/">zookeeper</a>了，那么维护工具也必然需要，所谓兵马未动，粮草先行。请同事帮忙看过几个开源项目后，并没有特别让人满意的。
          <br />&nbsp;&nbsp;&nbsp; 我想要的功能比较简单。首先，希望能将zookeeper集群的数据展示为树形结构，跟zookeeper模型保持一致。可以逐步展开每层的节点，每次展开都是延迟加载从zk里取数据，这样不会对zk造成太大压力。其次，除了展示树形结构外，我还希望它能展示每个path的属性和数据，更进一步，如果数据是文本的，我希望它可编辑。当然，因为编辑功能是比较危险的行为，我还希望这个管理工具有个简单的授权验证机制。
          <br />
          <br />&nbsp;&nbsp;&nbsp; 最终，我自己写了这么个东西，取名为
          <a href="https://github.com/killme2008/node-zk-browser">node-zk-browser</a>，基于node.js的
          <a href="http://expressjs.com/">express.js</a>框架和
          <a href="https://github.com/yfinkelstein/node-zookeeper">node-zookeeper</a>客户端实现的。我将它放在了github上
          <br />
          <br />&nbsp;&nbsp;&nbsp;
          <a href="https://github.com/killme2008/node-zk-browser"> https://github.com/killme2008/node-zk-browser</a>
          <br />
          <br />&nbsp;&nbsp;&nbsp; 你可以自己搭建这个小app， npm几乎能帮你搞定大部分工作。界面不美观，实用为主，几张运行时截图
          <br />
          <br />
          <br />
          <img alt="" src="/images/blogjava_net/killme2008/zk1.png" height="494" width="531" />
          <br />
          <br />
          <img alt="" src="/images/blogjava_net/killme2008/zk2.png" height="579" width="618" />
          <br />
          <br />
          <br />
          <img alt="" src="/images/blogjava_net/killme2008/zk3.png" height="187" width="639" />
         </div> 
         <p class="postfoot"> posted @ <a href="http://www.blogjava.net/killme2008/archive/2011/06/06/351793.html" title="permalink">2011-06-06 01:13</a> dennis 阅读(10506) | <a href="http://www.blogjava.net/killme2008/archive/2011/06/06/351793.html#FeedBack" title="comments, pingbacks, trackbacks">评论 (3)</a> |&nbsp;<a href="http://www.blogjava.net/killme2008/admin/EditPosts.aspx?postid=351793">编辑</a>&nbsp;<a href="http://www.blogjava.net/killme2008/AddToFavorite.aspx?id=351793">收藏</a> </p> 
        </div> 
        <div class="post" style="filter:progid:DXImageTransform.Microsoft.Shadow(color='Blue', Direction=135, Strength=32)"> 
         <div class="posthead"> 
          <h2 style="padding-top:4px; padding-bottom:4px;"><a id="ArchiveDay1_SingleDay_DayList_ctl56_TitleUrl" href="http://www.blogjava.net/killme2008/archive/2011/06/04/351744.html">Node.js Undocumented(2)</a></h2> 
         </div> 
         <div class="postbody">
          <br />&nbsp;&nbsp;&nbsp; 
          <a href="http://www.blogjava.net/killme2008/archive/2011/05/31/351368.html">Node.js Undocumented(1)</a>
          <br />&nbsp;&nbsp;&nbsp; 
          <a href="http://www.blogjava.net/killme2008/archive/2011/06/04/351744.html">Node.js Undocumented(2)</a>
          <br />
          <br />&nbsp;&nbsp;&nbsp; 写这种系列blog，是为了监督自己，不然我估计我不会有动力写完。这一节，我将介绍下Buffer这个module。js本身对文本友好，但是处理二进制数据就不是特别方便，因此node.js提供了Buffer模块来帮助你处理二进制数据，毕竟node.js的定位在网络服务端，不能只对文本协议友好。
          <br />
          <br />&nbsp;&nbsp;&nbsp; Buffer模块本身其实没有多少未公开的方法，重要的方法都在文档里提到了，有两个方法稍微值的提下。
          <br />
          <br />&nbsp;&nbsp;
          <strong>&nbsp; Buffer.get(idx)</strong>
          <br />
          <br />&nbsp;&nbsp;&nbsp; 跟buffer[idx]是一样的，返回的是第idx个字节，返回的结果是数字，如果要转成字符，用String.fromCharCode(code)即可。
          <br />
          <br />&nbsp;&nbsp;&nbsp; 
          <strong>Buffer.inspect()</strong>
          <br />&nbsp;&nbsp;&nbsp; 返回Buffer的字符串表示，每个字节用十六进制表示，当你调用console.dir的时候打印的就是这个方法返回的结果。
          <br />
          <br />&nbsp;&nbsp;&nbsp; Buffer真正值的一提的是它的内部实现。Buffer在node.js内部的cpp代码对应的是SlowBuffer类（src/node_buffer.cc)，但是两者之间并不是一一对应。
          <strong>对于创建小于8K的Buffer，其实是从一个pool里slice出来，只有大于8K的Buffer才是每次都new一个SlowBuffer</strong>。查看源码（lib/buffer.js)：
          <span style="color: #000000;"><br /></span>
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
           <span style="color: #000000; ">Buffer.poolSize&nbsp;</span>
           <span style="color: #000000; ">=</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #000000; ">8</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #000000; ">*</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #000000; ">1024</span>
           <span style="color: #000000; ">;<br />&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000FF; ">if</span>
           <span style="color: #000000; ">&nbsp;(</span>
           <span style="color: #0000FF; ">this</span>
           <span style="color: #000000; ">.length&nbsp;</span>
           <span style="color: #000000; ">&gt;</span>
           <span style="color: #000000; ">&nbsp;Buffer.poolSize)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #008000; ">//</span>
           <span style="color: #008000; ">&nbsp;Big&nbsp;buffer,&nbsp;just&nbsp;alloc&nbsp;one.</span>
           <span style="color: #008000; "><br /></span>
           <span style="color: #000000; ">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000FF; ">this</span>
           <span style="color: #000000; ">.parent&nbsp;</span>
           <span style="color: #000000; ">=</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #0000FF; ">new</span>
           <span style="color: #000000; ">&nbsp;SlowBuffer(</span>
           <span style="color: #0000FF; ">this</span>
           <span style="color: #000000; ">.length);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000FF; ">this</span>
           <span style="color: #000000; ">.offset&nbsp;</span>
           <span style="color: #000000; ">=</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #000000; ">0</span>
           <span style="color: #000000; ">;<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;</span>
           <span style="color: #0000FF; ">else</span>
           <span style="color: #000000; ">&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #008000; ">//</span>
           <span style="color: #008000; ">&nbsp;Small&nbsp;buffer.</span>
           <span style="color: #008000; "><br /></span>
           <span style="color: #000000; ">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000FF; ">if</span>
           <span style="color: #000000; ">&nbsp;(</span>
           <span style="color: #000000; ">!</span>
           <span style="color: #000000; ">pool&nbsp;</span>
           <span style="color: #000000; ">||</span>
           <span style="color: #000000; ">&nbsp;pool.length&nbsp;</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">&nbsp;pool.used&nbsp;</span>
           <span style="color: #000000; ">&lt;</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #0000FF; ">this</span>
           <span style="color: #000000; ">.length)&nbsp;allocPool();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000FF; ">this</span>
           <span style="color: #000000; ">.parent&nbsp;</span>
           <span style="color: #000000; ">=</span>
           <span style="color: #000000; ">&nbsp;pool;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000FF; ">this</span>
           <span style="color: #000000; ">.offset&nbsp;</span>
           <span style="color: #000000; ">=</span>
           <span style="color: #000000; ">&nbsp;pool.used;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pool.used&nbsp;</span>
           <span style="color: #000000; ">+=</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #0000FF; ">this</span>
           <span style="color: #000000; ">.length;<br />&nbsp;&nbsp;&nbsp;&nbsp;}</span>
          </div>
          <span style="color: #000000; ">&nbsp; <br /></span>
          <br />&nbsp;&nbsp;&nbsp; 因此，我们可以修改Buffer.poolSize这个“静态”变量来改变池的大小
          <br />
          <br />&nbsp;&nbsp;&nbsp; 
          <strong>Buffer.poolSize</strong>
          <br />&nbsp;&nbsp;&nbsp; Buffer类创建的池大小，大于此值则每次new一个SlowBuffer，否则从池中slice返回一个Buffer，如果池剩余空间不够，则新创建一个SlowBuffer做为池。下面的例子打印这个值并修改成16K:
          <br />
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
           <span style="color: #000000; ">console.log(Buffer.poolSize);<br />Buffer.poolSize</span>
           <span style="color: #000000; ">=</span>
           <span style="color: #000000; ">16</span>
           <span style="color: #000000; ">*</span>
           <span style="color: #000000; ">1024</span>
           <span style="color: #000000; ">;</span>
          </div>
          <br />&nbsp;&nbsp; 
          <strong>SlowBuffer类</strong>
          <br />&nbsp;&nbsp; SlowBuffer类我们可以直接使用的，如果你不想使用Buffer类的话，SlowBuffer类有Buffer模块的所有方法实现，例子如下：
          <br />
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
           <span style="color: #0000FF; ">var</span>
           <span style="color: #000000; ">&nbsp;SlowBuffer</span>
           <span style="color: #000000; ">=</span>
           <span style="color: #000000; ">require('buffer').SlowBuffer<br /></span>
           <span style="color: #0000FF; ">var</span>
           <span style="color: #000000; ">&nbsp;buf</span>
           <span style="color: #000000; ">=</span>
           <span style="color: #0000FF; ">new</span>
           <span style="color: #000000; ">&nbsp;SlowBuffer(</span>
           <span style="color: #000000; ">1024</span>
           <span style="color: #000000; ">)<br />buf.write(</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">hello</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">,'utf</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">8</span>
           <span style="color: #000000; ">');<br />console.log(buf.toString('utf</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">8</span>
           <span style="color: #000000; ">',</span>
           <span style="color: #000000; ">0</span>
           <span style="color: #000000; ">,</span>
           <span style="color: #000000; ">5</span>
           <span style="color: #000000; ">));<br />console.log(buf[</span>
           <span style="color: #000000; ">0</span>
           <span style="color: #000000; ">]);<br /></span>
           <span style="color: #0000FF; ">var</span>
           <span style="color: #000000; ">&nbsp;sub</span>
           <span style="color: #000000; ">=</span>
           <span style="color: #000000; ">buf.slice(</span>
           <span style="color: #000000; ">1</span>
           <span style="color: #000000; ">,</span>
           <span style="color: #000000; ">3</span>
           <span style="color: #000000; ">);<br />console.log(sub.length);</span>
          </div>&nbsp;&nbsp;&nbsp; 
          <br />&nbsp;&nbsp;&nbsp; 请注意，SlowBuffer默认不是Global的，需要require buffer模块。
          <br />
          <br />&nbsp;&nbsp;&nbsp; 
          <strong>使用建议和性能测试</strong>
          <br />
          <br />&nbsp;&nbsp;&nbsp; Buffer的这个实现告诉我们，要使用好Buffer类还是有讲究的，每次创建小于8K的Buffer最好大小刚好能被8k整除，这样能充分利用空间；或者每次创建大于8K的Buffer，并充分重用。我们来看一个性能测试，分别循环1000万次创建16K,4096和4097大小的Buffer，看看耗时多少：
          <br />
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
           <span style="color: #0000FF; ">function</span>
           <span style="color: #000000; ">&nbsp;benchmark(size,repeats){<br />&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000FF; ">var</span>
           <span style="color: #000000; ">&nbsp;total</span>
           <span style="color: #000000; ">=</span>
           <span style="color: #000000; ">0</span>
           <span style="color: #000000; ">;<br />&nbsp;&nbsp;&nbsp;&nbsp;console.log(</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">create&nbsp;%d&nbsp;size&nbsp;buffer&nbsp;for&nbsp;%d&nbsp;times</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">,size,repeats);<br />&nbsp;&nbsp;&nbsp;&nbsp;console.time(</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">times</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">);<br />&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000FF; ">for</span>
           <span style="color: #000000; ">(</span>
           <span style="color: #0000FF; ">var</span>
           <span style="color: #000000; ">&nbsp;i</span>
           <span style="color: #000000; ">=</span>
           <span style="color: #000000; ">0</span>
           <span style="color: #000000; ">;i</span>
           <span style="color: #000000; ">&lt;</span>
           <span style="color: #000000; ">repeats;i</span>
           <span style="color: #000000; ">++</span>
           <span style="color: #000000; ">){<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;total</span>
           <span style="color: #000000; ">+=</span>
           <span style="color: #0000FF; ">new</span>
           <span style="color: #000000; ">&nbsp;Buffer(size).length;<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;console.timeEnd(</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">times</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">);<br />}<br /></span>
           <span style="color: #0000FF; ">var</span>
           <span style="color: #000000; ">&nbsp;repeats</span>
           <span style="color: #000000; ">=</span>
           <span style="color: #000000; ">10000000</span>
           <span style="color: #000000; ">;<br /><br />console.log(</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">warm&nbsp;up<img src="http://www.blogjava.net/Images/dot.gif" alt="" /></span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">)<br />benchmark(</span>
           <span style="color: #000000; ">1024</span>
           <span style="color: #000000; ">,repeats);<br />console.log(</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">start&nbsp;benchmark</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">)<br />benchmark(</span>
           <span style="color: #000000; ">16</span>
           <span style="color: #000000; ">*</span>
           <span style="color: #000000; ">1024</span>
           <span style="color: #000000; ">,repeats);<br />benchmark(</span>
           <span style="color: #000000; ">4096</span>
           <span style="color: #000000; ">,repeats);<br />benchmark(</span>
           <span style="color: #000000; ">4097</span>
           <span style="color: #000000; ">,repeats);<br /></span>
          </div>
          <br />&nbsp;&nbsp;&nbsp; 创建1024的Buffer是为了做warm up。在我机器上的输出：
          <br />&nbsp;&nbsp;&nbsp;&nbsp; 
          <br />
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
           <span style="color: #000000; ">start&nbsp;benchmark<br />create&nbsp;</span>
           <span style="color: #000000; ">16384</span>
           <span style="color: #000000; ">&nbsp;size&nbsp;buffer&nbsp;</span>
           <span style="color: #0000FF; ">for</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #000000; ">10000000</span>
           <span style="color: #000000; ">&nbsp;times<br />times:&nbsp;81973ms<br />create&nbsp;</span>
           <span style="color: #000000; ">4096</span>
           <span style="color: #000000; ">&nbsp;size&nbsp;buffer&nbsp;</span>
           <span style="color: #0000FF; ">for</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #000000; ">10000000</span>
           <span style="color: #000000; ">&nbsp;times<br />times:&nbsp;80452ms<br />create&nbsp;</span>
           <span style="color: #000000; ">4097</span>
           <span style="color: #000000; ">&nbsp;size&nbsp;buffer&nbsp;</span>
           <span style="color: #0000FF; ">for</span>
           <span style="color: #000000; ">&nbsp;</span>
           <span style="color: #000000; ">10000000</span>
           <span style="color: #000000; ">&nbsp;times<br />times:&nbsp;138364ms<br /><br /></span>
          </div>&nbsp;&nbsp; 
          <br />&nbsp;&nbsp;&nbsp; 创建4096和创建4097大小的Buffer，只差了一个字节，
          <strong>耗时却相差非常大</strong>，为什么会这样？读者可以自己根据上面的介绍分析下，有兴趣的可以留言。
          <br />&nbsp;&nbsp;&nbsp; 另外，可以看到创建16K和创建4K大小的Buffer，差距非常小，平均每秒钟都能创建10万个以上的Buffer，这个效率已经足以满足绝大多数网络应用的需求。
          <br />
         </div> 
         <p class="postfoot"> posted @ <a href="http://www.blogjava.net/killme2008/archive/2011/06/04/351744.html" title="permalink">2011-06-04 18:09</a> dennis 阅读(3382) | <a href="http://www.blogjava.net/killme2008/archive/2011/06/04/351744.html#FeedBack" title="comments, pingbacks, trackbacks">评论 (0)</a> |&nbsp;<a href="http://www.blogjava.net/killme2008/admin/EditPosts.aspx?postid=351744">编辑</a>&nbsp;<a href="http://www.blogjava.net/killme2008/AddToFavorite.aspx?id=351744">收藏</a> </p> 
        </div> 
        <div class="post" style="filter:progid:DXImageTransform.Microsoft.Shadow(color='Blue', Direction=135, Strength=32)"> 
         <div class="posthead"> 
          <h2 style="padding-top:4px; padding-bottom:4px;"><a id="ArchiveDay1_SingleDay_DayList_ctl57_TitleUrl" href="http://www.blogjava.net/killme2008/archive/2011/05/31/351447.html">node-leveldb的memcached adapter</a></h2> 
         </div> 
         <div class="postbody">
          &nbsp; &nbsp; 
          <a href="http://code.google.com/p/leveldb/">leveldb</a>是google最近开源的一个实现，但是它仅是个lib，还需要包装才能使用。
          <a href="https://github.com/creationix/node-leveldb">node-leveldb</a>就是一个用node.js包装leveldb的项目，你可以用javascript访问leveldb。
          <a href="https://github.com/creationix/node-leveldb">node-leveldb</a>仅提供API，不提供网络接口供外部访问。我fork了个分支，搞了个memcached的adapter，将node-leveldb的API暴露为memcached的文本协议，这样一来你可以直接用现有的memcached client甚至直接telnet上去进行测试。感兴趣的朋友可以测试下。adpater就一个文件
          <a href="https://github.com/killme2008/node-leveldb/blob/master/memcached-adapter/memcached.js">memcached.js</a>。
          <br />&nbsp; &nbsp;&nbsp;
          <br />&nbsp; &nbsp; fork的分支在：
          <br />&nbsp;&nbsp;&nbsp;&nbsp;
          <a href="https://github.com/killme2008/node-leveldb" title="https://github.com/killme2008/node-leveldb">https://github.com/killme2008/node-leveldb<br /><br /></a>&nbsp;&nbsp;&nbsp;&nbsp;编译node-leveldb之后，执行
          <br />
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
           <span style="color: #000000; ">node&nbsp;memcached</span>
           <span style="color: #000000; ">-</span>
           <span style="color: #000000; ">adpater</span>
           <span style="color: #000000; ">/</span>
           <span style="color: #000000; ">memcached.js</span>
          </div>
          <br />&nbsp; &nbsp; 即可启动memcached adapter在11211端口，你可以telnet上去测试。目前仅支持get/set/delete/quit协议，不支持flag和exptime。
          <br />
         </div> 
         <p class="postfoot"> posted @ <a href="http://www.blogjava.net/killme2008/archive/2011/05/31/351447.html" title="permalink">2011-05-31 16:45</a> dennis 阅读(3523) | <a href="http://www.blogjava.net/killme2008/archive/2011/05/31/351447.html#FeedBack" title="comments, pingbacks, trackbacks">评论 (1)</a> |&nbsp;<a href="http://www.blogjava.net/killme2008/admin/EditPosts.aspx?postid=351447">编辑</a>&nbsp;<a href="http://www.blogjava.net/killme2008/AddToFavorite.aspx?id=351447">收藏</a> </p> 
        </div> 
        <div class="post" style="filter:progid:DXImageTransform.Microsoft.Shadow(color='Blue', Direction=135, Strength=32)"> 
         <div class="posthead"> 
          <h2 style="padding-top:4px; padding-bottom:4px;"><a id="ArchiveDay1_SingleDay_DayList_ctl58_TitleUrl" href="http://www.blogjava.net/killme2008/archive/2011/05/31/351368.html">Node.js Undocumented(1)</a></h2> 
         </div> 
         <div class="postbody">
          <a href="http://nodejs.org/"><br />&nbsp;&nbsp;&nbsp; node.js</a>的API文档做的不是很好，有些部分干脆没文档，最终还是要看代码才能解决。我这里将记录下看源码过程中看到的一些API并补充一些测试例子。在玩
          <a href="http://nodejs.org/">node.js</a>的朋友可以瞧瞧。
          <br />
          <br />
          <br />&nbsp;&nbsp;&nbsp; 
          <strong>process.reallyExit(status)</strong>
          <br />
          <br />&nbsp;&nbsp;&nbsp; 用于进程主动退出，status设置退出的状态码。请注意，reallyExit退出的进程不会调用'exit'事件，下面的代码不会有任何输出：
          <br />
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
           <span style="color: #0000FF; ">var</span>
           <span style="color: #000000; ">&nbsp;interval</span>
           <span style="color: #000000; ">=</span>
           <span style="color: #000000; ">setInterval(</span>
           <span style="color: #0000FF; ">function</span>
           <span style="color: #000000; ">(){<br />&nbsp;&nbsp;&nbsp;&nbsp;process.reallyExit(</span>
           <span style="color: #000000; ">1</span>
           <span style="color: #000000; ">);<br />},</span>
           <span style="color: #000000; ">1000</span>
           <span style="color: #000000; ">);<br />process.on('exit',</span>
           <span style="color: #0000FF; ">function</span>
           <span style="color: #000000; ">(){<br />&nbsp;&nbsp;&nbsp;&nbsp;console.log(</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">hello</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">);<br />});</span>
          </div>
          <br />&nbsp;&nbsp; 
          <strong>process._kill(pid,sig)</strong>
          <br />
          <br />&nbsp;&nbsp; 用于给指定pid的进程发送指定信号（类似kill命令），这是个“private”方法，你需要慎重使用，下面的代码会杀死自身的进程：
          <br />
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
           <span style="color: #0000FF; ">var</span>
           <span style="color: #000000; ">&nbsp;pid</span>
           <span style="color: #000000; ">=</span>
           <span style="color: #000000; ">process.pid<br />process._kill(pid,</span>
           <span style="color: #000000; ">9</span>
           <span style="color: #000000; ">);</span>
          </div>
          <br />&nbsp;&nbsp; 
          <strong>process.binding(name)</strong>
          <br />
          <br />&nbsp;&nbsp; 非常有用的方法，很奇怪API文档里竟然没提到，这个方法用于返回指定名称的内置模块。例如下面的代码将打印node_net模块所有的可以调用的方法或变量（很多是文档没有提到的并且没有exports的，后续我会介绍下）：
          <br />
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
           <span style="color: #0000FF; ">var</span>
           <span style="color: #000000; "> binding</span>
           <span style="color: #000000; ">=</span>
           <span style="color: #000000; ">process.binding('net');<br />console.dir(binding);</span>
          </div>
          <strong><br />&nbsp;&nbsp; process.dlopen(filename,target)</strong>
          <br />&nbsp;&nbsp; 看源码注释说是用来动态加载node.module的动态链接库的，以后尝试写扩展的时候也许可以尝试一下。
          <br />
          <br />&nbsp;&nbsp; 
          <strong>定时器</strong>
          <br />&nbsp;&nbsp; Node.js的定时器模块的实现是有讲究的，对于超时时间after&lt;=0的callback，会在内部new一个Timer并start（本质是使用libev的timer机制）；但是对于after&gt;0的callback，却不是这样。因为在实际应用中，大多数定时器事件的超时时间都是一样的，如果每个事件都new一个Timer并start，代价太高。因此node.js采用了一个类似哈希表的方案，将相同after超时时间的定时器事件组织成链表，以after为key，以链表为value整体构成一张表。每个链表只new一个Timer,这个Timer负责整个链表的定时器事件，当某个事件超时调用后，利用ev_timer_again来高效地重新设置超时时间。
          <br />&nbsp;&nbsp; 如果你确实希望对于after&gt;0的定时器也每次new一个Timer来处理，那也可以做到，这就要用到前面提到的process.binding方法来获取timer模块,一个例子：
          <br />
          <div style="background-color:#eeeeee;font-size:13px;border:1px solid #CCCCCC;padding-right: 5px;padding-bottom: 4px;padding-left: 4px;padding-top: 4px;width: 98%;word-break:break-all">
           <!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />-->
           <span style="color: #0000FF; ">var</span>
           <span style="color: #000000; ">&nbsp;Timer&nbsp;</span>
           <span style="color: #000000; ">=</span>
           <span style="color: #000000; ">&nbsp;process.binding('timer').Timer;<br /><br /></span>
           <span style="color: #0000FF; ">var</span>
           <span style="color: #000000; ">&nbsp;timer</span>
           <span style="color: #000000; ">=</span>
           <span style="color: #0000FF; ">new</span>
           <span style="color: #000000; ">&nbsp;Timer();<br />timer.callback</span>
           <span style="color: #000000; ">=</span>
           <span style="color: #0000FF; ">function</span>
           <span style="color: #000000; ">(){<br />&nbsp;&nbsp;&nbsp;&nbsp;console.log(</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">callback&nbsp;called</span>
           <span style="color: #000000; ">&quot;</span>
           <span style="color: #000000; ">);<br />};<br />timer.start(</span>
           <span style="color: #000000; ">1000</span>
           <span style="color: #000000; ">,</span>
           <span style="color: #000000; ">0</span>
           <span style="color: #000000; ">);</span>
          </div>&nbsp;&nbsp; 
          <br />&nbsp;&nbsp;&nbsp; 
          <strong>timer.callback</strong>
          <br />&nbsp;&nbsp;&nbsp; 设定timer的回调函数，当超时的时候调用。
          <br />
          <br />&nbsp;&nbsp;&nbsp; 
          <strong>timer.start(after,repeat)</strong>
          <br />&nbsp;&nbsp;&nbsp; 启动定时器，在after毫秒之后调用超时回调；如果repeat==0，则自动停止定时器；如果repeat&gt;0，则在repeat毫秒之后再次调用callback，以repeat毫秒为间隔不断重复下去。
          <br />
          <br />&nbsp;&nbsp;&nbsp; ps.这篇blog刚好是我的第499篇blog，不出意外，第500篇还是继续介绍node.js。
          <br />&nbsp;&nbsp;&nbsp;
         </div> 
         <p class="postfoot"> posted @ <a href="http://www.blogjava.net/killme2008/archive/2011/05/31/351368.html" title="permalink">2011-05-31 00:33</a> dennis 阅读(3323) | <a href="http://www.blogjava.net/killme2008/archive/2011/05/31/351368.html#FeedBack" title="comments, pingbacks, trackbacks">评论 (7)</a> |&nbsp;<a href="http://www.blogjava.net/killme2008/admin/EditPosts.aspx?postid=351368">编辑</a>&nbsp;<a href="http://www.blogjava.net/killme2008/AddToFavorite.aspx?id=351368">收藏</a> </p> 
        </div> 
        <div class="post" style="filter:progid:DXImageTransform.Microsoft.Shadow(color='Blue', Direction=135, Strength=32)"> 
         <div class="posthead"> 
          <h2 style="padding-top:4px; padding-bottom:4px;"><a id="ArchiveDay1_SingleDay_DayList_ctl59_TitleUrl" href="http://www.blogjava.net/killme2008/archive/2011/05/22/350752.html">做基础产品的体会</a></h2> 
         </div> 
         <div class="postbody">
          <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 一个公司大了，总有部分人要去做一些通用的东西给大家用，我这里说的基础产品就是这类通用性质的东西，不一定高科技，但是一定很多人依赖你的东西来完成各种各样的功能。做这样的东西，有些体会可以说下。
          <br />
          <br />&nbsp;&nbsp;&nbsp; 首先，能集中存储的，就不要分布存储，数据集中存储有单点的危险，但是比之分布式存储带来的复杂度不可同日而语。况且集中式的存储也可以利用各种机制做备份，所谓单点风险远没有想象中那么大。
          <br />
          <br />&nbsp;&nbsp; 其次，能利用开源框架的，就不要重复造轮子。程序员都喜欢造轮子，但是造轮子的周期长，并且不一定造的更好。在强调开发效率的互联网时代，如果能直接利用现有框架组装出你想要的东西，迅速占领市场，比你造的高性能、高可用、高科技的轮子更实用。这个跟做新产品开发有点类似，迅速组装，高效开发，然后再想办法改进。
          <br />
          <br />&nbsp;&nbsp; 第三，要文本，不要二进制。协议要文本化，配置要文本化。不要担心性能，在可见的时间里，你基本不会因为文本化的问题遇到性能瓶颈。
          <br />
          <br />&nbsp;&nbsp; 第四，要透明，不要黑盒。基础产品尤其需要对用户透明，你的用户不是小白用户，他们也是程序员，而程序员天生对黑盒性质的东西充满厌恶，他们总想知道你的东西背后在做什么，这对于查找问题分析问题也很重要。怎么做到透明呢？设计，统计，监控，日志等等。
          <br />
          <br />&nbsp;&nbsp; 第五，要拥抱标准，不要另搞一套。已经有了久经考验的HTTP协议，你就不要再搞个STTP，有了AMQP协议，你就不要再搞个BMQP。被广泛认可的标准是一些业界的顶尖专家制定出来的，他们早就将你没有考虑到的问题都考虑进去了。你自己搞的那一套，随着时间推移你会发现跟业界标准越来越像，因为面对的问题是一样的。使用标准的额外好处是，你有一大堆可用的代码或者类库可以直接使用，特别是在面对跨语言的时候。
          <br />
          <br />&nbsp;&nbsp;&nbsp; 第六，能Share nothing，就不要搞状态复制。无状态的东西是最可爱的，天然的无副作用。水平扩展不要太容易。
          <br />
          <br />&nbsp;&nbsp;&nbsp; 第七，要将你的系统做的越不“重要”越好，如果太多的产品依赖你的系统，那么当你的系统故障的时候，整个应用就完蛋了。我们不要担这个责任，我们要将系统做的越来越“不重要”，别人万一没了你也能重启，也能一定时间内支撑正常的工作。
          <br />
          <br />&nbsp;&nbsp;&nbsp; 第八，要专注眼前，适当关注未来。有远见是好事，但是太多远见就容易好高骛远。为很小可能性设计的东西，没有机会经历实际检验，当故障真的发生的时候，你也不可能完全信赖它。更好的办法是将系统设计得可介入，可在紧急情况下人工去介入处理，可介入是不够的，还要容易介入。
          <br />
          <br />&nbsp;&nbsp;&nbsp; 第九，不要对用户有假设，假设你的用户都是smart programmer，假设你的用户不需要位运算，假设你的用户要同步不要异步。除非你对这个领域非常熟悉并实际使用过类似的东西，否则还是不要假设。
          <br />
          <br />&nbsp;&nbsp;&nbsp; 第十，咳咳，似乎没有第十了，一大早憋了这么篇无头无脑的Blog，大伙将就看看。
          <br />
          <br />
          <br />
          <br />
          <br />
          <br />
         </div> 
         <p class="postfoot"> posted @ <a href="http://www.blogjava.net/killme2008/archive/2011/05/22/350752.html" title="permalink">2011-05-22 10:30</a> dennis 阅读(5961) | <a href="http://www.blogjava.net/killme2008/archive/2011/05/22/350752.html#FeedBack" title="comments, pingbacks, trackbacks">评论 (6)</a> |&nbsp;<a href="http://www.blogjava.net/killme2008/admin/EditPosts.aspx?postid=350752">编辑</a>&nbsp;<a href="http://www.blogjava.net/killme2008/AddToFavorite.aspx?id=350752">收藏</a> </p> 
        </div> 
        <div class="post" style="filter:progid:DXImageTransform.Microsoft.Shadow(color='Blue', Direction=135, Strength=32)"> 
         <div class="posthead"> 
          <h2 style="padding-top:4px; padding-bottom:4px;"><a id="ArchiveDay1_SingleDay_DayList_ctl60_TitleUrl" href="http://www.blogjava.net/killme2008/archive/2011/05/07/349731.html">最近对kafka的移植工作</a></h2> 
         </div> 
         <div class="postbody">
          &nbsp;&nbsp;&nbsp; 
          <a href="http://sna-projects.com/kafka/">Kafka</a>这个linkedin开源的MQ，我在过去的
          <a href="http://www.blogjava.net/killme2008/archive/2011/01/20/343284.html">blog</a>简单介绍过。最近3周来，我的工作就是做它的一个Java移植版本，kafka是用scala写的，基于维护和定制的角度，这个拷贝的版本还是用Java。说拷贝，也不尽然，原理相同，但实现完全换过，从数据结构到通讯框架、通讯协议、程序组织，乃至一些重要功能点上都做了改进和更新。我将这个Java版本取名为metamorphosis,也就是卡夫卡的代表作《变形记》的英文名。
          <br /> 
          <br /> &nbsp;&nbsp;&nbsp; 在原版本上，目前做了如下改进：
          <br /> 1、协议替换为文本协议，整个协议类似memcached，文本协议的优点自不必说。通讯框架也是采用内部使用的通讯框架，减少工作量。
          <br /> 
          <br /> 2、存储结构上也采用自定义结构，更简洁紧凑。
          <br /> 
          <br /> 3、kafka原来只支持consumer和broker之间的服务查找和负载均衡，meta加入了producer和broker之间的服务查找和负载均衡。
          <br /> 
          <br /> 4、Consumer API没有采用kafka的stream方式，而是同时实现同步获取和异步订阅两种方式，更接近JMS和Notify。
          <br /> 
          <br /> 5、改进了服务器端文件recover的性能，采用并发多线程recover的方式（可选）。
          <br /> 
          <br /> 6、添加了实时统计功能和协议，类似memcached的stats协议,响应透明号召。
          <br /> 
          <br /> 7、客户端的连接复用。
          <br /> &nbsp;&nbsp;&nbsp; 
          <br /> &nbsp;&nbsp;&nbsp; 以后要做的事情，可能包括：
          <br /> 1、实现类似Mysql的master/slave方案，可能还要分为同步和异步两种模式。
          <br /> 
          <br /> 2、分区扩展时候的数据自动迁移功能，做到无痛水平扩展。
          <br /> 
          <br /> 3、高可用方案的另一个实现。
          <br /> 
          <br /> 4、嵌入Http server做web管理。
          <br /> &nbsp;&nbsp; 
          <br /> &nbsp;&nbsp;&nbsp; 工作在本周初步告一段落，接下来是要做集成测试和压测等，我在两台8核16G的机器上分别部署服务器和客户端（订阅者发布者同在一台），做的一个简单压测数据如下：并发100个线程发送5000万消息并同时消费，1K大小的消息TPS可以达到3.8万，4K大小的消息TPS可以达到1.8万，服务器load都维持在一个较低的水平。从这个数据来看，超过我一开始的预期。后续可能做下kakfa的测试对比下。
          <br /> 
          <br /> 
          <br />
         </div> 
         <p class="postfoot"> posted @ <a href="http://www.blogjava.net/killme2008/archive/2011/05/07/349731.html" title="permalink">2011-05-07 10:46</a> dennis 阅读(5270) | <a href="http://www.blogjava.net/killme2008/archive/2011/05/07/349731.html#FeedBack" title="comments, pingbacks, trackbacks">评论 (6)</a> |&nbsp;<a href="http://www.blogjava.net/killme2008/admin/EditPosts.aspx?postid=349731">编辑</a>&nbsp;<a href="http://www.blogjava.net/killme2008/AddToFavorite.aspx?id=349731">收藏</a> </p> 
        </div> 
        <div class="post" style="filter:progid:DXImageTransform.Microsoft.Shadow(color='Blue', Direction=135, Strength=32)"> 
         <div class="posthead"> 
          <h2 style="padding-top:4px; padding-bottom:4px;"><a id="ArchiveDay1_SingleDay_DayList_ctl61_TitleUrl" href="http://www.blogjava.net/killme2008/archive/2011/04/30/349303.html">Push or pull?</a></h2> 
         </div> 
         <div class="postbody">
          &nbsp;&nbsp; &nbsp;无论是消息系统，还是配置管理中心，甚至存储系统，你都要面临这样一个选择，push模型 or pull模型?是服务端主动给客户端推送数据，还是客户端去服务器拉数据，一张图表对比如下：
          <br /> &nbsp; 
          <table style="width: 804px; height: 563px" border="2" cellspacing="2" cellpadding="2" width="804"> 
           <tbody> 
            <tr> 
             <td></td> 
             <td>push模型</td> 
             <td>pull模型</td> 
            </tr> 
            <tr> 
             <td>描述</td> 
             <td>服务端主动发送数据给客户端</td> 
             <td>客户端主动从服务端拉取数据，通常客户端会定时拉取</td> 
            </tr> 
            <tr> 
             <td>实时性</td> 
             <td>较好，收到数据后可立即发送给客户端</td> 
             <td>一般，取决于pull的间隔时间</td> 
            </tr> 
            <tr> 
             <td>服务端状态</td> 
             <td>需要保存push状态，哪些客户端已经发送成功，哪些发送失败</td> 
             <td>服务端无状态</td> 
            </tr> 
            <tr> 
             <td>&nbsp;客户端状态</td> 
             <td>&nbsp;无需额外保存状态</td> 
             <td>需保存当前拉取的信息的状态，以便在故障或者重启的时候恢复</td> 
            </tr> 
            <tr> 
             <td>状态保存</td> 
             <td>集中式，集中在服务端</td> 
             <td>分布式，分散在各个客户端</td> 
            </tr> 
            <tr> 
             <td>负载均衡</td> 
             <td>服务端统一处理和控制</td> 
             <td>客户端之间做分配，需要协调机制，如使用zookeeper</td> 
            </tr> 
            <tr> 
             <td>其他</td> 
             <td> <p>服务端需要做流量控制，无法最大化客户端的处理能力。</p> <p>其次，在客户端故障情况下，无效的push对服务端有一定负载。</p> </td> 
             <td>客户端的请求可能很多无效或者没有数据可供传输，浪费带宽和服务器处理能力</td> 
            </tr> 
            <tr> 
             <td>缺点方案</td> 
             <td>服务器端的状态存储是个难点，可以将这些状态转移到DB或者key-value存储，来减轻server压力。</td> 
             <td> <p>针对实时性的问题，可以将push加入进来，push小数据的通知信息，让客户端再来主动pull。</p> <p>针对无效请求的问题，可以设置逐渐延长间隔时间的策略，以及合理设计协议尽量缩小请求数据包来节省带宽。</p> </td> 
            </tr> 
           </tbody> 
          </table> 
          <br /> 
          <br /> 在面对大量甚至海量客户端的时候，使用push模型，保存大量的状态信息是个沉重的负担，加上复制N份数据分发的压力，也会使得实时性这唯一的优点也被放小。使用pull模型，通过将客户端状态保存在客户端，大大减轻了服务器端压力，通过客户端自身做流量控制也更容易，更能发挥客户端的处理能力，但是需要面对如何在这些客户端之间做协调的难题。
         </div> 
         <p class="postfoot"> posted @ <a href="http://www.blogjava.net/killme2008/archive/2011/04/30/349303.html" title="permalink">2011-04-30 01:06</a> dennis 阅读(4229) | <a href="http://www.blogjava.net/killme2008/archive/2011/04/30/349303.html#FeedBack" title="comments, pingbacks, trackbacks">评论 (1)</a> |&nbsp;<a href="http://www.blogjava.net/killme2008/admin/EditPosts.aspx?postid=349303">编辑</a>&nbsp;<a href="http://www.blogjava.net/killme2008/AddToFavorite.aspx?id=349303">收藏</a> </p> 
        </div> 
        <div class="post" style="filter:progid:DXImageTransform.Microsoft.Shadow(color='Blue', Direction=135, Strength=32)"> 
         <div class="posthead"> 
          <h2 style="padding-top:4px; padding-bottom:4px;"><a id="ArchiveDay1_SingleDay_DayList_ctl62_TitleUrl" href="http://www.blogjava.net/killme2008/archive/2011/03/29/347160.html">HandlerSocket client for java――hs4j正式发布0.1版本</a></h2> 
         </div> 
         <div class="postbody">
          <br /> 
          <br /> &nbsp;&nbsp;&nbsp; 
          <a href="https://github.com/ahiguti/HandlerSocket-Plugin-for-MySQL">HandlerSocket</a>是一个mysql插件，可以将mysql作为NoSQL来使用，具体可以看我过去写的
          <a href="http://www.blogjava.net/killme2008/default.html?page=2">这篇Blog</a>。
          <a href="http://code.google.com/p/hs4j/">hs4j</a>是HandlerSocket的一个java客户端，自认为它比日本人写的那个客户端更实用和易用一些。写完好久，经过不少朋友使用和测试，现在正式发一个0.1版本，并已同步到maven中心仓库。
          <br /> 
          <br /> &nbsp;&nbsp;&nbsp; 项目主页：
          <a title="http://code.google.com/p/hs4j/" href="http://code.google.com/p/hs4j/">http://code.google.com/p/hs4j/</a>
          <br /> &nbsp;&nbsp;&nbsp; 项目描述：hs4j is a practical java client for 
          <a href="https://github.com/ahiguti/HandlerSocket-Plugin-for-MySQL" rel="nofollow">HandlerSocket</a>,it is nio based and turned to get better performance. 
          <br /> &nbsp;&nbsp;&nbsp; 使用文档：
          <a href="http://code.google.com/p/hs4j/w/list">http://code.google.com/p/hs4j/w/list</a>
          <br /> &nbsp;&nbsp;&nbsp; 下载地址：
          <a title="http://code.google.com/p/hs4j/downloads/list" href="http://code.google.com/p/hs4j/downloads/list">http://code.google.com/p/hs4j/downloads/list</a>
          <br /> &nbsp;&nbsp;&nbsp; 源码仓库：
          <a href="https://github.com/killme2008/hs4j" rel="nofollow">https://github.com/killme2008/hs4j</a>
          <br /> 
          <br /> &nbsp;&nbsp;&nbsp;&nbsp; 如果你使用maven2，可以直接引用：
          <br /> 
          <div style="background-color: rgb(238, 238, 238); font-size: 13px; border: 1px solid rgb(204, 204, 204); padding: 4px 5px 4px 4px; width: 98%;">
           <!--<br />
<br />
Code highlighting produced by Actipro CodeHighlighter (freeware)<br />
http://www.CodeHighlighter.com/<br />
<br />
-->
           <span style="color: rgb(0, 0, 255);">&lt;</span>
           <span style="color: rgb(128, 0, 0);">dependency</span>
           <span style="color: rgb(0, 0, 255);">&gt;</span>
           <span style="color: rgb(0, 0, 0);"><br /> &nbsp;&nbsp;</span>
           <span style="color: rgb(0, 0, 255);">&lt;</span>
           <span style="color: rgb(128, 0, 0);">groupId</span>
           <span style="color: rgb(0, 0, 255);">&gt;</span>
           <span style="color: rgb(0, 0, 0);">com.googlecode.hs4j</span>
           <span style="color: rgb(0, 0, 255);">&lt;/</span>
           <span style="color: rgb(128, 0, 0);">groupId</span>
           <span style="color: rgb(0, 0, 255);">&gt;</span>
           <span style="color: rgb(0, 0, 0);"><br /> &nbsp;&nbsp;</span>
           <span style="color: rgb(0, 0, 255);">&lt;</span>
           <span style="color: rgb(128, 0, 0);">artifactId</span>
           <span style="color: rgb(0, 0, 255);">&gt;</span>
           <span style="color: rgb(0, 0, 0);">hs4j</span>
           <span style="color: rgb(0, 0, 255);">&lt;/</span>
           <span style="color: rgb(128, 0, 0);">artifactId</span>
           <span style="color: rgb(0, 0, 255);">&gt;</span>
           <span style="color: rgb(0, 0, 0);"><br /> &nbsp;&nbsp;</span>
           <span style="color: rgb(0, 0, 255);">&lt;</span>
           <span style="color: rgb(128, 0, 0);">version</span>
           <span style="color: rgb(0, 0, 255);">&gt;</span>
           <span style="color: rgb(0, 0, 0);">0.1</span>
           <span style="color: rgb(0, 0, 255);">&lt;/</span>
           <span style="color: rgb(128, 0, 0);">version</span>
           <span style="color: rgb(0, 0, 255);">&gt;</span>
           <span style="color: rgb(0, 0, 0);"><br /> </span>
           <span style="color: rgb(0, 0, 255);">&lt;/</span>
           <span style="color: rgb(128, 0, 0);">dependency</span>
           <span style="color: rgb(0, 0, 255);">&gt;</span>
          </div> 
          <br /> &nbsp;&nbsp;&nbsp;&nbsp; 有疑问和bug请联系我。
          <br />
         </div> 
         <p class="postfoot"> posted @ <a href="http://www.blogjava.net/killme2008/archive/2011/03/29/347160.html" title="permalink">2011-03-29 06:55</a> dennis 阅读(3451) | <a href="http://www.blogjava.net/killme2008/archive/2011/03/29/347160.html#FeedBack" title="comments, pingbacks, trackbacks">评论 (3)</a> |&nbsp;<a href="http://www.blogjava.net/killme2008/admin/EditPosts.aspx?postid=347160">编辑</a>&nbsp;<a href="http://www.blogjava.net/killme2008/AddToFavorite.aspx?id=347160">收藏</a> </p> 
        </div> 
        <div class="post" style="filter:progid:DXImageTransform.Microsoft.Shadow(color='Blue', Direction=135, Strength=32)"> 
         <div class="posthead"> 
          <h2 style="padding-top:4px; padding-bottom:4px;"><a id="ArchiveDay1_SingleDay_DayList_ctl63_TitleUrl" href="http://www.blogjava.net/killme2008/archive/2011/03/27/347102.html">xmemcached发布1.3.2版本</a></h2> 
         </div> 
         <div class="postbody">
          <p><a href="http://code.google.com/p/xmemcached">&nbsp;&nbsp;&nbsp;&nbsp; Xmemcached</a>是一个开源的java memcached client，具有高性能、更易用、功能完善等优点，距离上次发布1.3.1已经超过两个月，现在正式发布1.3.2这个新版本，主要的改进如下：</p> 
          <br /> 
          <strong>1、Bug修复</strong>，从1.3.1版本以来发现的bug并修复，包括： 
          <p><a href="http://code.google.com/p/xmemcached/issues/detail?id=112">issue 112</a>:: 新引入的failure模式在启动的时候，如果memcached故障，运行不符合预期的bug.</p> 
          <p><a href="http://code.google.com/p/xmemcached/issues/detail?id=113">issue 113</a>: 新增加一个delete方法，可以设置操作超时</p> 
          <div style="background-color: #eeeeee; font-size: 13px; border: 1px solid #cccccc; padding: 4px 5px 4px 4px; width: 98%;">
           <!--<br />
<br />
Code highlighting produced by Actipro CodeHighlighter (freeware)<br />
http://www.CodeHighlighter.com/<br />
<br />
-->
           <span style="color: #0000ff;">public</span>
           <span style="color: #000000;">&nbsp;</span>
           <span style="color: #0000ff;">boolean</span>
           <span style="color: #000000;">&nbsp;delete(</span>
           <span style="color: #0000ff;">final</span>
           <span style="color: #000000;">&nbsp;String&nbsp;key,&nbsp;</span>
           <span style="color: #0000ff;">long</span>
           <span style="color: #000000;">&nbsp;opTimeout)<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000ff;">throws</span>
           <span style="color: #000000;">&nbsp;TimeoutException,&nbsp;InterruptedException,&nbsp;MemcachedException;<br /> <br /> </span>
          </div> 
          <p><strong>2、性能调优</strong>，存储操作(set/add/replace/prepend/append/cas)的性能提升5%。</p> 
          <p><strong>3、修复pom.xml</strong>，使得xmemcached可以在其他机器上编译。</p> 
          <p><strong>4、使用github作为源码仓库</strong>，版本管理使用git替换svn，源码转移到</p> 
          <p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <a href="https://github.com/killme2008/xmemcached">https://github.com/killme2008/xmemcached</a></p> 
          <p>新版本下载地址：</p> 
          <a href="http://code.google.com/p/xmemcached/downloads/list">&nbsp;&nbsp;&nbsp; http://code.google.com/p/xmemcached/downloads/list</a> 
          <p>使用maven可以直接引用：&nbsp; </p> 
          <span style="color: #0000ff;">&lt;</span>
          <span style="color: #800000;">dependency</span>
          <span style="color: #0000ff;">&gt;</span>
          <br /> 
          <div style="background-color: #eeeeee; font-size: 13px; border: 1px solid #cccccc; padding: 4px 5px 4px 4px; width: 98%;">
           <span style="color: #000000;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000ff;">&lt;</span>
           <span style="color: #800000;">groupId</span>
           <span style="color: #0000ff;">&gt;</span>
           <span style="color: #000000;">com.googlecode.xmemcached</span>
           <span style="color: #0000ff;">&lt;/</span>
           <span style="color: #800000;">groupId</span>
           <span style="color: #0000ff;">&gt;</span>
           <span style="color: #000000;"><br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000ff;">&lt;</span>
           <span style="color: #800000;">artifactId</span>
           <span style="color: #0000ff;">&gt;</span>
           <span style="color: #000000;">xmemcached</span>
           <span style="color: #0000ff;">&lt;/</span>
           <span style="color: #800000;">artifactId</span>
           <span style="color: #0000ff;">&gt;</span>
           <span style="color: #000000;"><br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000ff;">&lt;</span>
           <span style="color: #800000;">version</span>
           <span style="color: #0000ff;">&gt;</span>
           <span style="color: #000000;">1.3.2</span>
           <span style="color: #0000ff;">&lt;/</span>
           <span style="color: #800000;">version</span>
           <span style="color: #0000ff;">&gt;</span>
           <span style="color: #000000;"><br /> &nbsp;</span>
           <span style="color: #0000ff;">&lt;/</span>
           <span style="color: #800000;">dependency</span>
           <span style="color: #0000ff;">&gt;</span>
           <span style="color: #000000;"><br /> <br /> </span>
          </div> 
          <p>项目文档：</p> 
          <p><a href="http://code.google.com/p/xmemcached/w/list">http://code.google.com/p/xmemcached/w/list</a></p>
         </div> 
         <p class="postfoot"> posted @ <a href="http://www.blogjava.net/killme2008/archive/2011/03/27/347102.html" title="permalink">2011-03-27 14:06</a> dennis 阅读(2916) | <a href="http://www.blogjava.net/killme2008/archive/2011/03/27/347102.html#FeedBack" title="comments, pingbacks, trackbacks">评论 (1)</a> |&nbsp;<a href="http://www.blogjava.net/killme2008/admin/EditPosts.aspx?postid=347102">编辑</a>&nbsp;<a href="http://www.blogjava.net/killme2008/AddToFavorite.aspx?id=347102">收藏</a> </p> 
        </div> 
        <div class="post" style="filter:progid:DXImageTransform.Microsoft.Shadow(color='Blue', Direction=135, Strength=32)"> 
         <div class="posthead"> 
          <h2 style="padding-top:4px; padding-bottom:4px;"><a id="ArchiveDay1_SingleDay_DayList_ctl64_TitleUrl" href="http://www.blogjava.net/killme2008/archive/2011/01/28/343727.html">CN-Clojure群组建立</a></h2> 
         </div> 
         <div class="postbody">
          <br /> &nbsp;&nbsp;&nbsp; 在国内，
          <a href="http://clojure.org/">Clojure</a>语言的用户估计是小众中的小众，没有多少人听说，也没有多少人使用，资料也大多数是英文的，讨论也只能上国外论坛。因此，我想建立一个CN-Clojure的google group，供大家交流和学习clojure语言。群组地址（需要翻墙）：
          <a href="http://groups.google.com/group/cn-clojure">http://groups.google.com/group/cn-clojure</a>
          <br /> 
          <br /> &nbsp;&nbsp; 现在没人，就我一个
          <img src="/CuteSoft_Client/CuteEditor/images/emteeth.gif" alt="" align="absmiddle" border="0" />。我也会在群组里放些学习资料，欢迎任何对clojure感兴趣的朋友加入。
          <br /> 
          <br />
         </div> 
         <p class="postfoot"> posted @ <a href="http://www.blogjava.net/killme2008/archive/2011/01/28/343727.html" title="permalink">2011-01-28 19:39</a> dennis 阅读(3444) | <a href="http://www.blogjava.net/killme2008/archive/2011/01/28/343727.html#FeedBack" title="comments, pingbacks, trackbacks">评论 (5)</a> |&nbsp;<a href="http://www.blogjava.net/killme2008/admin/EditPosts.aspx?postid=343727">编辑</a>&nbsp;<a href="http://www.blogjava.net/killme2008/AddToFavorite.aspx?id=343727">收藏</a> </p> 
        </div> 
        <div class="post" style="filter:progid:DXImageTransform.Microsoft.Shadow(color='Blue', Direction=135, Strength=32)"> 
         <div class="posthead"> 
          <h2 style="padding-top:4px; padding-bottom:4px;"><a id="ArchiveDay1_SingleDay_DayList_ctl65_TitleUrl" href="http://www.blogjava.net/killme2008/archive/2011/01/24/343423.html">Scheme interpreter in clojure</a></h2> 
         </div> 
         <div class="postbody">
          &nbsp;&nbsp;&nbsp;&nbsp; 昨天晚上用clojure搞了个scheme解释器，基本上是sicp里的解释器的clojure翻译版本，可能唯一值的一提的是对transient集合的使用，实现副作用的set!。总共代码包含注释才366行，支持的feature包括
          <br /> 
          <br /> 
          <table class="wiki-content-table" border="2" bordercolor="" cellpadding="" cellspacing=""> 
           <tbody> 
            <tr> 
             <th>Feature</th> 
             <th>Supported</th> 
             <th>Comment</th> 
            </tr> 
            <tr> 
             <td>define</td> 
             <td>yes</td> 
             <td><br /> </td> 
            </tr> 
            <tr> 
             <td>lambda</td> 
             <td>yes</td> 
             <td><br /> </td> 
            </tr> 
            <tr> 
             <td>variable lookup</td> 
             <td>yes</td> 
             <td><br /> </td> 
            </tr> 
            <tr> 
             <td>primitive procedure evaluation</td> 
             <td>yes</td> 
             <td><br /> </td> 
            </tr> 
            <tr> 
             <td>compound procedure evaluation</td> 
             <td>yes</td> 
             <td>no tail recursion yet</td> 
            </tr> 
            <tr> 
             <td>if</td> 
             <td>yes</td> 
             <td><br /> </td> 
            </tr> 
            <tr> 
             <td>cond</td> 
             <td>yes</td> 
             <td><br /> </td> 
            </tr> 
            <tr> 
             <td>let</td> 
             <td>yes<br /> </td> 
             <td><br /> </td> 
            </tr> 
            <tr> 
             <td>let*</td> 
             <td>yes<br /> </td> 
             <td>no named let* yet<br /> </td> 
            </tr> 
            <tr> 
             <td>letrec</td> 
             <td>no</td> 
             <td><br /> </td> 
            </tr> 
            <tr> 
             <td>begin</td> 
             <td>yes<br /> </td> 
             <td><br /> </td> 
            </tr> 
            <tr> 
             <td>set!</td> 
             <td>yes<br /> </td> 
             <td><br /> </td> 
            </tr> 
            <tr> 
             <td>quote</td> 
             <td>yes</td> 
             <td><br /> </td> 
            </tr> 
            <tr> 
             <td>quasiquote</td> 
             <td>no</td> 
             <td><br /> </td> 
            </tr> 
            <tr> 
             <td>unquote</td> 
             <td>no</td> 
             <td><br /> </td> 
            </tr> 
            <tr> 
             <td>delay</td> 
             <td>no</td> 
             <td><br /> </td> 
            </tr> 
            <tr> 
             <td>define-syntax</td> 
             <td>no</td> 
             <td><br /> </td> 
            </tr> 
           </tbody> 
          </table> 
          <br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 支持的primitive procedure包括常见的四则运算、car/cdr、list以及display、newline等。代码放在了github上：
          <a href="https://github.com/killme2008/cscheme">https://github.com/killme2008/cscheme</a>,有兴趣的可以玩玩吧。
          <br />
         </div> 
         <p class="postfoot"> posted @ <a href="http://www.blogjava.net/killme2008/archive/2011/01/24/343423.html" title="permalink">2011-01-24 10:42</a> dennis 阅读(3569) | <a href="http://www.blogjava.net/killme2008/archive/2011/01/24/343423.html#FeedBack" title="comments, pingbacks, trackbacks">评论 (0)</a> |&nbsp;<a href="http://www.blogjava.net/killme2008/admin/EditPosts.aspx?postid=343423">编辑</a>&nbsp;<a href="http://www.blogjava.net/killme2008/AddToFavorite.aspx?id=343423">收藏</a> </p> 
        </div> 
        <div class="post" style="filter:progid:DXImageTransform.Microsoft.Shadow(color='Blue', Direction=135, Strength=32)"> 
         <div class="posthead"> 
          <h2 style="padding-top:4px; padding-bottom:4px;"><a id="ArchiveDay1_SingleDay_DayList_ctl66_TitleUrl" href="http://www.blogjava.net/killme2008/archive/2011/01/20/343284.html">最近关注过的一些项目</a></h2> 
         </div> 
         <div class="postbody">
          <br /> &nbsp;&nbsp;&nbsp; 最近因为空闲时间有一些，所以去看了不少开源项目，大部分东西如果看过不记录下来，其实还是相当于没看，所以想想还是有必要摘要记录一下。
          <br /> 
          <br /> &nbsp;&nbsp;&nbsp; 首先是去了解了
          <a href="http://hadoop.apache.org/zookeeper/">zookeeper</a>这个项目，基于paxos算法的分布式服务组件，同事对此有非常深入的研究和介绍，具体可以看我们的
          <a href="http://rdc.taobao.com/team/jm/archives/category/rpc-soa">团队Blog</a>。令我感慨的是这么一个非常难以理解的算法，却用一个简单的树状目录模型表达出来，并且在这个模型的基础上衍生出种种应用：集群感知、分布式锁、分布式队列、分布式并发原语等等，具体可以看文档给出的
          <a href="http://hadoop.apache.org/zookeeper/docs/r3.3.2/recipes.html">recipes</a>。在实现这些应用的时候，突出强调的是避免网络风暴，例如分布式锁的实现，竞争创建子节点，节点序列号最小的获取锁，其他节点等待，但是等待在什么条件上是有讲究的，如果所有节点都等待最小节点的删除事件，那么当最小节点释放锁的时候，就需要广播消息给所有其他等待的节点；换一个思路，如果每个等待节点只是等待比它序列号小的节点上，那么就可以避免这种广播风暴，变成一个顺序唤醒的过程。因此尽管有了zookeeper帮助实现分布式这些服务，但是要实现好仍然有一定难度，具体可以参考官方例子。我本来萌生了基于zookeeper实现一套封装好的类似j.u.c的服务框架，后来在邮件列表发现已经有人搞了这么一个基础类库放在github上:
          <a href="https://github.com/openUtility/menagerie">https://github.com/openUtility/menagerie</a> 。不过我没有继续深入了，有兴趣的朋友可以瞧瞧。
          <br /> 
          <br /> &nbsp;&nbsp;&nbsp; 然后又去看了我们淘宝开源的
          <a title="TimeTunnel" href="http://code.taobao.org/project/view/411/">TimeTunnel</a>。TimeTunnel你可以理解成一个消息中间件，它整个设计跟我们的产品相当接近，但是两者的目的完全不同，tt强调的是高吞吐量，而notify强调的则是可靠性。TT的通讯层直接采用Facebook的thrift，并且利用zookeeper做集群管理和路由。TT的代码质量很好，有兴趣可以拉出来看一下，并且对zookeeper的应用也是一个典型的案例。TT在高可用性上的方案也很有特色，所有的服务器节点形成一个环，两两相互主辅备份，一个节点挂了，后续节点仍然可以提供服务直到主节点回来，有点类似一致性哈希的概念。节点的主从关系和顺序也是通过zookeeper保证。消息顺序的实现是通过称为router的路由到固定节点做传输，router默认是策略不是固定而是RR。TT的数据存储优先放在内存，并设置了一个内存状况监视的组件，当发现内存放不下的时候，swap到磁盘文件缓存，实现类似内存换页的功能。正常情况数据都应该在内存，当然如果可靠级别要求高的话可以先存磁盘再传输。TT目前仍然还是比较适合传输日志这样的文本增量数据，并且提供了TailFile这样的python脚本帮你做这个事情，这个脚本可以通过checkpoint做断点续传。在学习这个项目的时候，发现文档有很大问题，要么错误，要么遗漏，并且代码也不是最新的，我估计开源出来外面的人用的还不太多，希望慢慢能搞的更好一些。
          <br /> 
          <br /> &nbsp;&nbsp;&nbsp; 跟TT类似，另一个追求高吞吐量的MQ是linkedin开源的
          <a title="kafka" href="http://sna-projects.com/kafka/">kafka</a>。Kafka就跟这个名字一样，设计非常独特。首先，kafka的开发者们认为不需要在内存里缓存什么数据，操作系统的文件缓存已经足够完善和强大，只要你不搞随机写，顺序读写的性能是非常高效的。kafka的数据只会顺序append，数据的删除策略是累积到一定程度或者超过一定时间再删除。Kafka另一个独特的地方是将消费者信息保存在客户端而不是MQ服务器，这样服务器就不用记录消息的投递过程，每个客户端都自己知道自己下一次应该从什么地方什么位置读取消息，消息的投递过程也是采用客户端主动pull的模型，这样大大减轻了服务器的负担。Kafka还强调减少数据的序列化和拷贝开销，它会将一些消息组织成Message Set做批量存储和发送，并且客户端在pull数据的时候，尽量以zero-copy的方式传输，利用sendfile（对应java里的FileChannel.transferTo/transferFrom）这样的高级IO函数来减少拷贝开销。可见，kafka是一个精心设计，特定于某些应用的MQ系统，这种偏向特定领域的MQ系统我估计会越来越多，垂直化的产品策略值的考虑。
          <br /> 
          <br /> &nbsp;&nbsp;&nbsp;&nbsp; 在此期间，我还重新去看了activemq和hornetq的存储实现，从实现上大家都大同小异，append log + data file的模式。Activemq采用异步队列写来提高吞吐量，而Hornetq干脆就直接利用JNI调用原生aio来实现高性能。在搜索Java的aio实现的时候，碰巧发现Mina的沙箱里有个aioj的实现，源码在：
          <a href="https://svn.apache.org/repos/asf/mina/sandbox/mheath/aioj/">https://svn.apache.org/repos/asf/mina/sandbox/mheath/aioj/</a> 。我测试了完全可用，也尝试改造我们的磁盘存储组件，可惜提升不多，估计不从整个设计上调整服务器，不大可能从aio上获益。
          <br /> 
          <br /> &nbsp;&nbsp;&nbsp;&nbsp; 最近也重新看起了clojure的一些开源项目，clojure的开源资源在github上也非常丰富，有待挖掘，下次有机会再尝试介绍一二。
          <br /> &nbsp;&nbsp; 
          <br /> &nbsp;&nbsp;&nbsp; 
          <br /> &nbsp;&nbsp;&nbsp; 
          <br /> 
          <br />
         </div> 
         <p class="postfoot"> posted @ <a href="http://www.blogjava.net/killme2008/archive/2011/01/20/343284.html" title="permalink">2011-01-20 23:23</a> dennis 阅读(7227) | <a href="http://www.blogjava.net/killme2008/archive/2011/01/20/343284.html#FeedBack" title="comments, pingbacks, trackbacks">评论 (11)</a> |&nbsp;<a href="http://www.blogjava.net/killme2008/admin/EditPosts.aspx?postid=343284">编辑</a>&nbsp;<a href="http://www.blogjava.net/killme2008/AddToFavorite.aspx?id=343284">收藏</a> </p> 
        </div> 
        <div class="post" style="filter:progid:DXImageTransform.Microsoft.Shadow(color='Blue', Direction=135, Strength=32)"> 
         <div class="posthead"> 
          <h2 style="padding-top:4px; padding-bottom:4px;"><a id="ArchiveDay1_SingleDay_DayList_ctl67_TitleUrl" href="http://www.blogjava.net/killme2008/archive/2011/01/15/343037.html">A 77 lines echo server in clojure</a></h2> 
         </div> 
         <div class="postbody">
          &nbsp;&nbsp;&nbsp; 写着玩的，不使用任何网络框架从头构建的echo server，总共77行。
          <br /> 
          <div style="background-color: #eeeeee; font-size: 13px; border: 1px solid #cccccc; padding: 4px 5px 4px 4px; width: 98%;">
           <!--<br />
<br />
Code highlighting produced by Actipro CodeHighlighter (freeware)<br />
http://www.CodeHighlighter.com/<br />
<br />
-->
           <span style="color: #008080;">&nbsp;1</span>&nbsp;
           <span style="color: #000000;">;;Author:dennis&nbsp;(killme2008@gmail.com)<br /> </span>
           <span style="color: #008080;">&nbsp;2</span>&nbsp;
           <span style="color: #000000;">(ns&nbsp;webee.network<br /> </span>
           <span style="color: #008080;">&nbsp;3</span>&nbsp;
           <span style="color: #000000;">&nbsp;&nbsp;&nbsp;(:</span>
           <span style="color: #0000ff;">import</span>
           <span style="color: #000000;">&nbsp;(java.nio.channels&nbsp;Selector&nbsp;SocketChannel&nbsp;ServerSocketChannel&nbsp;SelectionKey)<br /> </span>
           <span style="color: #008080;">&nbsp;4</span>&nbsp;
           <span style="color: #000000;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(java.net&nbsp;InetSocketAddress)<br /> </span>
           <span style="color: #008080;">&nbsp;5</span>&nbsp;
           <span style="color: #000000;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(java.nio&nbsp;ByteBuffer)<br /> </span>
           <span style="color: #008080;">&nbsp;6</span>&nbsp;
           <span style="color: #000000;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(java.io&nbsp;IOException)))<br /> </span>
           <span style="color: #008080;">&nbsp;7</span>&nbsp;
           <span style="color: #000000;"><br /> </span>
           <span style="color: #008080;">&nbsp;8</span>&nbsp;
           <span style="color: #000000;">(declare&nbsp;reactor&nbsp;process</span>
           <span style="color: #000000;">-</span>
           <span style="color: #000000;">keys&nbsp;accept</span>
           <span style="color: #000000;">-</span>
           <span style="color: #000000;">channel&nbsp;read</span>
           <span style="color: #000000;">-</span>
           <span style="color: #000000;">channel)<br /> </span>
           <span style="color: #008080;">&nbsp;9</span>&nbsp;
           <span style="color: #000000;"><br /> </span>
           <span style="color: #008080;">10</span>&nbsp;
           <span style="color: #000000;">(defn&nbsp;bind&nbsp;[</span>
           <span style="color: #000000;">^</span>
           <span style="color: #000000;">InetSocketAddress&nbsp;addr&nbsp;fcol]<br /> </span>
           <span style="color: #008080;">11</span>&nbsp;
           <span style="color: #000000;">&nbsp;&nbsp;(let&nbsp;[selector&nbsp;(Selector</span>
           <span style="color: #000000;">/</span>
           <span style="color: #000000;">open)<br /> </span>
           <span style="color: #008080;">12</span>&nbsp;
           <span style="color: #000000;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ssc&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(ServerSocketChannel</span>
           <span style="color: #000000;">/</span>
           <span style="color: #000000;">open)<br /> </span>
           <span style="color: #008080;">13</span>&nbsp;
           <span style="color: #000000;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ag&nbsp;&nbsp;(agent&nbsp;selector)]<br /> </span>
           <span style="color: #008080;">14</span>&nbsp;
           <span style="color: #000000;">&nbsp;&nbsp;&nbsp;&nbsp;(</span>
           <span style="color: #0000ff;">do</span>
           <span style="color: #000000;"><br /> </span>
           <span style="color: #008080;">15</span>&nbsp;
           <span style="color: #000000;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(.configureBlocking&nbsp;ssc&nbsp;</span>
           <span style="color: #0000ff;">false</span>
           <span style="color: #000000;">)<br /> </span>
           <span style="color: #008080;">16</span>&nbsp;
           <span style="color: #000000;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(..&nbsp;ssc&nbsp;(socket)&nbsp;(bind&nbsp;addr&nbsp;</span>
           <span style="color: #000000;">1000</span>
           <span style="color: #000000;">))<br /> </span>
           <span style="color: #008080;">17</span>&nbsp;
           <span style="color: #000000;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(.register&nbsp;ssc&nbsp;selector&nbsp;SelectionKey</span>
           <span style="color: #000000;">/</span>
           <span style="color: #000000;">OP_ACCEPT)<br /> </span>
           <span style="color: #008080;">18</span>&nbsp;
           <span style="color: #000000;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(send</span>
           <span style="color: #000000;">-</span>
           <span style="color: #000000;">off&nbsp;ag&nbsp;reactor&nbsp;fcol)<br /> </span>
           <span style="color: #008080;">19</span>&nbsp;
           <span style="color: #000000;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ag)))<br /> </span>
           <span style="color: #008080;">20</span>&nbsp;
           <span style="color: #000000;"><br /> </span>
           <span style="color: #008080;">21</span>&nbsp;
           <span style="color: #000000;">(defn</span>
           <span style="color: #000000;">-</span>
           <span style="color: #000000;">&nbsp;reactor&nbsp;[</span>
           <span style="color: #000000;">^</span>
           <span style="color: #000000;">Selector&nbsp;selector&nbsp;fcol]<br /> </span>
           <span style="color: #008080;">22</span>&nbsp;
           <span style="color: #000000;">&nbsp;&nbsp;(let&nbsp;[sel&nbsp;(.&nbsp;selector&nbsp;select&nbsp;</span>
           <span style="color: #000000;">1000</span>
           <span style="color: #000000;">)]<br /> </span>
           <span style="color: #008080;">23</span>&nbsp;
           <span style="color: #000000;">&nbsp;&nbsp;&nbsp;&nbsp;(</span>
           <span style="color: #0000ff;">if</span>
           <span style="color: #000000;">&nbsp;(</span>
           <span style="color: #000000;">&gt;</span>
           <span style="color: #000000;">&nbsp;sel&nbsp;</span>
           <span style="color: #000000;">0</span>
           <span style="color: #000000;">)<br /> </span>
           <span style="color: #008080;">24</span>&nbsp;
           <span style="color: #000000;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(let&nbsp;[sks&nbsp;(.&nbsp;selector&nbsp;selectedKeys)]<br /> </span>
           <span style="color: #008080;">25</span>&nbsp;
           <span style="color: #000000;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(</span>
           <span style="color: #0000ff;">do</span>
           <span style="color: #000000;">&nbsp;<br /> </span>
           <span style="color: #008080;">26</span>&nbsp;
           <span style="color: #000000;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(dorun&nbsp;(map&nbsp;(partial&nbsp;process</span>
           <span style="color: #000000;">-</span>
           <span style="color: #000000;">keys&nbsp;selector&nbsp;fcol)&nbsp;sks))<br /> </span>
           <span style="color: #008080;">27</span>&nbsp;
           <span style="color: #000000;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(.clear&nbsp;sks))))<br /> </span>
           <span style="color: #008080;">28</span>&nbsp;
           <span style="color: #000000;">&nbsp;&nbsp;&nbsp;&nbsp;(recur&nbsp;selector&nbsp;fcol)))<br /> </span>
           <span style="color: #008080;">29</span>&nbsp;
           <span style="color: #000000;">&nbsp;&nbsp;<br /> </span>
           <span style="color: #008080;">30</span>&nbsp;
           <span style="color: #000000;">(defn</span>
           <span style="color: #000000;">-</span>
           <span style="color: #000000;">&nbsp;process</span>
           <span style="color: #000000;">-</span>
           <span style="color: #000000;">keys&nbsp;[</span>
           <span style="color: #000000;">^</span>
           <span style="color: #000000;">Selector&nbsp;selector </span>
           <span style="color: #000000;">^</span>
           <span style="color: #000000;">SelectionKey&nbsp;fcol&nbsp;sk]<br /> </span>
           <span style="color: #008080;">31</span>&nbsp;
           <span style="color: #000000;">&nbsp;&nbsp;(</span>
           <span style="color: #0000ff;">try</span>
           <span style="color: #000000;"><br /> </span>
           <span style="color: #008080;">32</span>&nbsp;
           <span style="color: #000000;">&nbsp;&nbsp;&nbsp;&nbsp;(cond&nbsp;<br /> </span>
           <span style="color: #008080;">33</span>&nbsp;
           <span style="color: #000000;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(.isAcceptable&nbsp;sk)&nbsp;(accept</span>
           <span style="color: #000000;">-</span>
           <span style="color: #000000;">channel&nbsp;sk&nbsp;&nbsp;selector&nbsp;fcol)<br /> </span>
           <span style="color: #008080;">34</span>&nbsp;
           <span style="color: #000000;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(.isReadable&nbsp;sk)&nbsp;(read</span>
           <span style="color: #000000;">-</span>
           <span style="color: #000000;">channel&nbsp;sk&nbsp;selector&nbsp;fcol)&nbsp;&nbsp;&nbsp;&nbsp;<br /> </span>
           <span style="color: #008080;">35</span>&nbsp;
           <span style="color: #000000;">&nbsp;&nbsp;&nbsp;&nbsp;)<br /> </span>
           <span style="color: #008080;">36</span>&nbsp;
           <span style="color: #000000;">&nbsp;&nbsp;&nbsp;&nbsp;(</span>
           <span style="color: #0000ff;">catch</span>
           <span style="color: #000000;">&nbsp;Throwable&nbsp;e&nbsp;(.printStackTrace&nbsp;e))))<br /> </span>
           <span style="color: #008080;">37</span>&nbsp;
           <span style="color: #000000;"><br /> </span>
           <span style="color: #008080;">38</span>&nbsp;
           <span style="color: #000000;">(defn</span>
           <span style="color: #000000;">-</span>
           <span style="color: #000000;">&nbsp;accept</span>
           <span style="color: #000000;">-</span>
           <span style="color: #000000;">channel&nbsp;[</span>
           <span style="color: #000000;">^</span>
           <span style="color: #000000;">SelectionKey&nbsp;sk </span>
           <span style="color: #000000;">^</span>
           <span style="color: #000000;">Selector&nbsp;selector&nbsp;fcol]<br /> </span>
           <span style="color: #008080;">39</span>&nbsp;
           <span style="color: #000000;">&nbsp;&nbsp;&nbsp;(let&nbsp;[</span>
           <span style="color: #000000;">^</span>
           <span style="color: #000000;">ServerSocketChannel&nbsp;ssc&nbsp;(.&nbsp;sk&nbsp;channel)<br /> </span>
           <span style="color: #008080;">40</span>&nbsp;
           <span style="color: #000000;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>
           <span style="color: #000000;">^</span>
           <span style="color: #000000;">SocketChannel&nbsp;sc&nbsp;(.&nbsp;ssc&nbsp;accept)<br /> </span>
           <span style="color: #008080;">41</span>&nbsp;
           <span style="color: #000000;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;created</span>
           <span style="color: #000000;">-</span>
           <span style="color: #000000;">fn&nbsp;(:created&nbsp;fcol)]<br /> </span>
           <span style="color: #008080;">42</span>&nbsp;
           <span style="color: #000000;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(</span>
           <span style="color: #0000ff;">do</span>
           <span style="color: #000000;">&nbsp;<br /> </span>
           <span style="color: #008080;">43</span>&nbsp;
           <span style="color: #000000;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(.configureBlocking&nbsp;sc&nbsp;</span>
           <span style="color: #0000ff;">false</span>
           <span style="color: #000000;">)&nbsp;<br /> </span>
           <span style="color: #008080;">44</span>&nbsp;
           <span style="color: #000000;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(.register&nbsp;sc&nbsp;selector&nbsp;SelectionKey</span>
           <span style="color: #000000;">/</span>
           <span style="color: #000000;">OP_READ)<br /> </span>
           <span style="color: #008080;">45</span>&nbsp;
           <span style="color: #000000;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(</span>
           <span style="color: #0000ff;">if</span>
           <span style="color: #000000;">&nbsp;created</span>
           <span style="color: #000000;">-</span>
           <span style="color: #000000;">fn<br /> </span>
           <span style="color: #008080;">46</span>&nbsp;
           <span style="color: #000000;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(created</span>
           <span style="color: #000000;">-</span>
           <span style="color: #000000;">fn&nbsp;sc)))))<br /> </span>
           <span style="color: #008080;">47</span>&nbsp;
           <span style="color: #000000;"><br /> </span>
           <span style="color: #008080;">48</span>&nbsp;
           <span style="color: #000000;">(defn</span>
           <span style="color: #000000;">-</span>
           <span style="color: #000000;">&nbsp;close</span>
           <span style="color: #000000;">-</span>
           <span style="color: #000000;">channel&nbsp;[</span>
           <span style="color: #000000;">^</span>
           <span style="color: #000000;">SelectionKey&nbsp;sk </span>
           <span style="color: #000000;">^</span>
           <span style="color: #000000;">SocketChannel&nbsp;sc&nbsp;fcol]<br /> </span>
           <span style="color: #008080;">49</span>&nbsp;
           <span style="color: #000000;">&nbsp;&nbsp;(let&nbsp;[closed</span>
           <span style="color: #000000;">-</span>
           <span style="color: #000000;">fn&nbsp;(:closed&nbsp;fcol)]<br /> </span>
           <span style="color: #008080;">50</span>&nbsp;
           <span style="color: #000000;">&nbsp;&nbsp;&nbsp;&nbsp;(</span>
           <span style="color: #0000ff;">do</span>
           <span style="color: #000000;">&nbsp;<br /> </span>
           <span style="color: #008080;">51</span>&nbsp;
           <span style="color: #000000;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(.close&nbsp;sc)<br /> </span>
           <span style="color: #008080;">52</span>&nbsp;
           <span style="color: #000000;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(.cancel&nbsp;sk)<br /> </span>
           <span style="color: #008080;">53</span>&nbsp;
           <span style="color: #000000;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(</span>
           <span style="color: #0000ff;">if</span>
           <span style="color: #000000;">&nbsp;closed</span>
           <span style="color: #000000;">-</span>
           <span style="color: #000000;">fn&nbsp;<br /> </span>
           <span style="color: #008080;">54</span>&nbsp;
           <span style="color: #000000;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(closed</span>
           <span style="color: #000000;">-</span>
           <span style="color: #000000;">fn&nbsp;sc)))))<br /> </span>
           <span style="color: #008080;">55</span>&nbsp;
           <span style="color: #000000;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br /> </span>
           <span style="color: #008080;">56</span>&nbsp;
           <span style="color: #000000;">(defn</span>
           <span style="color: #000000;">-</span>
           <span style="color: #000000;">&nbsp;&nbsp;read</span>
           <span style="color: #000000;">-</span>
           <span style="color: #000000;">channel&nbsp;[</span>
           <span style="color: #000000;">^</span>
           <span style="color: #000000;">SelectionKey&nbsp;sk </span>
           <span style="color: #000000;">^</span>
           <span style="color: #000000;">Selector&nbsp;selector&nbsp;fcol]<br /> </span>
           <span style="color: #008080;">57</span>&nbsp;
           <span style="color: #000000;">&nbsp;&nbsp;&nbsp;(let [</span>
           <span style="color: #000000;">^</span>
           <span style="color: #000000;">SocketChannel&nbsp;sc&nbsp;(.&nbsp;sk&nbsp;channel)<br /> </span>
           <span style="color: #008080;">58</span>&nbsp;
           <span style="color: #000000;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>
           <span style="color: #000000;">^</span>
           <span style="color: #000000;">ByteBuffer&nbsp;buf&nbsp;(ByteBuffer</span>
           <span style="color: #000000;">/</span>
           <span style="color: #000000;">allocate&nbsp;</span>
           <span style="color: #000000;">4096</span>
           <span style="color: #000000;">)<br /> </span>
           <span style="color: #008080;">59</span>&nbsp;
           <span style="color: #000000;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;read</span>
           <span style="color: #000000;">-</span>
           <span style="color: #000000;">fn&nbsp;(:read&nbsp;fcol)]<br /> </span>
           <span style="color: #008080;">60</span>&nbsp;
           <span style="color: #000000;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(</span>
           <span style="color: #0000ff;">try</span>
           <span style="color: #000000;"><br /> </span>
           <span style="color: #008080;">61</span>&nbsp;
           <span style="color: #000000;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(let&nbsp;[n&nbsp;(.read&nbsp;sc&nbsp;buf)]<br /> </span>
           <span style="color: #008080;">62</span>&nbsp;
           <span style="color: #000000;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(</span>
           <span style="color: #0000ff;">if</span>
           <span style="color: #000000;">&nbsp;(</span>
           <span style="color: #000000;">&lt;</span>
           <span style="color: #000000;">&nbsp;n&nbsp;</span>
           <span style="color: #000000;">0</span>
           <span style="color: #000000;">)<br /> </span>
           <span style="color: #008080;">63</span>&nbsp;
           <span style="color: #000000;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(close</span>
           <span style="color: #000000;">-</span>
           <span style="color: #000000;">channel&nbsp;sk&nbsp;sc&nbsp;fcol)<br /> </span>
           <span style="color: #008080;">64</span>&nbsp;
           <span style="color: #000000;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(</span>
           <span style="color: #0000ff;">do</span>
           <span style="color: #000000;">&nbsp;(.flip&nbsp;buf)<br /> </span>
           <span style="color: #008080;">65</span>&nbsp;
           <span style="color: #000000;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(</span>
           <span style="color: #0000ff;">if</span>
           <span style="color: #000000;">&nbsp;read</span>
           <span style="color: #000000;">-</span>
           <span style="color: #000000;">fn<br /> </span>
           <span style="color: #008080;">66</span>&nbsp;
           <span style="color: #000000;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(read</span>
           <span style="color: #000000;">-</span>
           <span style="color: #000000;">fn&nbsp;sc&nbsp;buf)))))<br /> </span>
           <span style="color: #008080;">67</span>&nbsp;
           <span style="color: #000000;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(</span>
           <span style="color: #0000ff;">catch</span>
           <span style="color: #000000;">&nbsp;IOException&nbsp;e<br /> </span>
           <span style="color: #008080;">68</span>&nbsp;
           <span style="color: #000000;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(close</span>
           <span style="color: #000000;">-</span>
           <span style="color: #000000;">channel&nbsp;sk&nbsp;sc&nbsp;fcol)))))<br /> </span>
           <span style="color: #008080;">69</span>&nbsp;
           <span style="color: #000000;"><br /> </span>
           <span style="color: #008080;">70</span>&nbsp;
           <span style="color: #000000;">;;Bind&nbsp;a&nbsp;tcp&nbsp;server&nbsp;to&nbsp;localhost&nbsp;at&nbsp;port&nbsp;</span>
           <span style="color: #000000;">8080</span>
           <span style="color: #000000;">,you&nbsp;can&nbsp;telnet&nbsp;it.<br /> </span>
           <span style="color: #008080;">71</span>&nbsp;
           <span style="color: #000000;">(def&nbsp;server<br /> </span>
           <span style="color: #008080;">72</span>&nbsp;
           <span style="color: #000000;">&nbsp;&nbsp;(bind&nbsp;<br /> </span>
           <span style="color: #008080;">73</span>&nbsp;
           <span style="color: #000000;">&nbsp;&nbsp;&nbsp;&nbsp;(</span>
           <span style="color: #0000ff;">new</span>
           <span style="color: #000000;">&nbsp;InetSocketAddress&nbsp;</span>
           <span style="color: #000000;">8080</span>
           <span style="color: #000000;">)<br /> </span>
           <span style="color: #008080;">74</span>&nbsp;
           <span style="color: #000000;">&nbsp;&nbsp;&nbsp;&nbsp;{:read&nbsp;#(.write&nbsp;</span>
           <span style="color: #000000;">%</span>
           <span style="color: #000000;">1</span>
           <span style="color: #000000;">&nbsp;</span>
           <span style="color: #000000;">%</span>
           <span style="color: #000000;">2</span>
           <span style="color: #000000;">)<br /> </span>
           <span style="color: #008080;">75</span>&nbsp;
           <span style="color: #000000;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:created&nbsp;#(println&nbsp;</span>
           <span style="color: #000000;">&quot;</span>
           <span style="color: #000000;">Accepted&nbsp;from</span>
           <span style="color: #000000;">&quot;</span>
           <span style="color: #000000;">&nbsp;(..&nbsp;</span>
           <span style="color: #000000;">%</span>
           <span style="color: #000000;">&nbsp;(socket)&nbsp;(getRemoteSocketAddress)))<br /> </span>
           <span style="color: #008080;">76</span>&nbsp;
           <span style="color: #000000;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:closed&nbsp;&nbsp;#(println&nbsp;</span>
           <span style="color: #000000;">&quot;</span>
           <span style="color: #000000;">Disconnected&nbsp;from</span>
           <span style="color: #000000;">&quot;</span>
           <span style="color: #000000;">&nbsp;(..&nbsp;</span>
           <span style="color: #000000;">%</span>
           <span style="color: #000000;">&nbsp;(socket)&nbsp;(getRemoteSocketAddress)))<br /> </span>
           <span style="color: #008080;">77</span>&nbsp;
           <span style="color: #000000;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}))</span>
          </div> 
          <br /> 
          <br />
         </div> 
         <p class="postfoot"> posted @ <a href="http://www.blogjava.net/killme2008/archive/2011/01/15/343037.html" title="permalink">2011-01-15 22:56</a> dennis 阅读(1753) | <a href="http://www.blogjava.net/killme2008/archive/2011/01/15/343037.html#FeedBack" title="comments, pingbacks, trackbacks">评论 (0)</a> |&nbsp;<a href="http://www.blogjava.net/killme2008/admin/EditPosts.aspx?postid=343037">编辑</a>&nbsp;<a href="http://www.blogjava.net/killme2008/AddToFavorite.aspx?id=343037">收藏</a> </p> 
        </div> 
        <div class="post" style="filter:progid:DXImageTransform.Microsoft.Shadow(color='Blue', Direction=135, Strength=32)"> 
         <div class="posthead"> 
          <h2 style="padding-top:4px; padding-bottom:4px;"><a id="ArchiveDay1_SingleDay_DayList_ctl68_TitleUrl" href="http://www.blogjava.net/killme2008/archive/2011/01/04/342287.html">Xmemcached 1.3.0正式发布</a></h2> 
         </div> 
         <div class="postbody">
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
          <a href="http://code.google.com/p/xmemcached/">Xmemcached</a>是一个开源的memcached的Java客户端，最近引入了一些关键特性，因此版本号直接从1.2.6.2升级到1.3.0。主要的更改如下：
          <br /> 
          <p> <strong>1、引入了failure模式</strong>，所谓failure模式是指在当一个memcached由于各种原因不可用的情况下，发往这个节点的请求将直接抛出异常，而非使用下一个可用的节点。具体可以看memached的<a href="http://code.google.com/p/memcached/wiki/NewConfiguringClient#Failure,_or_Failover">这个文档</a>。默认不启用，启用failure模式很简单：</p> 
          <div style="background-color: #eeeeee; font-size: 13px; border: 1px solid #cccccc; padding: 4px 5px 4px 4px; width: 98%;">
           <!--<br />
<br />
Code highlighting produced by Actipro CodeHighlighter (freeware)<br />
http://www.CodeHighlighter.com/<br />
<br />
-->
           <span style="color: #000000;">MemcachedClientBuilder&nbsp;builder</span>
           <span style="color: #000000;">=</span>
           <span style="color: #000000;">……<br /> </span>
           <span style="color: #008000;">//</span>
           <span style="color: #008000;">启用failure模式。</span>
           <span style="color: #008000;"><br /> </span>
           <span style="color: #000000;">builder.setFailureMode(</span>
           <span style="color: #0000ff;">true</span>
           <span style="color: #000000;">);<br /> </span>
          </div> 
          <p>也可以采用spring配置。<br /> </p> 
          <strong>2、在启用failure模式的情况下，允许为每个memcached设置一个备份节点，</strong>当主节点挂掉的情况下，会将请求转交给备份节点，主节点恢复后又自动切换到主节点。请注意，要设置备份节点的前提是启用failure模式。假设我们已经有两个memcached节点：host1:port和host2:port，为host1:port设置一个备份节点host3:port可以实现为：
          <br /> 
          <div style="background-color: #eeeeee; font-size: 13px; border: 1px solid #cccccc; padding: 4px 5px 4px 4px; width: 98%;">
           <!--<br />
<br />
Code highlighting produced by Actipro CodeHighlighter (freeware)<br />
http://www.CodeHighlighter.com/<br />
<br />
-->
           <span style="color: #000000;">MemcachedClientBuilder&nbsp;builder</span>
           <span style="color: #000000;">=</span>
           <span style="color: #0000ff;">new</span>
           <span style="color: #000000;">&nbsp;XmemcachedClientBuilder(AddrUtil.getAddressMap(</span>
           <span style="color: #000000;">&quot;</span>
           <span style="color: #000000;">host1:port,host3:port&nbsp;host2:port</span>
           <span style="color: #000000;">&quot;</span>
           <span style="color: #000000;">))<br /> ……</span>
          </div> 
          <br /> 主备节点之间用逗号隔开，不同分组之间用空格隔开，完全兼容1.2。并且当备份节点连接意外断开的情况下，xmemcached也会自动修复备份节点的连接并加入映射。
          <br /> 
          <p> 关于failure模式和standby节点更多内容可以参考<a href="http://www.blogjava.net/killme2008/archive/2010/12/28/341731.html">这篇blog</a>.<br /> </p> 
          <p> <strong>3、修正BUG和新功能</strong>，包括<a href="http://code.google.com/p/xmemcached/issues/detail?id=104">issue 104</a>,<a href="http://code.google.com/p/xmemcached/issues/detail?id=105">issue 105</a>,<a href="http://code.google.com/p/xmemcached/issues/detail?id=107">issue 107</a>等。<br /> </p> 
          <p> 项目主页 <a href="http://code.google.com/p/xmemcached/" title="http://code.google.com/p/xmemcached/">http://code.google.com/p/xmemcached/</a><br /> </p> 
          <p> 下载地址 <a href="http://code.google.com/p/xmemcached/downloads/list" title="http://code.google.com/p/xmemcached/downloads/list">http://code.google.com/p/xmemcached/downloads/list</a><br /> </p> 
          <p> 用户指南 <a href="http://code.google.com/p/xmemcached/wiki/TableOfContents" title="http://code.google.com/p/xmemcached/wiki/TableOfContents">http://code.google.com/p/xmemcached/wiki/TableOfContents</a><br /> </p> 
          <p>&nbsp;&nbsp;&nbsp;&nbsp; 如果你使用maven构建，可以直接引用：<br /> </p> 
          <div style="background-color: #eeeeee; font-size: 13px; border: 1px solid #cccccc; padding: 4px 5px 4px 4px; width: 98%;">
           <!--<br />
<br />
Code highlighting produced by Actipro CodeHighlighter (freeware)<br />
http://www.CodeHighlighter.com/<br />
<br />
-->
           <span style="color: #0000ff;">&lt;</span>
           <span style="color: #800000;">dependency</span>
           <span style="color: #0000ff;">&gt;</span>
           <span style="color: #000000;"><br /> </span>
           <span style="color: #0000ff;">&lt;</span>
           <span style="color: #800000;">groupId</span>
           <span style="color: #0000ff;">&gt;</span>
           <span style="color: #000000;">com.googlecode.xmemcached</span>
           <span style="color: #0000ff;">&lt;/</span>
           <span style="color: #800000;">groupId</span>
           <span style="color: #0000ff;">&gt;</span>
           <span style="color: #000000;"><br /> </span>
           <span style="color: #0000ff;">&lt;</span>
           <span style="color: #800000;">artifactId</span>
           <span style="color: #0000ff;">&gt;</span>
           <span style="color: #000000;">xmemcached</span>
           <span style="color: #0000ff;">&lt;/</span>
           <span style="color: #800000;">artifactId</span>
           <span style="color: #0000ff;">&gt;</span>
           <span style="color: #000000;"><br /> </span>
           <span style="color: #0000ff;">&lt;</span>
           <span style="color: #800000;">version</span>
           <span style="color: #0000ff;">&gt;</span>
           <span style="color: #000000;">1.3.1</span>
           <span style="color: #0000ff;">&lt;/</span>
           <span style="color: #800000;">version</span>
           <span style="color: #0000ff;">&gt;</span>
           <span style="color: #000000;"><br /> </span>
           <span style="color: #0000ff;">&lt;/</span>
           <span style="color: #800000;">dependency</span>
           <span style="color: #0000ff;">&gt;</span>
          </div> 
          <p><br /> </p> 
          <p>&nbsp;&nbsp;&nbsp; 更新：发布1.3.1了，如果你还在使用1.3.0，建议升级。1.3.0因为改变了memcached地址服务器顺序，可能导致原有的缓存失效。<br /> </p> 
          <br />
         </div> 
         <p class="postfoot"> posted @ <a href="http://www.blogjava.net/killme2008/archive/2011/01/04/342287.html" title="permalink">2011-01-04 20:10</a> dennis 阅读(2817) | <a href="http://www.blogjava.net/killme2008/archive/2011/01/04/342287.html#FeedBack" title="comments, pingbacks, trackbacks">评论 (0)</a> |&nbsp;<a href="http://www.blogjava.net/killme2008/admin/EditPosts.aspx?postid=342287">编辑</a>&nbsp;<a href="http://www.blogjava.net/killme2008/AddToFavorite.aspx?id=342287">收藏</a> </p> 
        </div> 
        <div class="post" style="filter:progid:DXImageTransform.Microsoft.Shadow(color='Blue', Direction=135, Strength=32)"> 
         <div class="posthead"> 
          <h2 style="padding-top:4px; padding-bottom:4px;"><a id="ArchiveDay1_SingleDay_DayList_ctl69_TitleUrl" href="http://www.blogjava.net/killme2008/archive/2011/01/01/342110.html">2010年的小小总结</a></h2> 
         </div> 
         <div class="postbody">
          <br /> &nbsp;&nbsp;&nbsp; 首先，还是利用下这个
          <a href="http://code.google.com/p/doubanlet/">小工具</a>，查看下我10年读过的书，看过的电影
          <br /> 
          <br /> 
          <img id="chartMonth" src="http://chart.apis.google.com/chart?chs=400x200&amp;cht=bvs&amp;chd=s:3MAAAGAlSfGl&amp;chxt=y,x,x&amp;chxl=0:|0|1|2|3|4|5|6|7|8|9|10|1:|1|2|3|4|5|6|7|8|9|10|11|12|2:|month&amp;chxp=2,100&amp;chf=c,lg,90,76A4FB,0.5,ffffff,0|bg,s,EFEFEF&amp;chco=0000ff&amp;chtt=33 books+you+added+in+year+2010|divided+by+month" alt="" /> 
          <div id="doubanlist"> 
           <table> 
            <tbody> 
             <tr> 
              <td><a title="1Q84 BOOK 2" target="_blank" href="http://book.douban.com/subject/4885241/"><img src="http://img3.douban.com/spic/s4393610.jpg" alt="" border="0" /></a></td> 
              <td><a title="1Q84 BOOK 1" target="_blank" href="http://book.douban.com/subject/4742918/"><img src="http://img3.douban.com/spic/s4363464.jpg" alt="" border="0" /></a></td> 
              <td><a title="新宋Ⅲ&middot;燕云4" target="_blank" href="http://book.douban.com/subject/5336752/"><img src="http://img3.douban.com/spic/s4517390.jpg" alt="" border="0" /></a></td> 
              <td><a title="Google Android揭秘" target="_blank" href="http://book.douban.com/subject/4320723/"><img src="http://img3.douban.com/spic/s4205363.jpg" alt="" border="0" /></a></td> 
              <td><a title="演讲之禅：一位技术演讲家的自白" target="_blank" href="http://book.douban.com/subject/4760725/"><img src="http://img3.douban.com/spic/s4279952.jpg" alt="" border="0" /></a></td> 
              <td><a title="Android应用开发" target="_blank" href="http://book.douban.com/subject/5250774/"><img src="http://img3.douban.com/spic/s4484502.jpg" alt="" border="0" /></a></td> 
              <td><a title="Facebook效应" target="_blank" href="http://book.douban.com/subject/5313010/"><img src="http://img3.douban.com/spic/s4528546.jpg" alt="" border="0" /></a></td> 
             </tr> 
             <tr> 
              <td><a title="问道" target="_blank" href="http://book.douban.com/subject/3248269/"><img src="http://img3.douban.com/pics/book-default-small.gif" alt="" border="0" /></a></td> 
              <td><a title="诛仙" target="_blank" href="http://book.douban.com/subject/2337600/"><img src="http://img3.douban.com/spic/s3055502.jpg" alt="" border="0" /></a></td> 
              <td><a title="宋史十讲" target="_blank" href="http://book.douban.com/subject/3360630/"><img src="http://img3.douban.com/spic/s3479564.jpg" alt="" border="0" /></a></td> 
              <td><a title="回到明朝当王爷" target="_blank" href="http://book.douban.com/subject/2974188/"><img src="http://img3.douban.com/spic/s3138849.jpg" alt="" border="0" /></a></td> 
              <td><a title="健身国术（时尚健身版）五禽戏（附光盘）" target="_blank" href="http://book.douban.com/subject/4065702/"><img src="http://img3.douban.com/spic/s4236919.jpg" alt="" border="0" /></a></td> 
              <td><a title="蒋经国论" target="_blank" href="http://book.douban.com/subject/3671599/"><img src="http://img3.douban.com/spic/s3729140.jpg" alt="" border="0" /></a></td> 
              <td><a title="呐喊" target="_blank" href="http://book.douban.com/subject/1449351/"><img src="http://img3.douban.com/spic/s1462621.jpg" alt="" border="0" /></a></td> 
             </tr> 
             <tr> 
              <td><a title="构建高性能Web站点" target="_blank" href="http://book.douban.com/subject/3924175/"><img src="http://img3.douban.com/spic/s3935862.jpg" alt="" border="0" /></a></td> 
              <td><a title="一只牡羊的金刚经笔记" target="_blank" href="http://book.douban.com/subject/4133007/"><img src="http://img3.douban.com/spic/s4066824.jpg" alt="" border="0" /></a></td> 
              <td><a title="他的国" target="_blank" href="http://book.douban.com/subject/3394338/"><img src="http://img3.douban.com/spic/s3557848.jpg" alt="" border="0" /></a></td> 
              <td><a title="庆余年&middot;壹" target="_blank" href="http://book.douban.com/subject/3155622/"><img src="http://img3.douban.com/spic/s3207456.jpg" alt="" border="0" /></a></td> 
              <td><a title="我的奋斗" target="_blank" href="http://book.douban.com/subject/4741216/"><img src="http://img3.douban.com/spic/s4270619.jpg" alt="" border="0" /></a></td> 
              <td><a title="把时间当作朋友" target="_blank" href="http://book.douban.com/subject/3609132/"><img src="http://img3.douban.com/spic/s3778613.jpg" alt="" border="0" /></a></td> 
              <td><a title="Programming Clojure" target="_blank" href="http://book.douban.com/subject/3279191/"><img src="http://img3.douban.com/spic/s4263259.jpg" alt="" border="0" /></a></td> 
             </tr> 
             <tr> 
              <td><a title="历史深处的忧虑" target="_blank" href="http://book.douban.com/subject/1027191/"><img src="http://img3.douban.com/spic/s1688308.jpg" alt="" border="0" /></a></td> 
              <td><a title="ACM图灵奖：1966～2001：（增订版）：计算机发展史的缩影" target="_blank" href="http://book.douban.com/subject/1649502/"><img src="http://img3.douban.com/spic/s2323966.jpg" alt="" border="0" /></a></td> 
              <td><a title="民主的细节" target="_blank" href="http://book.douban.com/subject/3813669/"><img src="http://img3.douban.com/spic/s4146437.jpg" alt="" border="0" /></a></td> 
              <td><a title="失落的秘符" target="_blank" href="http://book.douban.com/subject/4171951/"><img src="http://img3.douban.com/spic/s4113637.jpg" alt="" border="0" /></a></td> 
              <td><a title="哈佛琐记（增订版）" target="_blank" href="http://book.douban.com/subject/4152159/"><img src="http://img5.douban.com/spic/s4071265.jpg" alt="" border="0" /></a></td> 
              <td><a title="亲爱的安德烈" target="_blank" href="http://book.douban.com/subject/2298674/"><img src="http://img3.douban.com/spic/s2757904.jpg" alt="" border="0" /></a></td> 
              <td><a title="我们台湾这些年" target="_blank" href="http://book.douban.com/subject/4113090/"><img src="http://img3.douban.com/spic/s4036921.jpg" alt="" border="0" /></a></td> 
             </tr> 
             <tr> 
              <td><a title="疯狂实验史" target="_blank" href="http://book.douban.com/subject/3732346/"><img src="http://img3.douban.com/spic/s4053694.jpg" alt="" border="0" /></a></td> 
              <td><a title="Joel说软件" target="_blank" href="http://book.douban.com/subject/1426838/"><img src="http://img3.douban.com/spic/s1436476.jpg" alt="" border="0" /></a></td> 
              <td><a title="牧羊少年奇幻之旅" target="_blank" href="http://book.douban.com/subject/3608208/"><img src="http://img3.douban.com/spic/s3668327.jpg" alt="" border="0" /></a></td> 
              <td><a title="数字城堡" target="_blank" href="http://book.douban.com/subject/3654590/"><img src="http://img3.douban.com/spic/s3714684.jpg" alt="" border="0" /></a></td> 
              <td><a title="骗局" target="_blank" href="http://book.douban.com/subject/3700600/"><img src="http://img5.douban.com/spic/s3762795.jpg" alt="" border="0" /></a></td> 
             </tr> 
            </tbody> 
           </table> 
          </div> 
          <br /> 
          <img id="chartMonth" src="http://chart.apis.google.com/chart?chs=400x200&amp;cht=bvs&amp;chd=s:MAGMSfAGMGxG&amp;chxt=y,x,x&amp;chxl=0:|0|1|2|3|4|5|6|7|8|9|10|1:|1|2|3|4|5|6|7|8|9|10|11|12|2:|month&amp;chxp=2,100&amp;chf=c,lg,90,76A4FB,0.5,ffffff,0|bg,s,EFEFEF&amp;chco=0000ff&amp;chtt=26 movies+you+added+in+year+2010|divided+by+month" alt="" /> 
          <div id="doubanlist"> 
           <table> 
            <tbody> 
             <tr> 
             </tr> 
             <tr> 
              <td><a title="让子弹飞" target="_blank" href="http://movie.douban.com/subject/3742360/"><img src="http://img3.douban.com/spic/s4562687.jpg" alt="" border="0" /></a></td> 
              <td><a title="Predators" target="_blank" href="http://movie.douban.com/subject/3699737/"><img src="http://img3.douban.com/spic/s4368407.jpg" alt="" border="0" /></a></td> 
              <td><a title="Daybreakers" target="_blank" href="http://movie.douban.com/subject/1972732/"><img src="http://img3.douban.com/spic/s4103604.jpg" alt="" border="0" /></a></td> 
              <td><a title="From Paris with Love" target="_blank" href="http://movie.douban.com/subject/3231686/"><img src="http://img5.douban.com/spic/s4084145.jpg" alt="" border="0" /></a></td> 
              <td><a title="狄仁杰之通天帝国" target="_blank" href="http://movie.douban.com/subject/3412830/"><img src="http://img3.douban.com/spic/s4470299.jpg" alt="" border="0" /></a></td> 
              <td><a title="枪王之王" target="_blank" href="http://movie.douban.com/subject/4133988/"><img src="http://img3.douban.com/spic/s4381860.jpg" alt="" border="0" /></a></td> 
              <td><a title="精武风云&middot;陈真" target="_blank" href="http://movie.douban.com/subject/3792816/"><img src="http://img3.douban.com/spic/s4460284.jpg" alt="" border="0" /></a></td> 
             </tr> 
             <tr> 
              <td><a title="The American" target="_blank" href="http://movie.douban.com/subject/3744561/"><img src="http://img3.douban.com/spic/s4392060.jpg" alt="" border="0" /></a></td> 
              <td><a title="The Social Network" target="_blank" href="http://movie.douban.com/subject/3205624/"><img src="http://img5.douban.com/spic/s4387115.jpg" alt="" border="0" /></a></td> 
              <td><a title="Resident Evil: Afterlife" target="_blank" href="http://movie.douban.com/subject/3041294/"><img src="http://img3.douban.com/spic/s4379754.jpg" alt="" border="0" /></a></td> 
              <td><a title="The Expendables" target="_blank" href="http://movie.douban.com/subject/3279080/"><img src="http://img3.douban.com/spic/s4225756.jpg" alt="" border="0" /></a></td> 
              <td><a title="Inception" target="_blank" href="http://movie.douban.com/subject/3541415/"><img src="http://img3.douban.com/spic/s4356687.jpg" alt="" border="0" /></a></td> 
              <td><a title="Shutter Island" target="_blank" href="http://movie.douban.com/subject/2334904/"><img src="http://img3.douban.com/spic/s3895194.jpg" alt="" border="0" /></a></td> 
              <td><a title="The Aviator" target="_blank" href="http://movie.douban.com/subject/1309070/"><img src="http://img3.douban.com/spic/s2352169.jpg" alt="" border="0" /></a></td> 
             </tr> 
             <tr> 
              <td><a title="Gangs of New York" target="_blank" href="http://movie.douban.com/subject/1301061/"><img src="http://img3.douban.com/spic/s1325556.jpg" alt="" border="0" /></a></td> 
              <td><a title="Body of Lies" target="_blank" href="http://movie.douban.com/subject/2091015/"><img src="http://img3.douban.com/spic/s3236199.jpg" alt="" border="0" /></a></td> 
              <td><a title="Blood Diamond" target="_blank" href="http://movie.douban.com/subject/1428175/"><img src="http://img3.douban.com/spic/s1946797.jpg" alt="" border="0" /></a></td> 
              <td><a title="Catch Me If You Can" target="_blank" href="http://movie.douban.com/subject/1305487/"><img src="http://img3.douban.com/spic/s2404628.jpg" alt="" border="0" /></a></td> 
              <td><a title="Cinderella Man" target="_blank" href="http://movie.douban.com/subject/1418519/"><img src="http://img3.douban.com/spic/s4064422.jpg" alt="" border="0" /></a></td> 
              <td><a title="Iron Man 2" target="_blank" href="http://movie.douban.com/subject/3066739/"><img src="http://img3.douban.com/spic/s4234948.jpg" alt="" border="0" /></a></td> 
              <td><a title="L.A. Confidential" target="_blank" href="http://movie.douban.com/subject/1292348/"><img src="http://img3.douban.com/spic/s3104346.jpg" alt="" border="0" /></a></td> 
             </tr> 
             <tr> 
              <td><a title="Clash of the Titans" target="_blank" href="http://movie.douban.com/subject/2131654/"><img src="http://img3.douban.com/spic/s4259344.jpg" alt="" border="0" /></a></td> 
              <td><a title="倔强萝卜" target="_blank" href="http://movie.douban.com/subject/3558661/"><img src="http://img3.douban.com/spic/s3991069.jpg" alt="" border="0" /></a></td> 
              <td><a title="意外" target="_blank" href="http://movie.douban.com/subject/3013580/"><img src="http://img3.douban.com/spic/s3958466.jpg" alt="" border="0" /></a></td> 
              <td><a title="The Big Bang Theory Season 2" target="_blank" href="http://movie.douban.com/subject/3190880/"><img src="http://img3.douban.com/spic/s4194192.jpg" alt="" border="0" /></a></td> 
              <td><a title="十月围城" target="_blank" href="http://movie.douban.com/subject/3626416/"><img src="http://img3.douban.com/spic/s3778044.jpg" alt="" border="0" /></a></td> 
             </tr> 
            </tbody> 
           </table> 
          </div> 
          <br /> 
          <br /> &nbsp;&nbsp;&nbsp; 读书：读的太少，也可以看到，技术方面的更少，如果要说推荐，我只会推荐《Programming Clojure》作为学习clojure的入门，并且推荐《构建高性能web站点》作为了解一个网站构建的方放面面的入门书。
          <br /> 
          <br /> &nbsp;&nbsp;&nbsp; 电影：今年进电影院的次数也寥寥无几，主要还是重看了莱昂纳多的作品，《I梦空间》很惊艳，《钢铁侠2》很失望。
          <br /> 
          <br /> &nbsp;&nbsp;&nbsp;&nbsp; 去年的愿望：读完《算法导论》――2/3，继续深入Erlang，探索Erlang在工作中的实际应用――几乎没有，加强对其他系统的了解以及大型网站构建方面的学习――小小一些了解，希望能全家一起去旅游一次，希望能将老爸老妈接过来玩一段时间――没有做到。
          <br /> &nbsp;&nbsp; 
          <br /> &nbsp;&nbsp;&nbsp;&nbsp; 工作：状态并不好，还是尝试努力去做了一些事情，包括参与一些分享，更多参与他人的代码复查和设计审查等。抱怨、牢骚少了一些，相对淡定了。
          <br /> 
          <br /> &nbsp;&nbsp;&nbsp;&nbsp; 2011年：还是不谈大的愿望，从以往的经验来说，很难靠谱。也许有一个相对明晰的目标：提高自制力和计划性。
          <br /> 
          <br /> 
          <br />
         </div> 
         <p class="postfoot"> posted @ <a href="http://www.blogjava.net/killme2008/archive/2011/01/01/342110.html" title="permalink">2011-01-01 09:08</a> dennis 阅读(1977) | <a href="http://www.blogjava.net/killme2008/archive/2011/01/01/342110.html#FeedBack" title="comments, pingbacks, trackbacks">评论 (3)</a> |&nbsp;<a href="http://www.blogjava.net/killme2008/admin/EditPosts.aspx?postid=342110">编辑</a>&nbsp;<a href="http://www.blogjava.net/killme2008/AddToFavorite.aspx?id=342110">收藏</a> </p> 
        </div> 
        <div class="post" style="filter:progid:DXImageTransform.Microsoft.Shadow(color='Blue', Direction=135, Strength=32)"> 
         <div class="posthead"> 
          <h2 style="padding-top:4px; padding-bottom:4px;"><a id="ArchiveDay1_SingleDay_DayList_ctl70_TitleUrl" href="http://www.blogjava.net/killme2008/archive/2010/12/30/341964.html">高质量软件，从点点滴滴做起</a></h2> 
         </div> 
         <div class="postbody">
          <br /> &nbsp;&nbsp;&nbsp; 写这篇文章的想法产生在昨天晚上读《面向对象分析与设计》的时候，我渐渐发现我们这个小组不知不觉地贯彻了很多非常有价值的实践经验，这些点点滴滴都对我们的最终的产品质量产生了或大或小的影响，保证我们的系统不会出现重大的故障。我想有必要将这些“隐性知识”稍微总结一下，以供参考和记录。
          <br /> 
          <br /> &nbsp;&nbsp; 从过程的连续光谱来看，我们大概处于中间位置偏左的位置，更偏向一个轻量级团队的敏捷过程，但是也包含计划驱动过程中的因素。我们的小组是自管理的，没有专门的QA和SA，我们自己去想出最好的工作方法，但是在执行中我们的计划还是相对确定的，每个季度做什么都会有一个比较明确的计划和里程碑，并且对问题领域都相对熟悉；我们的过程是迭代式，一般一个季度至少会交付一个稳定可执行的新版本，我们在文档上做的不是特别好，很多都依赖于团队成员之间的“隐性知识”；同时我们对问题的改进基本还是有一个流程和机制，会持续的跟踪问题并改进。
          <br /> 
          <br /> &nbsp;&nbsp; 下面分阶段总结下我们的一些实践经验。
          <br /> 
          <br /> 一、分析和设计阶段
          <br /> 
          <br /> 1、在这个阶段，我们会明确准备做什么，界定问题的边界，对功能进行一个取舍。一般在一个版本完成之后会马上开始这个过程。大家都想一想接下来做什么，经过几轮PK后确定
          <strong>重要紧急的事情优先做，定义下一个版本的功能列表</strong>。
          <br /> 
          <br /> 2、功能列表出来之后，我们会针对每个功能提出各种方案做比较，在此期间，我们会
          <strong>邀请更大团队范围内的专家参与方案和设计的评审</strong>，剔除不切实际以及明显有缺陷的方案，针对一些风险点提出改进建议和防范措施。
          <br /> 
          <br /> 3、在设计方案出来之后，我们会分配功能的开发任务，根据每个开发人员熟悉的领域，
          <strong>自主领取或者被动分配任务</strong>。这个过程不是一成不变的，考虑到团队内部知识交流的必要性，也可能让不熟悉某个领域的人去做他不熟悉的事情。
          <br /> 
          <br /> 二、构造阶段
          <br /> 
          <br /> 1、整个系统已经有一个
          <strong>关键的抽象机制</strong>，针对我们的服务器有一个核心的pipeline机制，针对我们的客户端，有一个核心的发送消息流程。将所有的功能模块组织在这个关键机制周围，形成一个强有力的整体。
          <br /> 
          <br /> 2、开发完成不
          <strong>仅仅意味着功能代码的完成，还包括测试代码</strong>：单元测试和集成测试。如果你没办法做到全面的覆盖，那就要求必须覆盖运行的关键路径和极端场景。
          <br /> 
          <br /> 3、单元测试我们使用JUnit，适当使用Mock可以简化测试。但是Mock对象如果太多，也许会失去测试的价值，这里有一个权衡。
          <br /> 
          <br /> 4、在整个构造过程中，我们贯彻每日构建、持续集成的原则。使用hudson做持续集成，
          <strong>时刻关注测试状况</strong>，有问题及时反馈给开发者。
          <br /> 
          <br /> 5、有一个功能强大的集成测试框架，模拟实际环境做各种测试，它的目的是尽量在接近真实状况下去执行系统并尽早暴露问题。
          <br /> 
          <br /> 6、每个功能完成之后，立即发起review，请同事和你一起复审代码。复审代码的作用不仅是发现bug，改良设计，也是一个知识交流的最佳途径。我们经常能通过
          <strong>代码审查</strong>发现一些设计上的缺陷，以及功能实现上的BUG。我们团队应该说是非常看重代码审查的作用。
          <br /> 
          <br /> 7、
          <strong>使用findbugs和clover等工具</strong>，分析代码质量并改进。
          <br /> 
          <br /> 8、在发布之前，做一次
          <strong>集中的代码review</strong>，每个人介绍下自己的功能实现代码和设计，一般我们会申请一个会议室和投影仪，并邀请团队之外的人加入review。
          <br /> 
          <br /> 9、在发布之前，有一个系统的
          <strong>压测流程</strong>，针对每个版本更新压测方案，并预留一到两周的时间做性能压测。压测不仅能尽早暴露性能隐患，还可以发现系统在特殊情况下的一些BUG。压测除了关注系统的吞吐量、GC情况之外，还应该关注硬件的性能指标。
          <br /> 
          <br /> 三、发布和总结
          <br /> 1、发布之前，最好让使用我们系统的用户使用新版本做一个
          <strong>回归测试</strong>，一方面是测试兼容性，一方面也可以及早发现BUG。
          <br /> 
          <br /> 2、我们的发布流程：线下、beta、线上。每个阶段通常都持续一到两周，才会进行到下一阶段。并且是从相对不重要的系统，到关键系统的顺序进行发布。
          <br /> 
          <br /> 3、发布之后，通过日志、运行时监控、用户反馈等方式收集系统运行状况，发现BUG，修正BUG，补充测试，测试通过，重新发布。
          <br /> 
          <br /> 4、每个版本发布后，需要总结下本次发布过程中遇到的所有BUG以及经验教训，并提出可能的改进建议。
          <br /> 
          <br /> 5、需要一个跟踪线上问题的BUG跟踪系统，可以用JIRA之类的trace软件。跟踪不仅是记录，最好列出解决的时间点，在哪个版本确定解决，甚至确定交给谁去解决，并持续跟进。
          <br /> 
          <br />
         </div> 
         <p class="postfoot"> posted @ <a href="http://www.blogjava.net/killme2008/archive/2010/12/30/341964.html" title="permalink">2010-12-30 11:01</a> dennis 阅读(4023) | <a href="http://www.blogjava.net/killme2008/archive/2010/12/30/341964.html#FeedBack" title="comments, pingbacks, trackbacks">评论 (9)</a> |&nbsp;<a href="http://www.blogjava.net/killme2008/admin/EditPosts.aspx?postid=341964">编辑</a>&nbsp;<a href="http://www.blogjava.net/killme2008/AddToFavorite.aspx?id=341964">收藏</a> </p> 
        </div> 
        <div class="post" style="filter:progid:DXImageTransform.Microsoft.Shadow(color='Blue', Direction=135, Strength=32)"> 
         <div class="posthead"> 
          <h2 style="padding-top:4px; padding-bottom:4px;"><a id="ArchiveDay1_SingleDay_DayList_ctl71_TitleUrl" href="http://www.blogjava.net/killme2008/archive/2010/12/28/341731.html">Xmemcached 1.3预览：failure模式和standby节点</a></h2> 
         </div> 
         <div class="postbody">
          <br /> &nbsp;&nbsp;&nbsp; 
          <a href="http://code.google.com/p/xmemcached/">Xmemcached</a>在元旦左右准备发1.3这个版本，这个版本新增加的一个关键特性就是所谓的failure模式。关于这个，可以看下memcached官方文档的解释
          <br /> 
          <a title=" 《Failure,or Failover》" href="http://code.google.com/p/memcached/wiki/NewConfiguringClient#Failure,_or_Failover"> 《Failure,or Failover》</a>。
          <br /> 
          <br /> &nbsp;&nbsp;&nbsp; 展开来说，在某个memcached节点挂掉或者由于其他故障连接断开的时候，大部分客户端的默认策略都是failover的，也就是会查找下一个可用的memcached节点继续使用，挂掉或者连接不上的节点的数据会转移到其他节点上，路由的策略可以是Round Robin，也可以是一致性哈希。这样的模式在节点意外故障挂掉的情况下运行的很好，但是memached节点也完全可能因为一个意外的事故而
          <strong>短暂</strong>挂掉，比如你不小心弄掉了网线又马上接上去，比如机房交换机突然停电又立即恢复了，假设在故障前，用户A正要更新数据到节点A，节点A意外断开，那么这些数据就更新到下一个有效节点B，但是节点A又马上恢复，这时候用户又从节点A去读数据，读到却是更新前的老数据了（新数据更新到B节点去了），这种情况对用户来说就非常困惑，你告诉我更新成功，但是看到却还是更新前的数据。
          <br /> 
          <br /> &nbsp;&nbsp; 怎么解决呢？一个简单的方案就是所谓failure模式，当某个节点挂掉的时候，不会从节点列表移除，请求也不会转移到下一个有效节点，而是直接将请求置为失败，就刚才的场景来说，在用户更新数据到节点A的时候，节点A意外断开，那么用户的这次更新请求不会转移到节点B，而是直接告诉用户更新失败，用户再次查询数据则绕过节点A直接查询后端存储。这种模式很适合这种节点短暂不可用的状况，请求会穿透缓存到后端，但是避免了新旧数据的问题。
          <br /> &nbsp;&nbsp;&nbsp; Xmemcached 1.3将支持failure模式，只要你设置下failureMode为true即可，简单示例：
          <br /> 
          <br /> 
          <div style="background-color: #eeeeee; font-size: 13px; border: 1px solid #cccccc; padding: 4px 5px 4px 4px; width: 98%;">
           <!--<br />
<br />
Code highlighting produced by Actipro CodeHighlighter (freeware)<br />
http://www.CodeHighlighter.com/<br />
<br />
-->
           <span style="color: #000000;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; XMemcachedClientBuilder&nbsp;builder&nbsp;</span>
           <span style="color: #000000;">=</span>
           <span style="color: #000000;">……<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #008000;">//</span>
           <span style="color: #008000;">设置使用failure模式</span>
           <span style="color: #008000;"><br /> </span>
           <span style="color: #000000;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;builder.setFailureMode(</span>
           <span style="color: #0000ff;">true</span>
           <span style="color: #000000;">);</span>
          </div> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 在此模式下，某个节点挂掉的情况下，往这个节点的请求都将直接抛出MemcachedException的异常。
          <br /> 
          <br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 不仅如此，xmemcached 1.3还将引入standby node的概念，你可以设置某个memached节点的备份节点，当这个节点挂掉的时候会将请求转发给这个备份节点，不会简单地抛出异常，也不会转发给其他节点。要使用standby node，必须首先设置使用failure mode，一个例子：
          <br /> 
          <br /> 
          <div style="background-color: #eeeeee; font-size: 13px; border: 1px solid #cccccc; padding: 4px 5px 4px 4px; width: 98%;">
           <!--<br />
<br />
Code highlighting produced by Actipro CodeHighlighter (freeware)<br />
http://www.CodeHighlighter.com/<br />
<br />
-->
           <span style="color: #000000;">XMemcachedClientBuilder&nbsp;builder&nbsp;</span>
           <span style="color: #000000;">=</span>
           <span style="color: #000000;">&nbsp;</span>
           <span style="color: #0000ff;">new</span>
           <span style="color: #000000;">&nbsp;XMemcachedClientBuilder(AddrUtil<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.getAddressMap(</span>
           <span style="color: #000000;">&quot;</span>
           <span style="color: #000000;">192.168.1.99:11211,192.168.1.100:11211&nbsp;192.168.1.101:11211,192.168.1.102:11211</span>
           <span style="color: #000000;">&quot;</span>
           <span style="color: #000000;">));<br /> builder.setFailureMode(</span>
           <span style="color: #0000ff;">true</span>
           <span style="color: #000000;">);</span>
          </div> 
          <br /> &nbsp;&nbsp;&nbsp;&nbsp; 可以看到，新的服务器字符串格式变化为host:port,host:port host:port,host:port的格式，以空格隔开的是两个节点组成的一个分组，以逗号隔开的是主节点和备份节点，以上面的例子来说，我们设置客户端使用的节点是192.168.1.99和192.168.1.101，其中99对应的备份节点是100，而101的备份节点是102。并且我们需要设置使用failure mode为true。
          <br /> &nbsp;&nbsp;&nbsp; 
          <br /> &nbsp;&nbsp;&nbsp;&nbsp; Failure mode加上standby节点可以比较好的解决新旧数据的问题，并且也可以防止请求穿透缓存到DB，但是主备两个节点之间的数据同步，xmemcached不准备帮你做，我的建议是可以使用repcached这个patch做复制。
          <br /> &nbsp;&nbsp;&nbsp; 有的朋友可能希望，在使用备份节点之前先flush掉备份节点的数据，防止使用到老的数据，请求还是可以穿透缓存去DB查找，并存储到备份节点，我仔细考虑了这个方案，衡量之下还是不准备做自动flush，主要是并发上很难处理，并且flush数据这个事情可以手工来搞，根据我的经验，做的太透明太自动不一定是好事。你可以在主节点恢复之后，手工flush下备份节点的数据。
          <br /> 
          <br /> 
          <br /> &nbsp;&nbsp;&nbsp; 目前，xmemcached 1.3已经整装待发，对这些特性有兴趣的朋友可以先从
          <a href="http://code.google.com/p/xmemcached/source/checkout">svn下载源</a>码尝鲜，有任何改进的建议请发邮件给我。我的邮件地址在博客的右上角。
          <br /> 
          <br /> 
          <br /> 
          <br /> 
          <br /> 
          <br /> &nbsp;&nbsp; 
          <br />
         </div> 
         <p class="postfoot"> posted @ <a href="http://www.blogjava.net/killme2008/archive/2010/12/28/341731.html" title="permalink">2010-12-28 10:47</a> dennis 阅读(4296) | <a href="http://www.blogjava.net/killme2008/archive/2010/12/28/341731.html#FeedBack" title="comments, pingbacks, trackbacks">评论 (5)</a> |&nbsp;<a href="http://www.blogjava.net/killme2008/admin/EditPosts.aspx?postid=341731">编辑</a>&nbsp;<a href="http://www.blogjava.net/killme2008/AddToFavorite.aspx?id=341731">收藏</a> </p> 
        </div> 
        <div class="post" style="filter:progid:DXImageTransform.Microsoft.Shadow(color='Blue', Direction=135, Strength=32)"> 
         <div class="posthead"> 
          <h2 style="padding-top:4px; padding-bottom:4px;"><a id="ArchiveDay1_SingleDay_DayList_ctl72_TitleUrl" href="http://www.blogjava.net/killme2008/archive/2010/12/11/340361.html">我的第一个android练习</a></h2> 
         </div> 
         <div class="postbody">
          &nbsp;&nbsp;&nbsp; 最近没更新blog，因为我忙着写程序，玩android
          <img src="/CuteSoft_Client/CuteEditor/images/emteeth.gif" alt="" align="absmiddle" border="0" />。入手了一台moto xt701，下单后悔来想换里程碑，但是京东打包太快，客服不让换，这个很奇怪，我想用更多钱买东西反而被拒绝，看来京东处理太快也不一定是优点
          <img src="/CuteSoft_Client/CuteEditor/images/emteeth.gif" alt="" align="absmiddle" border="0" />。
          <br /> 
          <br /> &nbsp;&nbsp;&nbsp; 买了几本android相关的书，下决心好好学习一下，在读完一本加半本的情况下决定开始做个练习程序，最后的结果就是为乐天气这个小软件。为乐天气不仅仅是个烂大街的天气预报软件，它从google weather api抓取天气状况信息并显示在桌面widget，还提供了两个我个人很需要但还没有在其他天气软件上看到的功能：恶劣天气告警和气温变化告警――当有雨雪天气或者气温变化超过一定幅度的时候主动通知我，这对我这个常常不知道带伞并且家里有小孩的人比较有用。来几张运行在xt701上的截图：
          <br /> 
          <br /> 
          <img alt="" src="/images/blogjava_net/killme2008/device1.png" />
          <br /> 
          <br /> 
          <img alt="" src="/images/blogjava_net/killme2008/device2.png" />
          <br /> 
          <br /> 
          <img alt="" src="/images/blogjava_net/killme2008/device3.png" height="854" width="480" />
          <br /> &nbsp;&nbsp; 
          <br /> 
          <br /> &nbsp;&nbsp;&nbsp; 写程序总共花了3天，程序虽小，但基本上覆盖了android提供的一些基本机制：Activity显示组件、service负责信息抓取、桌面widget、通过intent在组件之间交互、handler处理界面更新、国际化和资源管理、利用preferences保存配置以及使用Application保存全局数据等等。Android开发给我的感觉是，入门还是相当容易的，如果熟悉Java甚至J2ME，那么学习android的入门成本还是很低的，因此从长期来看，做这一行的一般应用门槛不高，也会像现在的Java市场一样吸引大量开发者。如果说对独立开发者特别有价值的方向，应该还是游戏方向，做游戏不仅仅是技术，更多还是创意和推广，另外想在android做出效果非常出色的游戏，还需要去学习OpenGL和数学算法之类，需要熟悉c/c++，本质上跟传统的游戏开发没有太大区别，这个门槛就相对高一些。
          <br /> 
          <br /> &nbsp;&nbsp; 我将这个小程序发到了国内的几个market，从下载情况来看，尽管都非常少，但是91助手的应用汇还是最多，其次是安卓市场，再后面是爱米软件商店，从后台体验上来说，最好的还是eoeAndroid社区的优智市场，不过人气貌似不旺。
          <br /> &nbsp;&nbsp;&nbsp; 从我接触移动开发的这一周来看，我很兴奋，原来现在这个行业已经这么火热，有太多新鲜的东西我没有尝试过，有太多很有创意的小应用小游戏存在，有大量的开发者早就在从事这个激动人心的领域，我太out了，希望现在关注还来得及。
          <br />
         </div> 
         <p class="postfoot"> posted @ <a href="http://www.blogjava.net/killme2008/archive/2010/12/11/340361.html" title="permalink">2010-12-11 19:35</a> dennis 阅读(2454) | <a href="http://www.blogjava.net/killme2008/archive/2010/12/11/340361.html#FeedBack" title="comments, pingbacks, trackbacks">评论 (2)</a> |&nbsp;<a href="http://www.blogjava.net/killme2008/admin/EditPosts.aspx?postid=340361">编辑</a>&nbsp;<a href="http://www.blogjava.net/killme2008/AddToFavorite.aspx?id=340361">收藏</a> </p> 
        </div> 
        <div class="post" style="filter:progid:DXImageTransform.Microsoft.Shadow(color='Blue', Direction=135, Strength=32)"> 
         <div class="posthead"> 
          <h2 style="padding-top:4px; padding-bottom:4px;"><a id="ArchiveDay1_SingleDay_DayList_ctl73_TitleUrl" href="http://www.blogjava.net/killme2008/archive/2010/11/30/339386.html">HandlerSocket client for java――MySql as NoSQL</a></h2> 
         </div> 
         <div class="postbody">
          <br /> &nbsp;&nbsp;&nbsp; 
          <a href="https://github.com/ahiguti/HandlerSocket-Plugin-for-MySQL">HandlerSocket</a>是日本人 akira higuchi 写的一个MySql的插件，通过这个插件，你可以直接跟MySql后端的存储引擎做key-value式的交互，省去了MySql上层的SQL解释、打开关闭表、创建查询计划等CPU消耗型的开销，按照作者给出的数据可以在数据全部在内存的情况下可以达到75W的QPS查询。具体信息可以看这篇
          <a href="http://yoshinorimatsunobu.blogspot.com/2010/10/using-mysql-as-nosql-story-for.html?showComment=1287715880531#c2105763073739952882">Blog</a>，中文介绍可以看这篇文章《
          <a href="http://whitesock.javaeye.com/blog/811339">HandlerSocket in action</a>》。
          <br /> 
          <br /> &nbsp;&nbsp;&nbsp; 这个东西为什么让我很激动呢？首先性能是程序员的G点，一听高性能你不由地激动，其次，这也解决了缓存跟数据库的一致性问题，因为缓存就在数据库里面，第三，这个东西不仅仅是NoSQL，简单的CRUD你可以通过HandlerSocket，但是复杂的查询你仍然可以走MySql，完全符合我们应用的场景，并且从实际测试来看，性能确实非常优秀。但是呢，这个东西的代价也少不了，例如没有权限检查（未来可能添加）；不能启用MySql的查询缓存，否则会导致数据的不一致；
          <strike>
           协议设计也不合理，使用\t做分隔符，使用\n做换行符，那么你插入或者更新的字段数据就不能含有这些字符，否则行为将不如预期。
          </strike>
          <br /> 
          <br /> &nbsp;&nbsp; 
          <a href="https://github.com/ahiguti/HandlerSocket-Plugin-for-MySQL">HandlerSocket</a>有一个日本人的java客户端实现，我去尝试了下，结果发现这玩意完全不具实用性，封装的层次非常原始。因此我自己写了个新的客户端，这就是本文要介绍的HandlerSocket Client for Java，简称
          <a href="http://code.google.com/p/hs4j/">hs4j</a>，项目放在了
          <a href="http://code.google.com/p/hs4j/">googlecode</a>，代码的网络层复用xmemcached，重新实现了协议和上层接口，目前的状态完全可用，也希望有需要的朋友参与测试。
          <br /> 
          <br /> &nbsp;&nbsp; 项目地址：
          <a href="http://code.google.com/p/hs4j/">http://code.google.com/p/hs4j/</a>
          <br /> 
          <br /> &nbsp;&nbsp;&nbsp; HS4J的使用很简单，所有的操作都通过HSClient这个接口进行，如我们创建一个客户端对象：
          <br /> 
          <br /> 
          <div style="background-color: #eeeeee; font-size: 13px; border: 1px solid #cccccc; padding: 4px 5px 4px 4px; width: 98%;">
           <!--<br />
<br />
Code highlighting produced by Actipro CodeHighlighter (freeware)<br />
http://www.CodeHighlighter.com/<br />
<br />
-->
           <span style="color: #0000ff;">import</span>
           <span style="color: #000000;">&nbsp;com.google.code.hs4j.HSClient;<br /> </span>
           <span style="color: #0000ff;">import</span>
           <span style="color: #000000;">&nbsp;com.google.code.hs4j.impl.HSClientImpl;<br /> <br /> &nbsp;&nbsp;&nbsp;HSClient&nbsp;hsClient&nbsp;</span>
           <span style="color: #000000;">=</span>
           <span style="color: #000000;">&nbsp;</span>
           <span style="color: #0000ff;">new</span>
           <span style="color: #000000;">&nbsp;HSClientImpl(</span>
           <span style="color: #0000ff;">new</span>
           <span style="color: #000000;">&nbsp;InetSocketAddress(</span>
           <span style="color: #000000;">9999</span>
           <span style="color: #000000;">));</span>
          </div> 
          <br /> &nbsp;&nbsp; 假设HandlerSocket运行在本地的9999端口，默认的9998是只读的，9999才是允许读和写。HSClient是线程安全的。
          <br /> 
          <br /> &nbsp;&nbsp; 在执行操作前需要先open index：
          <br /> 
          <div style="background-color: #eeeeee; font-size: 13px; border: 1px solid #cccccc; padding: 4px 5px 4px 4px; width: 98%;">
           <!--<br />
<br />
Code highlighting produced by Actipro CodeHighlighter (freeware)<br />
http://www.CodeHighlighter.com/<br />
<br />
-->
           <span style="color: #0000ff;">import</span>
           <span style="color: #000000;">&nbsp;com.google.code.hs4j.IndexSession;<br /> <br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IndexSession&nbsp;session&nbsp;</span>
           <span style="color: #000000;">=</span>
           <span style="color: #000000;">&nbsp;hsClient.openIndexSession(db,&nbsp;table,<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #000000;">&quot;</span>
           <span style="color: #000000;">PRIMARY</span>
           <span style="color: #000000;">&quot;</span>
           <span style="color: #000000;">,&nbsp;columns);</span>
          </div> 
          <br /> &nbsp;&nbsp; 其中db是数据库名,table是表名，&quot;PRIMARY&quot;表示使用主键索引，columns是一个字符串数组代表你要查询的字段名称。这里没有指定indexid，默认会产生一个indexid，你也可以指定indexid，返回表示一次open-index会话对象，IndexSession同样是线程安全的。
          <br /> 
          <div style="background-color: #eeeeee; font-size: 13px; border: 1px solid #cccccc; padding: 4px 5px 4px 4px; width: 98%;">
           <!--<br />
<br />
Code highlighting produced by Actipro CodeHighlighter (freeware)<br />
http://www.CodeHighlighter.com/<br />
<br />
-->
           <span style="color: #000000;">IndexSession&nbsp;session&nbsp;</span>
           <span style="color: #000000;">=</span>
           <span style="color: #000000;">&nbsp;hsClient.openIndexSession(indexid,db,&nbsp;table,<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #000000;">&quot;</span>
           <span style="color: #000000;">PRIMARY</span>
           <span style="color: #000000;">&quot;</span>
           <span style="color: #000000;">,&nbsp;columns);</span>
          </div> 
          <br /> &nbsp;&nbsp; 查询操作通过find方法:
          <br /> 
          <div style="background-color: #eeeeee; font-size: 13px; border: 1px solid #cccccc; padding: 4px 5px 4px 4px; width: 98%;">
           <!--<br />
<br />
Code highlighting produced by Actipro CodeHighlighter (freeware)<br />
http://www.CodeHighlighter.com/<br />
<br />
-->
           <span style="color: #0000ff;">import</span>
           <span style="color: #000000;">&nbsp;java.sql.ResultSet;<br /> <br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000ff;">final</span>
           <span style="color: #000000;">&nbsp;String[]&nbsp;keys&nbsp;</span>
           <span style="color: #000000;">=</span>
           <span style="color: #000000;">&nbsp;{&nbsp;</span>
           <span style="color: #000000;">&quot;</span>
           <span style="color: #000000;">dennis</span>
           <span style="color: #000000;">&quot;</span>
           <span style="color: #000000;">,&nbsp;</span>
           <span style="color: #000000;">&quot;</span>
           <span style="color: #000000;">killme2008@gmail.com</span>
           <span style="color: #000000;">&quot;</span>
           <span style="color: #000000;">&nbsp;};<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ResultSet&nbsp;rs&nbsp;</span>
           <span style="color: #000000;">=</span>
           <span style="color: #000000;">&nbsp;session.find(keys);<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000ff;">while</span>
           <span style="color: #000000;">(rs.next()){<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String&nbsp;name</span>
           <span style="color: #000000;">=</span>
           <span style="color: #000000;">rs.getString(</span>
           <span style="color: #000000;">1</span>
           <span style="color: #000000;">);<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String&nbsp;mail</span>
           <span style="color: #000000;">=</span>
           <span style="color: #000000;">rs.getString(</span>
           <span style="color: #000000;">2</span>
           <span style="color: #000000;">);<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span>
          </div> 
          <br /> &nbsp;&nbsp; find返回的是java.sql.ResultSet，你完全可以像使用jdbc那样去操作结果集。当然我的简单实现并不符合JDBC规范，只实现了最常见的一些方法，如getStrng、getLong等。find(keys)方法默认使用的op是&quot;=&quot;。其他重载方法可以设置其他类型的op，统一封装为枚举类型FindOperator。
          <br /> 
          <br /> &nbsp;&nbsp; 更新操作：
          <br /> 
          <div style="background-color: #eeeeee; font-size: 13px; border: 1px solid #cccccc; padding: 4px 5px 4px 4px; width: 98%;">
           <!--<br />
<br />
Code highlighting produced by Actipro CodeHighlighter (freeware)<br />
http://www.CodeHighlighter.com/<br />
<br />
-->
           <span style="color: #0000ff;">import</span>
           <span style="color: #000000;">&nbsp;com.google.code.hs4j.FindOperator;<br /> <br /> &nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000ff;">int</span>
           <span style="color: #000000;">&nbsp;result</span>
           <span style="color: #000000;">=</span>
           <span style="color: #000000;">session.update(keys,&nbsp;</span>
           <span style="color: #0000ff;">new</span>
           <span style="color: #000000;">&nbsp;String[]&nbsp;{&nbsp;</span>
           <span style="color: #000000;">&quot;</span>
           <span style="color: #000000;">1</span>
           <span style="color: #000000;">&quot;</span>
           <span style="color: #000000;">,&nbsp;</span>
           <span style="color: #000000;">&quot;</span>
           <span style="color: #000000;">dennis</span>
           <span style="color: #000000;">&quot;</span>
           <span style="color: #000000;">,<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #000000;">&quot;</span>
           <span style="color: #000000;">test@163.com</span>
           <span style="color: #000000;">&quot;</span>
           <span style="color: #000000;">,&nbsp;</span>
           <span style="color: #000000;">&quot;</span>
           <span style="color: #000000;">109</span>
           <span style="color: #000000;">&quot;</span>
           <span style="color: #000000;">&nbsp;},&nbsp;FindOperator.EQ);</span>
          </div> 
          <br /> &nbsp;&nbsp; keys表示索引的字段列表对应的值数组，通过FindOperator.EQ比较这些值和索引，第二个参数values表示要更新的字段值，这些值跟你在open-index的时候传入的columns一一对应，最后返回作用的记录数。
          <br /> 
          <br /> &nbsp;&nbsp;&nbsp; 删除操作：
          <br /> 
          <div style="background-color: #eeeeee; font-size: 13px; border: 1px solid #cccccc; padding: 4px 5px 4px 4px; width: 98%;">
           <!--<br />
<br />
Code highlighting produced by Actipro CodeHighlighter (freeware)<br />
http://www.CodeHighlighter.com/<br />
<br />
-->
           <span style="color: #000000;">&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000ff;">int</span>
           <span style="color: #000000;">&nbsp;result</span>
           <span style="color: #000000;">=</span>
           <span style="color: #000000;">&nbsp;session.delete(</span>
           <span style="color: #0000ff;">new</span>
           <span style="color: #000000;">&nbsp;String[]&nbsp;{&nbsp;</span>
           <span style="color: #000000;">&quot;</span>
           <span style="color: #000000;">dennis</span>
           <span style="color: #000000;">&quot;</span>
           <span style="color: #000000;">&nbsp;},<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FindOperator.EQ)</span>
          </div> 
          <br /> &nbsp;&nbsp;&nbsp; HS4J同样支持连接池，可以在构建客户端的时候传入连接池大小：
          <br /> 
          <div style="background-color: #eeeeee; font-size: 13px; border: 1px solid #cccccc; padding: 4px 5px 4px 4px; width: 98%;">
           <!--<br />
<br />
Code highlighting produced by Actipro CodeHighlighter (freeware)<br />
http://www.CodeHighlighter.com/<br />
<br />
-->
           <span style="color: #000000;">&nbsp;&nbsp;</span>
           <span style="color: #008000;">//</span>
           <span style="color: #008000;">100-connections&nbsp;pool</span>
           <span style="color: #008000;"><br /> </span>
           <span style="color: #000000;">&nbsp;&nbsp;&nbsp;HSClient&nbsp;hsClient&nbsp;</span>
           <span style="color: #000000;">=</span>
           <span style="color: #000000;">&nbsp;</span>
           <span style="color: #0000ff;">new</span>
           <span style="color: #000000;">&nbsp;HSClientImpl(</span>
           <span style="color: #0000ff;">new</span>
           <span style="color: #000000;">&nbsp;InetSocketAddress(</span>
           <span style="color: #000000;">9999</span>
           <span style="color: #000000;">),</span>
           <span style="color: #000000;">100</span>
           <span style="color: #000000;">);</span>
          </div> 
          <br /> &nbsp;&nbsp; 在open index的时候，会在连接池里所有的连接上都open。并且在连接因为意外情况（如网络错误）断开的时候，HS4J会自动重连，并在重连成功的情况下自动发送已经open的index，保证应用的操作不受重连影响。
          <br /> 
          <br /> &nbsp;&nbsp;&nbsp; 因为HS4J是我在两天内写就的一个东西，可能还有不少隐藏的bug，并且HandlerSocket本身也是个新东西，如果有什么问题或者改进建议，随时欢迎告诉我，多谢。
          <br /> 
          <br /> 
          <br /> &nbsp;&nbsp; 
          <br /> &nbsp;&nbsp; 
          <br /> 
          <br />
         </div> 
         <p class="postfoot"> posted @ <a href="http://www.blogjava.net/killme2008/archive/2010/11/30/339386.html" title="permalink">2010-11-30 13:51</a> dennis 阅读(8707) | <a href="http://www.blogjava.net/killme2008/archive/2010/11/30/339386.html#FeedBack" title="comments, pingbacks, trackbacks">评论 (4)</a> |&nbsp;<a href="http://www.blogjava.net/killme2008/admin/EditPosts.aspx?postid=339386">编辑</a>&nbsp;<a href="http://www.blogjava.net/killme2008/AddToFavorite.aspx?id=339386">收藏</a> </p> 
        </div> 
        <div class="post" style="filter:progid:DXImageTransform.Microsoft.Shadow(color='Blue', Direction=135, Strength=32)"> 
         <div class="posthead"> 
          <h2 style="padding-top:4px; padding-bottom:4px;"><a id="ArchiveDay1_SingleDay_DayList_ctl74_TitleUrl" href="http://www.blogjava.net/killme2008/archive/2010/11/22/338420.html">Java NIO trick and trap</a></h2> 
         </div> 
         <div class="postbody">
          <br /> &nbsp;&nbsp;&nbsp;&nbsp; 上周在内部做的一个Java NIO框架的实现技巧和陷阱的分享，对编写NIO网络框架有兴趣的朋友可能有点帮助，上传slideshare.net一直出错，直接提供下载吧。
          <br /> &nbsp;&nbsp;&nbsp;&nbsp; 
          <br /> &nbsp;&nbsp;&nbsp;&nbsp; 下载地址：
          <a href="http://www.blogjava.net/Files/killme2008/NIO%20trick%20and%20trap.pdf.zip">Nio Trick and Trap.pdf.zip</a>
          <br /> 
          <br /> 
          <img alt="" src="/images/blogjava_net/killme2008/nio.png" height="576" width="808" />
          <br /> 
          <br /> 
          <br /> 
          <br />
         </div> 
         <p class="postfoot"> posted @ <a href="http://www.blogjava.net/killme2008/archive/2010/11/22/338420.html" title="permalink">2010-11-22 18:22</a> dennis 阅读(12546) | <a href="http://www.blogjava.net/killme2008/archive/2010/11/22/338420.html#FeedBack" title="comments, pingbacks, trackbacks">评论 (19)</a> |&nbsp;<a href="http://www.blogjava.net/killme2008/admin/EditPosts.aspx?postid=338420">编辑</a>&nbsp;<a href="http://www.blogjava.net/killme2008/AddToFavorite.aspx?id=338420">收藏</a> </p> 
        </div> 
        <div class="post" style="filter:progid:DXImageTransform.Microsoft.Shadow(color='Blue', Direction=135, Strength=32)"> 
         <div class="posthead"> 
          <h2 style="padding-top:4px; padding-bottom:4px;"><a id="ArchiveDay1_SingleDay_DayList_ctl75_TitleUrl" href="http://www.blogjava.net/killme2008/archive/2010/11/19/338504.html">对kilim nio模块的改进</a></h2> 
         </div> 
         <div class="postbody">
          <br /> &nbsp;&nbsp;&nbsp; 前段时间对kilim的当前版本做了一些改进，集中在nio调度器这一块。Kilim新版本引入了nio调度器，可以跟非阻塞IO结合在一起，从这个版本开始，kilim才真正具有实用性。协程只有跟非阻塞IO结合起来才能发挥威力啊。但是Kilim的默认的nio调度器还只是使用一个nio worker做调度，这跟现有的NIO框架采用多个nio worker来提升效率比较起来相对落伍。我改进了
          <a href="https://github.com/killme2008/kilim/blob/master/src/kilim/nio/NioSelectorScheduler.java">NioSelectorScheduler</a>，引入了类似Netty3的boss和woker的概念，boss负责连接接入，而worker负责连接的IO读写，并且默认设置worker数目为CPU个数的两倍。经过我的测试，改进后的NIO调度器的效率远远超过了现有的调度器，有兴趣可以用netty的benchmark跑一下example里的
          <a title="EchoServer" href="https://github.com/killme2008/kilim/blob/master/examples/kilim/examples/EchoServer.java">EchoServer</a>。
          <br /> 
          <br /> &nbsp;&nbsp;&nbsp; Kilim默认还提供了一个简易Http Server框架，但是没有提供Http Client的实现，我的另一个改进是提供了一个简易的Http Client实现，也是利用Ragel做协议解析，一个简单的使用例子如下：
          <br /> 
          <div style="background-color: #eeeeee; font-size: 13px; border: 1px solid #cccccc; padding: 4px 5px 4px 4px; width: 98%;">
           <!--<br />
<br />
Code highlighting produced by Actipro CodeHighlighter (freeware)<br />
http://www.CodeHighlighter.com/<br />
<br />
-->
           <span style="color: #0000ff;">package</span>
           <span style="color: #000000;">&nbsp;kilim.examples;<br /> <br /> </span>
           <span style="color: #0000ff;">import</span>
           <span style="color: #000000;">&nbsp;kilim.Pausable;<br /> </span>
           <span style="color: #0000ff;">import</span>
           <span style="color: #000000;">&nbsp;kilim.Task;<br /> </span>
           <span style="color: #0000ff;">import</span>
           <span style="color: #000000;">&nbsp;kilim.http.HttpClient;<br /> </span>
           <span style="color: #0000ff;">import</span>
           <span style="color: #000000;">&nbsp;kilim.http.HttpResponse;<br /> <br /> <br /> </span>
           <span style="color: #0000ff;">public</span>
           <span style="color: #000000;">&nbsp;</span>
           <span style="color: #0000ff;">class</span>
           <span style="color: #000000;">&nbsp;SimpleHttpClient&nbsp;{<br /> &nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000ff;">static</span>
           <span style="color: #000000;">&nbsp;</span>
           <span style="color: #0000ff;">class</span>
           <span style="color: #000000;">&nbsp;SimpleTask&nbsp;</span>
           <span style="color: #0000ff;">extends</span>
           <span style="color: #000000;">&nbsp;Task&nbsp;{<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@Override<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000ff;">public</span>
           <span style="color: #000000;">&nbsp;</span>
           <span style="color: #0000ff;">void</span>
           <span style="color: #000000;">&nbsp;execute()&nbsp;</span>
           <span style="color: #0000ff;">throws</span>
           <span style="color: #000000;">&nbsp;Pausable,&nbsp;Exception&nbsp;{<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpClient&nbsp;client&nbsp;</span>
           <span style="color: #000000;">=</span>
           <span style="color: #000000;">&nbsp;</span>
           <span style="color: #0000ff;">new</span>
           <span style="color: #000000;">&nbsp;HttpClient();<br /> <br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpResponse&nbsp;resp&nbsp;</span>
           <span style="color: #000000;">=</span>
           <span style="color: #000000;">&nbsp;client.get(</span>
           <span style="color: #000000;">&quot;</span>
           <span style="color: #000000;">http://www.google.com.hk/</span>
           <span style="color: #000000;">&quot;</span>
           <span style="color: #000000;">);<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;System.out.println(resp.status());<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;System.out.println(resp.content());<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br /> &nbsp;&nbsp;&nbsp;&nbsp;}<br /> <br /> <br /> &nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000ff;">public</span>
           <span style="color: #000000;">&nbsp;</span>
           <span style="color: #0000ff;">static</span>
           <span style="color: #000000;">&nbsp;</span>
           <span style="color: #0000ff;">void</span>
           <span style="color: #000000;">&nbsp;main(String[]&nbsp;args)&nbsp;{<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SimpleTask&nbsp;task&nbsp;</span>
           <span style="color: #000000;">=</span>
           <span style="color: #000000;">&nbsp;</span>
           <span style="color: #0000ff;">new</span>
           <span style="color: #000000;">&nbsp;SimpleTask();<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;task.start();<br /> &nbsp;&nbsp;&nbsp;&nbsp;}<br /> <br /> }<br /> </span>
          </div> 
          <br /> 
          <br /> &nbsp;&nbsp;&nbsp; 这个简陋的HttpClient目前只支持GET/POST，同时支持Http chunk编码（得益于kilim原有代码），做一些简单的HTTP调用已经足够。我尝试在一个项目里使用这个HttpClient去替代java默认的HttpURLConnection，效率有部分提升，但是同时由于大量协程存在占用了很大部分的内存，给GC也带来了不小的压力。
          <br /> 
          <br /> &nbsp;&nbsp;&nbsp; 我的代码直接从kilim的主干fork出来，有兴趣可以直接git clone下来玩玩,地址&nbsp;
          <a title="https://github.com/killme2008/kilim" href="https://github.com/killme2008/kilim"> https://github.com/killme2008/kilim</a>
          <br />
         </div> 
         <p class="postfoot"> posted @ <a href="http://www.blogjava.net/killme2008/archive/2010/11/19/338504.html" title="permalink">2010-11-19 18:40</a> dennis 阅读(3467) | <a href="http://www.blogjava.net/killme2008/archive/2010/11/19/338504.html#FeedBack" title="comments, pingbacks, trackbacks">评论 (3)</a> |&nbsp;<a href="http://www.blogjava.net/killme2008/admin/EditPosts.aspx?postid=338504">编辑</a>&nbsp;<a href="http://www.blogjava.net/killme2008/AddToFavorite.aspx?id=338504">收藏</a> </p> 
        </div> 
        <div class="post" style="filter:progid:DXImageTransform.Microsoft.Shadow(color='Blue', Direction=135, Strength=32)"> 
         <div class="posthead"> 
          <h2 style="padding-top:4px; padding-bottom:4px;"><a id="ArchiveDay1_SingleDay_DayList_ctl76_TitleUrl" href="http://www.blogjava.net/killme2008/archive/2010/11/11/337788.html">我的Java学习推荐书目</a></h2> 
         </div> 
         <div class="postbody">
          &nbsp; 
          <br /> &nbsp;&nbsp;&nbsp; 一直有这么个想法，列一下我个人认为在学习和使用Java过程中可以推荐一读的书籍，给初学者或者想深入的朋友一些建议，帮助成长。推荐的的都是我自己读过，也会推荐一些朋友读过并且口碑不错的书籍。
          <br /> 
          <br /> 一、基础类
          <br /> 1、《Thinking in java》，入门第一位是建立正确的概念。
          <br /> 2、《Core Java》，我没系统读过，这本书更贴近实践，更多API的介绍，同样，更新也更频繁。
          <br /> 
          <br /> 二、进阶类
          <br /> 1、《Effective Java》，在熟悉语法、API之后，你需要知道最佳实践和陷阱，没有比这本更好的。
          <br /> 2、《
          <span class="pl2">Java Puzzlers》，通过谜题介绍一些你可能没有注意到的边角料，作为趣味读物也不错<br /> 3、《深入Java虚拟机》，翻译一般，但不可不读，最好结合最新的JVM规范来读。<br /> <br /> 三、特定领域<br /> 1、网络编程：<br /> （1）</span> O'Reilly的《Java nio》，很多人都推荐，我个人觉的一般，基本上只是个API更详细的说明文档,O'reilly的java系列很多都是这样。
          <br /> （2）我更推荐这本《Fundamental networking in java》，由浅入深教你怎么做java网络编程，并且介绍很多背景知识，甚至介绍了各种最佳实践、网络编程模型以及Java socket在不同平台之间的差异等等。
          <br /> 
          <br /> 2、并发编程：
          <br /> （1）《
          <span class="pl2">Java Concurrency in Practic》，并发领域必读经典。<br /> （2）《Java并发编程：设计原则与模式》，同样是Doug lea的作品。<br /> （3) 《java threads》，入门读物。<br /> <br /> 3、web编程，这块我许久未接触了，就不推荐了，有兴趣的朋友可以补充下。<br /> <br /> 四、模式与设计<br /> <br /> 1、《设计模式》，GOF的经典。<br /> 2、《设计模式精解》，应该有最新版，个人认为更适合入门。<br /> 3、《Head first设计模式》，更轻松的入门读物。<br /> 4、《企业应用架构模式》<br /> 5、《分析模式――可复用对象模型》<br /> 6、《面向模式的软件体系结构》，国内貌似翻译了3卷，绝对经典，可惜翻译较差。<br /> 7、《重构――改善既有代码设计》,想写好代码必读。<br /> 8、《重构与模式》，给我印象很深的 xml构建的例子，在我的代码里应用到了。<br /> <br /> 五、方法论<br /> 1、《敏捷软件开发》<br /> 2、《测试驱动开发》，你不一定要TDD，但是你一定要学会做单元测试。<br /> 3、《Agile Java》，也可以作为java入门读物。<br /> 4、《快速软件开发》<br /> 5、《面向对象分析与设计》，OO设计必读。<br /> 6、《Unix编程艺术》，打开你的眼界。<br /> <br /> 六、Java之外<br /> 0、《代码大全》，编程的百科全书，必读。<br /> 1、《unix网络编程》，学习网络编程必读书。<br /> 2、《C++网络编程》上下两卷，介绍ACE的，但是其中对各种模式运用的介绍非常值的一读。<br /> 3、《Joel说软件》，编程文化<br /> 4、《人月神话》、《人件》<br /> 5、《卓有成效的程序员》，给我很大启发的一本书。<br /> 6、《程序员修炼之道》<br /> 7、《计算机程序的构造与解释》，必读<br /> 8、《算法导论》，可以作为参考书<br /> 9、《深入理解计算机系统》<br /> 10、《编译原理》龙书，最新版用java解释，我没有读完，顺便提下。<br /> <br /> <br /> <br /> </span>
          <br />
         </div> 
         <p class="postfoot"> posted @ <a href="http://www.blogjava.net/killme2008/archive/2010/11/11/337788.html" title="permalink">2010-11-11 11:13</a> dennis 阅读(20211) | <a href="http://www.blogjava.net/killme2008/archive/2010/11/11/337788.html#FeedBack" title="comments, pingbacks, trackbacks">评论 (12)</a> |&nbsp;<a href="http://www.blogjava.net/killme2008/admin/EditPosts.aspx?postid=337788">编辑</a>&nbsp;<a href="http://www.blogjava.net/killme2008/AddToFavorite.aspx?id=337788">收藏</a> </p> 
        </div> 
        <div class="post" style="filter:progid:DXImageTransform.Microsoft.Shadow(color='Blue', Direction=135, Strength=32)"> 
         <div class="posthead"> 
          <h2 style="padding-top:4px; padding-bottom:4px;"><a id="ArchiveDay1_SingleDay_DayList_ctl77_TitleUrl" href="http://www.blogjava.net/killme2008/archive/2010/11/03/337179.html">Kilim的小BUG</a></h2> 
         </div> 
         <div class="postbody">
          <br /> &nbsp;&nbsp;&nbsp; 我最近在实现一个基于Kilim的HttpClient，在处理响应body特别大的情形下遇到了kilim的一个BUG，有必要记录下。
          <br /> &nbsp;&nbsp;&nbsp; 问题是这样，Kilim将连接封装为EndPoint对象，EndPoint有个方法fill用于从管道读数据到缓冲区，并且可以指定希望至少读到多少个字节（atLeastN)才返回。那么在进入此方法的时候会判断缓冲区是否有足够空间容纳atLeastN个字节，如果没有，则创建一个更大的缓冲区，并将“老”的缓冲区的数据拷贝到新缓冲区，这部分代码是这样实现：
          <br /> 
          <div style="background-color: #eeeeee; font-size: 13px; border: 1px solid #cccccc; padding: 4px 5px 4px 4px; width: 98%;">
           <!--<br />
<br />
Code highlighting produced by Actipro CodeHighlighter (freeware)<br />
http://www.CodeHighlighter.com/<br />
<br />
-->
           <span style="color: #0000ff;">public</span>
           <span style="color: #000000;">&nbsp;ByteBuffer&nbsp;fill(ByteBuffer&nbsp;buf,&nbsp;</span>
           <span style="color: #0000ff;">int</span>
           <span style="color: #000000;">&nbsp;atleastN)&nbsp;</span>
           <span style="color: #0000ff;">throws</span>
           <span style="color: #000000;">&nbsp;IOException,&nbsp;Pausable&nbsp;{<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000ff;">if</span>
           <span style="color: #000000;">&nbsp;(buf.remaining()&nbsp;</span>
           <span style="color: #000000;">&lt;</span>
           <span style="color: #000000;">&nbsp;atleastN)&nbsp;{<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ByteBuffer&nbsp;newbb&nbsp;</span>
           <span style="color: #000000;">=</span>
           <span style="color: #000000;">&nbsp;ByteBuffer.allocate(Math.max(buf.capacity()&nbsp;</span>
           <span style="color: #000000;">*</span>
           <span style="color: #000000;">&nbsp;</span>
           <span style="color: #000000;">3</span>
           <span style="color: #000000;">&nbsp;</span>
           <span style="color: #000000;">/</span>
           <span style="color: #000000;">&nbsp;</span>
           <span style="color: #000000;">2</span>
           <span style="color: #000000;">,&nbsp;buf.position()&nbsp;</span>
           <span style="color: #000000;">+</span>
           <span style="color: #000000;">&nbsp;atleastN));<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;buf.rewind();<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;newbb.put(buf);<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;buf&nbsp;</span>
           <span style="color: #000000;">=</span>
           <span style="color: #000000;">&nbsp;newbb;<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;……<br /> }</span>
          </div> 
          <br /> &nbsp;&nbsp;&nbsp; 后面的代码我省略了，这个BUG就出现在这段代码里。这段代码的逻辑很简单，先是创建一个新的更大的缓冲区，然后将老的缓冲区的数据put到新的缓冲区，在put之前调用rewind方法将老的缓冲区的position设置为0。查看rewind干了什么：
          <br /> 
          <div style="background-color: #eeeeee; font-size: 13px; border: 1px solid #cccccc; padding: 4px 5px 4px 4px; width: 98%;">
           <!--<br />
<br />
Code highlighting produced by Actipro CodeHighlighter (freeware)<br />
http://www.CodeHighlighter.com/<br />
<br />
-->
           <span style="color: #000000;">&nbsp;</span>
           <span style="color: #0000ff;">public</span>
           <span style="color: #000000;">&nbsp;</span>
           <span style="color: #0000ff;">final</span>
           <span style="color: #000000;">&nbsp;Buffer&nbsp;rewind()&nbsp;{<br /> &nbsp;&nbsp;&nbsp;&nbsp;position&nbsp;</span>
           <span style="color: #000000;">=</span>
           <span style="color: #000000;">&nbsp;</span>
           <span style="color: #000000;">0</span>
           <span style="color: #000000;">;<br /> &nbsp;&nbsp;&nbsp;&nbsp;mark&nbsp;</span>
           <span style="color: #000000;">=</span>
           <span style="color: #000000;">&nbsp;</span>
           <span style="color: #000000;">-</span>
           <span style="color: #000000;">1</span>
           <span style="color: #000000;">;<br /> &nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000ff;">return</span>
           <span style="color: #000000;">&nbsp;</span>
           <span style="color: #0000ff;">this</span>
           <span style="color: #000000;">;<br /> &nbsp;&nbsp;&nbsp;&nbsp;}</span>
          </div> 
          <br /> &nbsp;&nbsp;&nbsp; 仅仅是将position设置为0，并让mark失效。position指向下一个读或者写的位置，这里在写入到新缓冲区之前确实需要将position设置为0，以便写入从老的缓冲区第一个位置开始。问题是什么？问题是position仅仅指定了下一个读取数据的位置，却没有指定有效数据的大小，换句话说，没有指定老的缓冲区的limit。因此这里造成的后果是老的缓冲区整个被写入到新的老缓冲区，包括有效数据和无效数据，默认情况下缓冲区的limit等于capacity。
          <br /> 
          <br /> &nbsp;&nbsp; 这个bug可以通过下面程序看出来：
          <br /> 
          <div style="background-color: #eeeeee; font-size: 13px; border: 1px solid #cccccc; padding: 4px 5px 4px 4px; width: 98%;">
           <!--<br />
<br />
Code highlighting produced by Actipro CodeHighlighter (freeware)<br />
http://www.CodeHighlighter.com/<br />
<br />
-->
           <span style="color: #000000;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ByteBuffer&nbsp;old&nbsp;</span>
           <span style="color: #000000;">=</span>
           <span style="color: #000000;">&nbsp;ByteBuffer.allocate(</span>
           <span style="color: #000000;">8</span>
           <span style="color: #000000;">);<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;old.putInt(</span>
           <span style="color: #000000;">99</span>
           <span style="color: #000000;">);<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ByteBuffer&nbsp;newBuf&nbsp;</span>
           <span style="color: #000000;">=</span>
           <span style="color: #000000;">&nbsp;ByteBuffer.allocate(</span>
           <span style="color: #000000;">16</span>
           <span style="color: #000000;">);<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;old.rewind();<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;newBuf.put(old);<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;newBuf.putInt(</span>
           <span style="color: #000000;">100</span>
           <span style="color: #000000;">);<br /> <br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;newBuf.flip();<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;System.out.println(newBuf.remaining());<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;System.out.println(newBuf.getInt());<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;System.out.println(newBuf.getInt());<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;System.out.println(newBuf.getInt());</span>
          </div> 
          <br /> &nbsp;&nbsp;&nbsp; 先往old写入一个整数99，然后创建newBuf并写入old数据，并再写入一个整数100，最后从newBuf读数据。本来我们预期只应该读到两个整数99和100，但是中间却插入一个0,输出如下：
          <br /> 
          <br /> 
          <div style="background-color: #eeeeee; font-size: 13px; border: 1px solid #cccccc; padding: 4px 5px 4px 4px; width: 98%;">
           <!--<br />
<br />
Code highlighting produced by Actipro CodeHighlighter (freeware)<br />
http://www.CodeHighlighter.com/<br />
<br />
-->
           <span style="color: #000000;">12</span>
           <span style="color: #000000;"><br /> </span>
           <span style="color: #000000;">99</span>
           <span style="color: #000000;"><br /> </span>
           <span style="color: #000000;">0</span>
           <span style="color: #000000;"><br /> </span>
           <span style="color: #000000;">100</span>
          </div> 
          <br /> &nbsp;&nbsp;&nbsp; 12表示缓冲区可读的数据，本来应该是8个字节，却多了4个字节的无效数据。
          <br /> 
          <br /> &nbsp;&nbsp;&nbsp;&nbsp; 这个BUG解决很简单，将rewind修改为flip方法即可，flip不仅将position设置为0，也将limit设置为当前位置：
          <br /> 
          <div style="background-color: #eeeeee; font-size: 13px; border: 1px solid #cccccc; padding: 4px 5px 4px 4px; width: 98%;">
           <!--<br />
<br />
Code highlighting produced by Actipro CodeHighlighter (freeware)<br />
http://www.CodeHighlighter.com/<br />
<br />
-->
           <span style="color: #000000;">&nbsp;&nbsp;</span>
           <span style="color: #0000ff;">public</span>
           <span style="color: #000000;">&nbsp;</span>
           <span style="color: #0000ff;">final</span>
           <span style="color: #000000;">&nbsp;Buffer&nbsp;flip()&nbsp;{<br /> &nbsp;&nbsp;&nbsp;&nbsp;limit&nbsp;</span>
           <span style="color: #000000;">=</span>
           <span style="color: #000000;">&nbsp;position;<br /> &nbsp;&nbsp;&nbsp;&nbsp;position&nbsp;</span>
           <span style="color: #000000;">=</span>
           <span style="color: #000000;">&nbsp;</span>
           <span style="color: #000000;">0</span>
           <span style="color: #000000;">;<br /> &nbsp;&nbsp;&nbsp;&nbsp;mark&nbsp;</span>
           <span style="color: #000000;">=</span>
           <span style="color: #000000;">&nbsp;</span>
           <span style="color: #000000;">-</span>
           <span style="color: #000000;">1</span>
           <span style="color: #000000;">;<br /> &nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000ff;">return</span>
           <span style="color: #000000;">&nbsp;</span>
           <span style="color: #0000ff;">this</span>
           <span style="color: #000000;">;<br /> &nbsp;&nbsp;&nbsp;&nbsp;}</span>
          </div> 
          <br /> 
          <br /> &nbsp;&nbsp;&nbsp; 修改上面的测试程序，符合我们的预期了：
          <br /> 
          <div style="background-color: #eeeeee; font-size: 13px; border: 1px solid #cccccc; padding: 4px 5px 4px 4px; width: 98%;">
           <!--<br />
<br />
Code highlighting produced by Actipro CodeHighlighter (freeware)<br />
http://www.CodeHighlighter.com/<br />
<br />
-->
           <span style="color: #000000;">&nbsp; &nbsp; &nbsp; &nbsp; ByteBuffer&nbsp;old&nbsp;</span>
           <span style="color: #000000;">=</span>
           <span style="color: #000000;">&nbsp;ByteBuffer.allocate(</span>
           <span style="color: #000000;">8</span>
           <span style="color: #000000;">);<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;old.putInt(</span>
           <span style="color: #000000;">99</span>
           <span style="color: #000000;">);<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ByteBuffer&nbsp;newBuf&nbsp;</span>
           <span style="color: #000000;">=</span>
           <span style="color: #000000;">&nbsp;ByteBuffer.allocate(</span>
           <span style="color: #000000;">16</span>
           <span style="color: #000000;">);<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;old.flip();<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;newBuf.put(old);<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;newBuf.putInt(</span>
           <span style="color: #000000;">100</span>
           <span style="color: #000000;">);<br /> <br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;newBuf.flip();<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;System.out.println(newBuf.remaining());<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;System.out.println(newBuf.getInt());<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;System.out.println(newBuf.getInt());;</span>
          </div> 
          <br /> &nbsp;&nbsp;&nbsp; 输出：
          <br /> 
          <div style="background-color: #eeeeee; font-size: 13px; border: 1px solid #cccccc; padding: 4px 5px 4px 4px; width: 98%;">
           <!--<br />
<br />
Code highlighting produced by Actipro CodeHighlighter (freeware)<br />
http://www.CodeHighlighter.com/<br />
<br />
-->
           <span style="color: #000000;">8</span>
           <span style="color: #000000;"><br /> </span>
           <span style="color: #000000;">99</span>
           <span style="color: #000000;"><br /> </span>
           <span style="color: #000000;">100</span>
          </div> 
          <br /> &nbsp;&nbsp;&nbsp; 总结，使用rewind的前提是limit已经正确设置，例如你将buffer写入成功并想记录这个buffer，可以使用rewind:
          <br /> 
          <div style="background-color: #eeeeee; font-size: 13px; border: 1px solid #cccccc; padding: 4px 5px 4px 4px; width: 98%;">
           <!--<br />
<br />
Code highlighting produced by Actipro CodeHighlighter (freeware)<br />
http://www.CodeHighlighter.com/<br />
<br />
-->
           <span style="color: #0000ff;">while</span>
           <span style="color: #000000;">&nbsp;(buffer.hasRemaining())&nbsp;</span>
           <span style="color: #008000;">//</span>
           <span style="color: #008000;">发送数据</span>
           <span style="color: #008000;"><br /> </span>
           <span style="color: #000000;">&nbsp; &nbsp; networkChannel.write(buffer);<br /> buffer.rewind();&nbsp;</span>
           <span style="color: #008000;">//</span>
           <span style="color: #008000;">&nbsp;重置buffer，准备写入日志管道</span>
           <span style="color: #008000;"><br /> </span>
           <span style="color: #0000ff;">while</span>
           <span style="color: #000000;">&nbsp;(buffer.hasRemaining())&nbsp;</span>
           <span style="color: #008000;">//</span>
           <span style="color: #008000;">&nbsp;写入日志</span>
           <span style="color: #008000;"><br /> </span>
           <span style="color: #000000;">&nbsp;&nbsp;&nbsp; loggerChannel.write(buffer);<br /> </span>
          </div> 
          <br /> &nbsp;&nbsp; 而flip用于缓冲区发送或者读取之前，也就是将缓冲区设置为等待传出状态。
          <br />
         </div> 
         <p class="postfoot"> posted @ <a href="http://www.blogjava.net/killme2008/archive/2010/11/03/337179.html" title="permalink">2010-11-03 23:22</a> dennis 阅读(2686) | <a href="http://www.blogjava.net/killme2008/archive/2010/11/03/337179.html#FeedBack" title="comments, pingbacks, trackbacks">评论 (2)</a> |&nbsp;<a href="http://www.blogjava.net/killme2008/admin/EditPosts.aspx?postid=337179">编辑</a>&nbsp;<a href="http://www.blogjava.net/killme2008/AddToFavorite.aspx?id=337179">收藏</a> </p> 
        </div> 
        <div class="post" style="filter:progid:DXImageTransform.Microsoft.Shadow(color='Blue', Direction=135, Strength=32)"> 
         <div class="posthead"> 
          <h2 style="padding-top:4px; padding-bottom:4px;"><a id="ArchiveDay1_SingleDay_DayList_ctl78_TitleUrl" href="http://www.blogjava.net/killme2008/archive/2010/11/02/336789.html">读某文有感</a></h2> 
         </div> 
         <div class="postbody">
          &nbsp;&nbsp;&nbsp; 这某文就是
          <a href="http://www.douban.com/note/98476055/">这篇文章</a>啦，咱也不废话，不遮掩。几点感想：
          <br /> 
          <br /> 1、首先，这篇文章很多的“我听说”、“据说“、我和……聊脱，他们都表示很郁闷“、“我就听说过一些……”诸如此类的道听途说，我觉的这不是“工程师”该说的话，请不要用可能，好像，听说这样的字眼，请给我数据，给我地点，给我程序。
          <br /> 
          <br /> 2、其次，文中作者提到的yahoo的优秀点，在淘宝我都发现了传承，我估计是学习yahoo中国的，比如发布流程、比如知识库、比如很有特色的技术大学培训、比如鼓励创建自动化工具等等，我不知道作者有没有在阿里集团的子公司待过，或者来淘宝待过，如果来过呆过，我想不会没看见。
          <br /> 
          <br /> 3、第三，Google是商业公司，百度是商业公司，阿里更是商业公司，没有销售人员的付出，工程师的劳动成果何以体现？你的薪水从哪里来？工程师文化或者销售文化，这不重要的，重要的是你能否认同，能否感受到尊重，不能可以用脚投票。
          <br /> 
          <br /> 4、个人感觉，阿里是非常富有理想主义的公司，点滴改变着我们的生活，不知不觉，淘宝、支付宝已经改变了很多人的生活。在我看来，这些都是很伟大的创造，伟大的“技术”，创造的社会效益显而易见。
          <br /> 
          <br /> 5、脱离商业的技术不存在，计算炮弹轨迹的需求诞生了计算机，美国国防部催生了互联网，网络购物的需要诞生了淘宝，在不健全的信用社会网络交易的需要诞生了支付宝。
          <br /> 
          <br /> 6、关于个人崇拜，你是成年人，你有自己的价值观，你有自己的世界观，如果你那么容易被人忽悠，那也是活该。
          <br /> 
          <br /> 7、如果哪天公司免费发淘公仔，我也去抢啊，哦，抢过一回口碑卡。
          <br /> 
          <br /> 8、以偏概全，会掩盖了很多人的努力工作。
          <br /> &nbsp;
          <br /> 
          <br /> 
          <br /> 
          <br />
         </div> 
         <p class="postfoot"> posted @ <a href="http://www.blogjava.net/killme2008/archive/2010/11/02/336789.html" title="permalink">2010-11-02 13:25</a> dennis 阅读(1862) | <a href="http://www.blogjava.net/killme2008/archive/2010/11/02/336789.html#FeedBack" title="comments, pingbacks, trackbacks">评论 (6)</a> |&nbsp;<a href="http://www.blogjava.net/killme2008/admin/EditPosts.aspx?postid=336789">编辑</a>&nbsp;<a href="http://www.blogjava.net/killme2008/AddToFavorite.aspx?id=336789">收藏</a> </p> 
        </div> 
        <div class="post" style="filter:progid:DXImageTransform.Microsoft.Shadow(color='Blue', Direction=135, Strength=32)"> 
         <div class="posthead"> 
          <h2 style="padding-top:4px; padding-bottom:4px;"><a id="ArchiveDay1_SingleDay_DayList_ctl79_TitleUrl" href="http://www.blogjava.net/killme2008/archive/2010/10/28/336357.html">一道面试题注记</a></h2> 
         </div> 
         <div class="postbody">
          &nbsp;&nbsp;&nbsp; 
          <br /> &nbsp;&nbsp;&nbsp; javaeye的一个帖子介绍一道
          <a href="http://www.javaeye.com/topic/795101">面试题</a>，取数组的最大元素和前n个大元素，取最大元素很简单，遍历即可。取前N大元素，可以利用排序，最简单的实现：
          <br /> 
          <br /> 
          <div style="background-color: #eeeeee; font-size: 13px; border: 1px solid #cccccc; padding: 4px 5px 4px 4px; width: 98%;">
           <span style="color: #000000;">&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000ff;">public</span>
           <span style="color: #000000;">&nbsp;</span>
           <span style="color: #0000ff;">static</span>
           <span style="color: #000000;">&nbsp;</span>
           <span style="color: #0000ff;">int</span>
           <span style="color: #000000;">[]&nbsp;findTopNValues(</span>
           <span style="color: #0000ff;">int</span>
           <span style="color: #000000;">[]&nbsp;anyOldOrderValues,&nbsp;</span>
           <span style="color: #0000ff;">int</span>
           <span style="color: #000000;">&nbsp;n)&nbsp;{<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Arrays.sort(anyOldOrderValues);<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000ff;">int</span>
           <span style="color: #000000;">[]&nbsp;result&nbsp;</span>
           <span style="color: #000000;">=</span>
           <span style="color: #000000;">&nbsp;</span>
           <span style="color: #0000ff;">new</span>
           <span style="color: #000000;">&nbsp;</span>
           <span style="color: #0000ff;">int</span>
           <span style="color: #000000;">[n];<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;System.arraycopy(anyOldOrderValues,&nbsp;anyOldOrderValues.length&nbsp;</span>
           <span style="color: #000000;">-</span>
           <span style="color: #000000;">&nbsp;n,<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result,&nbsp;</span>
           <span style="color: #000000;">0</span>
           <span style="color: #000000;">,&nbsp;n);<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000ff;">return</span>
           <span style="color: #000000;">&nbsp;result;<br /> &nbsp;&nbsp;&nbsp;&nbsp;}<br /> </span>
          </div> &nbsp;&nbsp;&nbsp; 
          <br /> &nbsp;&nbsp;&nbsp;&nbsp; Arrays.sort(int[])使用的是快排，平均的时间复杂度是O( n lg(n))，在一般情况下已经足够好。那么有没有平均情况下O(n)复杂度的算法？这个还是有的，这道题目其实是选择算法的变形，选择一个数组中的第n大元素，可以采用类似快排的方式划分数组，然后只要在一个子段做递归查找就可以，平均状况下可以做到O(n)的时间复杂度，对于这道题来说稍微变形下算法即可解决：
          <span style="color: #000000;"><br /> <br /> </span> 
          <div style="background-color: #eeeeee; font-size: 13px; border: 1px solid #cccccc; padding: 4px 5px 4px 4px; width: 98%;">
           <!--<br />
<br />
Code highlighting produced by Actipro CodeHighlighter (freeware)<br />
http://www.CodeHighlighter.com/<br />
<br />
-->
           <span style="color: #000000;">&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #008000;">/**</span>
           <span style="color: #008000;"><br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;求数组的前n个元素<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;</span>
           <span style="color: #808080;">@param</span>
           <span style="color: #008000;">&nbsp;anyOldOrderValues<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;</span>
           <span style="color: #808080;">@param</span>
           <span style="color: #008000;">&nbsp;n<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;</span>
           <span style="color: #808080;">@return</span>
           <span style="color: #008000;"><br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #008000;">*/</span>
           <span style="color: #000000;"><br /> &nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000ff;">public</span>
           <span style="color: #000000;">&nbsp;</span>
           <span style="color: #0000ff;">static</span>
           <span style="color: #000000;">&nbsp;</span>
           <span style="color: #0000ff;">int</span>
           <span style="color: #000000;">[]&nbsp;findTopNValues(</span>
           <span style="color: #0000ff;">int</span>
           <span style="color: #000000;">[]&nbsp;anyOldOrderValues,&nbsp;</span>
           <span style="color: #0000ff;">int</span>
           <span style="color: #000000;">&nbsp;n)&nbsp;{<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000ff;">int</span>
           <span style="color: #000000;">[]&nbsp;result&nbsp;</span>
           <span style="color: #000000;">=</span>
           <span style="color: #000000;">&nbsp;</span>
           <span style="color: #0000ff;">new</span>
           <span style="color: #000000;">&nbsp;</span>
           <span style="color: #0000ff;">int</span>
           <span style="color: #000000;">[n];<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;findTopNValues(anyOldOrderValues,&nbsp;</span>
           <span style="color: #000000;">0</span>
           <span style="color: #000000;">,&nbsp;anyOldOrderValues.length&nbsp;</span>
           <span style="color: #000000;">-</span>
           <span style="color: #000000;">&nbsp;</span>
           <span style="color: #000000;">1</span>
           <span style="color: #000000;">,&nbsp;n,<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;n,&nbsp;result);<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000ff;">return</span>
           <span style="color: #000000;">&nbsp;result;<br /> &nbsp;&nbsp;&nbsp;&nbsp;}<br /> <br /> &nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000ff;">public</span>
           <span style="color: #000000;">&nbsp;</span>
           <span style="color: #0000ff;">static</span>
           <span style="color: #000000;">&nbsp;</span>
           <span style="color: #0000ff;">final</span>
           <span style="color: #000000;">&nbsp;</span>
           <span style="color: #0000ff;">void</span>
           <span style="color: #000000;">&nbsp;findTopNValues(</span>
           <span style="color: #0000ff;">int</span>
           <span style="color: #000000;">[]&nbsp;a,&nbsp;</span>
           <span style="color: #0000ff;">int</span>
           <span style="color: #000000;">&nbsp;p,&nbsp;</span>
           <span style="color: #0000ff;">int</span>
           <span style="color: #000000;">&nbsp;r,&nbsp;</span>
           <span style="color: #0000ff;">int</span>
           <span style="color: #000000;">&nbsp;i,<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000ff;">int</span>
           <span style="color: #000000;">&nbsp;n,&nbsp;</span>
           <span style="color: #0000ff;">int</span>
           <span style="color: #000000;">[]&nbsp;result)&nbsp;{<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #008000;">//</span>
           <span style="color: #008000;">&nbsp;全部取到，直接返回</span>
           <span style="color: #008000;"><br /> </span>
           <span style="color: #000000;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000ff;">if</span>
           <span style="color: #000000;">&nbsp;(i&nbsp;</span>
           <span style="color: #000000;">==</span>
           <span style="color: #000000;">&nbsp;</span>
           <span style="color: #000000;">0</span>
           <span style="color: #000000;">)<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000ff;">return</span>
           <span style="color: #000000;">;<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #008000;">//</span>
           <span style="color: #008000;">&nbsp;只剩一个元素，拷贝到目标数组</span>
           <span style="color: #008000;"><br /> </span>
           <span style="color: #000000;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000ff;">if</span>
           <span style="color: #000000;">&nbsp;(p&nbsp;</span>
           <span style="color: #000000;">==</span>
           <span style="color: #000000;">&nbsp;r)&nbsp;{<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;System.arraycopy(a,&nbsp;p,&nbsp;result,&nbsp;n&nbsp;</span>
           <span style="color: #000000;">-</span>
           <span style="color: #000000;">&nbsp;i,&nbsp;i);<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000ff;">return</span>
           <span style="color: #000000;">;<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000ff;">int</span>
           <span style="color: #000000;">&nbsp;len&nbsp;</span>
           <span style="color: #000000;">=</span>
           <span style="color: #000000;">&nbsp;r&nbsp;</span>
           <span style="color: #000000;">-</span>
           <span style="color: #000000;">&nbsp;p&nbsp;</span>
           <span style="color: #000000;">+</span>
           <span style="color: #000000;">&nbsp;</span>
           <span style="color: #000000;">1</span>
           <span style="color: #000000;">;<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000ff;">if</span>
           <span style="color: #000000;">&nbsp;(i&nbsp;</span>
           <span style="color: #000000;">&gt;</span>
           <span style="color: #000000;">&nbsp;len&nbsp;</span>
           <span style="color: #000000;">||</span>
           <span style="color: #000000;">&nbsp;i&nbsp;</span>
           <span style="color: #000000;">&lt;</span>
           <span style="color: #000000;">&nbsp;</span>
           <span style="color: #000000;">0</span>
           <span style="color: #000000;">)<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000ff;">throw</span>
           <span style="color: #000000;">&nbsp;</span>
           <span style="color: #0000ff;">new</span>
           <span style="color: #000000;">&nbsp;IllegalArgumentException();<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #008000;">//</span>
           <span style="color: #008000;">&nbsp;if&nbsp;(len&nbsp;&lt;&nbsp;7)&nbsp;{<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #008000;">//</span>
           <span style="color: #008000;">&nbsp;Arrays.sort(a,&nbsp;p,&nbsp;r+1);<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #008000;">//</span>
           <span style="color: #008000;">&nbsp;System.arraycopy(a,&nbsp;r&nbsp;-&nbsp;i+1&nbsp;,&nbsp;result,&nbsp;n&nbsp;-&nbsp;i,&nbsp;i);<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #008000;">//</span>
           <span style="color: #008000;">&nbsp;return;<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #008000;">//</span>
           <span style="color: #008000;">&nbsp;}<br /> <br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #008000;">//</span>
           <span style="color: #008000;">&nbsp;划分</span>
           <span style="color: #008000;"><br /> </span>
           <span style="color: #000000;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000ff;">int</span>
           <span style="color: #000000;">&nbsp;q&nbsp;</span>
           <span style="color: #000000;">=</span>
           <span style="color: #000000;">&nbsp;medPartition(a,&nbsp;p,&nbsp;r);<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #008000;">//</span>
           <span style="color: #008000;">&nbsp;计算右子段长度</span>
           <span style="color: #008000;"><br /> </span>
           <span style="color: #000000;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000ff;">int</span>
           <span style="color: #000000;">&nbsp;k&nbsp;</span>
           <span style="color: #000000;">=</span>
           <span style="color: #000000;">&nbsp;r&nbsp;</span>
           <span style="color: #000000;">-</span>
           <span style="color: #000000;">&nbsp;q&nbsp;</span>
           <span style="color: #000000;">+</span>
           <span style="color: #000000;">&nbsp;</span>
           <span style="color: #000000;">1</span>
           <span style="color: #000000;">;<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #008000;">//</span>
           <span style="color: #008000;">&nbsp;右子段长度恰好等于i</span>
           <span style="color: #008000;"><br /> </span>
           <span style="color: #000000;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000ff;">if</span>
           <span style="color: #000000;">&nbsp;(i&nbsp;</span>
           <span style="color: #000000;">==</span>
           <span style="color: #000000;">&nbsp;k)&nbsp;{<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #008000;">//</span>
           <span style="color: #008000;">&nbsp;拷贝右子段到结果数组，返回</span>
           <span style="color: #008000;"><br /> </span>
           <span style="color: #000000;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;System.arraycopy(a,&nbsp;q,&nbsp;result,&nbsp;n&nbsp;</span>
           <span style="color: #000000;">-</span>
           <span style="color: #000000;">&nbsp;i,&nbsp;i);<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000ff;">return</span>
           <span style="color: #000000;">;<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;</span>
           <span style="color: #0000ff;">else</span>
           <span style="color: #000000;">&nbsp;</span>
           <span style="color: #0000ff;">if</span>
           <span style="color: #000000;">&nbsp;(k&nbsp;</span>
           <span style="color: #000000;">&gt;</span>
           <span style="color: #000000;">&nbsp;i)&nbsp;{<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #008000;">//</span>
           <span style="color: #008000;">&nbsp;右子段比i长，递归到右子段求前i个元素</span>
           <span style="color: #008000;"><br /> </span>
           <span style="color: #000000;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;findTopNValues(a,&nbsp;q&nbsp;</span>
           <span style="color: #000000;">+</span>
           <span style="color: #000000;">&nbsp;</span>
           <span style="color: #000000;">1</span>
           <span style="color: #000000;">,&nbsp;r,&nbsp;i,&nbsp;n,&nbsp;result);<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;</span>
           <span style="color: #0000ff;">else</span>
           <span style="color: #000000;">&nbsp;{<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #008000;">//</span>
           <span style="color: #008000;">&nbsp;右子段比i短，拷贝右子段到结果数组，递归左子段求前i-k个元素</span>
           <span style="color: #008000;"><br /> </span>
           <span style="color: #000000;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;System.arraycopy(a,&nbsp;q,&nbsp;result,&nbsp;n&nbsp;</span>
           <span style="color: #000000;">-</span>
           <span style="color: #000000;">&nbsp;i,&nbsp;k);<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;findTopNValues(a,&nbsp;p,&nbsp;q&nbsp;</span>
           <span style="color: #000000;">-</span>
           <span style="color: #000000;">&nbsp;</span>
           <span style="color: #000000;">1</span>
           <span style="color: #000000;">,&nbsp;i&nbsp;</span>
           <span style="color: #000000;">-</span>
           <span style="color: #000000;">&nbsp;k,&nbsp;n,&nbsp;result);<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br /> &nbsp;&nbsp;&nbsp;&nbsp;}<br /> <br /> &nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000ff;">public</span>
           <span style="color: #000000;">&nbsp;</span>
           <span style="color: #0000ff;">static</span>
           <span style="color: #000000;">&nbsp;</span>
           <span style="color: #0000ff;">int</span>
           <span style="color: #000000;">&nbsp;medPartition(</span>
           <span style="color: #0000ff;">int</span>
           <span style="color: #000000;">&nbsp;x[],&nbsp;</span>
           <span style="color: #0000ff;">int</span>
           <span style="color: #000000;">&nbsp;p,&nbsp;</span>
           <span style="color: #0000ff;">int</span>
           <span style="color: #000000;">&nbsp;r)&nbsp;{<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000ff;">int</span>
           <span style="color: #000000;">&nbsp;len&nbsp;</span>
           <span style="color: #000000;">=</span>
           <span style="color: #000000;">&nbsp;r&nbsp;</span>
           <span style="color: #000000;">-</span>
           <span style="color: #000000;">&nbsp;p&nbsp;</span>
           <span style="color: #000000;">+</span>
           <span style="color: #000000;">&nbsp;</span>
           <span style="color: #000000;">1</span>
           <span style="color: #000000;">;<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000ff;">int</span>
           <span style="color: #000000;">&nbsp;m&nbsp;</span>
           <span style="color: #000000;">=</span>
           <span style="color: #000000;">&nbsp;p&nbsp;</span>
           <span style="color: #000000;">+</span>
           <span style="color: #000000;">&nbsp;(len&nbsp;</span>
           <span style="color: #000000;">&gt;&gt;</span>
           <span style="color: #000000;">&nbsp;</span>
           <span style="color: #000000;">1</span>
           <span style="color: #000000;">);<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000ff;">if</span>
           <span style="color: #000000;">&nbsp;(len&nbsp;</span>
           <span style="color: #000000;">&gt;</span>
           <span style="color: #000000;">&nbsp;</span>
           <span style="color: #000000;">7</span>
           <span style="color: #000000;">)&nbsp;{<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000ff;">int</span>
           <span style="color: #000000;">&nbsp;l&nbsp;</span>
           <span style="color: #000000;">=</span>
           <span style="color: #000000;">&nbsp;p;<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000ff;">int</span>
           <span style="color: #000000;">&nbsp;n&nbsp;</span>
           <span style="color: #000000;">=</span>
           <span style="color: #000000;">&nbsp;r;<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000ff;">if</span>
           <span style="color: #000000;">&nbsp;(len&nbsp;</span>
           <span style="color: #000000;">&gt;</span>
           <span style="color: #000000;">&nbsp;</span>
           <span style="color: #000000;">40</span>
           <span style="color: #000000;">)&nbsp;{&nbsp;</span>
           <span style="color: #008000;">//</span>
           <span style="color: #008000;">&nbsp;Big&nbsp;arrays,&nbsp;pseudomedian&nbsp;of&nbsp;9</span>
           <span style="color: #008000;"><br /> </span>
           <span style="color: #000000;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000ff;">int</span>
           <span style="color: #000000;">&nbsp;s&nbsp;</span>
           <span style="color: #000000;">=</span>
           <span style="color: #000000;">&nbsp;len&nbsp;</span>
           <span style="color: #000000;">/</span>
           <span style="color: #000000;">&nbsp;</span>
           <span style="color: #000000;">8</span>
           <span style="color: #000000;">;<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;l&nbsp;</span>
           <span style="color: #000000;">=</span>
           <span style="color: #000000;">&nbsp;med3(x,&nbsp;l,&nbsp;l&nbsp;</span>
           <span style="color: #000000;">+</span>
           <span style="color: #000000;">&nbsp;s,&nbsp;l&nbsp;</span>
           <span style="color: #000000;">+</span>
           <span style="color: #000000;">&nbsp;</span>
           <span style="color: #000000;">2</span>
           <span style="color: #000000;">&nbsp;</span>
           <span style="color: #000000;">*</span>
           <span style="color: #000000;">&nbsp;s);<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;m&nbsp;</span>
           <span style="color: #000000;">=</span>
           <span style="color: #000000;">&nbsp;med3(x,&nbsp;m&nbsp;</span>
           <span style="color: #000000;">-</span>
           <span style="color: #000000;">&nbsp;s,&nbsp;m,&nbsp;m&nbsp;</span>
           <span style="color: #000000;">+</span>
           <span style="color: #000000;">&nbsp;s);<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;n&nbsp;</span>
           <span style="color: #000000;">=</span>
           <span style="color: #000000;">&nbsp;med3(x,&nbsp;n&nbsp;</span>
           <span style="color: #000000;">-</span>
           <span style="color: #000000;">&nbsp;</span>
           <span style="color: #000000;">2</span>
           <span style="color: #000000;">&nbsp;</span>
           <span style="color: #000000;">*</span>
           <span style="color: #000000;">&nbsp;s,&nbsp;n&nbsp;</span>
           <span style="color: #000000;">-</span>
           <span style="color: #000000;">&nbsp;s,&nbsp;n);<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;m&nbsp;</span>
           <span style="color: #000000;">=</span>
           <span style="color: #000000;">&nbsp;med3(x,&nbsp;l,&nbsp;m,&nbsp;n);&nbsp;</span>
           <span style="color: #008000;">//</span>
           <span style="color: #008000;">&nbsp;Mid-size,&nbsp;med&nbsp;of&nbsp;3</span>
           <span style="color: #008000;"><br /> </span>
           <span style="color: #000000;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000ff;">if</span>
           <span style="color: #000000;">&nbsp;(m&nbsp;</span>
           <span style="color: #000000;">!=</span>
           <span style="color: #000000;">&nbsp;r)&nbsp;{<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000ff;">int</span>
           <span style="color: #000000;">&nbsp;temp&nbsp;</span>
           <span style="color: #000000;">=</span>
           <span style="color: #000000;">&nbsp;x[m];<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;x[m]&nbsp;</span>
           <span style="color: #000000;">=</span>
           <span style="color: #000000;">&nbsp;x[r];<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;x[r]&nbsp;</span>
           <span style="color: #000000;">=</span>
           <span style="color: #000000;">&nbsp;temp;<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000ff;">return</span>
           <span style="color: #000000;">&nbsp;partition(x,&nbsp;p,&nbsp;r);<br /> &nbsp;&nbsp;&nbsp;&nbsp;}<br /> <br /> &nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000ff;">private</span>
           <span style="color: #000000;">&nbsp;</span>
           <span style="color: #0000ff;">static</span>
           <span style="color: #000000;">&nbsp;</span>
           <span style="color: #0000ff;">int</span>
           <span style="color: #000000;">&nbsp;med3(</span>
           <span style="color: #0000ff;">int</span>
           <span style="color: #000000;">&nbsp;x[],&nbsp;</span>
           <span style="color: #0000ff;">int</span>
           <span style="color: #000000;">&nbsp;a,&nbsp;</span>
           <span style="color: #0000ff;">int</span>
           <span style="color: #000000;">&nbsp;b,&nbsp;</span>
           <span style="color: #0000ff;">int</span>
           <span style="color: #000000;">&nbsp;c)&nbsp;{<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000ff;">return</span>
           <span style="color: #000000;">&nbsp;x[a]&nbsp;</span>
           <span style="color: #000000;">&lt;</span>
           <span style="color: #000000;">&nbsp;x[b]&nbsp;</span>
           <span style="color: #000000;">?</span>
           <span style="color: #000000;">&nbsp;(x[b]&nbsp;</span>
           <span style="color: #000000;">&lt;</span>
           <span style="color: #000000;">&nbsp;x[c]&nbsp;</span>
           <span style="color: #000000;">?</span>
           <span style="color: #000000;">&nbsp;b&nbsp;:&nbsp;x[a]&nbsp;</span>
           <span style="color: #000000;">&lt;</span>
           <span style="color: #000000;">&nbsp;x[c]&nbsp;</span>
           <span style="color: #000000;">?</span>
           <span style="color: #000000;">&nbsp;c&nbsp;:&nbsp;a)<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;x[b]&nbsp;</span>
           <span style="color: #000000;">&gt;</span>
           <span style="color: #000000;">&nbsp;x[c]&nbsp;</span>
           <span style="color: #000000;">?</span>
           <span style="color: #000000;">&nbsp;b&nbsp;:&nbsp;x[a]&nbsp;</span>
           <span style="color: #000000;">&gt;</span>
           <span style="color: #000000;">&nbsp;x[c]&nbsp;</span>
           <span style="color: #000000;">?</span>
           <span style="color: #000000;">&nbsp;c&nbsp;:&nbsp;a;<br /> &nbsp;&nbsp;&nbsp;&nbsp;}<br /> <br /> &nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000ff;">public</span>
           <span style="color: #000000;">&nbsp;</span>
           <span style="color: #0000ff;">static</span>
           <span style="color: #000000;">&nbsp;</span>
           <span style="color: #0000ff;">void</span>
           <span style="color: #000000;">&nbsp;swap(</span>
           <span style="color: #0000ff;">int</span>
           <span style="color: #000000;">[]&nbsp;a,&nbsp;</span>
           <span style="color: #0000ff;">int</span>
           <span style="color: #000000;">&nbsp;i,&nbsp;</span>
           <span style="color: #0000ff;">int</span>
           <span style="color: #000000;">&nbsp;j)&nbsp;{<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000ff;">int</span>
           <span style="color: #000000;">&nbsp;temp&nbsp;</span>
           <span style="color: #000000;">=</span>
           <span style="color: #000000;">&nbsp;a[i];<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;a[i]&nbsp;</span>
           <span style="color: #000000;">=</span>
           <span style="color: #000000;">&nbsp;a[j];<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;a[j]&nbsp;</span>
           <span style="color: #000000;">=</span>
           <span style="color: #000000;">&nbsp;temp;<br /> &nbsp;&nbsp;&nbsp;&nbsp;}<br /> <br /> &nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000ff;">public</span>
           <span style="color: #000000;">&nbsp;</span>
           <span style="color: #0000ff;">static</span>
           <span style="color: #000000;">&nbsp;</span>
           <span style="color: #0000ff;">int</span>
           <span style="color: #000000;">&nbsp;partition(</span>
           <span style="color: #0000ff;">int</span>
           <span style="color: #000000;">&nbsp;a[],&nbsp;</span>
           <span style="color: #0000ff;">int</span>
           <span style="color: #000000;">&nbsp;p,&nbsp;</span>
           <span style="color: #0000ff;">int</span>
           <span style="color: #000000;">&nbsp;r)&nbsp;{<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000ff;">int</span>
           <span style="color: #000000;">&nbsp;x&nbsp;</span>
           <span style="color: #000000;">=</span>
           <span style="color: #000000;">&nbsp;a[r];<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000ff;">int</span>
           <span style="color: #000000;">&nbsp;m&nbsp;</span>
           <span style="color: #000000;">=</span>
           <span style="color: #000000;">&nbsp;p&nbsp;</span>
           <span style="color: #000000;">-</span>
           <span style="color: #000000;">&nbsp;</span>
           <span style="color: #000000;">1</span>
           <span style="color: #000000;">;<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000ff;">int</span>
           <span style="color: #000000;">&nbsp;j&nbsp;</span>
           <span style="color: #000000;">=</span>
           <span style="color: #000000;">&nbsp;r;<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000ff;">while</span>
           <span style="color: #000000;">&nbsp;(</span>
           <span style="color: #0000ff;">true</span>
           <span style="color: #000000;">)&nbsp;{<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000ff;">do</span>
           <span style="color: #000000;">&nbsp;{<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;j</span>
           <span style="color: #000000;">--</span>
           <span style="color: #000000;">;<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;</span>
           <span style="color: #0000ff;">while</span>
           <span style="color: #000000;">&nbsp;(j</span>
           <span style="color: #000000;">&gt;=</span>
           <span style="color: #000000;">p</span>
           <span style="color: #000000;">&amp;&amp;</span>
           <span style="color: #000000;">a[j]&nbsp;</span>
           <span style="color: #000000;">&gt;</span>
           <span style="color: #000000;">&nbsp;x);<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000ff;">do</span>
           <span style="color: #000000;">&nbsp;{<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;m</span>
           <span style="color: #000000;">++</span>
           <span style="color: #000000;">;<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;</span>
           <span style="color: #0000ff;">while</span>
           <span style="color: #000000;">&nbsp;(a[m]&nbsp;</span>
           <span style="color: #000000;">&lt;</span>
           <span style="color: #000000;">&nbsp;x);<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000ff;">if</span>
           <span style="color: #000000;">&nbsp;(j&nbsp;</span>
           <span style="color: #000000;">&lt;</span>
           <span style="color: #000000;">&nbsp;m)<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000ff;">break</span>
           <span style="color: #000000;">;<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;swap(a,&nbsp;m,&nbsp;j);<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;swap(a,&nbsp;r,&nbsp;j&nbsp;</span>
           <span style="color: #000000;">+</span>
           <span style="color: #000000;">&nbsp;</span>
           <span style="color: #000000;">1</span>
           <span style="color: #000000;">);<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000ff;">return</span>
           <span style="color: #000000;">&nbsp;j&nbsp;</span>
           <span style="color: #000000;">+</span>
           <span style="color: #000000;">&nbsp;</span>
           <span style="color: #000000;">1</span>
           <span style="color: #000000;">;<br /> &nbsp;&nbsp;&nbsp;&nbsp;}<br /> </span>
          </div> &nbsp;选择算法还有最坏情况下O(n)复杂度的实现，有兴趣可以读算法导论和
          <a href="http://en.wikipedia.org/wiki/Selection_algorithm">维基百科</a>。题外，我测试了下这两个实现，在我的机器上大概有2倍多的差距，还是很明显。
          <br /> 
          <br />
         </div> 
         <p class="postfoot"> posted @ <a href="http://www.blogjava.net/killme2008/archive/2010/10/28/336357.html" title="permalink">2010-10-28 10:53</a> dennis 阅读(2918) | <a href="http://www.blogjava.net/killme2008/archive/2010/10/28/336357.html#FeedBack" title="comments, pingbacks, trackbacks">评论 (8)</a> |&nbsp;<a href="http://www.blogjava.net/killme2008/admin/EditPosts.aspx?postid=336357">编辑</a>&nbsp;<a href="http://www.blogjava.net/killme2008/AddToFavorite.aspx?id=336357">收藏</a> </p> 
        </div> 
        <div class="post" style="filter:progid:DXImageTransform.Microsoft.Shadow(color='Blue', Direction=135, Strength=32)"> 
         <div class="posthead"> 
          <h2 style="padding-top:4px; padding-bottom:4px;"><a id="ArchiveDay1_SingleDay_DayList_ctl80_TitleUrl" href="http://www.blogjava.net/killme2008/archive/2010/10/22/335897.html">xmemcached 1.2.6.2紧急发布（升级到1.2.6.1的朋友注意）</a></h2> 
         </div> 
         <div class="postbody">
          <br /> &nbsp;&nbsp;&nbsp; 今年在阅读某个项目源码的时候看到DelayQueue的使用，
          <a href="http://code.google.com/p/xmemcached/">xmemcached</a> 1.2.6.1的重连任务也是采用DelayQueue管理，ReconnectRequest实现Delayed接口，我突然想起去review下xmc的源码，发现一个严重的BUG，原始代码如下：
          <br /> 
          <div style="background-color: #eeeeee; font-size: 13px; border: 1px solid #cccccc; padding: 4px 5px 4px 4px; width: 98%;">
           <span style="color: #0000ff;">public</span>
           <span style="color: #000000;">&nbsp;</span>
           <span style="color: #0000ff;">final</span>
           <span style="color: #000000;">&nbsp;</span>
           <span style="color: #0000ff;">class</span>
           <span style="color: #000000;">&nbsp;ReconnectRequest&nbsp;</span>
           <span style="color: #0000ff;">implements</span>
           <span style="color: #000000;">&nbsp;Delayed&nbsp;{<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000ff;">public</span>
           <span style="color: #000000;">&nbsp;</span>
           <span style="color: #0000ff;">long</span>
           <span style="color: #000000;">&nbsp;getDelay(TimeUnit&nbsp;unit)&nbsp;{<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000ff;">return</span>
           <span style="color: #000000;">&nbsp;&nbsp;nextReconnectTimestamp&nbsp;</span>
           <span style="color: #000000;">-</span>
           <span style="color: #000000;">&nbsp;System.currentTimeMillis();<br /> &nbsp;&nbsp;&nbsp;&nbsp;}<br /> }</span>
          </div> 
          <br /> &nbsp;&nbsp;&nbsp; getDelay返回该任务还剩下多少时间可以被执行，将下次执行的时间戳减去当前时间即可，问题在于这里返回的是毫秒，而没有调用getDelay传入的TimeUnit做转换，在DelayQueue内部其实是用纳秒做单位交给Condition对象去等待
          <br /> 
          <div style="background-color: #eeeeee; font-size: 13px; border: 1px solid #cccccc; padding: 4px 5px 4px 4px; width: 98%;">
           <span style="color: #000000;">&nbsp;&nbsp;</span>
           <span style="color: #0000ff;">for</span>
           <span style="color: #000000;">&nbsp;(;;)&nbsp;{<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;E&nbsp;first&nbsp;</span>
           <span style="color: #000000;">=</span>
           <span style="color: #000000;">&nbsp;q.peek();<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000ff;">if</span>
           <span style="color: #000000;">&nbsp;(first&nbsp;</span>
           <span style="color: #000000;">==</span>
           <span style="color: #000000;">&nbsp;</span>
           <span style="color: #0000ff;">null</span>
           <span style="color: #000000;">)&nbsp;{<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;available.await();<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;</span>
           <span style="color: #0000ff;">else</span>
           <span style="color: #000000;">&nbsp;{<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000ff;">long</span>
           <span style="color: #000000;">&nbsp;delay&nbsp;</span>
           <span style="color: #000000;">=</span>
           <span style="color: #000000;">&nbsp;&nbsp;first.getDelay(TimeUnit.NANOSECONDS);<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000ff;">if</span>
           <span style="color: #000000;">&nbsp;(delay&nbsp;</span>
           <span style="color: #000000;">&gt;</span>
           <span style="color: #000000;">&nbsp;</span>
           <span style="color: #000000;">0</span>
           <span style="color: #000000;">)&nbsp;{<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000ff;">long</span>
           <span style="color: #000000;">&nbsp;tl&nbsp;</span>
           <span style="color: #000000;">=</span>
           <span style="color: #000000;">&nbsp;available.awaitNanos(delay);<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;</span>
           <span style="color: #0000ff;">else</span>
           <span style="color: #000000;">&nbsp;{<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;E&nbsp;x&nbsp;</span>
           <span style="color: #000000;">=</span>
           <span style="color: #000000;">&nbsp;q.poll();<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000ff;">assert</span>
           <span style="color: #000000;">&nbsp;x&nbsp;</span>
           <span style="color: #000000;">!=</span>
           <span style="color: #000000;">&nbsp;</span>
           <span style="color: #0000ff;">null</span>
           <span style="color: #000000;">;<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000ff;">if</span>
           <span style="color: #000000;">&nbsp;(q.size()&nbsp;</span>
           <span style="color: #000000;">!=</span>
           <span style="color: #000000;">&nbsp;</span>
           <span style="color: #000000;">0</span>
           <span style="color: #000000;">)<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;available.signalAll();&nbsp;</span>
           <span style="color: #008000;">//</span>
           <span style="color: #008000;">&nbsp;wake&nbsp;up&nbsp;other&nbsp;takers</span>
           <span style="color: #008000;"><br /> </span>
           <span style="color: #000000;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000ff;">return</span>
           <span style="color: #000000;">&nbsp;x;<br /> <br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span>
          </div> &nbsp;&nbsp; 
          <br /> &nbsp;&nbsp;&nbsp;&nbsp; 最终导致的问题是，
          <span style="color: #000000;">awaitNanos很快返回（</span>
          <span style="color: #000000;">awaitNanos接受的是纳秒，这里却传入毫秒）</span>
          <span style="color: #000000;">，循环执行发现重新计算的delay仍然大于0，循环等到getDelay返回的越来越小直到0才执行相应的Task,，造成的现象是在重连的时候cpu占用率很高。<br /> <br /> &nbsp;&nbsp;&nbsp;&nbsp; 单元测试的时候没有发现这个问题，主要是因为功能正常，没有关注资源消耗情况，因此惭愧地忽略了。<br /> <br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 解决的办法很简单，修改getDelay方法即可：<br /> </span> 
          <div style="background-color: #eeeeee; font-size: 13px; border: 1px solid #cccccc; padding: 4px 5px 4px 4px; width: 98%;">
           <span style="color: #000000;">&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000ff;">public</span>
           <span style="color: #000000;">&nbsp;</span>
           <span style="color: #0000ff;">long</span>
           <span style="color: #000000;">&nbsp;getDelay(TimeUnit&nbsp;unit)&nbsp;{<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000ff;">return</span>
           <span style="color: #000000;">&nbsp;unit.convert(<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nextReconnectTimestamp&nbsp;</span>
           <span style="color: #000000;">-</span>
           <span style="color: #000000;">&nbsp;System.currentTimeMillis(),<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TimeUnit.MILLISECONDS);<br /> &nbsp;&nbsp;&nbsp;&nbsp;}<br /> </span>
          </div> 
          <br /> 
          <span style="color: #000000;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 这个BUG比较严重，已经升级1.2.6.1的朋友建议马上升级到1.2.6.2，使用maven的朋友只要修改版本即可，没有使用maven的请到<a href="http://code.google.com/p/xmemcached/downloads/list">这里</a>下载。<br /> <br /> </span>
         </div> 
         <p class="postfoot"> posted @ <a href="http://www.blogjava.net/killme2008/archive/2010/10/22/335897.html" title="permalink">2010-10-22 15:52</a> dennis 阅读(3701) | <a href="http://www.blogjava.net/killme2008/archive/2010/10/22/335897.html#FeedBack" title="comments, pingbacks, trackbacks">评论 (4)</a> |&nbsp;<a href="http://www.blogjava.net/killme2008/admin/EditPosts.aspx?postid=335897">编辑</a>&nbsp;<a href="http://www.blogjava.net/killme2008/AddToFavorite.aspx?id=335897">收藏</a> </p> 
        </div> 
        <div class="post" style="filter:progid:DXImageTransform.Microsoft.Shadow(color='Blue', Direction=135, Strength=32)"> 
         <div class="posthead"> 
          <h2 style="padding-top:4px; padding-bottom:4px;"><a id="ArchiveDay1_SingleDay_DayList_ctl81_TitleUrl" href="http://www.blogjava.net/killme2008/archive/2010/10/22/335861.html">Selector.wakeup实现注记</a></h2> 
         </div> 
         <div class="postbody">
          <br /> &nbsp;&nbsp;&nbsp; NIO中的Selector封装了底层的系统调用，其中wakeup用于唤醒阻塞在select方法上的线程，它的实现很简单，在linux上就是创建一个管道并加入poll的fd集合，wakeup就是往管道里写一个字节，那么阻塞的poll方法有数据可读就立即返回。证明这一点很简单，strace即可知道：
          <br /> 
          <div style="background-color: #eeeeee; font-size: 13px; border: 1px solid #cccccc; padding: 4px 5px 4px 4px; width: 98%;">
           <span style="color: #0000ff;">public</span>
           <span style="color: #000000;">&nbsp;</span>
           <span style="color: #0000ff;">class</span>
           <span style="color: #000000;">&nbsp;SelectorTest&nbsp;{<br /> &nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000ff;">public</span>
           <span style="color: #000000;">&nbsp;</span>
           <span style="color: #0000ff;">static</span>
           <span style="color: #000000;">&nbsp;</span>
           <span style="color: #0000ff;">void</span>
           <span style="color: #000000;">&nbsp;main(String[]&nbsp;args)&nbsp;</span>
           <span style="color: #0000ff;">throws</span>
           <span style="color: #000000;">&nbsp;Exception&nbsp;{<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Selector&nbsp;selector&nbsp;</span>
           <span style="color: #000000;">=</span>
           <span style="color: #000000;">&nbsp;Selector.open();<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;selector.wakeup();<br /> &nbsp;&nbsp;&nbsp;&nbsp;}<br /> }</span>
          </div> 
          <br /> &nbsp;&nbsp;&nbsp;&nbsp; 使用strace调用,只关心write的系统调用
          <br /> 
          <div style="background-color: #eeeeee; font-size: 13px; border: 1px solid #cccccc; padding: 4px 5px 4px 4px; width: 98%;">
           <span style="color: #000000;">sudo&nbsp;strace&nbsp;</span>
           <span style="color: #000000;">-</span>
           <span style="color: #000000;">f&nbsp;</span>
           <span style="color: #000000;">-</span>
           <span style="color: #000000;">e&nbsp;write&nbsp;java SelectorTest<br /> </span>
          </div> 
          <br /> &nbsp;&nbsp;&nbsp;&nbsp; 输出：
          <br /> 
          <div style="background-color: #eeeeee; font-size: 13px; border: 1px solid #cccccc; padding: 4px 5px 4px 4px; width: 98%;">
           <span style="color: #000000;">Process&nbsp;</span>
           <span style="color: #000000;">29181</span>
           <span style="color: #000000;">&nbsp;attached<br /> Process&nbsp;</span>
           <span style="color: #000000;">29182</span>
           <span style="color: #000000;">&nbsp;attached<br /> Process&nbsp;</span>
           <span style="color: #000000;">29183</span>
           <span style="color: #000000;">&nbsp;attached<br /> Process&nbsp;</span>
           <span style="color: #000000;">29184</span>
           <span style="color: #000000;">&nbsp;attached<br /> Process&nbsp;</span>
           <span style="color: #000000;">29185</span>
           <span style="color: #000000;">&nbsp;attached<br /> Process&nbsp;</span>
           <span style="color: #000000;">29186</span>
           <span style="color: #000000;">&nbsp;attached<br /> Process&nbsp;</span>
           <span style="color: #000000;">29187</span>
           <span style="color: #000000;">&nbsp;attached<br /> Process&nbsp;</span>
           <span style="color: #000000;">29188</span>
           <span style="color: #000000;">&nbsp;attached<br /> Process&nbsp;</span>
           <span style="color: #000000;">29189</span>
           <span style="color: #000000;">&nbsp;attached<br /> Process&nbsp;</span>
           <span style="color: #000000;">29190</span>
           <span style="color: #000000;">&nbsp;attached<br /> Process&nbsp;</span>
           <span style="color: #000000;">29191</span>
           <span style="color: #000000;">&nbsp;attached<br /> [pid&nbsp;</span>
           <span style="color: #000000;">29181</span>
           <span style="color: #000000;">]&nbsp;write(</span>
           <span style="color: #000000;">36</span>
           <span style="color: #000000;">,&nbsp;</span>
           <span style="color: #000000;">&quot;</span>
           <span style="color: #000000;">\1</span>
           <span style="color: #000000;">&quot;</span>
           <span style="color: #000000;">,&nbsp;</span>
           <span style="color: #000000;">1</span>
           <span style="color: #000000;">)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #000000;">=</span>
           <span style="color: #000000;">&nbsp;</span>
           <span style="color: #000000;">1</span>
           <span style="color: #000000;"><br /> Process&nbsp;</span>
           <span style="color: #000000;">29191</span>
           <span style="color: #000000;">&nbsp;detached<br /> Process&nbsp;</span>
           <span style="color: #000000;">29184</span>
           <span style="color: #000000;">&nbsp;detached<br /> Process&nbsp;</span>
           <span style="color: #000000;">29181</span>
           <span style="color: #000000;">&nbsp;detached<br /> </span>
          </div> 
          <br /> &nbsp;&nbsp;&nbsp; 有的同学说了，怎么证明这个write是wakeup方法调用的，而不是其他方法呢，这个很好证明，我们多调用几次：
          <br /> 
          <div style="background-color: #eeeeee; font-size: 13px; border: 1px solid #cccccc; padding: 4px 5px 4px 4px; width: 98%;">
           <span style="color: #0000ff;">public</span>
           <span style="color: #000000;">&nbsp;</span>
           <span style="color: #0000ff;">class</span>
           <span style="color: #000000;">&nbsp;SelectorTest&nbsp;{<br /> &nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000ff;">public</span>
           <span style="color: #000000;">&nbsp;</span>
           <span style="color: #0000ff;">static</span>
           <span style="color: #000000;">&nbsp;</span>
           <span style="color: #0000ff;">void</span>
           <span style="color: #000000;">&nbsp;main(String[]&nbsp;args)&nbsp;</span>
           <span style="color: #0000ff;">throws</span>
           <span style="color: #000000;">&nbsp;Exception&nbsp;{<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Selector&nbsp;selector&nbsp;</span>
           <span style="color: #000000;">=</span>
           <span style="color: #000000;">&nbsp;Selector.open();<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;selector.wakeup();<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;selector.selectNow();<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;selector.wakeup();<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;selector.selectNow();<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;selector.wakeup();<br /> &nbsp;&nbsp;&nbsp;&nbsp;}<br /> }</span>
          </div> 
          <br /> &nbsp;&nbsp;&nbsp; 修改程序调用三次wakeup，心细的朋友肯定注意到我们还调用了两次selectNow，这是因为在两次成功的select方法之间调用wakeup多次都只算做一次，为了显示3次write，这里就每次调用前select一下将前一次写入的字节读到，同样执行上面的strace调用，输出：
          <br /> 
          <br /> 
          <div style="background-color: #eeeeee; font-size: 13px; border: 1px solid #cccccc; padding: 4px 5px 4px 4px; width: 98%;">
           <span style="color: #000000;">Process&nbsp;</span>
           <span style="color: #000000;">29303</span>
           <span style="color: #000000;">&nbsp;attached<br /> Process&nbsp;</span>
           <span style="color: #000000;">29304</span>
           <span style="color: #000000;">&nbsp;attached<br /> Process&nbsp;</span>
           <span style="color: #000000;">29305</span>
           <span style="color: #000000;">&nbsp;attached<br /> Process&nbsp;</span>
           <span style="color: #000000;">29306</span>
           <span style="color: #000000;">&nbsp;attached<br /> Process&nbsp;</span>
           <span style="color: #000000;">29307</span>
           <span style="color: #000000;">&nbsp;attached<br /> Process&nbsp;</span>
           <span style="color: #000000;">29308</span>
           <span style="color: #000000;">&nbsp;attached<br /> Process&nbsp;</span>
           <span style="color: #000000;">29309</span>
           <span style="color: #000000;">&nbsp;attached<br /> Process&nbsp;</span>
           <span style="color: #000000;">29310</span>
           <span style="color: #000000;">&nbsp;attached<br /> Process&nbsp;</span>
           <span style="color: #000000;">29311</span>
           <span style="color: #000000;">&nbsp;attached<br /> Process&nbsp;</span>
           <span style="color: #000000;">29312</span>
           <span style="color: #000000;">&nbsp;attached<br /> Process&nbsp;</span>
           <span style="color: #000000;">29313</span>
           <span style="color: #000000;">&nbsp;attached<br /> [pid&nbsp;</span>
           <span style="color: #000000;">29303</span>
           <span style="color: #000000;">]&nbsp;write(</span>
           <span style="color: #000000;">36</span>
           <span style="color: #000000;">,&nbsp;</span>
           <span style="color: #000000;">&quot;</span>
           <span style="color: #000000;">\1</span>
           <span style="color: #000000;">&quot;</span>
           <span style="color: #000000;">,&nbsp;</span>
           <span style="color: #000000;">1</span>
           <span style="color: #000000;">)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #000000;">=</span>
           <span style="color: #000000;">&nbsp;</span>
           <span style="color: #000000;">1</span>
           <span style="color: #000000;"><br /> [pid&nbsp;</span>
           <span style="color: #000000;">29303</span>
           <span style="color: #000000;">]&nbsp;write(</span>
           <span style="color: #000000;">36</span>
           <span style="color: #000000;">,&nbsp;</span>
           <span style="color: #000000;">&quot;</span>
           <span style="color: #000000;">\1</span>
           <span style="color: #000000;">&quot;</span>
           <span style="color: #000000;">,&nbsp;</span>
           <span style="color: #000000;">1</span>
           <span style="color: #000000;">)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #000000;">=</span>
           <span style="color: #000000;">&nbsp;</span>
           <span style="color: #000000;">1</span>
           <span style="color: #000000;"><br /> [pid&nbsp;</span>
           <span style="color: #000000;">29303</span>
           <span style="color: #000000;">]&nbsp;write(</span>
           <span style="color: #000000;">36</span>
           <span style="color: #000000;">,&nbsp;</span>
           <span style="color: #000000;">&quot;</span>
           <span style="color: #000000;">\1</span>
           <span style="color: #000000;">&quot;</span>
           <span style="color: #000000;">,&nbsp;</span>
           <span style="color: #000000;">1</span>
           <span style="color: #000000;">)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #000000;">=</span>
           <span style="color: #000000;">&nbsp;</span>
           <span style="color: #000000;">1</span>
           <span style="color: #000000;"><br /> Process&nbsp;</span>
           <span style="color: #000000;">29313</span>
           <span style="color: #000000;">&nbsp;detached<br /> Process&nbsp;</span>
           <span style="color: #000000;">29309</span>
           <span style="color: #000000;">&nbsp;detached<br /> Process&nbsp;</span>
           <span style="color: #000000;">29306</span>
           <span style="color: #000000;">&nbsp;detached<br /> Process&nbsp;</span>
           <span style="color: #000000;">29303</span>
           <span style="color: #000000;">&nbsp;detached<br /> </span>
          </div> 
          <br /> &nbsp;&nbsp;&nbsp;&nbsp; 果然是3次write的系统调用，都是写入一个字节，如果我们去掉selectNow，那么三次wakeup还是等于一次：
          <br /> 
          <div style="background-color: #eeeeee; font-size: 13px; border: 1px solid #cccccc; padding: 4px 5px 4px 4px; width: 98%;">
           <span style="color: #0000ff;">public</span>
           <span style="color: #000000;">&nbsp;</span>
           <span style="color: #0000ff;">class</span>
           <span style="color: #000000;">&nbsp;SelectorTest&nbsp;{<br /> &nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000ff;">public</span>
           <span style="color: #000000;">&nbsp;</span>
           <span style="color: #0000ff;">static</span>
           <span style="color: #000000;">&nbsp;</span>
           <span style="color: #0000ff;">void</span>
           <span style="color: #000000;">&nbsp;main(String[]&nbsp;args)&nbsp;</span>
           <span style="color: #0000ff;">throws</span>
           <span style="color: #000000;">&nbsp;Exception&nbsp;{<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Selector&nbsp;selector&nbsp;</span>
           <span style="color: #000000;">=</span>
           <span style="color: #000000;">&nbsp;Selector.open();<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;selector.wakeup();<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;selector.wakeup();<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;selector.wakeup();<br /> &nbsp;&nbsp;&nbsp;&nbsp;}<br /> }<br /> </span>
          </div> &nbsp; 
          <br /> &nbsp;&nbsp; 输出：
          <br /> 
          <div style="background-color: #eeeeee; font-size: 13px; border: 1px solid #cccccc; padding: 4px 5px 4px 4px; width: 98%;">
           <span style="color: #000000;">Process&nbsp;</span>
           <span style="color: #000000;">29331</span>
           <span style="color: #000000;">&nbsp;attached<br /> Process&nbsp;</span>
           <span style="color: #000000;">29332</span>
           <span style="color: #000000;">&nbsp;attached<br /> Process&nbsp;</span>
           <span style="color: #000000;">29333</span>
           <span style="color: #000000;">&nbsp;attached<br /> Process&nbsp;</span>
           <span style="color: #000000;">29334</span>
           <span style="color: #000000;">&nbsp;attached<br /> Process&nbsp;</span>
           <span style="color: #000000;">29335</span>
           <span style="color: #000000;">&nbsp;attached<br /> Process&nbsp;</span>
           <span style="color: #000000;">29336</span>
           <span style="color: #000000;">&nbsp;attached<br /> Process&nbsp;</span>
           <span style="color: #000000;">29337</span>
           <span style="color: #000000;">&nbsp;attached<br /> Process&nbsp;</span>
           <span style="color: #000000;">29338</span>
           <span style="color: #000000;">&nbsp;attached<br /> Process&nbsp;</span>
           <span style="color: #000000;">29339</span>
           <span style="color: #000000;">&nbsp;attached<br /> Process&nbsp;</span>
           <span style="color: #000000;">29340</span>
           <span style="color: #000000;">&nbsp;attached<br /> Process&nbsp;</span>
           <span style="color: #000000;">29341</span>
           <span style="color: #000000;">&nbsp;attached<br /> [pid&nbsp;</span>
           <span style="color: #000000;">29331</span>
           <span style="color: #000000;">]&nbsp;write(</span>
           <span style="color: #000000;">36</span>
           <span style="color: #000000;">,&nbsp;</span>
           <span style="color: #000000;">&quot;</span>
           <span style="color: #000000;">\1</span>
           <span style="color: #000000;">&quot;</span>
           <span style="color: #000000;">,&nbsp;</span>
           <span style="color: #000000;">1</span>
           <span style="color: #000000;">)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #000000;">=</span>
           <span style="color: #000000;">&nbsp;</span>
           <span style="color: #000000;">1</span>
           <span style="color: #000000;"><br /> Process&nbsp;</span>
           <span style="color: #000000;">29341</span>
           <span style="color: #000000;">&nbsp;detached<br /> Process&nbsp;</span>
           <span style="color: #000000;">29337</span>
           <span style="color: #000000;">&nbsp;detached<br /> Process&nbsp;</span>
           <span style="color: #000000;">29334</span>
           <span style="color: #000000;">&nbsp;detached<br /> Process&nbsp;</span>
           <span style="color: #000000;">29331</span>
           <span style="color: #000000;">&nbsp;detached<br /> </span>
          </div> 
          <br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; wakeup方法的API说明没有欺骗我们。wakeup方法的API还告诉我们，如果当前Selector没有阻塞在select方法上，那么本次wakeup调用会在下一次select阻塞的时候生效，这个道理很简单，wakeup方法写入一个字节，下次poll等待的时候立即发现可读并返回，因此不会阻塞。
          <br /> 
          <br /> &nbsp;&nbsp;&nbsp;&nbsp; 具体到源码级别，在linux平台上的wakeup方法其实调用了pipe创建了管道，wakeup调用了
          <span id="cls"><a title="EPollArrayWrapper" href="http://www.docjar.com/docs/api/sun/nio/ch/EPollArrayWrapper.html">EPollArrayWrapper</a>的</span>interrupt方法：
          <br /> 
          <div style="background-color: #eeeeee; font-size: 13px; border: 1px solid #cccccc; padding: 4px 5px 4px 4px; width: 98%;">
           <span style="color: #0000ff;">public</span>
           <span style="color: #000000;">&nbsp;&nbsp;</span>
           <span style="color: #0000ff;">void</span>
           <span style="color: #000000;">&nbsp;interrupt()&nbsp;<br /> <br /> {<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;interrupt(outgoingInterruptFD);<br /> }</span>
          </div> 
          <br /> &nbsp;&nbsp;&nbsp; 实际调用的是interrupt(fd)的native方法，查看EPollArrayWrapper.c可见清晰的write系统调用：
          <br /> 
          <div style="background-color: #eeeeee; font-size: 13px; border: 1px solid #cccccc; padding: 4px 5px 4px 4px; width: 98%;">
           <span style="color: #000000;"><br /> JNIEXPORT&nbsp;</span>
           <span style="color: #0000ff;">void</span>
           <span style="color: #000000;">&nbsp;JNICALL<br /> Java_sun_nio_ch_EPollArrayWrapper_interrupt(JNIEnv&nbsp;</span>
           <span style="color: #000000;">*</span>
           <span style="color: #000000;">env,&nbsp;jobject&nbsp;</span>
           <span style="color: #0000ff;">this</span>
           <span style="color: #000000;">,&nbsp;jint&nbsp;fd)<br /> {<br /> &nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000ff;">int</span>
           <span style="color: #000000;">&nbsp;fakebuf[</span>
           <span style="color: #000000;">1</span>
           <span style="color: #000000;">];<br /> &nbsp;&nbsp;&nbsp;&nbsp;fakebuf[</span>
           <span style="color: #000000;">0</span>
           <span style="color: #000000;">]&nbsp;</span>
           <span style="color: #000000;">=</span>
           <span style="color: #000000;">&nbsp;</span>
           <span style="color: #000000;">1</span>
           <span style="color: #000000;">;<br /> &nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000ff;">if</span>
           <span style="color: #000000;">&nbsp;(write(fd,&nbsp;fakebuf,&nbsp;</span>
           <span style="color: #000000;">1</span>
           <span style="color: #000000;">)&nbsp;</span>
           <span style="color: #000000;">&lt;</span>
           <span style="color: #000000;">&nbsp;</span>
           <span style="color: #000000;">0</span>
           <span style="color: #000000;">)&nbsp;{<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JNU_ThrowIOExceptionWithLastError(env,</span>
           <span style="color: #000000;">&quot;</span>
           <span style="color: #000000;">write&nbsp;to&nbsp;interrupt&nbsp;fd&nbsp;failed</span>
           <span style="color: #000000;">&quot;</span>
           <span style="color: #000000;">);<br /> &nbsp;&nbsp;&nbsp;&nbsp;}<br /> }</span>
          </div> &nbsp;&nbsp;&nbsp; 写入一个字节的fakebuf。有朋友问起这个问题，写个注记在此。strace充分利用对了解这些细节很有帮助。
          <br /> &nbsp; 
          <br /> 
          <br />
         </div> 
         <p class="postfoot"> posted @ <a href="http://www.blogjava.net/killme2008/archive/2010/10/22/335861.html" title="permalink">2010-10-22 10:35</a> dennis 阅读(4867) | <a href="http://www.blogjava.net/killme2008/archive/2010/10/22/335861.html#FeedBack" title="comments, pingbacks, trackbacks">评论 (3)</a> |&nbsp;<a href="http://www.blogjava.net/killme2008/admin/EditPosts.aspx?postid=335861">编辑</a>&nbsp;<a href="http://www.blogjava.net/killme2008/AddToFavorite.aspx?id=335861">收藏</a> </p> 
        </div> 
        <div class="post" style="filter:progid:DXImageTransform.Microsoft.Shadow(color='Blue', Direction=135, Strength=32)"> 
         <div class="posthead"> 
          <h2 style="padding-top:4px; padding-bottom:4px;"><a id="ArchiveDay1_SingleDay_DayList_ctl82_TitleUrl" href="http://www.blogjava.net/killme2008/archive/2010/10/17/335356.html">Xmemcached发布1.2.6.1（推荐升级)</a></h2> 
         </div> 
         <div class="postbody">
          <br /> &nbsp;&nbsp;&nbsp;&nbsp; 
          <a href="http://code.google.com/p/xmemcached/">Xmemcached</a> 1.2.6.1正式发布，这个版本的主要是做bug fix以及一些细节改进，主要变动如下：
          <br /> 
          <br /> 1、修复BUG，包括：
          <br /> Issue 
          <a href="http://code.google.com/p/xmemcached/issues/detail?id=85">85</a>: 
          <span class="h3">当存在多个MemcachedClient的时候，JMX的统计只显示其中一个<br /> </span>Issue 
          <a href="http://code.google.com/p/xmemcached/issues/detail?id=87">87</a>: 当使用一致性哈希的时候，连接池不起作用
          <br /> Issue 
          <a href="http://code.google.com/p/xmemcached/issues/detail?id=90">90</a>: 用户线程
          <span class="h3">中断引起的连接关闭</span>
          <br /> Issue 
          <a href="http://code.google.com/p/xmemcached/issues/detail?id=94">94</a>:
          <span class="h3">BinaryMemcachedClientUnitTest测试失败<br /> </span>Issue 
          <a href="http://code.google.com/p/xmemcached/issues/detail?id=95">95</a>: 
          <span class="h3">JMX addServer,removeServer存在缺陷<br /> </span>Issue 
          <a href="http://code.google.com/p/xmemcached/issues/detail?id=96">96</a>: 
          <span class="h3">OOM Error while decompressing 60 KB of actuall data<br /> </span> Issue 
          <a href="http://code.google.com/p/xmemcached/issues/detail?id=97">97</a>: 
          <span class="h3">使得关闭连接更友好<br /> <br /> 2、改进重连机制，重连不再是以固定间隔（默认2秒）做重试连接，而是以一个等差数列递增间隔时间，第一次2秒，第二次4秒，第三次6秒……直到最大间隔时间1分钟做重连尝试。<br /> <br /> 3、改善关闭机制，关闭连接前发送quit命令，尽量做到友好关闭，等待服务器主动断开连接。<br /> <br /> 4、添加新的方法用于设置XmemcachedClient实例名称，用于区分不同的缓存集群，方便统计显示：<br /> </span> 
          <div style="background-color: rgb(238, 238, 238); font-size: 13px; border: 1px solid rgb(204, 204, 204); padding: 4px 5px 4px 4px; width: 98%;">
           <span style="color: rgb(0, 0, 255);">public</span>
           <span style="color: rgb(0, 0, 0);">&nbsp;</span>
           <span style="color: rgb(0, 0, 255);">interface</span>
           <span style="color: rgb(0, 0, 0);">&nbsp;MemcachedClient{<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: rgb(0, 128, 0);">/**</span>
           <span style="color: rgb(0, 128, 0);"><br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Return&nbsp;the&nbsp;cache&nbsp;instance&nbsp;name<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;</span>
           <span style="color: rgb(128, 128, 128);">@return</span>
           <span style="color: rgb(0, 128, 0);"><br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: rgb(0, 128, 0);">*/</span>
           <span style="color: rgb(0, 0, 0);"><br /> &nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: rgb(0, 0, 255);">public</span>
           <span style="color: rgb(0, 0, 0);">&nbsp;String&nbsp;getName();<br /> <br /> &nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: rgb(0, 128, 0);">/**</span>
           <span style="color: rgb(0, 128, 0);"><br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Set&nbsp;cache&nbsp;instance&nbsp;name<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;</span>
           <span style="color: rgb(128, 128, 128);">@param</span>
           <span style="color: rgb(0, 128, 0);">&nbsp;name<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: rgb(0, 128, 0);">*/</span>
           <span style="color: rgb(0, 0, 0);"><br /> &nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: rgb(0, 0, 255);">public</span>
           <span style="color: rgb(0, 0, 0);">&nbsp;</span>
           <span style="color: rgb(0, 0, 255);">void</span>
           <span style="color: rgb(0, 0, 0);">&nbsp;setName(String&nbsp;name);<br /> }</span>
          </div> 
          <br /> 名称也可通过spring配置。
          <br /> 
          <br /> 5、提供
          <a href="http://code.google.com/p/xmemcached/wiki/User_Guide">英文的用户指南</a>，非常感谢
          <a href="http://code.google.com/u/cnscud/">cnscud</a>的帮助，这份文档是他一人搞定的。
          <br /> 
          <br /> 6、更新了
          <a href="http://xmemcached.googlecode.com/svn/trunk/benchmark/benchmark.html">Java Memcached Client Benchmark</a>，跟最新版本的
          <a href="http://code.google.com/p/spymemcached">spymemcached</a>,
          <a href="http://github.com/gwhalin/Memcached-Java-Client">Java-Memcached-Client</a>做对比测试，提供给需要的朋友参考。
          <br /> 
          <br /> 
          <br /> 项目首页&nbsp; 
          <a title="http://code.google.com/p/xmemcached/" href="http://code.google.com/p/xmemcached/">http://code.google.com/p/xmemcached/</a>
          <br /> 下载地址&nbsp; 
          <a title="http://code.google.com/p/xmemcached/downloads/list" href="http://code.google.com/p/xmemcached/downloads/list">http://code.google.com/p/xmemcached/downloads/list</a>
          <br /> wiki地址&nbsp;&nbsp; 
          <a href="http://code.google.com/p/xmemcached/w/list">http://code.google.com/p/xmemcached/w/list</a>
          <br /> 
          <br /> 
          <br /> 
          <br /> 
          <br />
         </div> 
         <p class="postfoot"> posted @ <a href="http://www.blogjava.net/killme2008/archive/2010/10/17/335356.html" title="permalink">2010-10-17 14:06</a> dennis 阅读(2329) | <a href="http://www.blogjava.net/killme2008/archive/2010/10/17/335356.html#FeedBack" title="comments, pingbacks, trackbacks">评论 (0)</a> |&nbsp;<a href="http://www.blogjava.net/killme2008/admin/EditPosts.aspx?postid=335356">编辑</a>&nbsp;<a href="http://www.blogjava.net/killme2008/AddToFavorite.aspx?id=335356">收藏</a> </p> 
        </div> 
        <div class="post" style="filter:progid:DXImageTransform.Microsoft.Shadow(color='Blue', Direction=135, Strength=32)"> 
         <div class="posthead"> 
          <h2 style="padding-top:4px; padding-bottom:4px;"><a id="ArchiveDay1_SingleDay_DayList_ctl83_TitleUrl" href="http://www.blogjava.net/killme2008/archive/2010/10/17/335351.html">Java Memcached Client Benchmark</a></h2> 
         </div> 
         <div class="postbody">
          <br /> &nbsp;&nbsp;&nbsp;&nbsp; Xmemcached 1.2.6.1 released，所以更新了一下
          <a href="http://xmemcached.googlecode.com/svn/trunk/benchmark/benchmark.html">Java Memcached Client Benchmark</a>。对比下
          <a href="http://code.google.com/p/xmemcached/">Xmemached</a>,
          <a href="http://code.google.com/p/spymemcached">Spymemcached</a>和
          <a href="http://github.com/gwhalin/Memcached-Java-Client">Java-Memcached-Client</a>这三个开源客户端的性能，具体的测试信息可以看这个
          <a href="http://xmemcached.googlecode.com/svn/trunk/benchmark/benchmark.html">链接</a>。
          <br /> 
          <br /> &nbsp;&nbsp;&nbsp; 测试源码
          <br /> 
          <div style="background-color: #eeeeee; font-size: 13px; border: 1px solid #cccccc; padding: 4px 5px 4px 4px; width: 98%;">
           <span style="color: #000000;">svn&nbsp;co&nbsp;http:</span>
           <span style="color: #008000;">//</span>
           <span style="color: #008000;">xmemcached.googlecode.com/svn/trunk/benchmark/</span>
          </div> &nbsp;&nbsp;&nbsp; 测试结果：
          <br /> 
          <div style="background-color: #eeeeee; font-size: 13px; border: 1px solid #cccccc; padding: 4px 5px 4px 4px; width: 98%;">
           <span style="color: #000000;">svn&nbsp;co&nbsp;http:</span>
           <span style="color: #008000;">//</span>
           <span style="color: #008000;">xmemcached.googlecode.com/svn/trunk/benchmark/result</span>
          </div> 
          <br /> &nbsp;&nbsp;&nbsp; 总结下测试结果，为还在选择和考察
          <a target="">java memcached client</a>的朋友提供参考：
          <br /> 
          <br /> 1、
          <a href="http://github.com/gwhalin/Memcached-Java-Client">Java-Memcached-Client</a> 2.5.1这个版本果然有很大改进，性能上有非常大的提升，从测试结果来看在小于100并发下有非常明显的优势，同时耗费资源也相对较多。但是在300并发访问下，Java-Memcached-Client会不断地报错：
          <br /> 
          <div style="background-color: #eeeeee; font-size: 13px; border: 1px solid #cccccc; padding: 4px 5px 4px 4px; width: 98%;">
           <span style="color: #000000;">com.schooner.MemCached.SchoonerSockIOPool&nbsp;Sun&nbsp;Oct&nbsp;</span>
           <span style="color: #000000;">17</span>
           <span style="color: #000000;">&nbsp;</span>
           <span style="color: #000000;">11</span>
           <span style="color: #000000;">:</span>
           <span style="color: #000000;">09</span>
           <span style="color: #000000;">:</span>
           <span style="color: #000000;">05</span>
           <span style="color: #000000;">&nbsp;GMT</span>
           <span style="color: #000000;">+</span>
           <span style="color: #000000;">08</span>
           <span style="color: #000000;">:</span>
           <span style="color: #000000;">00</span>
           <span style="color: #000000;">&nbsp;</span>
           <span style="color: #000000;">2010</span>
           <span style="color: #000000;">&nbsp;</span>
           <span style="color: #000000;">-</span>
           <span style="color: #000000;">&nbsp;</span>
           <span style="color: #000000;">++++</span>
           <span style="color: #000000;">&nbsp;failed&nbsp;to&nbsp;get&nbsp;SockIO&nbsp;obj&nbsp;</span>
           <span style="color: #0000ff;">for</span>
           <span style="color: #000000;">:&nbsp;</span>
           <span style="color: #000000;">10.232</span>
           <span style="color: #000000;">.</span>
           <span style="color: #000000;">36.82</span>
           <span style="color: #000000;">:</span>
           <span style="color: #000000;">12000<br /> com.schooner.MemCached.SchoonerSockIOPool Sun Oct 17 11:09:05 GMT+08:00 2010 - ++++ failed to get SockIO obj for: 10.232.36.82:12000<br /> com.schooner.MemCached.SchoonerSockIOPool Sun Oct 17 11:09:05 GMT+08:00 2010 - ++++ failed to get SockIO obj for: 10.232.36.90:12000<br /> com.schooner.MemCached.SchoonerSockIOPool Sun Oct 17 11:09:05 GMT+08:00 2010 - ++++ failed to get SockIO obj for: 10.232.36.82:12000<br /> com.schooner.MemCached.SchoonerSockIOPool Sun Oct 17 11:09:05 GMT+08:00 2010 - ++++ failed to get SockIO obj for: 10.232.36.90:12000<br /> com.schooner.MemCached.SchoonerSockIOPool Sun Oct 17 11:09:05 GMT+08:00 2010 - ++++ failed to get SockIO obj for: 10.232.36.82:12000</span>
           <br /> 
          </div> 
          <br /> &nbsp;并且无法正常地存取数据， 而xmc和spy却可以正常应对这一场景。因此可以看到在300并发下，Java-Memcached-Client测试的结果直接为0，因为测试无法完成。尽管我尝试将最大连接数调到2000，仍然是无法完成测试。
          <br /> 
          <br /> 2、
          <a href="http://code.google.com/p/xmemcached/">Xmemcached</a>无论在低并发还是高并发访问的情况下，都可以保持一个比较优秀的性能表现，从xmc和spy的对比来看，xmc的优势相当大。
          <br /> 
          <br /> 3、
          <strong>从用户选择角度来说，如果你的应用对memached的访问负载并不高，Java-Memcached-Client是一个不错的选择，但是在高峰访问的时候可能命中率会有个急剧的波动；如果你的应用访问memached的负载较高，此时我推荐你选择<a href="http://code.google.com/p/xmemcached/">xmemcached</a>；如果你需要异步的批量处理(future模式），可以选择<a href="http://code.google.com/p/spymemcached">spymemcached</a>；如果你不知道你的应用是什么状况，我推荐你用<a href="http://code.google.com/p/xmemcached/">xmemcached</a>，可以在任何情况下获得一个比较好的性能表现</strong>。
          <br /> 
          <br /> 
          <br />
         </div> 
         <p class="postfoot"> posted @ <a href="http://www.blogjava.net/killme2008/archive/2010/10/17/335351.html" title="permalink">2010-10-17 13:44</a> dennis 阅读(3947) | <a href="http://www.blogjava.net/killme2008/archive/2010/10/17/335351.html#FeedBack" title="comments, pingbacks, trackbacks">评论 (0)</a> |&nbsp;<a href="http://www.blogjava.net/killme2008/admin/EditPosts.aspx?postid=335351">编辑</a>&nbsp;<a href="http://www.blogjava.net/killme2008/AddToFavorite.aspx?id=335351">收藏</a> </p> 
        </div> 
        <div class="post" style="filter:progid:DXImageTransform.Microsoft.Shadow(color='Blue', Direction=135, Strength=32)"> 
         <div class="posthead"> 
          <h2 style="padding-top:4px; padding-bottom:4px;"><a id="ArchiveDay1_SingleDay_DayList_ctl84_TitleUrl" href="http://www.blogjava.net/killme2008/archive/2010/09/17/332281.html">Kilim实现浅析（一）</a></h2> 
         </div> 
         <div class="postbody">
          <br /> &nbsp;&nbsp;&nbsp; Kilim是一个Java的actor框架，让你可以在JVM里使用基于协程的actor模型，bluedavy曾经介绍过，这里不再赘言。这篇blog的目的在于分析下kilim实现的基本原理，看看怎么在JVM上实现协程。
          <br /> 
          <br /> &nbsp;&nbsp;&nbsp; 在一些语言层面上支持协程的语言，如lua、ruby，都是直接在VM级别支持协程，VM帮你做context的保存和恢复。JVM没有提供这样的指令来保存和恢复方法栈的状态，因此kilim的实现还是需要在bytecode级别做文章。首先，试想下，如果是你来实现协程，你会怎么做？协程的两个基本原语resume和yield，resume运行协程，yield让出执行权，下次resume的时候会从yield的地方重新执行，并且context保持不变。可见，你需要做这么几个事情：
          <br /> 1、在yield的时候保存当前context。
          <br /> 2、在resume的时候恢复context，并根据pc计数来决定从哪里恢复执行。
          <br /> 3、半协程的实现来说，还需要一个调度器来调度所有协程。
          <br /> 4、为了做到用户代码透明，可能需要某种手段去修改用户代码，自动帮你做上面三个事情。
          <br /> 
          <br /> &nbsp;&nbsp;&nbsp; kilim的实现就是干了这么几个事情：
          <br /> 1、利用字节码增强，将普通的java代码转换为支持协程的代码。
          <br /> 2、在调用pausable方法的时候，如果pause了就保存当前方法栈的State，停止执行当前协程，将控制权交给调度器
          <br /> 3、调度器负责调度就绪的协程
          <br /> 4、协程resume的时候，自动恢复State，根据协程的pc计数跳转到上次执行的位置，继续执行。
          <br /> 
          <br /> 
          <br /> &nbsp;&nbsp;&nbsp; 下面是来自kilim文档的一个例子，同一段代码，在字节码增前前后的变化：
          <br /> 
          <img alt="" src="/images/blogjava_net/killme2008/kilim.png" height="619" width="833" />
          <br /> &nbsp;&nbsp;&nbsp; 
          <br /> 左边是原始代码，右边是通过字节码增强后的代码。其中h方法是pausable的，也就是说可能被暂停阻塞的，g方法因为调用了h这个方法也变成了pausable。
          <br /> 
          <br /> 首先看，原始的h方法是没有传入任何参数的，增强后的代码，多了个参数Fiber，指向当前的协程，同样，g方法本来只有一个参数n，现在在后面也多了个Fiber类型的参数，同样是指向当前执行的协程。
          <br /> 
          <br /> 其次，在原始的g方法里，一旦调用，马上进入一个for循环。但是在增强后的代码，多了个switch派发的过程，这就是前面提到的，根据当前的Fiber的pc计数，跳转到上一次执行的地方执行。如果是第一次resume，也就是启动协程，那么就将初始循环的i设置为0，进入原始代码的循环部分。Fiber有一个pc计数，称为程序计数器，用于指向恢复context的时候需要跳转到位置。
          <br /> 
          <br /> 第三，在g方法里调用h这个可被暂停阻塞的方法的时候，在h方法前后多了一些调用:
          <br /> 
          <div style="background-color: #eeeeee; font-size: 13px; border: 1px solid #cccccc; padding: 4px 5px 4px 4px; width: 98%;">
           <!--<br />
<br />
Code highlighting produced by Actipro CodeHighlighter (freeware)<br />
http://www.CodeHighlighter.com/<br />
<br />
-->
           <span style="color: #000000;">f.down();<br /> h(f);<br /> f.up();</span>
          </div> 
          <br /> kilim的Fiber将每个pauseable方法的调用组织成一个栈，每个pauseable方法都有一个activation frame，翻译过来可以称为活动栈帧，这个栈帧记录了当前的栈的State，注意这个栈跟java本身的方法调用栈区分开来，一个是VM层面的，一个是kilim框架层面的。这里的down方法就是将栈向下延伸，表示将调用一个pauseable方法，并且设置当前State和pc计数。
          <br /> 调用了down之后，才是调用实际的h方法，最后还要调用一次up，顾名思义，就是说一次pauseable方法调用完成，fiber的活动栈要递增一层，回到上一层。但是h方法调用可能出现四种情况：
          <br /> 1、正常的顺利返回，没有状态需要恢复，所谓NOT_PAUSING__NO_STATE
          <br /> 2、也是正常返回，有状态需要恢复，也就是NOT_PAUSING__HAS_STATE
          <br /> 3、h方法暂停阻塞，当前没有保存状态，需要保存状态，这是第一次暂停的时候，称为PAUSING__NO_STATE
          <br /> 4、h方法暂停阻塞，当前已经有状态，不需要保存状态，这是第一次暂停之后的resume再次暂停,称为PAUSING__HAS_STATE，通常不需要处理什么。
          <br /> 
          <br /> 第四，可以看到，在up之后，就要根据up返回的上述4种状态执行不同的逻辑：
          <br /> 
          <div style="background-color: #eeeeee; font-size: 13px; border: 1px solid #cccccc; padding: 4px 5px 4px 4px; width: 98%;">
           <!--<br />
<br />
Code highlighting produced by Actipro CodeHighlighter (freeware)<br />
http://www.CodeHighlighter.com/<br />
<br />
-->
           <span style="color: #0000ff;">if</span>
           <span style="color: #000000;">&nbsp;(f.isPausing){<br /> &nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #008000;">//</span>
           <span style="color: #008000;">第一次暂停，没有状态</span>
           <span style="color: #008000;"><br /> </span>
           <span style="color: #000000;">&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000ff;">if</span>
           <span style="color: #000000;">&nbsp;(</span>
           <span style="color: #000000;">!</span>
           <span style="color: #000000;">f.hasState){<br /> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #008000;">//</span>
           <span style="color: #008000;">new一个State_I2，并保存i和n</span>
           <span style="color: #008000;"><br /> </span>
           <span style="color: #000000;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f.state&nbsp;</span>
           <span style="color: #000000;">=</span>
           <span style="color: #000000;">&nbsp;</span>
           <span style="color: #0000ff;">new</span>
           <span style="color: #000000;">&nbsp;State_I2(i,n);<br /> &nbsp;&nbsp;&nbsp;&nbsp;</span>
           <span style="color: #008000;">//</span>
           <span style="color: #008000;">记录pc，还记的前面的switch吗？</span>
           <span style="color: #008000;"><br /> </span>
           <span style="color: #000000;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f.pc&nbsp;</span>
           <span style="color: #000000;">=</span>
           <span style="color: #000000;">&nbsp;H1;<br /> &nbsp;&nbsp;&nbsp;}<br /> &nbsp;&nbsp;&nbsp;</span>
           <span style="color: #0000ff;">return</span>
           <span style="color: #000000;">;<br /> }&nbsp;</span>
           <span style="color: #0000ff;">else</span>
           <span style="color: #000000;">&nbsp;</span>
           <span style="color: #0000ff;">if</span>
           <span style="color: #000000;">&nbsp;(f.hasState)<br /> &nbsp;&nbsp;&nbsp;</span>
           <span style="color: #008000;">//</span>
           <span style="color: #008000;">正常返回，有状态需要恢复，恢复i和n</span>
           <span style="color: #008000;"><br /> </span>
           <span style="color: #000000;">&nbsp;&nbsp;&nbsp;State_I2&nbsp;st&nbsp;</span>
           <span style="color: #000000;">=</span>
           <span style="color: #000000;">&nbsp;(State_I2)&nbsp;f.state;<br /> &nbsp;&nbsp;&nbsp;i&nbsp;</span>
           <span style="color: #000000;">=</span>
           <span style="color: #000000;">&nbsp;st.i1;&nbsp;n&nbsp;</span>
           <span style="color: #000000;">=</span>
           <span style="color: #000000;">&nbsp;st.i2;<br /> }</span>
          </div> 
          <br /> 
          <br /> 这里没有处理NOT_PAUSING__NO_STATE和PAUSING__HAS_STATE，因为这两种情况在这里不需要处理。
          <br /> 
          <br /> 
          <br /> &nbsp;&nbsp;&nbsp; 通过上面的分析，我想大家对kilim的实现应该已经有一个很基本的认识。下一步，我们分析一个实际的代码例子，查看整个运作流程。
          <br /> &nbsp; 
          <br />
         </div> 
         <p class="postfoot"> posted @ <a href="http://www.blogjava.net/killme2008/archive/2010/09/17/332281.html" title="permalink">2010-09-17 12:05</a> dennis 阅读(9489) | <a href="http://www.blogjava.net/killme2008/archive/2010/09/17/332281.html#FeedBack" title="comments, pingbacks, trackbacks">评论 (5)</a> |&nbsp;<a href="http://www.blogjava.net/killme2008/admin/EditPosts.aspx?postid=332281">编辑</a>&nbsp;<a href="http://www.blogjava.net/killme2008/AddToFavorite.aspx?id=332281">收藏</a> </p> 
        </div> 
       </div> </td> 
     </tr> 
     <tr> 
      <td colspan="2" class="FooterCell"> <p id="footer"> Powered by: <br /> <a id="Footer1_Hyperlink3" name="Hyperlink1" href="http://www.blogjava.net/"><font face="Verdana">BlogJava</font></a> <br /> Copyright &copy; dennis </p> </td> 
     </tr> 
    </tbody>
   </table> 
   <div id="lefttemp" style="DISPLAY:none"> 
    <div id="cell"> 
     <img src="/Skins/KJC/Images/icon-group.jpg" hspace="5" align="left" vspace="2" />
     <h3>公告</h3> 
     <iframe id="sina_widget_2652916941" style="width:100%; height:500px;" frameborder="0" scrolling="no" src="http://v.t.sina.com.cn/widget/widget_blog.php?uid=2652916941&amp;height=500&amp;skin=wd_02&amp;showpic=1"></iframe> 
     <br /> 
     <p><strong><a target="_blank" href="http://fnil.net">关于我</a></strong></p> 
     <script type="text/javascript" src="http://js.tongji.linezing.com/1535812/tongji.js"></script>
     <noscript>
      <a href="http://www.linezing.com"><img src="http://img.tongji.linezing.com/1535812/tongji.gif" alt="" /></a>
     </noscript> 
     <!-- Feedsky FEED发布代码开始 -->
     <!-- FEED自动发现标记开始 --> 
     <!-- FEED自动发现标记结束 -->
     <a href="http://feed.feedsky.com/killme2008" target="_blank"><img src="http://img.feedsky.com/images/icon_sub_c1s16.gif" alt="feedsky" style="margin-bottom: 3px;" border="0" vspace="2" /></a>
     <br /> 
     <a href="http://www.zhuaxia.com/add_channel.php?url=http://feed.feedsky.com/killme2008" target="_blank"><img src="http://img.feedsky.com/images/icon_subshot01_zhuaxia.gif" alt="抓虾" style="margin-bottom: 3px;" border="0" vspace="2" /></a>
     <br /> 
     <a href="http://fusion.google.com/add?feedurl=http://feed.feedsky.com/killme2008" target="_blank"><img src="http://img.feedsky.com/images/icon_subshot01_google.gif" alt="google reader" style="margin-bottom: 3px;" border="0" vspace="2" /></a>
     <br /> 
     <a href="http://add.my.yahoo.com/rss?url=http://feed.feedsky.com/killme2008" target="_blank"><img src="http://img.feedsky.com/images/icon_subshot01_yahoo.gif" alt="my yahoo" style="margin-bottom: 3px;" border="0" vspace="2" /></a>
     <br /> 
     <a href="http://www.bloglines.com/sub/http://feed.feedsky.com/killme2008" target="_blank"><img src="http://img.feedsky.com/images/icon_subshot01_bloglines.gif" alt="bloglines" style="margin-bottom: 3px;" border="0" vspace="2" /></a>
     <br /> 
     <a href="http://www.xianguo.com/subscribe.php?url=http://feed.feedsky.com/killme2008" target="_blank"><img src="http://img.feedsky.com/images/icon_subshot01_xianguo.gif" alt="鲜果" style="margin-bottom: 3px;" border="0" vspace="2" /></a>
     <br /> 
     <a href="http://inezha.com/add?url=http://feed.feedsky.com/killme2008" target="_blank"><img src="http://img.feedsky.com/images/icon_subshot01_nazha.gif" alt="哪吒" style="margin-bottom: 3px;" border="0" vspace="2" /></a>
     <br /> 
     <a href="http://reader.youdao.com/b.do?keyfrom=feedsky&amp;url=http://feed.feedsky.com/killme2008" target="_blank"><img src="http://img.feedsky.com/images/icon_subshot01_youdao.gif" alt="有道" style="margin-bottom: 3px;" border="0" vspace="2" /></a>
     <br /> 
     <a href="http://9.douban.com/reader/subscribe?url=http://feed.feedsky.com/killme2008" target="_blank"><img src="http://img.feedsky.com/images/icon_subshot01_douban.gif" alt="九点" style="margin-bottom: 3px;" border="0" vspace="2" /></a>
     <br /> 
     <a href="http://mail.qq.com/cgi-bin/feed?u=http://feed.feedsky.com/killme2008" target="_blank"><img src="http://img.feedsky.com/images/icon_subshot02_qq.gif" alt="QQ邮箱" style="margin-bottom: 3px;" border="0" vspace="2" /></a>
     <br /> 
     <!-- Feedsky FEED发布代码结束 -->
     <!-- Feedsky FEED发布代码开始 -->
     <!-- FEED自动发现标记开始 --> 
     <!-- FEED自动发现标记结束 -->
     <a href="http://wap.feedsky.com/killme2008"><img src="http://img.feedsky.com/images/icon_sub_mobile_c1s1.gif" alt="http://wap.feedsky.com/killme2008" border="0" vspace="2" /></a>
     <!-- Feedsky FEED发布代码结束 --> 
    </div> 
    <div id="cell"> 
     <img src="/Skins/KJC/Images/icon-group.jpg" hspace="5" align="left" vspace="2" />
     <h3>随笔分类</h3> 
     <ul> 
      <li><a id="Singlecolumn2_Categories_CatList_ctl00_LinkList_ctl01_RssLink" title="Subscribe to Android相关" href="http://www.blogjava.net/killme2008/category/49826.html/rss"><img title="Subscribe to Android相关" src="/Skins/KJC/Images/xmlsmall.gif" border="0" /></a><a id="Singlecolumn2_Categories_CatList_ctl00_LinkList_ctl01_Link" href="http://www.blogjava.net/killme2008/category/49826.html">Android相关</a> </li> 
      <li><a id="Singlecolumn2_Categories_CatList_ctl00_LinkList_ctl02_RssLink" title="Subscribe to C#历程(13)" href="http://www.blogjava.net/killme2008/category/19912.html/rss"><img title="Subscribe to C#历程(13)" src="/Skins/KJC/Images/xmlsmall.gif" border="0" /></a><a id="Singlecolumn2_Categories_CatList_ctl00_LinkList_ctl02_Link" href="http://www.blogjava.net/killme2008/category/19912.html">C#历程(13)</a> </li> 
      <li><a id="Singlecolumn2_Categories_CatList_ctl00_LinkList_ctl03_RssLink" title="Subscribe to Clojure(43)" href="http://www.blogjava.net/killme2008/category/45592.html/rss"><img title="Subscribe to Clojure(43)" src="/Skins/KJC/Images/xmlsmall.gif" border="0" /></a><a id="Singlecolumn2_Categories_CatList_ctl00_LinkList_ctl03_Link" href="http://www.blogjava.net/killme2008/category/45592.html">Clojure(43)</a> </li> 
      <li><a id="Singlecolumn2_Categories_CatList_ctl00_LinkList_ctl04_RssLink" title="Subscribe to erlang(16)" href="http://www.blogjava.net/killme2008/category/20770.html/rss"><img title="Subscribe to erlang(16)" src="/Skins/KJC/Images/xmlsmall.gif" border="0" /></a><a id="Singlecolumn2_Categories_CatList_ctl00_LinkList_ctl04_Link" href="http://www.blogjava.net/killme2008/category/20770.html">erlang(16)</a> </li> 
      <li><a id="Singlecolumn2_Categories_CatList_ctl00_LinkList_ctl05_RssLink" title="Subscribe to Hadoop与分布式(16)" href="http://www.blogjava.net/killme2008/category/33789.html/rss"><img title="Subscribe to Hadoop与分布式(16)" src="/Skins/KJC/Images/xmlsmall.gif" border="0" /></a><a id="Singlecolumn2_Categories_CatList_ctl00_LinkList_ctl05_Link" href="http://www.blogjava.net/killme2008/category/33789.html">Hadoop与分布式(16)</a> </li> 
      <li><a id="Singlecolumn2_Categories_CatList_ctl00_LinkList_ctl06_RssLink" title="Subscribe to java(176)" href="http://www.blogjava.net/killme2008/category/19800.html/rss"><img title="Subscribe to java(176)" src="/Skins/KJC/Images/xmlsmall.gif" border="0" /></a><a id="Singlecolumn2_Categories_CatList_ctl00_LinkList_ctl06_Link" href="http://www.blogjava.net/killme2008/category/19800.html">java(176)</a> </li> 
      <li><a id="Singlecolumn2_Categories_CatList_ctl00_LinkList_ctl07_RssLink" title="Subscribe to linux &amp; C(25)" href="http://www.blogjava.net/killme2008/category/23659.html/rss"><img title="Subscribe to linux &amp; C(25)" src="/Skins/KJC/Images/xmlsmall.gif" border="0" /></a><a id="Singlecolumn2_Categories_CatList_ctl00_LinkList_ctl07_Link" href="http://www.blogjava.net/killme2008/category/23659.html">linux &amp; C(25)</a> </li> 
      <li><a id="Singlecolumn2_Categories_CatList_ctl00_LinkList_ctl08_RssLink" title="Subscribe to my open-source(100)" href="http://www.blogjava.net/killme2008/category/20771.html/rss"><img title="Subscribe to my open-source(100)" src="/Skins/KJC/Images/xmlsmall.gif" border="0" /></a><a id="Singlecolumn2_Categories_CatList_ctl00_LinkList_ctl08_Link" href="http://www.blogjava.net/killme2008/category/20771.html">my open-source(100)</a> </li> 
      <li><a id="Singlecolumn2_Categories_CatList_ctl00_LinkList_ctl09_RssLink" title="Subscribe to node.js(5)" href="http://www.blogjava.net/killme2008/category/48752.html/rss"><img title="Subscribe to node.js(5)" src="/Skins/KJC/Images/xmlsmall.gif" border="0" /></a><a id="Singlecolumn2_Categories_CatList_ctl00_LinkList_ctl09_Link" href="http://www.blogjava.net/killme2008/category/48752.html">node.js(5)</a> </li> 
      <li><a id="Singlecolumn2_Categories_CatList_ctl00_LinkList_ctl10_RssLink" title="Subscribe to unix网络编程(6)" href="http://www.blogjava.net/killme2008/category/37396.html/rss"><img title="Subscribe to unix网络编程(6)" src="/Skins/KJC/Images/xmlsmall.gif" border="0" /></a><a id="Singlecolumn2_Categories_CatList_ctl00_LinkList_ctl10_Link" href="http://www.blogjava.net/killme2008/category/37396.html">unix网络编程(6)</a> </li> 
      <li><a id="Singlecolumn2_Categories_CatList_ctl00_LinkList_ctl11_RssLink" title="Subscribe to web开发(13)" href="http://www.blogjava.net/killme2008/category/19798.html/rss"><img title="Subscribe to web开发(13)" src="/Skins/KJC/Images/xmlsmall.gif" border="0" /></a><a id="Singlecolumn2_Categories_CatList_ctl00_LinkList_ctl11_Link" href="http://www.blogjava.net/killme2008/category/19798.html">web开发(13)</a> </li> 
      <li><a id="Singlecolumn2_Categories_CatList_ctl00_LinkList_ctl12_RssLink" title="Subscribe to 动态语言(81)" href="http://www.blogjava.net/killme2008/category/19799.html/rss"><img title="Subscribe to 动态语言(81)" src="/Skins/KJC/Images/xmlsmall.gif" border="0" /></a><a id="Singlecolumn2_Categories_CatList_ctl00_LinkList_ctl12_Link" href="http://www.blogjava.net/killme2008/category/19799.html">动态语言(81)</a> </li> 
      <li><a id="Singlecolumn2_Categories_CatList_ctl00_LinkList_ctl13_RssLink" title="Subscribe to 小毅同学二三事(1)" href="http://www.blogjava.net/killme2008/category/38569.html/rss"><img title="Subscribe to 小毅同学二三事(1)" src="/Skins/KJC/Images/xmlsmall.gif" border="0" /></a><a id="Singlecolumn2_Categories_CatList_ctl00_LinkList_ctl13_Link" href="http://www.blogjava.net/killme2008/category/38569.html">小毅同学二三事(1)</a> </li> 
      <li><a id="Singlecolumn2_Categories_CatList_ctl00_LinkList_ctl14_RssLink" title="Subscribe to 工作流(5)" href="http://www.blogjava.net/killme2008/category/19902.html/rss"><img title="Subscribe to 工作流(5)" src="/Skins/KJC/Images/xmlsmall.gif" border="0" /></a><a id="Singlecolumn2_Categories_CatList_ctl00_LinkList_ctl14_Link" href="http://www.blogjava.net/killme2008/category/19902.html">工作流(5)</a> </li> 
      <li><a id="Singlecolumn2_Categories_CatList_ctl00_LinkList_ctl15_RssLink" title="Subscribe to 工作随笔(9)" href="http://www.blogjava.net/killme2008/category/45690.html/rss"><img title="Subscribe to 工作随笔(9)" src="/Skins/KJC/Images/xmlsmall.gif" border="0" /></a><a id="Singlecolumn2_Categories_CatList_ctl00_LinkList_ctl15_Link" href="http://www.blogjava.net/killme2008/category/45690.html">工作随笔(9)</a> </li> 
      <li><a id="Singlecolumn2_Categories_CatList_ctl00_LinkList_ctl16_RssLink" title="Subscribe to 工具和命令(4)" href="http://www.blogjava.net/killme2008/category/49226.html/rss"><img title="Subscribe to 工具和命令(4)" src="/Skins/KJC/Images/xmlsmall.gif" border="0" /></a><a id="Singlecolumn2_Categories_CatList_ctl00_LinkList_ctl16_Link" href="http://www.blogjava.net/killme2008/category/49226.html">工具和命令(4)</a> </li> 
      <li><a id="Singlecolumn2_Categories_CatList_ctl00_LinkList_ctl17_RssLink" title="Subscribe to 数据库技术(14)" href="http://www.blogjava.net/killme2008/category/19801.html/rss"><img title="Subscribe to 数据库技术(14)" src="/Skins/KJC/Images/xmlsmall.gif" border="0" /></a><a id="Singlecolumn2_Categories_CatList_ctl00_LinkList_ctl17_Link" href="http://www.blogjava.net/killme2008/category/19801.html">数据库技术(14)</a> </li> 
      <li><a id="Singlecolumn2_Categories_CatList_ctl00_LinkList_ctl18_RssLink" title="Subscribe to 数据结构与算法(26)" href="http://www.blogjava.net/killme2008/category/20137.html/rss"><img title="Subscribe to 数据结构与算法(26)" src="/Skins/KJC/Images/xmlsmall.gif" border="0" /></a><a id="Singlecolumn2_Categories_CatList_ctl00_LinkList_ctl18_Link" href="http://www.blogjava.net/killme2008/category/20137.html">数据结构与算法(26)</a> </li> 
      <li><a id="Singlecolumn2_Categories_CatList_ctl00_LinkList_ctl19_RssLink" title="Subscribe to 模式与架构(30)" href="http://www.blogjava.net/killme2008/category/19797.html/rss"><img title="Subscribe to 模式与架构(30)" src="/Skins/KJC/Images/xmlsmall.gif" border="0" /></a><a id="Singlecolumn2_Categories_CatList_ctl00_LinkList_ctl19_Link" href="http://www.blogjava.net/killme2008/category/19797.html">模式与架构(30)</a> </li> 
      <li><a id="Singlecolumn2_Categories_CatList_ctl00_LinkList_ctl20_RssLink" title="Subscribe to 涂鸦(141)" href="http://www.blogjava.net/killme2008/category/19802.html/rss"><img title="Subscribe to 涂鸦(141)" src="/Skins/KJC/Images/xmlsmall.gif" border="0" /></a><a id="Singlecolumn2_Categories_CatList_ctl00_LinkList_ctl20_Link" href="http://www.blogjava.net/killme2008/category/19802.html">涂鸦(141)</a> </li> 
      <li><a id="Singlecolumn2_Categories_CatList_ctl00_LinkList_ctl21_RssLink" title="Subscribe to 源码解读(28)" href="http://www.blogjava.net/killme2008/category/21285.html/rss"><img title="Subscribe to 源码解读(28)" src="/Skins/KJC/Images/xmlsmall.gif" border="0" /></a><a id="Singlecolumn2_Categories_CatList_ctl00_LinkList_ctl21_Link" href="http://www.blogjava.net/killme2008/category/21285.html">源码解读(28)</a> </li> 
      <li><a id="Singlecolumn2_Categories_CatList_ctl00_LinkList_ctl22_RssLink" title="Subscribe to 移动开发(1)" href="http://www.blogjava.net/killme2008/category/47337.html/rss"><img title="Subscribe to 移动开发(1)" src="/Skins/KJC/Images/xmlsmall.gif" border="0" /></a><a id="Singlecolumn2_Categories_CatList_ctl00_LinkList_ctl22_Link" href="http://www.blogjava.net/killme2008/category/47337.html">移动开发(1)</a> </li> 
      <li><a id="Singlecolumn2_Categories_CatList_ctl00_LinkList_ctl23_RssLink" title="Subscribe to 计算机科学与基础(56)" href="http://www.blogjava.net/killme2008/category/22252.html/rss"><img title="Subscribe to 计算机科学与基础(56)" src="/Skins/KJC/Images/xmlsmall.gif" border="0" /></a><a id="Singlecolumn2_Categories_CatList_ctl00_LinkList_ctl23_Link" href="http://www.blogjava.net/killme2008/category/22252.html">计算机科学与基础(56)</a> </li> 
      <li><a id="Singlecolumn2_Categories_CatList_ctl00_LinkList_ctl24_RssLink" title="Subscribe to 软件工程(6)" href="http://www.blogjava.net/killme2008/category/30223.html/rss"><img title="Subscribe to 软件工程(6)" src="/Skins/KJC/Images/xmlsmall.gif" border="0" /></a><a id="Singlecolumn2_Categories_CatList_ctl00_LinkList_ctl24_Link" href="http://www.blogjava.net/killme2008/category/30223.html">软件工程(6)</a> </li> 
     </ul> 
    </div> 
    <div id="cell"> 
     <img src="/Skins/KJC/Images/icon-group.jpg" hspace="5" align="left" vspace="2" />
     <h3>友情链接</h3> 
     <ul> 
      <li><a id="Singlecolumn2_Categories_CatList_ctl01_LinkList_ctl01_Link" href="http://fnil.net/">About me</a> </li> 
      <li><a id="Singlecolumn2_Categories_CatList_ctl01_LinkList_ctl02_Link" href="http://clojure.cn" target="_blank">Clojure中文技术社区</a> </li> 
      <li><a id="Singlecolumn2_Categories_CatList_ctl01_LinkList_ctl03_Link" href="http://code.google.com/p/xmemcached/">xmemcached</a> </li> 
      <li><a id="Singlecolumn2_Categories_CatList_ctl01_LinkList_ctl04_Link" href="http://www.1kg.org/">多背一公斤</a> </li> 
      <li><a id="Singlecolumn2_Categories_CatList_ctl01_LinkList_ctl05_Link" href="http://dreamhead.blogbus.com/" target="_blank">梦想风暴</a> </li> 
      <li><a id="Singlecolumn2_Categories_CatList_ctl01_LinkList_ctl06_RssLink" title="Subscribe to 淘宝Java中间件" href="http://rdc.taobao.com/team/jm/feed"><img title="Subscribe to 淘宝Java中间件" src="/Skins/KJC/Images/xmlsmall.gif" border="0" /></a><a id="Singlecolumn2_Categories_CatList_ctl01_LinkList_ctl06_Link" href="http://rdc.taobao.com/team/jm/">淘宝Java中间件</a> </li> 
      <li><a id="Singlecolumn2_Categories_CatList_ctl01_LinkList_ctl07_Link" href="http://meiweisq.com">美味书签</a> </li> 
      <li><a id="Singlecolumn2_Categories_CatList_ctl01_LinkList_ctl08_Link" href="http://team.mei.fm/">美味书签团队博客</a> </li> 
      <li><a id="Singlecolumn2_Categories_CatList_ctl01_LinkList_ctl09_Link" href="http://readwise.net">美味爱读</a> </li> 
      <li><a id="Singlecolumn2_Categories_CatList_ctl01_LinkList_ctl10_Link" href="http://blogger.org.cn/blog/blog.asp?name=hongrui">邢红瑞的blog</a> </li> 
      <li><a id="Singlecolumn2_Categories_CatList_ctl01_LinkList_ctl11_Link" href="http://arbow.javaeye.com">阿宝的blog</a> </li> 
      <li><a id="Singlecolumn2_Categories_CatList_ctl01_LinkList_ctl12_Link" href="http://yangzhihuan.javaeye.com/">阿欢的blog</a> </li> 
     </ul> 
    </div> 
    <div id="cell"> 
     <img src="/Skins/KJC/Images/icon-group.jpg" hspace="5" align="left" vspace="2" />
     <h3>最新随笔</h3> 
     <ul style="word-break:break-all"> 
      <li><a id="Singlecolumn2__1553e88e4b66_RecentPostsList_ctl00_RecentPostsList2_ctl00_Hyperlink1" href="http://www.blogjava.net/killme2008/archive/2012/12/10/392701.html">1.&nbsp;博客搬迁</a></li> 
      <li><a id="Singlecolumn2__1553e88e4b66_RecentPostsList_ctl01_RecentPostsList2_ctl00_Hyperlink1" href="http://www.blogjava.net/killme2008/archive/2012/11/25/391936.html">2.&nbsp;Another URL Shortener using NodeJS</a></li> 
      <li><a id="Singlecolumn2__1553e88e4b66_RecentPostsList_ctl02_RecentPostsList2_ctl00_Hyperlink1" href="http://www.blogjava.net/killme2008/archive/2012/09/25/388498.html">3.&nbsp;Clojure中文专业技术社区</a></li> 
      <li><a id="Singlecolumn2__1553e88e4b66_RecentPostsList_ctl03_RecentPostsList2_ctl00_Hyperlink1" href="http://www.blogjava.net/killme2008/archive/2012/07/18/383354.html">4.&nbsp;Ring.velocity:render velocity templates for ring in clojure</a></li> 
      <li><a id="Singlecolumn2__1553e88e4b66_RecentPostsList_ctl04_RecentPostsList2_ctl00_Hyperlink1" href="http://www.blogjava.net/killme2008/archive/2012/07/10/382738.html">5.&nbsp;Clojure笔记：用好type hint</a></li> 
      <li><a id="Singlecolumn2__1553e88e4b66_RecentPostsList_ctl05_RecentPostsList2_ctl00_Hyperlink1" href="http://www.blogjava.net/killme2008/archive/2012/06/15/380822.html">6.&nbsp;Clojure世界：利用HouseMD诊断clojure</a></li> 
      <li><a id="Singlecolumn2__1553e88e4b66_RecentPostsList_ctl06_RecentPostsList2_ctl00_Hyperlink1" href="http://www.blogjava.net/killme2008/archive/2012/06/04/379895.html">7.&nbsp;分布式消息中间件Metaq发布1.4.3</a></li> 
      <li><a id="Singlecolumn2__1553e88e4b66_RecentPostsList_ctl07_RecentPostsList2_ctl00_Hyperlink1" href="http://www.blogjava.net/killme2008/archive/2012/05/22/378885.html">8.&nbsp;如何熟悉一个开源项目？</a></li> 
      <li><a id="Singlecolumn2__1553e88e4b66_RecentPostsList_ctl08_RecentPostsList2_ctl00_Hyperlink1" href="http://www.blogjava.net/killme2008/archive/2012/05/19/378535.html">9.&nbsp;Emacs + Clojure配置的几个Tip</a></li> 
      <li><a id="Singlecolumn2__1553e88e4b66_RecentPostsList_ctl09_RecentPostsList2_ctl00_Hyperlink1" href="http://www.blogjava.net/killme2008/archive/2012/05/12/378018.html">10.&nbsp;clj.monitor : monitoring applications in clojure based on SSH</a></li> 
     </ul> 
    </div> 
    <script language="JavaScript">
function SearchGoogle(key,evt,site)
		{
			if(evt.keyCode==13 || evt.keyCode==0)
			{
				key.focus();
				var keystr = encodeURIComponent(key.value);
				url = "http://www.google.com/search?q=";
				url = url+keystr;
				url += "&ie=UTF-8&oe=GB2312&hl=zh-CN&domains="+site+"&sitesearch="+site;
				window.location = url;
				return false;			
			}
			
		}
</script> 
    <div id="cell"> 
     <img src="/Skins/KJC/Images/icon-group.jpg" hspace="5" align="left" vspace="2" />
     <h3>搜索</h3> 
     <ul> 
      <li><input style="WIDTH: 130px" type="text" name="q" id="q" onkeydown="return SearchGoogle(document.getElementById('q'),event,'http://www.blogjava.net/killme2008/')" />&nbsp;<input onclick="SearchGoogle(document.getElementById('q'),event,'http://www.blogjava.net/killme2008/')" type="button" value="搜索" name="sa" /></li>
     </ul> 
    </div> 
    <div id="cell"> 
     <img src="/Skins/KJC/Images/icon-group.jpg" hspace="5" align="left" vspace="2" />
     <h3>最新评论 <a id="Singlecolumn2__3f6f3f061b49_RSSHyperlink1" href="http://www.blogjava.net/killme2008/CommentsRSS.aspx"><img src="/images/xml.gif" border="0" /></a></h3> 
     <div class="RecentComment"> 
      <ul> 
       <li style="word-break:break-all"> <a id="Singlecolumn2__3f6f3f061b49_CommentList_ctl01_Hyperlink1" href="http://www.blogjava.net/killme2008/archive/2016/08/13/152301.html#431571">1.&nbsp;vitamind28448</a> </li> 
       <li style="word-break:break-all"> 评论内容较长,点击标题查看 </li> 
       <li style="text-align:right;margin-right:4px"> --Good post. I learn something totally new and chall</li> 
       <li style="word-break:break-all"> <a id="Singlecolumn2__3f6f3f061b49_CommentList_ctl02_Hyperlink1" href="http://www.blogjava.net/killme2008/archive/2016/07/27/324758.html#431353">2.&nbsp;re: Aviator――让表达式飞起来</a> </li> 
       <li style="word-break:break-all"> 很好用，刚用到最近的一个项目中 </li> 
       <li style="text-align:right;margin-right:4px"> --welcomezhang</li> 
       <li style="word-break:break-all"> <a id="Singlecolumn2__3f6f3f061b49_CommentList_ctl03_Hyperlink1" href="http://www.blogjava.net/killme2008/archive/2016/06/17/251368.html#430947">3.&nbsp;re: Java字符串的最大长度</a> </li> 
       <li style="word-break:break-all"> 写得很好 </li> 
       <li style="text-align:right;margin-right:4px"> --zzz</li> 
       <li style="word-break:break-all"> <a id="Singlecolumn2__3f6f3f061b49_CommentList_ctl04_Hyperlink1" href="http://www.blogjava.net/killme2008/archive/2016/06/14/152301.html#430902">4.&nbsp;clashofclanshack1155</a> </li> 
       <li style="word-break:break-all"> Very clean site, thanks for this post. </li> 
       <li style="text-align:right;margin-right:4px"> --Very clean site, thanks for this post.</li> 
       <li style="word-break:break-all"> <a id="Singlecolumn2__3f6f3f061b49_CommentList_ctl05_Hyperlink1" href="http://www.blogjava.net/killme2008/archive/2016/06/04/388498.html#430772">5.&nbsp;binaryrobot89773</a> </li> 
       <li style="word-break:break-all"> 评论内容较长,点击标题查看 </li> 
       <li style="text-align:right;margin-right:4px"> --Howdy! I simply wish to offer you a big thumbs up </li> 
      </ul> 
     </div> 
    </div> 
   </div> 
  </form> 
  <script type="text/javascript" src="/script/ShowHidden.js"></script> 
  <script type="text/javascript">
	  var _gaq = _gaq || [];
	  _gaq.push(['_setAccount', 'UA-476124-3']);
	  _gaq.push(['_trackPageview']);

	  (function() {
		var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
		ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
		var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
	  })();
	</script>   
 </body>
</html>